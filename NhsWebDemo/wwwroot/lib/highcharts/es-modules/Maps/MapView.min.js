"use strict";import defaultOptions from"./MapViewOptionsDefault.js";import Projection from"./Projection.js";import U from"../Core/Utilities.js";var addEvent=U.addEvent,clamp=U.clamp,fireEvent=U.fireEvent,isNumber=U.isNumber,merge=U.merge,pick=U.pick,relativeLength=U.relativeLength,worldSize=400.979322,tileSize=256,MapView=function(){function o(c,t){var p=this;this.userOptions=t||{};var a,d,m,t=merge(defaultOptions,t);this.chart=c,this.center=t.center,this.options=t,this.projection=new Projection(t.projection),this.zoom=t.zoom||0,addEvent(c,"afterSetChartSize",function(){void 0!==p.minZoom&&p.minZoom!==p.zoom||(p.fitToBounds(void 0,void 0,!1),isNumber(p.userOptions.zoom)&&(p.zoom=p.userOptions.zoom),p.userOptions.center&&merge(!0,p.center,p.userOptions.center))});t=function(t){var o,e,i,r,n=c.pointer.pinchDown,s=c.mouseDownX,h=c.mouseDownY;1===n.length&&(s=n[0].chartX,h=n[0].chartY),"number"==typeof s&&"number"==typeof h&&(o=(i=t.originalEvent).chartX,e=i.chartY,(n=s+","+h)!==d&&(d=n,a=p.projection.forward(p.center),m=(p.projection.options.rotation||[0,0]).slice()),"Orthographic"===p.projection.options.name&&(p.minZoom||1/0)<3?(i=440/(p.getScale()*Math.min(c.plotWidth,c.plotHeight)),m&&(n=(s-o)*i-m[0],r=clamp(-m[1]-(h-e)*i,-80,80),p.update({projection:{rotation:[-n,-r]},center:[n,r],zoom:p.zoom},!0,!1))):(r=p.getScale(),r=p.projection.inverse([a[0]+(s-o)/r,a[1]-(h-e)/r]),p.setView(r,void 0,!0,!1)),t.preventDefault())};addEvent(c,"pan",t),addEvent(c,"touchpan",t),addEvent(c,"selection",function(t){var o,e,i,r;t.resetSelection?p.zoomBy():(r=t.x-c.plotLeft,i=t.y-c.plotTop,o=(e=p.pixelsToProjectedUnits({x:r,y:i})).y,e=e.x,i=(r=p.pixelsToProjectedUnits({x:r+t.width,y:i+t.height})).y,r=r.x,p.fitToBounds({x1:e,y1:o,x2:r,y2:i},void 0,!0,!t.originalEvent.touches&&void 0),/^touch/.test(t.originalEvent.type)||c.showResetZoom(),t.preventDefault())})}return o.prototype.fitToBounds=function(t,o,e,i){void 0===e&&(e=!0);var r,n,s,h=t||this.getProjectedBounds();h&&(r=(s=this.chart).plotWidth,n=s.plotHeight,s=pick(o,t?0:this.options.padding),o=relativeLength(s,r),s=relativeLength(s,n),s=Math.max((h.x2-h.x1)/((r-o)/tileSize),(h.y2-h.y1)/((n-s)/tileSize)),s=Math.log(worldSize/s)/Math.log(2),t||(this.minZoom=s),h=this.projection.inverse([(h.x2+h.x1)/2,(h.y2+h.y1)/2]),this.setView(h,s,e,i))},o.prototype.getProjectedBounds=function(){var t=this.chart.series.reduce(function(t,o){o=o.getProjectedBounds&&o.getProjectedBounds();return o&&t.push(o),t},[]);return o.compositeBounds(t)},o.prototype.getScale=function(){return tileSize/worldSize*Math.pow(2,this.zoom)},o.prototype.redraw=function(t){this.chart.series.forEach(function(t){t.useMapGeometry&&(t.isDirty=!0)}),this.chart.redraw(t)},o.prototype.setView=function(t,o,e,i){void 0===e&&(e=!0);var r=!1;t&&(this.center=t),"number"==typeof o&&("number"==typeof this.minZoom&&(o=Math.max(o,this.minZoom)),r=(o="number"==typeof this.options.maxZoom?Math.min(o,this.options.maxZoom):o)>this.zoom,this.zoom=o);var n,s,h,c,p,a=this.getProjectedBounds();a&&!r&&(n=this.projection.forward(this.center),s=(p=this.chart).plotWidth,h=p.plotHeight,c=this.getScale(),t=this.projectedUnitsToPixels({x:a.x1,y:a.y1}),o=this.projectedUnitsToPixels({x:a.x2,y:a.y2}),r=[(a.x1+a.x2)/2,(a.y1+a.y2)/2],p=t.x,a=o.y,o=o.x,t=t.y,o-p<s?n[0]=r[0]:p<0&&o<s?n[0]+=Math.max(p,o-s)/c:s<o&&0<p&&(n[0]+=Math.min(o-s,p)/c),t-a<h?n[1]=r[1]:a<0&&t<h?n[1]-=Math.max(a,t-h)/c:h<t&&0<a&&(n[1]-=Math.min(t-h,a)/c),this.center=this.projection.inverse(n)),fireEvent(this,"afterSetView"),e&&this.redraw(i)},o.prototype.projectedUnitsToPixels=function(t){var o=this.getScale(),e=this.projection.forward(this.center),i=this.chart.plotWidth/2,r=this.chart.plotHeight/2;return{x:i-o*(e[0]-t.x),y:r+o*(e[1]-t.y)}},o.prototype.pixelsToProjectedUnits=function(t){var o=t.x,e=t.y,i=this.getScale(),r=this.projection.forward(this.center),n=this.chart.plotWidth/2,t=this.chart.plotHeight/2;return{x:r[0]+(o-n)/i,y:r[1]-(e-t)/i}},o.prototype.update=function(t,o,e){void 0===o&&(o=!0);var i=t.projection,i=i&&Projection.toString(i)!==Projection.toString(this.options.projection);merge(!0,this.userOptions,t),merge(!0,this.options,t),i&&(this.chart.series.forEach(function(t){t.clearBounds&&t.clearBounds(),t.isDirty=!0,t.isDirtyData=!0}),this.projection=new Projection(this.options.projection),t.center||isNumber(t.zoom)||this.fitToBounds(void 0,void 0,!1)),(t.center||isNumber(t.zoom))&&this.setView(this.options.center,t.zoom,!1),o&&this.chart.redraw(e)},o.prototype.zoomBy=function(t,o,e,i){var r,n,s,h=this.chart,c=this.projection.forward(this.center),p=o?this.projection.forward(o):[],a=p[0],o=p[1];"number"==typeof t?(p=this.zoom+t,t=void 0,e&&(n=e[0],s=e[1],r=this.getScale(),n=n-h.plotLeft-h.plotWidth/2,s=s-h.plotTop-h.plotHeight/2,a=c[0]+n/r,o=c[1]+s/r),"number"==typeof a&&"number"==typeof o&&(r=1-Math.pow(2,this.zoom)/Math.pow(2,p),n=c[0]-a,s=c[1]-o,c[0]-=n*r,c[1]+=s*r,t=this.projection.inverse(c)),this.setView(t,p,void 0,i)):this.fitToBounds(void 0,void 0,void 0,i)},o.compositeBounds=function(t){if(t.length)return t.slice(1).reduce(function(t,o){return t.x1=Math.min(t.x1,o.x1),t.y1=Math.min(t.y1,o.y1),t.x2=Math.max(t.x2,o.x2),t.y2=Math.max(t.y2,o.y2),t},merge(t[0]))},o}();export default MapView;