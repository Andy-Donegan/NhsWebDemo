"use strict";var __spreadArrays=this&&this.__spreadArrays||function(){for(var r=0,t=0,a=arguments.length;t<a;t++)r+=arguments[t].length;for(var i=Array(r),o=0,t=0;t<a;t++)for(var e=arguments[t],n=0,s=e.length;n<s;n++,o++)i[o]=e[n];return i};import registry from"./Projections/ProjectionRegistry.js";import U from"../Core/Utilities.js";var erase=U.erase,deg2rad=2*Math.PI/360,floatCorrection=1e-6,wrapLon=function(r){return r<-180&&(r+=360),180<r&&(r-=360),r},Projection=function(){function v(r){void 0===r&&(r={}),this.hasCoordinates=!1,this.hasGeoProjection=!1,this.maxLatitude=90;var t=(this.options=r).name,a=r.rotation;this.rotator=a?this.getRotator(a):void 0,this.def=t?v.registry[t]:void 0;var i=this.def,o=this.rotator;i&&(i.init&&i.init(r),this.maxLatitude=i.maxLatitude||90,this.hasGeoProjection=!0),o&&i?(this.forward=function(r){return r=o.forward(r),i.forward(r)},this.inverse=function(r){r=i.inverse(r);return o.inverse(r)}):i?(this.forward=i.forward,this.inverse=i.inverse):o&&(this.forward=o.forward,this.inverse=o.inverse)}return v.add=function(r,t){v.registry[r]=t},v.greatCircle=function(r,t,a){var i=Math.atan2,o=Math.cos,e=Math.sin,n=Math.sqrt,s=r[1]*deg2rad,h=r[0]*deg2rad,c=t[1]*deg2rad,d=t[0]*deg2rad,f=c-s,l=d-h,l=e(f/2)*e(f/2)+o(s)*o(c)*e(l/2)*e(l/2),u=2*i(n(l),n(1-l)),l=Math.round(6371e3*u/5e5),p=[];if(a&&p.push(r),1<l)for(var g=1/l,v=g;v<.999;v+=g){var M=e((1-v)*u)/e(u),y=e(v*u)/e(u),C=M*o(s)*o(h)+y*o(c)*o(d),L=M*o(s)*e(h)+y*o(c)*e(d),y=i(M*e(s)+y*e(c),n(C*C+L*L)),C=i(L,C);p.push([C/deg2rad,y/deg2rad])}return a&&p.push(t),p},v.insertGreatCircles=function(r){for(var t,a=r.length-1;a--;)10<Math.max(Math.abs(r[a][0]-r[a+1][0]),Math.abs(r[a][1]-r[a+1][1]))&&((t=v.greatCircle(r[a],r[a+1])).length&&r.splice.apply(r,__spreadArrays([a+1,0],t)))},v.toString=function(r){var t=r||{},r=t.name,t=t.rotation;return[r,t&&t.join(",")].join(";")},v.prototype.getRotator=function(r){var o=r[0]*deg2rad,t=(r[1]||0)*deg2rad,r=(r[2]||0)*deg2rad,e=Math.cos(t),n=Math.sin(t),s=Math.cos(r),h=Math.sin(r);if(0!=o||0!=t||0!=r)return{forward:function(r){var t=r[0]*deg2rad+o,a=r[1]*deg2rad,i=Math.cos(a),r=Math.cos(t)*i,t=Math.sin(t)*i,i=Math.sin(a),a=i*e+r*n;return[Math.atan2(t*s-a*h,r*e-i*n)/deg2rad,Math.asin(a*s+t*h)/deg2rad]},inverse:function(r){var t=r[0]*deg2rad,a=r[1]*deg2rad,i=Math.cos(a),r=Math.cos(t)*i,t=Math.sin(t)*i,i=Math.sin(a),a=i*s-t*h;return[(Math.atan2(t*s+i*h,r*e+a*n)-o)/deg2rad,Math.asin(a*e-r*n)/deg2rad]}}},v.prototype.forward=function(r){return r},v.prototype.inverse=function(r){return r},v.prototype.clipOnAntimeridian=function(e,n){var r,s=[],t=[e];if(e.forEach(function(r,t){var a=e[t-1];if(!t){if(!n)return;a=e[e.length-1]}var i=a[0],o=r[0];(i<-90||90<i)&&(o<-90||90<o)&&0<i!=0<o&&(o=(180-a[0])/(r[0]-a[0]),o=a[1]+o*(r[1]-a[1]),s.push({i:t,lat:o,direction:i<0?1:-1,previousLonLat:a,lonLat:r}))}),s.length)if(n){s.length%2==1&&(r=s.slice().sort(function(r,t){return Math.abs(t.lat)-Math.abs(r.lat)})[0],erase(s,r));for(var a=s.length-2;0<=a;){var i=s[a].i,o=wrapLon(180+s[a].direction*floatCorrection),h=wrapLon(180-s[a].direction*floatCorrection);(g=e.splice.apply(e,__spreadArrays([i,s[a+1].i-i],v.greatCircle([o,s[a].lat],[o,s[a+1].lat],!0)))).push.apply(g,v.greatCircle([h,s[a+1].lat],[h,s[a].lat],!0)),t.push(g),a-=2}if(r)for(var c=0;c<t.length;c++){var d=t[c],f=d.indexOf(r.lonLat);if(-1<f){var l=(r.lat<0?-1:1)*this.maxLatitude,u=wrapLon(180+r.direction*floatCorrection),p=wrapLon(180-r.direction*floatCorrection),p=v.greatCircle([u,r.lat],[u,l],!0).concat(v.greatCircle([p,l],[p,r.lat],!0));d.splice.apply(d,__spreadArrays([f,0],p));break}}}else for(a=s.length;a--;){var g,i=s[a].i;(g=e.splice(i,e.length,[wrapLon(180+s[a].direction*floatCorrection),s[a].lat])).unshift([wrapLon(180-s[a].direction*floatCorrection),s[a].lat]),t.push(g)}return t},v.prototype.path=function(r){function t(r){var t=r.map(function(r){var t;return o&&(t=(r=e?e.forward(r):r)[0],r=[t=Math.abs(t-180)<floatCorrection?t<180?180-floatCorrection:180+floatCorrection:t,r[1]]),r}),r=[t];l&&(v.insertGreatCircles(t),o&&(r=c.clipOnAntimeridian(t,f))),r.forEach(function(r){if(!(r.length<2))for(var t,a,i=!1,o=!1,e=function(r){i?d.push(["L",r[0],r[1]]):(d.push(["M",r[0],r[1]]),i=!0)},n=0;n<r.length;n++)var s=r[n],h=u.forward(s),o=!(!isNaN(h[0])&&!isNaN(h[1])&&(!l||s[1]<=c.maxLatitude&&s[1]>=-c.maxLatitude))||(f&&!t&&r.push(t=s),o&&a&&(f&&l?v.greatCircle(a,s).forEach(function(r){return e(u.forward(r))}):i=!1),e(h),a=s,!1)})}var c=this,a=this.def,i=this.rotator,d=[],f="Polygon"===r.type||"MultiPolygon"===r.type,l=this.hasGeoProjection,o="Orthographic"!==this.options.name,e=o?i:void 0,u=o&&a||this;return"LineString"===r.type?t(r.coordinates):"MultiLineString"===r.type?r.coordinates.forEach(t):"Polygon"===r.type?(r.coordinates.forEach(t),d.length&&d.push(["Z"])):"MultiPolygon"===r.type&&(r.coordinates.forEach(function(r){r.forEach(t)}),d.length&&d.push(["Z"])),d},v.registry=registry,v}();export default Projection;