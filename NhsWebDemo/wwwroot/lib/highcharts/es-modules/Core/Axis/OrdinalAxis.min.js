"use strict";import Axis from"./Axis.js";import H from"../Globals.js";import Series from"../Series/Series.js";import U from"../Utilities.js";var OrdinalAxis,addEvent=U.addEvent,correctFloat=U.correctFloat,css=U.css,defined=U.defined,error=U.error,pick=U.pick,timeUnits=U.timeUnits,composedClasses=[];!function(n){function e(t,i,o,n,e,s,r){void 0===e&&(e=[]),void 0===s&&(s=0);var a,l,d,p,c={},f=this.options.tickPixelInterval,h=this.chart.time,v=[],g=0,u=[],x=-Number.MAX_VALUE;if(!this.options.ordinal&&!this.options.breaks||!e||e.length<3||void 0===i)return h.getTimeTicks.apply(h,arguments);for(var m=e.length,P=0;P<m;P++){if(p=P&&e[P-1]>o,e[P]<i&&(g=P),P===m-1||e[P+1]-e[P]>5*s||p){if(e[P]>x){for(a=h.getTimeTicks(t,e[g],e[P],n);a.length&&a[0]<=x;)a.shift();a.length&&(x=a[a.length-1]),v.push(u.length),u=u.concat(a)}g=P+1}if(p)break}if(a){if(d=a.info,r&&d.unitRange<=timeUnits.hour){for(P=u.length-1,g=1;g<P;g++)h.dateFormat("%d",u[g])!==h.dateFormat("%d",u[g-1])&&(c[u[g]]="day",l=!0);l&&(c[u[0]]="day"),d.higherRanks=c}d.segmentStarts=v,u.info=d}else error(12,!1,this.chart);if(r&&defined(f)){for(var O,r=u.length,y=[],M=[],A=void 0,E=void 0,k=void 0,I=void 0,D=r;D--;)E=this.translate(u[D]),k&&(M[D]=k-E),y[D]=k=E;for(M.sort(),(I=M[Math.floor(M.length/2)])<.6*f&&(I=null),D=u[r-1]>o?r-1:r,k=void 0;D--;)E=y[D],O=Math.abs(k-E),k&&O<.8*f&&(null===I||O<.8*I)?(c[u[D]]&&!c[u[D+1]]?(A=D+1,k=E):A=D,u.splice(A,1)):k=E}return u}function s(t){var i=this.ordinal.positions;if(!i)return t;var o,n=i.length-1;return t<0?t=i[0]:n<t?t=i[n]:o=t-(n=Math.floor(t)),void 0!==o&&void 0!==i[n]?i[n]+(o?o*(i[n+1]-i[n]):0):t}function r(t){var i=this,o=i.ordinal,n=(i.old||i).min,e=(i.old||i).transA,s=o.positions;if(!s)return t;e=(t-n)*e+i.minPixelPadding;if(0<e&&e<i.left+i.len||(o.extendedOrdinalPositions||(o.extendedOrdinalPositions=o.getExtendedPositions()),s=o.extendedOrdinalPositions),s&&s.length){o=o.getIndexOfPoint(e,s),e=correctFloat(o%1);if(0<=o&&o<s.length-1){var r=s[Math.floor(o)],a=s[Math.ceil(o)]-r;return s[Math.floor(o)]+e*a}r=s.length,e=s[0],a=s[r-1],s=(a-e)/(r-1);return o<0?e+s*o:a+s*(o-r)}return t}function l(t,i){var o=n.Additions.findIndexOf(t,i,!0);return t[o]===i?o:o+(i-t[o])/(t[o+1]-t[o])}function a(){this.ordinal||(this.ordinal=new n.Additions(this))}function d(){var t=this;t.isXAxis&&defined(t.options.overscroll)&&t.max===t.dataMax&&(!t.chart.mouseIsDown||t.isInternal)&&(!t.eventArgs||t.eventArgs&&"navigator"!==t.eventArgs.trigger)&&(t.max+=t.options.overscroll,!t.isInternal&&defined(t.userMin)&&(t.min+=t.options.overscroll))}function p(){var t=this;t.horiz&&!t.isDirty&&(t.isDirty=t.isOrdinal&&t.chart.navigator&&!t.chart.navigator.adaptToUpdatedData)}function c(){var t=this;t.ordinal&&(t.ordinal.beforeSetTickPositions(),t.tickInterval=t.ordinal.postProcessTickInterval(t.tickInterval))}function f(t){var i,o,n,e,s,r,a,l,d,p,c,f,h,v=this,g=v.xAxis[0],u=g.options.overscroll,x=t.originalEvent.chartX,m=v.options.chart.panning,P=!1;m&&"y"!==m.type&&g.options.ordinal&&g.series.length?(f=v.mouseDownX,o=(i=g.getExtremes()).dataMax,n=i.min,e=i.max,s=v.hoverPoints,h=g.closestPointRange||g.ordinal&&g.ordinal.overscrollPointsRange,r=(f-x)/(g.translationSlope*(g.ordinal.slope||h)),a={ordinal:{positions:g.ordinal.getExtendedPositions()}},l=g.index2val,d=g.val2lin,h=f=c=p=void 0,a.ordinal.positions?1<Math.abs(r)&&(s&&s.forEach(function(t){t.setState()}),o>(c=(h=r<0?(f=a,g.ordinal.positions?g:a):(f=g.ordinal.positions?g:a,a)).ordinal.positions)[c.length-1]&&c.push(o),v.fixedRange=e-n,(p=g.navigatorAxis.toFixedRange(void 0,void 0,l.apply(f,[d.apply(f,[n,!0])+r]),l.apply(h,[d.apply(h,[e,!0])+r]))).min>=Math.min(i.dataMin,n)&&p.max<=Math.max(o,e)+u&&g.setExtremes(p.min,p.max,!0,!1,{trigger:"pan"}),v.mouseDownX=x,css(v.container,{cursor:"move"})):P=!0):P=!0,P||m&&/y/.test(m.type)?u&&(g.max=g.dataMax+u):t.preventDefault()}function h(){var t=this.xAxis;t&&t.options.ordinal&&(delete t.ordinal.index,delete t.ordinal.extendedOrdinalPositions)}function v(t,i){var o=this.ordinal,n=o.positions,e=o.slope,s=o.extendedOrdinalPositions;if(!n)return t;var r=n.length;if(n[0]<=t&&n[r-1]>=t)a=l(n,t);else{if(s||(s=o.getExtendedPositions&&o.getExtendedPositions(),o.extendedOrdinalPositions=s),!s||!s.length)return t;var a,r=s.length,e=e||(s[r-1]-s[0])/r,n=l(s,n[0]);a=t>=s[0]&&t<=s[r-1]?l(s,t)-n:t<s[0]?-n-(s[0]-t)/e:(t-s[r-1])/e+r-n}return i?a:e*(a||0)+o.offset}n.compose=function(t,i,o){var n;return-1===composedClasses.indexOf(t)&&(composedClasses.push(t),(n=t.prototype).getTimeTicks=e,n.index2val=s,n.lin2val=r,n.val2lin=v,n.ordinal2lin=n.val2lin,addEvent(t,"afterInit",a),addEvent(t,"foundExtremes",d),addEvent(t,"afterSetScale",p),addEvent(t,"initialAxisTranslation",c)),-1===composedClasses.indexOf(o)&&(composedClasses.push(o),addEvent(o,"pan",f)),-1===composedClasses.indexOf(i)&&(composedClasses.push(i),addEvent(i,"updatedData",h)),t};var t=(g.prototype.beforeSetTickPositions=function(){var o,n,t,i,e,s=this.axis,r=s.ordinal,a=s.getExtremes(),l=a.min,d=a.max,p=s.isXAxis&&!!s.options.breaks,c=s.options.ordinal,f=s.chart.options.chart.ignoreHiddenSeries,h=[],v=Number.MAX_VALUE,g=!1;if(c||p){if(s.series.forEach(function(t,i){if(n=[],(!f||!1!==t.visible)&&(!1!==t.takeOrdinalPosition||p)&&(h=h.concat(t.processedXData),o=h.length,h.sort(function(t,i){return t-i}),v=Math.min(v,pick(t.closestPointRange,v)),o)){for(i=0;i<o-1;)h[i]!==h[i+1]&&n.push(h[i+1]),i++;n[0]!==h[0]&&n.unshift(h[0]),h=n}}),2<(o=h.length)){for(t=h[1]-h[0],e=o-1;e--&&!g;)h[e+1]-h[e]!=t&&(g=!0);!s.options.keepOrdinalPadding&&(h[0]-l>t||d-h[h.length-1]>t)&&(g=!0)}else s.options.overscroll&&(2===o?v=h[1]-h[0]:1===o?(v=s.options.overscroll,h=[h[0],h[0]+v]):v=r.overscrollPointsRange);g||s.forceOrdinal?(s.options.overscroll&&(r.overscrollPointsRange=v,h=h.concat(r.getOverscrollPositions())),r.positions=h,i=s.ordinal2lin(Math.max(l,h[0]),!0),a=Math.max(s.ordinal2lin(Math.min(d,h[h.length-1]),!0),1),r.slope=a=(d-l)/(a-i),r.offset=l-i*a):(r.overscrollPointsRange=pick(s.closestPointRange,r.overscrollPointsRange),r.positions=s.ordinal.slope=r.offset=void 0)}s.isOrdinal=c&&g,r.groupIntervalFactor=null},g.findIndexOf=function(t,i,o){for(var n,e=0,s=t.length-1;e<s;)t[n=Math.ceil((e+s)/2)]<=i?e=n:s=n-1;return t[e]===i||o?e:-1},g.prototype.getExtendedPositions=function(){var i,o=this,t=o.axis,n=t.constructor.prototype,e=t.chart,s=t.series[0].currentDataGrouping,r=s?s.count+s.unitName:"raw",a=t.options.overscroll,l=t.getExtremes(),d=void 0,p=o.index;return(p=p||(o.index={}))[r]||((i={series:[],chart:e,forceOrdinal:!1,getExtremes:function(){return{min:l.dataMin,max:l.dataMax+a}},getGroupPixelWidth:n.getGroupPixelWidth,getTimeTicks:n.getTimeTicks,options:{ordinal:!0},ordinal:{getGroupIntervalFactor:this.getGroupIntervalFactor},ordinal2lin:n.ordinal2lin,getIndexOfPoint:n.getIndexOfPoint,val2lin:n.val2lin}).ordinal.axis=i,t.series.forEach(function(t){(d={xAxis:i,xData:t.xData.slice(),chart:e,destroyGroupedData:H.noop,getProcessedData:Series.prototype.getProcessedData,applyGrouping:Series.prototype.applyGrouping}).xData=d.xData.concat(o.getOverscrollPositions()),d.options={dataGrouping:s?{firstAnchor:"firstPoint",anchor:"middle",lastAnchor:"lastPoint",enabled:!0,forced:!0,approximation:"open",units:[[s.unitName,[s.count]]]}:{enabled:!1}},i.series.push(d),t.processData.apply(d)}),d.closestPointRange!==d.basePointRange&&d.currentDataGrouping&&(i.forceOrdinal=!0),t.ordinal.beforeSetTickPositions.apply({axis:i}),p[r]=i.ordinal.positions),p[r]},g.prototype.getGroupIntervalFactor=function(t,i,o){this.axis;var n,e=o.processedXData,s=e.length,r=[],a=this.groupIntervalFactor;if(!a){for(n=0;n<s-1;n++)r[n]=e[n+1]-e[n];r.sort(function(t,i){return t-i}),o=r[Math.floor(s/2)],t=Math.max(t,e[0]),i=Math.min(i,e[s-1]),this.groupIntervalFactor=a=s*o/(i-t)}return a},g.prototype.getIndexOfPoint=function(t,i){var o=this,n=o.axis,e=o.positions?o.positions[0]:0,s=n.series[0].points&&n.series[0].points[0]&&n.series[0].points[0].plotX||n.minPixelPadding;1<n.series.length&&n.series.forEach(function(t){t.points&&defined(t.points[0])&&defined(t.points[0].plotX)&&t.points[0].plotX<s&&(s=t.points[0].plotX)});o=n.translationSlope*(o.slope||n.closestPointRange||o.overscrollPointsRange),o=(t-s)/o;return g.findIndexOf(i,e)+o},g.prototype.getOverscrollPositions=function(){var t=this.axis,i=t.options.overscroll,o=this.overscrollPointsRange,n=[],e=t.dataMax;if(defined(o))for(;e<=t.dataMax+i;)n.push(e+=o);return n},g.prototype.postProcessTickInterval=function(t){var i=this.axis,o=this.slope,t=o?i.options.breaks?i.closestPointRange||t:t/(o/i.closestPointRange):t;return t},g);function g(t){this.index={},this.axis=t}n.Additions=t}(OrdinalAxis=OrdinalAxis||{});export default OrdinalAxis;