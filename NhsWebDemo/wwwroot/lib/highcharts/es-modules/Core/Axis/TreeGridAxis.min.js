"use strict";import BrokenAxis from"./BrokenAxis.js";import GridAxis from"./GridAxis.js";import Tree from"../../Gantt/Tree.js";import TreeGridTick from"./TreeGridTick.js";import TU from"../../Series/TreeUtilities.js";var getLevelOptions=TU.getLevelOptions;import U from"../Utilities.js";var TreeGridAxis,addEvent=U.addEvent,find=U.find,fireEvent=U.fireEvent,isArray=U.isArray,isObject=U.isObject,isString=U.isString,merge=U.merge,pick=U.pick,wrap=U.wrap;!function(e){var d;function o(e,t){var r=e.collapseEnd||0,e=e.collapseStart||0;return t<=r&&(e-=.5),{from:e,to:r,showPoints:!1}}function p(e,t,r){var n,a=[],i=[],d={},p="boolean"==typeof t&&t,l={},c=-1,t={after:function(e){var e=l[e.pos],t=0,r=0;e.children.forEach(function(e){r+=(e.descendants||0)+1,t=Math.max((e.height||0)+1,t)}),e.descendants=r,e.height=t,e.collapsed&&i.push(e)},before:function(e){var t,r,i=isObject(e.data,!0)?e.data:{},o=isString(i.name)?i.name:"",s=d[e.parent],s=isObject(s,!0)?l[s.pos]:null;p&&isObject(s,!0)&&(t=find(s.children,function(e){return e.name===o}))?(r=t.pos,t.nodes.push(e)):r=c++,l[r]||(l[r]=t={depth:s?s.depth+1:0,name:o,id:i.id,nodes:[e],children:[],pos:r},-1!==r&&a.push(o),isObject(s,!0)&&s.children.push(t)),isString(e.id)&&(d[e.id]=e),t&&!0===i.collapsed&&(t.collapsed=!0),e.pos=r}},t=Tree.getTree(e,t);function f(e,r,t){var i=e.nodes,o=r+(-1===r?0:n-1),s=(o-r)/2,a=r+s;return i.forEach(function(e){var t=e.data;isObject(t,!0)&&(t.y=r+(t.seriesIndex||0),delete t.seriesIndex),e.pos=a}),(t[a]=e).pos=a,e.tickmarkOffset=.5+s,e.collapseStart=o+.5,e.children.forEach(function(e){f(e,o+1,t),o=(e.collapseEnd||0)-.5}),e.collapseEnd=o+.5,t}return n=r,l=f(l[-1],-1,{}),{categories:a,mapOfIdToNode:d,mapOfPosToGridNode:l,collapsedNodes:i,tree:t}}function s(d){d.target.axes.filter(function(e){return"treegrid"===e.options.type}).forEach(function(e){var r,t=e.options||{},i=t.labels,o=t.uniqueNames,s=t.max,t=!e.treeGrid.mapOfPosToGridNode||e.series.some(function(e){return!e.hasRendered||e.isDirtyData||e.isDirty}),a=0;if(t){if(r=e.series.reduce(function(t,r){return r.visible&&((r.options.data||[]).forEach(function(e){r.options.keys&&r.options.keys.length&&(e=r.pointClass.prototype.optionsToObject.call({series:r},e),r.pointClass.setGanttPointAliases(e)),isObject(e,!0)&&(e.seriesIndex=a,t.push(e))}),!0===o&&a++),t},[]),s&&r.length<s)for(var n=r.length;n<=s;n++)r.push({name:n+"â€‹"});t=p(r,o||!1,!0===o?a:1),e.categories=t.categories,e.treeGrid.mapOfPosToGridNode=t.mapOfPosToGridNode,e.hasNames=!0,e.treeGrid.tree=t.tree,e.series.forEach(function(e){var t=(e.options.data||[]).map(function(t){return isArray(t)&&e.options.keys&&e.options.keys.length&&r.forEach(function(e){0<=t.indexOf(e.x)&&0<=t.indexOf(e.x2)&&(t=e)}),isObject(t,!0)?merge(t):t});e.visible&&e.setData(t,!1)}),e.treeGrid.mapOptionsToLevel=getLevelOptions({defaults:i,from:1,levels:i&&i.levels,to:e.treeGrid.tree&&e.treeGrid.tree.height}),"beforeRender"===d.type&&(e.treeGrid.collapsedNodes=t.collapsedNodes)}})}function a(e,t){var r,i=this,o=i.treeGrid.mapOptionsToLevel||{},s="treegrid"===i.options.type,a=i.ticks,n=a[t];s&&i.treeGrid.mapOfPosToGridNode?((o=o[(s=i.treeGrid.mapOfPosToGridNode[t]).depth])&&(r={labels:o}),!n&&d?a[t]=n=new d(i,t,void 0,void 0,{category:s.name,tickmarkOffset:s.tickmarkOffset,options:r}):(n.parameters.category=s.name,n.options=r,n.addLabel())):e.apply(i,Array.prototype.slice.call(arguments,1))}function n(e,t,r){var i=this,o="treegrid"===r.type;i.treeGrid||(i.treeGrid=new c(i)),o&&(addEvent(t,"beforeRender",s),addEvent(t,"beforeRedraw",s),addEvent(t,"addSeries",function(e){e.options.data&&(e=p(e.options.data,r.uniqueNames||!1,1),i.treeGrid.collapsedNodes=(i.treeGrid.collapsedNodes||[]).concat(e.collapsedNodes))}),addEvent(i,"foundExtremes",function(){i.treeGrid.collapsedNodes&&i.treeGrid.collapsedNodes.forEach(function(t){var e=i.treeGrid.collapse(t);i.brokenAxis&&(i.brokenAxis.setBreaks(e,!1),i.treeGrid.collapsedNodes&&(i.treeGrid.collapsedNodes=i.treeGrid.collapsedNodes.filter(function(e){return t.collapseStart!==e.collapseStart||t.collapseEnd!==e.collapseEnd})))})}),addEvent(i,"afterBreaks",function(){"yAxis"===i.coll&&!i.staticScale&&i.chart.options.chart.height&&(i.isDirty=!0)}),r=merge({grid:{enabled:!0},labels:{align:"left",levels:[{level:void 0},{level:1,style:{fontWeight:"bold"}}],symbol:{type:"triangle",x:-5,y:-5,height:10,width:10,padding:5}},uniqueNames:!1},r,{reversed:!0,grid:{columns:void 0}})),e.apply(i,[t,r]),o&&(i.hasNames=!0,i.options.showLastLabel=!0)}function l(e){var t=this,r=t.options;"treegrid"===r.type?(t.min=pick(t.userMin,r.min,t.dataMin),t.max=pick(t.userMax,r.max,t.dataMax),fireEvent(t,"foundExtremes"),t.setAxisTranslation(),t.tickmarkOffset=.5,t.tickInterval=1,t.tickPositions=t.treeGrid.mapOfPosToGridNode?t.treeGrid.getTickPositions():[]):e.apply(t,Array.prototype.slice.call(arguments,1))}e.compose=function(e,t,r,i){return-1===e.keepProps.indexOf("treeGrid")&&(e.keepProps.push("treeGrid"),d=i,wrap(e.prototype,"generateTick",a),wrap(e.prototype,"init",n),wrap(e.prototype,"setTickInterval",l),e.prototype.utils={getNode:Tree.getNode},GridAxis.compose(e,t,i),BrokenAxis.compose(e,r),TreeGridTick.compose(i)),e};var c=(t.prototype.setCollapsedStatus=function(i){var e=this.axis,o=e.chart;e.series.forEach(function(e){var t,r=e.options.data;i.id&&r&&(t=o.get(i.id),e=r[e.data.indexOf(t)],t&&e&&(t.collapsed=i.collapsed,e.collapsed=i.collapsed))})},t.prototype.collapse=function(e){var t=this.axis,r=t.options.breaks||[],i=o(e,t.max);return r.push(i),e.collapsed=!0,t.treeGrid.setCollapsedStatus(e),r},t.prototype.expand=function(e){var t=this.axis,r=t.options.breaks||[],i=o(e,t.max);return e.collapsed=!1,t.treeGrid.setCollapsedStatus(e),r.reduce(function(e,t){return t.to===i.to&&t.from===i.from||e.push(t),e},[])},t.prototype.getTickPositions=function(){var r=this.axis,i=Math.floor(r.min/r.tickInterval)*r.tickInterval,o=Math.ceil(r.max/r.tickInterval)*r.tickInterval;return Object.keys(r.treeGrid.mapOfPosToGridNode||{}).reduce(function(e,t){t=+t;return!(i<=t&&t<=o)||r.brokenAxis&&r.brokenAxis.isInAnyBreak(t)||e.push(t),e},[])},t.prototype.isCollapsed=function(e){var t=this.axis,r=t.options.breaks||[],i=o(e,t.max);return r.some(function(e){return e.from===i.from&&e.to===i.to})},t.prototype.toggleCollapse=function(e){return this.isCollapsed(e)?this.expand(e):this.collapse(e)},t);function t(e){this.axis=e}e.Additions=c}(TreeGridAxis=TreeGridAxis||{});export default TreeGridAxis;