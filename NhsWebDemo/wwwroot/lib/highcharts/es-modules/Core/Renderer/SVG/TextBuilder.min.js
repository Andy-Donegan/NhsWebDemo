"use strict";import AST from"../HTML/AST.js";import H from"../../Globals.js";var doc=H.doc,SVG_NS=H.SVG_NS,win=H.win;import U from"../../Utilities.js";var attr=U.attr,isString=U.isString,objectEach=U.objectEach,pick=U.pick,TextBuilder=function(){function t(t){var e=t.styles;this.renderer=t.renderer,this.svgElement=t,this.width=t.textWidth,this.textLineHeight=e&&e.lineHeight,this.textOutline=e&&e.textOutline,this.ellipsis=Boolean(e&&"ellipsis"===e.textOverflow),this.noWrap=Boolean(e&&"nowrap"===e.whiteSpace),this.fontSize=e&&e.fontSize}return t.prototype.buildSVG=function(){var t=this.svgElement,e=t.element,i=t.renderer,n=pick(t.textStr,"").toString(),r=-1!==n.indexOf("<"),o=e.childNodes,s=this.width&&!t.added&&i.box,i=[n,this.ellipsis,this.noWrap,this.textLineHeight,this.textOutline,this.fontSize,this.width].join(",");if(i!==t.textCache){t.textCache=i,delete t.actualWidth;for(var l=o.length;l--;)e.removeChild(o[l]);r||this.ellipsis||this.width||-1!==n.indexOf(" ")&&(!this.noWrap||/<br.*?>/g.test(n))?""!==n&&(s&&s.appendChild(e),r=new AST(n),this.modifyTree(r.nodes),r.addToDOM(t.element),this.modifyDOM(),this.ellipsis&&-1!==(e.textContent||"").indexOf("…")&&t.attr("title",this.unescapeEntities(t.textStr||"",["&lt;","&gt;"])),s&&s.removeChild(e)):e.appendChild(doc.createTextNode(this.unescapeEntities(n))),isString(this.textOutline)&&t.applyTextOutline&&t.applyTextOutline(this.textOutline)}},t.prototype.modifyDOM=function(){var t,c=this,d=this.svgElement,f=attr(d.element,"x");for(d.firstLineMetrics=void 0;(t=d.element.firstChild)&&/^[\s\u200B]*$/.test(t.textContent||" ");)d.element.removeChild(t);[].forEach.call(d.element.querySelectorAll("tspan.highcharts-br"),function(t,e){t.nextSibling&&t.previousSibling&&(0===e&&1===t.previousSibling.nodeType&&(d.firstLineMetrics=d.renderer.fontMetrics(void 0,t.previousSibling)),attr(t,{dy:c.getLineHeight(t.nextSibling),x:f}))});var i,n,p=this.width||0;p&&(i=function(e,i){var t=e.textContent||"",n=t.replace(/([^\^])-/g,"$1- ").split(" "),r=!c.noWrap&&(1<n.length||1<d.element.childNodes.length),o=c.getLineHeight(i),s=0,l=d.actualWidth;if(c.ellipsis)t&&c.truncate(e,t,void 0,0,Math.max(0,p-parseInt(c.fontSize||12,10)),function(t,e){return t.substring(0,e)+"…"});else if(r){for(var h=[],a=[];i.firstChild&&i.firstChild!==e;)a.push(i.firstChild),i.removeChild(i.firstChild);for(;n.length;)n.length&&!c.noWrap&&0<s&&(h.push(e.textContent||""),e.textContent=n.join(" ").replace(/- /g,"-")),c.truncate(e,void 0,n,0===s&&l||0,p,function(t,e){return n.slice(0,e).join(" ").replace(/- /g,"-")}),l=d.actualWidth,s++;a.forEach(function(t){i.insertBefore(t,e)}),h.forEach(function(t){i.insertBefore(doc.createTextNode(t),e);t=doc.createElementNS(SVG_NS,"tspan");t.textContent="​",attr(t,{dy:o,x:f}),i.insertBefore(t,e)})}},(n=function(e){[].slice.call(e.childNodes).forEach(function(t){t.nodeType===win.Node.TEXT_NODE?i(t,e):(-1!==t.className.baseVal.indexOf("highcharts-br")&&(d.actualWidth=0),n(t))})})(d.element))},t.prototype.getLineHeight=function(t){var e,t=t.nodeType===win.Node.TEXT_NODE?t.parentElement:t;return this.renderer.styledMode||(e=t&&/(px|em)$/.test(t.style.fontSize)?t.style.fontSize:this.fontSize||this.renderer.style.fontSize||12),this.textLineHeight?parseInt(this.textLineHeight.toString(),10):this.renderer.fontMetrics(e,t||this.svgElement.element).h},t.prototype.modifyTree=function(s){function l(t,e){var i=void 0===(o=t.attributes)?{}:o,n=t.children,r=t.tagName,o=h.renderer.styledMode;"b"===r||"strong"===r?o?i.class="highcharts-strong":i.style="font-weight:bold;"+(i.style||""):"i"!==r&&"em"!==r||(o?i.class="highcharts-emphasized":i.style="font-style:italic;"+(i.style||"")),isString(i.style)&&(i.style=i.style.replace(/(;| |^)color([ :])/,"$1fill$2")),"br"===r?(i.class="highcharts-br",t.textContent="​",(e=s[e+1])&&e.textContent&&(e.textContent=e.textContent.replace(/^ +/gm,""))):"a"===r&&n&&n.some(function(t){return"#text"===t.tagName})&&(t.children=[{children:n,tagName:"tspan"}]),"#text"!==r&&"a"!==r&&(t.tagName="tspan"),t.attributes=i,n&&n.filter(function(t){return"#text"!==t.tagName}).forEach(l)}var h=this;s.forEach(l)},t.prototype.truncate=function(n,r,o,s,t,l){function e(t,e){var i=e||t;if((e=n.parentNode)&&void 0===f[i])if(e.getSubStringLength)try{f[i]=s+e.getSubStringLength(0,o?i+1:i)}catch(t){}else c.getSpanWidth&&(n.textContent=l(r||o,t),f[i]=s+c.getSpanWidth(a,n));return f[i]}var i,h,a=this.svgElement,c=a.renderer,d=a.rotation,f=[],p=o?1:0,g=(r||o||"").length,u=g;if(a.rotation=0,h=e(n.textContent.length),t<s+h){for(;p<=g;)h=e(u=Math.ceil((p+g)/2),(i=o?l(o,u):i)&&i.length-1),p===g?p=g+1:t<h?g=u-1:p=u;0===g?n.textContent="":r&&g===r.length-1||(n.textContent=i||l(r||o,u))}o&&o.splice(0,u),a.actualWidth=h,a.rotation=d},t.prototype.unescapeEntities=function(i,n){return objectEach(this.renderer.escapes,function(t,e){n&&-1!==n.indexOf(t)||(i=i.toString().replace(new RegExp(t,"g"),e))}),i},t}();export default TextBuilder;