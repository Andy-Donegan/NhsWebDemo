"use strict";var __extends=this&&this.__extends||function(){var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};return function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}();import A from"../../Animation/AnimationUtilities.js";var animObject=A.animObject;import Color from"../../Color/Color.js";var color=Color.parse;import H from"../../Globals.js";var charts=H.charts,deg2rad=H.deg2rad;import Math3D from"../../../Extensions/Math3D.js";var perspective=Math3D.perspective,shapeArea=Math3D.shapeArea;import SVGElement from"./SVGElement.js";import SVGElement3D from"./SVGElement3D.js";import SVGRenderer from"./SVGRenderer.js";import U from"../../Utilities.js";var defined=U.defined,extend=U.extend,merge=U.merge,pick=U.pick,cos=Math.cos,sin=Math.sin,PI=Math.PI,dFactor=4*(Math.sqrt(2)-1)/3/(PI/2),SVGRenderer3D=function(t){function b(){return null!==t&&t.apply(this,arguments)||this}return __extends(b,t),b.compose=function(t){var e=t.prototype,t=b.prototype;e.elements3d=SVGElement3D,e.arc3d=t.arc3d,e.arc3dPath=t.arc3dPath,e.cuboid=t.cuboid,e.cuboidPath=t.cuboidPath,e.element3d=t.element3d,e.face3d=t.face3d,e.polyhedron=t.polyhedron,e.toLinePath=t.toLinePath,e.toLineSegments=t.toLineSegments},b.curveTo=function(t,e,n,r,a,i,o,s){var h=[],c=i-a;return a<i&&i-a>Math.PI/2+1e-4?h=(h=h.concat(this.curveTo(t,e,n,r,a,a+Math.PI/2,o,s))).concat(this.curveTo(t,e,n,r,a+Math.PI/2,i,o,s)):i<a&&a-i>Math.PI/2+1e-4?h=(h=h.concat(this.curveTo(t,e,n,r,a,a-Math.PI/2,o,s))).concat(this.curveTo(t,e,n,r,a-Math.PI/2,i,o,s)):[["C",t+n*Math.cos(a)-n*dFactor*c*Math.sin(a)+o,e+r*Math.sin(a)+r*dFactor*c*Math.cos(a)+s,t+n*Math.cos(i)+n*dFactor*c*Math.sin(i)+o,e+r*Math.sin(i)-r*dFactor*c*Math.cos(i)+s,t+n*Math.cos(i)+o,e+r*Math.sin(i)+s]]},b.prototype.toLinePath=function(t,e){var n=[];return t.forEach(function(t){n.push(["L",t.x,t.y])}),t.length&&(n[0][0]="M",e&&n.push(["Z"])),n},b.prototype.toLineSegments=function(t){var e=[],n=!0;return t.forEach(function(t){e.push(n?["M",t.x,t.y]:["L",t.x,t.y]),n=!n}),e},b.prototype.face3d=function(t){var r=this,e=this.createElement("path");return e.vertexes=[],e.insidePlotArea=!1,e.enabled=!0,e.attr=function(t){var e,n;return"object"==typeof t&&(defined(t.enabled)||defined(t.vertexes)||defined(t.insidePlotArea))&&(this.enabled=pick(t.enabled,this.enabled),this.vertexes=pick(t.vertexes,this.vertexes),this.insidePlotArea=pick(t.insidePlotArea,this.insidePlotArea),delete t.enabled,delete t.vertexes,delete t.insidePlotArea,e=charts[r.chartIndex],n=perspective(this.vertexes,e,this.insidePlotArea),e=r.toLinePath(n,!0),n=shapeArea(n),t.d=e,t.visibility=this.enabled&&0<n?"visible":"hidden"),SVGElement.prototype.attr.apply(this,arguments)},e.animate=function(t){var e,n;return"object"==typeof t&&(defined(t.enabled)||defined(t.vertexes)||defined(t.insidePlotArea))&&(this.enabled=pick(t.enabled,this.enabled),this.vertexes=pick(t.vertexes,this.vertexes),this.insidePlotArea=pick(t.insidePlotArea,this.insidePlotArea),delete t.enabled,delete t.vertexes,delete t.insidePlotArea,e=charts[r.chartIndex],n=perspective(this.vertexes,e,this.insidePlotArea),e=r.toLinePath(n,!0),n=shapeArea(n),n=this.enabled&&0<n?"visible":"hidden",t.d=e,this.attr("visibility",n)),SVGElement.prototype.animate.apply(this,arguments)},e.attr(t)},b.prototype.polyhedron=function(t){var i=this,o=this.g(),e=o.destroy;return this.styledMode||o.attr({"stroke-linejoin":"round"}),o.faces=[],o.destroy=function(){for(var t=0;t<o.faces.length;t++)o.faces[t].destroy();return e.call(this)},o.attr=function(t,e,n,r){if("object"==typeof t&&defined(t.faces)){for(;o.faces.length>t.faces.length;)o.faces.pop().destroy();for(;o.faces.length<t.faces.length;)o.faces.push(i.face3d().add(o));for(var a=0;a<t.faces.length;a++)i.styledMode&&delete t.faces[a].fill,o.faces[a].attr(t.faces[a],null,n,r);delete t.faces}return SVGElement.prototype.attr.apply(this,arguments)},o.animate=function(t,e,n){if(t&&t.faces){for(;o.faces.length>t.faces.length;)o.faces.pop().destroy();for(;o.faces.length<t.faces.length;)o.faces.push(i.face3d().add(o));for(var r=0;r<t.faces.length;r++)o.faces[r].animate(t.faces[r],e,n);delete t.faces}return SVGElement.prototype.animate.apply(this,arguments)},o.attr(t)},b.prototype.element3d=function(t,e){var n=this.g();return extend(n,this.elements3d[t]),n.initArgs(e),n},b.prototype.cuboid=function(t){return this.element3d("cuboid",t)},b.prototype.cuboidPath=function(t){var e,n,r,a,i=t.x||0,o=t.y||0,s=t.z||0,h=t.height||0,c=t.width||0,d=t.depth||0,p=charts[this.chartIndex],l=p.options.chart.options3d.alpha,u=0,f=[{x:i,y:o,z:s},{x:i+c,y:o,z:s},{x:i+c,y:o+h,z:s},{x:i,y:o+h,z:s},{x:i,y:o+h,z:s+d},{x:i+c,y:o+h,z:s+d},{x:i+c,y:o,z:s+d},{x:i,y:o,z:s+d}],y=[];function v(t){return 0===h&&1<t&&t<6?{x:f[t].x,y:f[t].y+10,z:f[t].z}:f[0].x===f[7].x&&4<=t?{x:f[t].x+10,y:f[t].y,z:f[t].z}:0===d&&t<2||5<t?{x:f[t].x,y:f[t].y,z:f[t].z+10}:f[t]}function m(t){return f[t]}return f=perspective(f,p,t.insidePlotArea),e=(r=(a=function(t,e,n){var r=[[],-1],a=t.map(m),i=e.map(m),t=t.map(v),e=e.map(v);return shapeArea(a)<0?r=[a,0]:shapeArea(i)<0?r=[i,1]:n&&(y.push(n),r=!(shapeArea(t)<0)&&shapeArea(e)<0?[i,1]:[a,0]),r})([3,2,1,0],[7,6,5,4],"front"))[0],n=r[1],c=(r=a([1,6,7,0],[4,5,2,3],"top"))[0],t=r[1],a=(r=a([1,2,5,6],[0,7,4,3],"side"))[0],1===(r=r[1])?u+=1e6*(p.plotWidth-i):r||(u+=1e6*i),u+=10*(!t||0<=l&&l<=180||l<360&&357.5<l?p.plotHeight-o:10+o),1===n?u+=100*s:n||(u+=100*(1e3-s)),{front:this.toLinePath(e,!0),top:this.toLinePath(c,!0),side:this.toLinePath(a,!0),zIndexes:{group:Math.round(u)},forcedSides:y,isFront:n,isTop:t}},b.prototype.arc3d=function(t){var h=this.g(),e=h.renderer,a=["x","y","r","innerR","start","end","depth"];function c(t){var e,n=!1,r={};for(e in t=merge(t))-1!==a.indexOf(e)&&(r[e]=t[e],delete t[e],n=!0);return!!n&&[r,t]}return(t=merge(t)).alpha=(t.alpha||0)*deg2rad,t.beta=(t.beta||0)*deg2rad,h.top=e.path(),h.side1=e.path(),h.side2=e.path(),h.inn=e.path(),h.out=e.path(),h.onAdd=function(){var e=h.parentGroup,n=h.attr("class");h.top.add(h),["out","inn","side1","side2"].forEach(function(t){h[t].attr({class:n+" highcharts-3d-side"}).add(e)})},["addClass","removeClass"].forEach(function(n){h[n]=function(){var e=arguments;["top","out","inn","side1","side2"].forEach(function(t){h[t][n].apply(h[t],e)})}}),h.setPaths=function(t){var e=h.renderer.arc3dPath(t),n=100*e.zTop;h.attribs=t,h.top.attr({d:e.top,zIndex:e.zTop}),h.inn.attr({d:e.inn,zIndex:e.zInn}),h.out.attr({d:e.out,zIndex:e.zOut}),h.side1.attr({d:e.side1,zIndex:e.zSide1}),h.side2.attr({d:e.side2,zIndex:e.zSide2}),h.zIndex=n,h.attr({zIndex:n}),t.center&&(h.top.setRadialReference(t.center),delete t.center)},h.setPaths(t),h.fillSetter=function(t){var e=color(t).brighten(-.1).get();return this.fill=t,this.side1.attr({fill:e}),this.side2.attr({fill:e}),this.inn.attr({fill:e}),this.out.attr({fill:e}),this.top.attr({fill:t}),this},["opacity","translateX","translateY","visibility"].forEach(function(t){h[t+"Setter"]=function(e,n){h[n]=e,["out","inn","side1","side2","top"].forEach(function(t){h[t].attr(n,e)})}}),h.attr=function(t){var e;return"object"==typeof t&&(e=c(t))&&(t=e[0],arguments[0]=e[1],extend(h.attribs,t),h.setPaths(h.attribs)),SVGElement.prototype.attr.apply(h,arguments)},h.animate=function(t,e,n){var r,a,i,o=this.attribs,s="data-"+Math.random().toString(26).substring(2,9);return delete t.center,delete t.z,delete t.alpha,delete t.beta,(i=animObject(pick(e,this.renderer.globalAnimation))).duration&&(r=c(t),h[s]=0,t[s]=1,h[s+"Setter"]=H.noop,r&&(a=r[0],i.step=function(t,e){function n(t){return o[t]+(pick(a[t],o[t])-o[t])*e.pos}e.prop===s&&e.elem.setPaths(merge(o,{x:n("x"),y:n("y"),r:n("r"),innerR:n("innerR"),start:n("start"),end:n("end"),depth:n("depth")}))}),e=i),SVGElement.prototype.animate.call(this,t,e,n)},h.destroy=function(){return this.top.destroy(),this.out.destroy(),this.inn.destroy(),this.side1.destroy(),this.side2.destroy(),SVGElement.prototype.destroy.call(this)},h.hide=function(){this.top.hide(),this.out.hide(),this.inn.hide(),this.side1.hide(),this.side2.hide()},h.show=function(t){this.top.show(t),this.out.show(t),this.inn.show(t),this.side1.show(t),this.side2.show(t)},h},b.prototype.arc3dPath=function(t){var e=t.x||0,n=t.y||0,r=t.start||0,a=(t.end||0)-1e-5,i=t.r||0,o=t.innerR||0,s=t.depth||0,h=t.alpha||0,c=t.beta||0,d=Math.cos(r),p=Math.sin(r),l=Math.cos(a),u=Math.sin(a),f=i*Math.cos(c),y=i*Math.cos(h),v=o*Math.cos(c),m=o*Math.cos(h),M=s*Math.sin(c),x=s*Math.sin(h),t=[["M",e+f*d,n+y*p]];(t=t.concat(b.curveTo(e,n,f,y,r,a,0,0))).push(["L",e+v*l,n+m*u]),(t=t.concat(b.curveTo(e,n,v,m,a,r,0,0))).push(["Z"]);i=0<c?Math.PI/2:0,o=0<h?0:Math.PI/2,s=!(-i<r)&&-i<a?-i:r,c=!(a<PI-o)&&r<PI-o?PI-o:a,h=2*PI-o,i=(i=[["M",e+f*cos(s),n+y*sin(s)]]).concat(b.curveTo(e,n,f,y,s,c,0,0));h<a&&r<h?(i.push(["L",e+f*cos(c)+M,n+y*sin(c)+x]),(i=i.concat(b.curveTo(e,n,f,y,c,h,M,x))).push(["L",e+f*cos(h),n+y*sin(h)]),(i=i.concat(b.curveTo(e,n,f,y,h,a,0,0))).push(["L",e+f*cos(a)+M,n+y*sin(a)+x]),(i=i.concat(b.curveTo(e,n,f,y,a,h,M,x))).push(["L",e+f*cos(h),n+y*sin(h)]),i=i.concat(b.curveTo(e,n,f,y,h,c,0,0))):PI-o<a&&r<PI-o&&(i.push(["L",e+f*Math.cos(c)+M,n+y*Math.sin(c)+x]),(i=i.concat(b.curveTo(e,n,f,y,c,a,M,x))).push(["L",e+f*Math.cos(a),n+y*Math.sin(a)]),i=i.concat(b.curveTo(e,n,f,y,a,c,0,0))),i.push(["L",e+f*Math.cos(c)+M,n+y*Math.sin(c)+x]),(i=i.concat(b.curveTo(e,n,f,y,c,s,M,x))).push(["Z"]);s=[["M",e+v*d,n+m*p]];(s=s.concat(b.curveTo(e,n,v,m,r,a,0,0))).push(["L",e+v*Math.cos(a)+M,n+m*Math.sin(a)+x]),(s=s.concat(b.curveTo(e,n,v,m,a,r,M,x))).push(["Z"]);p=[["M",e+f*d,n+y*p],["L",e+f*d+M,n+y*p+x],["L",e+v*d+M,n+m*p+x],["L",e+v*d,n+m*p],["Z"]],m=[["M",e+f*l,n+y*u],["L",e+f*l+M,n+y*u+x],["L",e+v*l+M,n+m*u+x],["L",e+v*l,n+m*u],["Z"]],u=Math.atan2(x,-M),x=Math.abs(a+u),M=Math.abs(r+u),u=Math.abs((r+a)/2+u);function P(t){return t=(t%=2*Math.PI)>Math.PI?2*Math.PI-t:t}x=P(x),M=P(M),u=1e5*(u=P(u)),M*=1e5,x*=1e5;return{top:t,zTop:1e5*Math.PI+1,out:i,zOut:Math.max(u,M,x),inn:s,zInn:Math.max(u,M,x),side1:p,zSide1:.99*x,side2:m,zSide2:.99*M}},b}(SVGRenderer);export default SVGRenderer3D;