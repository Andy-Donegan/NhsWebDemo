"use strict";import A from"../../Animation/AnimationUtilities.js";var animate=A.animate,animObject=A.animObject,stop=A.stop;import AST from"../HTML/AST.js";import Color from"../../Color/Color.js";import H from"../../Globals.js";var deg2rad=H.deg2rad,doc=H.doc,noop=H.noop,svg=H.svg,SVG_NS=H.SVG_NS,win=H.win;import U from"../../Utilities.js";var addEvent=U.addEvent,attr=U.attr,createElement=U.createElement,css=U.css,defined=U.defined,erase=U.erase,extend=U.extend,fireEvent=U.fireEvent,isArray=U.isArray,isFunction=U.isFunction,isNumber=U.isNumber,isString=U.isString,merge=U.merge,objectEach=U.objectEach,pick=U.pick,pInt=U.pInt,syncTimeout=U.syncTimeout,uniqueKey=U.uniqueKey,SVGElement=function(){function f(){this.element=void 0,this.onEvents={},this.opacity=1,this.renderer=void 0,this.SVG_NS=SVG_NS,this.symbolCustomAttribs=["x","y","width","height","r","start","end","innerR","anchorX","anchorY","rounded"]}return f.prototype._defaultGetter=function(t){t=pick(this[t+"Value"],this[t],this.element?this.element.getAttribute(t):null,0);return t=/^[\-0-9\.]+$/.test(t)?parseFloat(t):t},f.prototype._defaultSetter=function(t,e,i){i.setAttribute(e,t)},f.prototype.add=function(t){var e,i=this.renderer,r=this.element;return t&&(this.parentGroup=t),this.parentInverted=t&&t.inverted,void 0!==this.textStr&&"text"===this.element.nodeName&&i.buildText(this),this.added=!0,(e=!t||t.handleZ||this.zIndex?this.zIndexSetter():e)||(t?t.element:i.box).appendChild(r),this.onAdd&&this.onAdd(),this},f.prototype.addClass=function(t,e){var i=!e&&this.attr("class")||"";return(t=(t||"").split(/ /g).reduce(function(t,e){return-1===i.indexOf(e)&&t.push(e),t},i?[i]:[]).join(" "))!==i&&this.attr("class",t),this},f.prototype.afterSetters=function(){this.doTransform&&(this.updateTransform(),this.doTransform=!1)},f.prototype.align=function(t,e,i){var r,o,n={},s=this.renderer,a=s.alignedObjects;t?(this.alignOptions=t,this.alignByTranslate=e,i&&!isString(i)||(this.alignTo=d=i||"renderer",erase(a,this),a.push(this),i=void 0)):(t=this.alignOptions,e=this.alignByTranslate,d=this.alignTo),i=pick(i,s[d],"scrollablePlotBox"===d?s.plotBox:void 0,s);var h=t.align,a=t.verticalAlign,d=(i.x||0)+(t.x||0),s=(i.y||0)+(t.y||0);return"right"===h?r=1:"center"===h&&(r=2),r&&(d+=(i.width-(t.width||0))/r),n[e?"translateX":"x"]=Math.round(d),"bottom"===a?o=1:"middle"===a&&(o=2),o&&(s+=(i.height-(t.height||0))/o),n[e?"translateY":"y"]=Math.round(s),this[this.placed?"animate":"attr"](n),this.placed=!0,this.alignAttr=n,this},f.prototype.alignSetter=function(t){var e={left:"start",center:"middle",right:"end"};e[t]&&(this.alignValue=t,this.element.setAttribute("text-anchor",e[t]))},f.prototype.animate=function(t,e,i){var r=this,o=animObject(pick(e,this.renderer.globalAnimation,!0)),e=o.defer;return pick(doc.hidden,doc.msHidden,doc.webkitHidden,!1)&&(o.duration=0),0!==o.duration?(i&&(o.complete=i),syncTimeout(function(){r.element&&animate(r,t,o)},e)):(this.attr(t,void 0,i),objectEach(t,function(t,e){o.step&&o.step.call(this,t,{prop:e,pos:1,elem:this})},this)),this},f.prototype.applyTextOutline=function(t){var i,r,o=this.element,e=(t=-1!==t.indexOf("contrast")?t.replace(/contrast/g,this.renderer.getContrast(o.style.fill)):t).split(" "),t=e[e.length-1],e=e[0];e&&"none"!==e&&H.svg&&(this.fakeTS=!0,this.ySetter=this.xSetter,e=e.replace(/(^[\d\.]+)(.*?)$/g,function(t,e,i){return 2*Number(e)+i}),this.removeTextOutline(),i=doc.createElementNS(SVG_NS,"tspan"),attr(i,{class:"highcharts-text-outline",fill:t,stroke:t,"stroke-width":e,"stroke-linejoin":"round"}),[].forEach.call(o.childNodes,function(t){var e=t.cloneNode(!0);e.removeAttribute&&["fill","stroke","stroke-width","stroke"].forEach(function(t){return e.removeAttribute(t)}),i.appendChild(e)}),(r=doc.createElementNS(SVG_NS,"tspan")).textContent="â€‹",["x","y"].forEach(function(t){var e=o.getAttribute(t);e&&r.setAttribute(t,e)}),i.appendChild(r),o.insertBefore(i,o.firstChild))},f.prototype.attr=function(i,t,e,r){var o,n,s,a=this.element,h=this.symbolCustomAttribs,d=this;return"string"==typeof i&&void 0!==t&&(o=i,(i={})[o]=t),"string"==typeof i?d=(this[i+"Getter"]||this._defaultGetter).call(this,i,a):(objectEach(i,function(t,e){s=!1,r||stop(this,e),this.symbolName&&-1!==h.indexOf(e)&&(n||(this.symbolAttr(i),n=!0),s=!0),!this.rotation||"x"!==e&&"y"!==e||(this.doTransform=!0),s||((s=this[e+"Setter"]||this._defaultSetter).call(this,t,e,a),!this.styledMode&&this.shadows&&/^(width|height|visibility|x|y|d|transform|cx|cy|r)$/.test(e)&&this.updateShadows(e,t,s))},this),this.afterSetters()),e&&e.call(this),d},f.prototype.clip=function(t){return this.attr("clip-path",t?"url("+this.renderer.url+"#"+t.id+")":"none")},f.prototype.crisp=function(t,e){e=e||t.strokeWidth||0;var i=Math.round(e)%2/2;return t.x=Math.floor(t.x||this.x||0)+i,t.y=Math.floor(t.y||this.y||0)+i,t.width=Math.floor((t.width||this.width||0)-2*i),t.height=Math.floor((t.height||this.height||0)-2*i),defined(t.strokeWidth)&&(t.strokeWidth=e),t},f.prototype.complexColor=function(t,i,r){var o,n,s,a,h,d,l,p,c,u,f=this.renderer,m=[];fireEvent(this.renderer,"complexColor",{args:arguments},function(){var e;t.radialGradient?o="radialGradient":t.linearGradient&&(o="linearGradient"),o&&(n=t[o],a=f.gradients,h=t.stops,p=r.radialReference,isArray(n)&&(t[o]=n={x1:n[0],y1:n[1],x2:n[2],y2:n[3],gradientUnits:"userSpaceOnUse"}),"radialGradient"===o&&p&&!defined(n.gradientUnits)&&(n=merge(s=n,f.getRadialAttr(p,s),{gradientUnits:"userSpaceOnUse"})),objectEach(n,function(t,e){"id"!==e&&m.push(e,t)}),objectEach(h,function(t){m.push(t)}),m=m.join(","),a[m]?c=a[m].attr("id"):(n.id=c=uniqueKey(),(e=a[m]=f.createElement(o).attr(n).add(f.defs)).radAttr=s,e.stops=[],h.forEach(function(t){l=0===t[1].indexOf("rgba")?(l=Color.parse(t[1]),d=l.get("rgb"),l.get("a")):(d=t[1],1);t=f.createElement("stop").attr({offset:t[0],"stop-color":d,"stop-opacity":l}).add(e);e.stops.push(t)})),u="url("+f.url+"#"+c+")",r.setAttribute(i,u),r.gradient=m,t.toString=function(){return u})})},f.prototype.css=function(t){var e,i,r=this.styles,o={},n=this.element,s=["textOutline","textOverflow","width"],a="",h=!r;return t&&t.color&&(t.fill=t.color),r&&objectEach(t,function(t,e){r&&r[e]!==t&&(o[e]=t,h=!0)}),h&&((t=r?extend(r,o):t)&&(null===t.width||"auto"===t.width?delete this.textWidth:"text"===n.nodeName.toLowerCase()&&t.width&&(e=this.textWidth=pInt(t.width))),this.styles=t,e&&!svg&&this.renderer.forExport&&delete t.width,n.namespaceURI===this.SVG_NS?(i=function(t,e){return"-"+e.toLowerCase()},objectEach(t,function(t,e){-1===s.indexOf(e)&&(a+=e.replace(/([A-Z])/g,i)+":"+t+";")}),a&&attr(n,"style",a)):css(n,t),this.added&&("text"===this.element.nodeName&&this.renderer.buildText(this),t&&t.textOutline&&this.applyTextOutline(t.textOutline))),this},f.prototype.dashstyleSetter=function(t){var e=this["stroke-width"];if("inherit"===e&&(e=1),t=t&&t.toLowerCase()){for(var i=t.replace("shortdashdotdot","3,1,1,1,1,1,").replace("shortdashdot","3,1,1,1").replace("shortdot","1,1,").replace("shortdash","3,1,").replace("longdash","8,3,").replace(/dot/g,"1,3,").replace("dash","4,3,").replace(/,$/,"").split(","),r=i.length;r--;)i[r]=""+pInt(i[r])*pick(e,NaN);t=i.join(",").replace(/NaN/g,"none"),this.element.setAttribute("stroke-dasharray",t)}},f.prototype.destroy=function(){var t,e,i,r=this,o=r.element||{},n=r.renderer,s=o.ownerSVGElement,a=n.isSVG&&"SPAN"===o.nodeName&&r.parentGroup||void 0;if(o.onclick=o.onmouseout=o.onmouseover=o.onmousemove=o.point=null,stop(r),r.clipPath&&s&&(i=r.clipPath,[].forEach.call(s.querySelectorAll("[clip-path],[CLIP-PATH]"),function(t){-1<t.getAttribute("clip-path").indexOf(i.element.id)&&t.removeAttribute("clip-path")}),r.clipPath=i.destroy()),r.stops){for(e=0;e<r.stops.length;e++)r.stops[e].destroy();r.stops.length=0,r.stops=void 0}for(r.safeRemoveChild(o),n.styledMode||r.destroyShadows();a&&a.div&&0===a.div.childNodes.length;)t=a.parentGroup,r.safeRemoveChild(a.div),delete a.div,a=t;r.alignTo&&erase(n.alignedObjects,r),objectEach(r,function(t,e){r[e]&&r[e].parentGroup===r&&r[e].destroy&&r[e].destroy(),delete r[e]})},f.prototype.destroyShadows=function(){(this.shadows||[]).forEach(function(t){this.safeRemoveChild(t)},this),this.shadows=void 0},f.prototype.destroyTextPath=function(t,e){var i,r=t.getElementsByTagName("text")[0];if(r){if(r.removeAttribute("dx"),r.removeAttribute("dy"),e.element.setAttribute("id",""),this.textPathWrapper&&r.getElementsByTagName("textPath").length){for(i=this.textPathWrapper.element.childNodes;i.length;)r.appendChild(i[0]);r.removeChild(this.textPathWrapper.element)}}else(t.getAttribute("dx")||t.getAttribute("dy"))&&(t.removeAttribute("dx"),t.removeAttribute("dy"));this.textPathWrapper&&(this.textPathWrapper=this.textPathWrapper.destroy())},f.prototype.dSetter=function(t,e,i){isArray(t)&&("string"==typeof t[0]&&(t=this.renderer.pathToSegments(t)),t=(this.pathArray=t).reduce(function(t,e,i){return e&&e.join?(i?t+" ":"")+e.join(" "):(e||"").toString()},"")),/(NaN| {2}|^$)/.test(t)&&(t="M 0 0"),this[e]!==t&&(i.setAttribute(e,t),this[e]=t)},f.prototype.fadeOut=function(t){var e=this;e.animate({opacity:0},{duration:pick(t,150),complete:function(){e.attr({y:-9999}).hide()}})},f.prototype.fillSetter=function(t,e,i){"string"==typeof t?i.setAttribute(e,t):t&&this.complexColor(t,e,i)},f.prototype.getBBox=function(t,e){var i,r,o,n=this,s=n.renderer,a=n.element,h=n.styles,d=n.textStr,l=s.cache,p=s.cacheKeys,c=a.namespaceURI===n.SVG_NS,u=pick(e,n.rotation,0),e=s.styledMode?a&&f.prototype.getStyle.call(a,"font-size"):h&&h.fontSize;if(defined(d)&&(-1===(o=d.toString()).indexOf("<")&&(o=o.replace(/[0-9]/g,"0")),o+=["",u,e,n.textWidth,h&&h.textOverflow,h&&h.fontWeight].join(",")),!(i=o&&!t?l[o]:i)){if(c||s.forExport){try{r=this.fakeTS&&function(t){var e=a.querySelector(".highcharts-text-outline");e&&css(e,{display:t})},isFunction(r)&&r("none"),i=a.getBBox?extend({},a.getBBox()):{width:a.offsetWidth,height:a.offsetHeight},isFunction(r)&&r("")}catch(t){}(!i||i.width<0)&&(i={width:0,height:0})}else i=n.htmlGetBBox();if(s.isSVG&&(n=i.width,s=i.height,c&&(i.height=s={"11px,17":14,"13px,20":16}[(e||"")+","+Math.round(s)]||s),u&&(u=u*deg2rad,i.width=Math.abs(s*Math.sin(u))+Math.abs(n*Math.cos(u)),i.height=Math.abs(s*Math.cos(u))+Math.abs(n*Math.sin(u)))),o&&(""===d||0<i.height)){for(;250<p.length;)delete l[p.shift()];l[o]||p.push(o),l[o]=i}}return i},f.prototype.getStyle=function(t){return win.getComputedStyle(this.element||this,"").getPropertyValue(t)},f.prototype.hasClass=function(t){return-1!==(""+this.attr("class")).split(" ").indexOf(t)},f.prototype.hide=function(t){return t?this.attr({y:-9999}):this.attr({visibility:"hidden"}),this},f.prototype.htmlGetBBox=function(){return{height:0,width:0,x:0,y:0}},f.prototype.init=function(t,e){this.element="span"===e?createElement(e):doc.createElementNS(this.SVG_NS,e),this.renderer=t,fireEvent(this,"afterInit")},f.prototype.invert=function(t){return this.inverted=t,this.updateTransform(),this},f.prototype.on=function(t,e){var i=this.onEvents;return i[t]&&i[t](),i[t]=addEvent(this.element,t,e),this},f.prototype.opacitySetter=function(t,e,i){t=Number(Number(t).toFixed(3));this.opacity=t,i.setAttribute(e,t)},f.prototype.removeClass=function(t){return this.attr("class",(""+this.attr("class")).replace(isString(t)?new RegExp("(^| )"+t+"( |$)"):t," ").replace(/ +/g," ").trim())},f.prototype.removeTextOutline=function(){var t=this.element.querySelector("tspan.highcharts-text-outline");t&&this.safeRemoveChild(t)},f.prototype.safeRemoveChild=function(t){var e=t.parentNode;e&&e.removeChild(t)},f.prototype.setRadialReference=function(t){var e=this.element.gradient&&this.renderer.gradients[this.element.gradient];return this.element.radialReference=t,e&&e.radAttr&&e.animate(this.renderer.getRadialAttr(t,e.radAttr)),this},f.prototype.setTextPath=function(t,e){var i,r=this.element,o=this.text?this.text.element:r,n={textAnchor:"text-anchor"},s=!1,a=this.textPathWrapper,h=!a;e=merge(!0,{enabled:!0,attributes:{dy:-5,startOffset:"50%",textAnchor:"middle"}},e);var d=AST.filterUserAttributes(e.attributes);if(t&&e&&e.enabled){if(a&&null===a.element.parentNode?(h=!0,a=a.destroy()):a&&this.removeTextOutline.call(a.parentGroup),this.options&&this.options.padding&&(d.dx=-this.options.padding),a||(this.textPathWrapper=a=this.renderer.createElement("textPath"),s=!0),i=a.element,(e=t.element.getAttribute("id"))||t.element.setAttribute("id",e=uniqueKey()),h){o.setAttribute("y",0),isNumber(d.dx)&&o.setAttribute("x",-d.dx);for(var l=[].slice.call(o.childNodes),p=0;p<l.length;p++){var c=l[p];c.nodeType!==win.Node.TEXT_NODE&&"tspan"!==c.nodeName||i.appendChild(c)}}s&&a&&a.add({element:o}),i.setAttributeNS("http://www.w3.org/1999/xlink","href",this.renderer.url+"#"+e),defined(d.dy)&&(i.parentNode.setAttribute("dy",d.dy),delete d.dy),defined(d.dx)&&(i.parentNode.setAttribute("dx",d.dx),delete d.dx),objectEach(d,function(t,e){i.setAttribute(n[e]||e,t)}),r.removeAttribute("transform"),this.removeTextOutline.call(a),this.text&&!this.renderer.styledMode&&this.attr({fill:"none","stroke-width":0}),this.updateTransform=noop,this.applyTextOutline=noop}else a&&(delete this.updateTransform,delete this.applyTextOutline,this.destroyTextPath(r,t),this.updateTransform(),this.options&&this.options.rotation&&this.applyTextOutline(this.options.style.textOutline));return this},f.prototype.shadow=function(t,e,i){var r,o,n,s,a,h,d=[],l=this.element,p=this.oldShadowOptions,c={color:"#000000",offsetX:this.parentInverted?-1:1,offsetY:this.parentInverted?-1:1,opacity:.15,width:3},u=!1;if(!0===t?h=c:"object"==typeof t&&(h=extend(c,t)),h&&(p&&objectEach(h,function(t,e){t!==p[e]&&(u=!0)}),u&&this.destroyShadows(),this.oldShadowOptions=h),h){if(!this.shadows){for(s=h.opacity/h.width,a=this.parentInverted?"translate("+h.offsetY+", "+h.offsetX+")":"translate("+h.offsetX+", "+h.offsetY+")",r=1;r<=h.width;r++)o=l.cloneNode(!1),n=2*h.width+1-2*r,attr(o,{stroke:t.color||"#000000","stroke-opacity":s*r,"stroke-width":n,transform:a,fill:"none"}),o.setAttribute("class",(o.getAttribute("class")||"")+" highcharts-shadow"),i&&(attr(o,"height",Math.max(attr(o,"height")-n,0)),o.cutHeight=n),e?e.element.appendChild(o):l.parentNode&&l.parentNode.insertBefore(o,l),d.push(o);this.shadows=d}}else this.destroyShadows();return this},f.prototype.show=function(t){return this.attr({visibility:t?"inherit":"visible"})},f.prototype.strokeSetter=function(t,e,i){this[e]=t,this.stroke&&this["stroke-width"]?(f.prototype.fillSetter.call(this,this.stroke,"stroke",i),i.setAttribute("stroke-width",this["stroke-width"]),this.hasStroke=!0):"stroke-width"===e&&0===t&&this.hasStroke?(i.removeAttribute("stroke"),this.hasStroke=!1):this.renderer.styledMode&&this["stroke-width"]&&(i.setAttribute("stroke-width",this["stroke-width"]),this.hasStroke=!0)},f.prototype.strokeWidth=function(){if(!this.renderer.styledMode)return this["stroke-width"]||0;var t,e=this.getStyle("stroke-width"),i=0;return e.indexOf("px")===e.length-2?i=pInt(e):""!==e&&(t=doc.createElementNS(SVG_NS,"rect"),attr(t,{width:e,"stroke-width":0}),this.element.parentNode.appendChild(t),i=t.getBBox().width,t.parentNode.removeChild(t)),i},f.prototype.symbolAttr=function(e){var i=this;["x","y","r","start","end","width","height","innerR","anchorX","anchorY","clockwise"].forEach(function(t){i[t]=pick(e[t],i[t])}),i.attr({d:i.renderer.symbols[i.symbolName](i.x,i.y,i.width,i.height,i)})},f.prototype.textSetter=function(t){t!==this.textStr&&(delete this.textPxLength,this.textStr=t,this.added&&this.renderer.buildText(this))},f.prototype.titleSetter=function(t){var e=this.element,i=e.getElementsByTagName("title")[0]||doc.createElementNS(this.SVG_NS,"title");e.insertBefore?e.insertBefore(i,e.firstChild):e.appendChild(i),i.textContent=String(pick(t,"")).replace(/<[^>]*>/g,"").replace(/&lt;/g,"<").replace(/&gt;/g,">")},f.prototype.toFront=function(){var t=this.element;return t.parentNode.appendChild(t),this},f.prototype.translate=function(t,e){return this.attr({translateX:t,translateY:e})},f.prototype.updateShadows=function(t,e,i){var r=this.shadows;if(r)for(var o=r.length;o--;)i.call(r[o],"height"===t?Math.max(e-(r[o].cutHeight||0),0):"d"===t?this.d:e,t,r[o])},f.prototype.updateTransform=function(){var t=this,e=t.scaleX,i=t.scaleY,r=t.inverted,o=t.rotation,n=t.matrix,s=t.element,a=t.translateX||0,h=t.translateY||0;r&&(a+=t.width,h+=t.height);h=["translate("+a+","+h+")"];defined(n)&&h.push("matrix("+n.join(",")+")"),r?h.push("rotate(90) scale(-1,1)"):o&&h.push("rotate("+o+" "+pick(this.rotationOriginX,s.getAttribute("x"),0)+" "+pick(this.rotationOriginY,s.getAttribute("y")||0)+")"),(defined(e)||defined(i))&&h.push("scale("+pick(e,1)+" "+pick(i,1)+")"),h.length&&s.setAttribute("transform",h.join(" "))},f.prototype.visibilitySetter=function(t,e,i){"inherit"===t?i.removeAttribute(e):this[e]!==t&&i.setAttribute(e,t),this[e]=t},f.prototype.xGetter=function(t){return"circle"===this.element.nodeName&&("x"===t?t="cx":"y"===t&&(t="cy")),this._defaultGetter(t)},f.prototype.zIndexSetter=function(t,e){var i,r,o,n,s,a=this.renderer,h=this.parentGroup,d=(h||a).element||a.box,l=this.element,p=d===a.box,c=!1,a=this.added;if(defined(t)?(l.setAttribute("data-z-index",t),this[e]===(t=+t)&&(a=!1)):defined(this[e])&&l.removeAttribute("data-z-index"),this[e]=t,a){for((t=this.zIndex)&&h&&(h.handleZ=!0),s=(i=d.childNodes).length-1;0<=s&&!c;s--)o=(r=i[s]).getAttribute("data-z-index"),n=!defined(o),r!==l&&(t<0&&n&&!p&&!s?(d.insertBefore(l,i[s]),c=!0):(pInt(o)<=t||n&&(!defined(t)||0<=t))&&(d.insertBefore(l,i[s+1]||null),c=!0));c||(d.insertBefore(l,i[p?3:0]||null),c=!0)}return c},f}();SVGElement.prototype["stroke-widthSetter"]=SVGElement.prototype.strokeSetter,SVGElement.prototype.yGetter=SVGElement.prototype.xGetter,SVGElement.prototype.matrixSetter=SVGElement.prototype.rotationOriginXSetter=SVGElement.prototype.rotationOriginYSetter=SVGElement.prototype.rotationSetter=SVGElement.prototype.scaleXSetter=SVGElement.prototype.scaleYSetter=SVGElement.prototype.translateXSetter=SVGElement.prototype.translateYSetter=SVGElement.prototype.verticalAlignSetter=function(t,e){this[e]=t,this.doTransform=!0};export default SVGElement;