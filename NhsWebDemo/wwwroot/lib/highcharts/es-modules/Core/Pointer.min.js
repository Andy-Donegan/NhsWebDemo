"use strict";import Color from"./Color/Color.js";var color=Color.parse;import H from"./Globals.js";var charts=H.charts,noop=H.noop;import Tooltip from"./Tooltip.js";import U from"./Utilities.js";var addEvent=U.addEvent,attr=U.attr,css=U.css,defined=U.defined,extend=U.extend,find=U.find,fireEvent=U.fireEvent,isNumber=U.isNumber,isObject=U.isObject,objectEach=U.objectEach,offset=U.offset,pick=U.pick,splat=U.splat,Pointer=function(){function u(t,o){this.lastValidTouch={},this.pinchDown=[],this.runChartClick=!1,this.eventsToUnbind=[],this.chart=t,this.hasDragged=!1,this.options=o,this.init(t,o)}return u.prototype.applyInactiveState=function(t){var o,e=[];(t||[]).forEach(function(t){o=t.series,e.push(o),o.linkedParent&&e.push(o.linkedParent),o.linkedSeries&&(e=e.concat(o.linkedSeries)),o.navigatorSeries&&e.push(o.navigatorSeries)}),this.chart.series.forEach(function(t){-1===e.indexOf(t)?t.setState("inactive",!0):t.options.inactiveOtherPoints&&t.setAllPointsToState("inactive")})},u.prototype.destroy=function(){var e=this;this.eventsToUnbind.forEach(function(t){return t()}),this.eventsToUnbind=[],H.chartCount||(u.unbindDocumentMouseUp&&(u.unbindDocumentMouseUp=u.unbindDocumentMouseUp()),u.unbindDocumentTouchEnd&&(u.unbindDocumentTouchEnd=u.unbindDocumentTouchEnd())),clearInterval(e.tooltipTimeout),objectEach(e,function(t,o){e[o]=void 0})},u.prototype.drag=function(t){var o,e,i=this.chart,n=i.options.chart,r=this.zoomHor,s=this.zoomVert,a=i.plotLeft,h=i.plotTop,c=i.plotWidth,u=i.plotHeight,p=this.mouseDownX||0,l=this.mouseDownY||0,d=isObject(n.panning)?n.panning&&n.panning.enabled:n.panning,v=n.panKey&&t[n.panKey+"Key"],f=t.chartX,m=t.chartY,x=this.selectionMarker;x&&x.touch||(f<a?f=a:a+c<f&&(f=a+c),m<h?m=h:h+u<m&&(m=h+u),this.hasDragged=Math.sqrt(Math.pow(p-f,2)+Math.pow(l-m,2)),10<this.hasDragged&&(o=i.isInsidePlot(p-a,l-h,{visiblePlotOnly:!0}),(i.hasCartesianSeries||i.mapView)&&(this.zoomX||this.zoomY)&&o&&!v&&(x||(this.selectionMarker=x=i.renderer.rect(a,h,r?1:c,s?1:u,0).attr({class:"highcharts-selection-marker",zIndex:7}).add(),i.styledMode||x.attr({fill:n.selectionMarkerFill||color("#335cad").setOpacity(.25).get()}))),x&&r&&(e=f-p,x.attr({width:Math.abs(e),x:(0<e?0:e)+p})),x&&s&&(e=m-l,x.attr({height:Math.abs(e),y:(0<e?0:e)+l})),o&&!x&&d&&i.pan(t,n.panning)))},u.prototype.dragStart=function(t){var o=this.chart;o.mouseIsDown=t.type,o.cancelClick=!1,o.mouseDownX=this.mouseDownX=t.chartX,o.mouseDownY=this.mouseDownY=t.chartY},u.prototype.drop=function(n){var t,r,s,a,h,c,u,p=this,o=this.chart,l=this.hasPinched;this.selectionMarker&&(t=this.selectionMarker,r=t.attr?t.attr("x"):t.x,s=t.attr?t.attr("y"):t.y,a=t.attr?t.attr("width"):t.width,h=t.attr?t.attr("height"):t.height,c={originalEvent:n,xAxis:[],yAxis:[],x:r,y:s,width:a,height:h},u=Boolean(o.mapView),(this.hasDragged||l)&&(o.axes.forEach(function(t){var o,e,i;t.zoomEnabled&&defined(t.min)&&(l||p[{xAxis:"zoomX",yAxis:"zoomY"}[t.coll]])&&isNumber(r)&&isNumber(s)&&(o=t.horiz,i="touchend"===n.type?t.minPixelPadding:0,e=t.toValue((o?r:s)+i),i=t.toValue((o?r+a:s+h)-i),c[t.coll].push({axis:t,min:Math.min(e,i),max:Math.max(e,i)}),u=!0)}),u&&fireEvent(o,"selection",c,function(t){o.zoom(extend(t,l?{animation:!1}:null))})),isNumber(o.index)&&(this.selectionMarker=this.selectionMarker.destroy()),l&&this.scaleGroups()),o&&isNumber(o.index)&&(css(o.container,{cursor:o._cursor}),o.cancelClick=10<this.hasDragged,o.mouseIsDown=this.hasDragged=this.hasPinched=!1,this.pinchDown=[])},u.prototype.findNearestKDPoint=function(t,s,a){var h,o=this.chart,e=o.hoverPoint,o=o.tooltip;return e&&o&&o.isStickyOnContact()?e:(t.forEach(function(t){var o,e,i,n=!(t.noSharedTooltip&&s)&&t.options.findNearestPointBy.indexOf("y")<0,r=t.searchPoint(a,n);isObject(r,!0)&&r.series&&(!isObject(h,!0)||(e=r,i=(o=h).distX-e.distX,t=o.dist-e.dist,n=(e.series.group&&e.series.group.zIndex)-(o.series.group&&o.series.group.zIndex),0<(e=0!=i&&s?i:0!=t?t:0!=n?n:o.series.index>e.series.index?-1:1)))&&(h=r)}),h)},u.prototype.getChartCoordinatesFromPoint=function(t,o){var e=t.series,i=e.xAxis,n=e.yAxis,r=t.shapeArgs;if(i&&n){var s=pick(t.clientX,t.plotX),e=t.plotY||0;return t.isNode&&r&&isNumber(r.x)&&isNumber(r.y)&&(s=r.x,e=r.y),o?{chartX:n.len+n.pos-e,chartY:i.len+i.pos-s}:{chartX:s+i.pos,chartY:e+n.pos}}if(r&&r.x&&r.y)return{chartX:r.x,chartY:r.y}},u.prototype.getChartPosition=function(){if(this.chartPosition)return this.chartPosition;var t=this.chart.container,o=offset(t);this.chartPosition={left:o.left,top:o.top,scaleX:1,scaleY:1};var e=t.offsetWidth,t=t.offsetHeight;return 2<e&&2<t&&(this.chartPosition.scaleX=o.width/e,this.chartPosition.scaleY=o.height/t),this.chartPosition},u.prototype.getCoordinates=function(o){var e={xAxis:[],yAxis:[]};return this.chart.axes.forEach(function(t){e[t.isXAxis?"xAxis":"yAxis"].push({axis:t,value:t.toValue(o[t.horiz?"chartX":"chartY"])})}),e},u.prototype.getHoverData=function(t,o,e,i,n,r){function s(t){return t.visible&&!(!n&&t.directTouch)&&pick(t.options.enableMouseTracking,!0)}var a=[],h=!(!i||!t),i=o,c={chartX:r?r.chartX:void 0,chartY:r?r.chartY:void 0,shared:n};fireEvent(this,"beforeGetHoverData",c);var o=i&&!i.stickyTracking?[i]:e.filter(function(t){return c.filter?c.filter(t):s(t)&&t.stickyTracking}),u=h||!r?t:this.findNearestKDPoint(o,n,r),i=u&&u.series;return u&&(n&&!i.noSharedTooltip?(o=e.filter(function(t){return c.filter?c.filter(t):s(t)&&!t.noSharedTooltip})).forEach(function(t){var o=find(t.points,function(t){return t.x===u.x&&!t.isNull});isObject(o)&&(t.chart.isBoosting&&(o=t.getPoint(o)),a.push(o))}):a.push(u)),fireEvent(this,"afterGetHoverData",c={hoverPoint:u}),{hoverPoint:c.hoverPoint,hoverSeries:i,hoverPoints:a}},u.prototype.getPointFromEvent=function(t){for(var o,e=t.target;e&&!o;)o=e.point,e=e.parentNode;return o},u.prototype.onTrackerMouseOut=function(t){var o=this.chart,t=t.relatedTarget||t.toElement,o=o.hoverSeries;this.isDirectTouch=!1,!o||!t||o.stickyTracking||this.inClass(t,"highcharts-tooltip")||this.inClass(t,"highcharts-series-"+o.index)&&this.inClass(t,"highcharts-tracker")||o.onMouseOut()},u.prototype.inClass=function(t,o){for(var e;t;){if(e=attr(t,"class")){if(-1!==e.indexOf(o))return!0;if(-1!==e.indexOf("highcharts-container"))return!1}t=t.parentNode}},u.prototype.init=function(t,o){this.options=o,this.chart=t,this.runChartClick=Boolean(o.chart.events&&o.chart.events.click),this.pinchDown=[],this.lastValidTouch={},Tooltip&&(t.tooltip=new Tooltip(t,o.tooltip),this.followTouchMove=pick(o.tooltip.followTouchMove,!0)),this.setDOMEvents()},u.prototype.normalize=function(t,o){var e=t.touches,i=e?e.length?e.item(0):pick(e.changedTouches,t.changedTouches)[0]:t;o=o||this.getChartPosition();e=i.pageX-o.left,i=i.pageY-o.top;return e/=o.scaleX,i/=o.scaleY,extend(t,{chartX:Math.round(e),chartY:Math.round(i)})},u.prototype.onContainerClick=function(t){var o=this.chart,e=o.hoverPoint,i=this.normalize(t),n=o.plotLeft,t=o.plotTop;o.cancelClick||(e&&this.inClass(i.target,"highcharts-tracker")?(fireEvent(e.series,"click",extend(i,{point:e})),o.hoverPoint&&e.firePointEvent("click",i)):(extend(i,this.getCoordinates(i)),o.isInsidePlot(i.chartX-n,i.chartY-t,{visiblePlotOnly:!0})&&fireEvent(o,"click",i)))},u.prototype.onContainerMouseDown=function(t){var o=1==(1&(t.buttons||t.button));t=this.normalize(t),H.isFirefox&&0!==t.button&&this.onContainerMouseMove(t),void 0!==t.button&&!o||(this.zoomOption(t),o&&t.preventDefault&&t.preventDefault(),this.dragStart(t))},u.prototype.onContainerMouseLeave=function(t){var o=charts[pick(u.hoverChartIndex,-1)],e=this.chart.tooltip;e&&e.shouldStickOnContact()&&this.inClass(t.relatedTarget,"highcharts-tooltip-container")||(t=this.normalize(t),o&&(t.relatedTarget||t.toElement)&&(o.pointer.reset(),o.pointer.chartPosition=void 0),e&&!e.isHidden&&this.reset())},u.prototype.onContainerMouseEnter=function(t){delete this.chartPosition},u.prototype.onContainerMouseMove=function(t){var o=this.chart,t=this.normalize(t);this.setHoverChartIndex(),t.preventDefault||(t.returnValue=!1),"mousedown"!==o.mouseIsDown&&!this.touchSelect(t)||this.drag(t),o.openMenu||!this.inClass(t.target,"highcharts-tracker")&&!o.isInsidePlot(t.chartX-o.plotLeft,t.chartY-o.plotTop,{visiblePlotOnly:!0})||(this.inClass(t.target,"highcharts-no-tooltip")?this.reset(!1,0):this.runPointActions(t))},u.prototype.onDocumentTouchEnd=function(t){var o=charts[pick(u.hoverChartIndex,-1)];o&&o.pointer.drop(t)},u.prototype.onContainerTouchMove=function(t){this.touchSelect(t)?this.onContainerMouseMove(t):this.touch(t)},u.prototype.onContainerTouchStart=function(t){this.touchSelect(t)?this.onContainerMouseDown(t):(this.zoomOption(t),this.touch(t,!0))},u.prototype.onDocumentMouseMove=function(t){var o=this.chart,e=this.chartPosition,i=this.normalize(t,e),t=o.tooltip;!e||t&&t.isStickyOnContact()||o.isInsidePlot(i.chartX-o.plotLeft,i.chartY-o.plotTop,{visiblePlotOnly:!0})||this.inClass(i.target,"highcharts-tracker")||this.reset()},u.prototype.onDocumentMouseUp=function(t){var o=charts[pick(u.hoverChartIndex,-1)];o&&o.pointer.drop(t)},u.prototype.pinch=function(t){var o=this,s=o.chart,e=o.pinchDown,i=t.touches||[],n=i.length,r=o.lastValidTouch,a=o.hasZoom,h={},c=1===n&&(o.inClass(t.target,"highcharts-tracker")&&s.runTrackerClick||o.runChartClick),u={},p=o.selectionMarker;1<n?o.initiated=!0:1===n&&this.followTouchMove&&(o.initiated=!1),a&&o.initiated&&!c&&!1!==t.cancelable&&t.preventDefault(),[].map.call(i,function(t){return o.normalize(t)}),"touchstart"===t.type?([].forEach.call(i,function(t,o){e[o]={chartX:t.chartX,chartY:t.chartY}}),r.x=[e[0].chartX,e[1]&&e[1].chartX],r.y=[e[0].chartY,e[1]&&e[1].chartY],s.axes.forEach(function(t){var o,e,i,n,r;t.zoomEnabled&&(o=s.bounds[t.horiz?"h":"v"],e=t.minPixelPadding,i=t.toPixels(Math.min(pick(t.options.min,t.dataMin),t.dataMin)),r=t.toPixels(Math.max(pick(t.options.max,t.dataMax),t.dataMax)),n=Math.min(i,r),r=Math.max(i,r),o.min=Math.min(t.pos,n-e),o.max=Math.max(t.pos+t.len,r+e))}),o.res=!0):o.followTouchMove&&1===n?this.runPointActions(o.normalize(t)):e.length&&(fireEvent(s,"touchpan",{originalEvent:t},function(){p||(o.selectionMarker=p=extend({destroy:noop,touch:!0},s.plotBox)),o.pinchTranslate(e,i,h,p,u,r),o.hasPinched=a,o.scaleGroups(h,u)}),o.res&&(o.res=!1,this.reset(!1,0)))},u.prototype.pinchTranslate=function(t,o,e,i,n,r){this.zoomHor&&this.pinchTranslateDirection(!0,t,o,e,i,n,r),this.zoomVert&&this.pinchTranslateDirection(!1,t,o,e,i,n,r)},u.prototype.pinchTranslateDirection=function(t,o,e,i,n,r,s,a){var h,c,u,p=this.chart,l=t?"x":"y",d=t?"X":"Y",v="chart"+d,f=t?"width":"height",m=p["plot"+(t?"Left":"Top")],x=p.inverted,g=p.bounds[t?"h":"v"],M=1===o.length,y=o[0][v],P=!M&&o[1][v],o=function(){"number"==typeof T&&20<Math.abs(y-P)&&(b=a||Math.abs(C-T)/Math.abs(y-P)),c=(m-C)/b+y,h=p["plot"+(t?"Width":"Height")]/b},b=a||1,C=e[0][v],T=!M&&e[1][v];o(),(v=c)<g.min?(v=g.min,u=!0):v+h>g.max&&(v=g.max-h,u=!0),u?(C-=.8*(C-s[l][0]),"number"==typeof T&&(T-=.8*(T-s[l][1])),o()):s[l]=[C,T],x||(r[l]=c-m,r[f]=h);r=x?t?"scaleY":"scaleX":"scale"+d,x=x?1/b:b;n[f]=h,n[l]=v,i[r]=b,i["translate"+d]=x*m+(C-x*y)},u.prototype.reset=function(o,t){var e=this,i=e.chart,n=i.hoverSeries,r=i.hoverPoint,s=i.hoverPoints,a=i.tooltip,h=a&&a.shared?s:r;o&&h&&splat(h).forEach(function(t){t.series.isCartesian&&void 0===t.plotX&&(o=!1)}),o?a&&h&&splat(h).length&&(a.refresh(h),a.shared&&s?s.forEach(function(t){t.setState(t.state,!0),t.series.isCartesian&&(t.series.xAxis.crosshair&&t.series.xAxis.drawCrosshair(null,t),t.series.yAxis.crosshair&&t.series.yAxis.drawCrosshair(null,t))}):r&&(r.setState(r.state,!0),i.axes.forEach(function(t){t.crosshair&&r.series[t.coll]===t&&t.drawCrosshair(null,r)}))):(r&&r.onMouseOut(),s&&s.forEach(function(t){t.setState()}),n&&n.onMouseOut(),a&&a.hide(t),e.unDocMouseMove&&(e.unDocMouseMove=e.unDocMouseMove()),i.axes.forEach(function(t){t.hideCrosshair()}),e.hoverX=i.hoverPoints=i.hoverPoint=null)},u.prototype.runPointActions=function(i,t){var o=this,n=o.chart,e=n.series,r=n.tooltip&&n.tooltip.options.enabled?n.tooltip:void 0,s=!!r&&r.shared,a=(h=t||n.hoverPoint)&&h.series||n.hoverSeries,t=(!i||"touchmove"!==i.type)&&(!!t||a&&a.directTouch&&o.isDirectTouch),t=this.getHoverData(h,a,e,t,s,i),h=t.hoverPoint,a=t.hoverSeries,c=t.hoverPoints,t=a&&a.tooltipOptions.followPointer&&!a.tooltipOptions.split,s=s&&a&&!a.noSharedTooltip;if(h&&(h!==n.hoverPoint||r&&r.isHidden)){if((n.hoverPoints||[]).forEach(function(t){-1===c.indexOf(t)&&t.setState()}),n.hoverSeries!==a&&a.onMouseOver(),o.applyInactiveState(c),(c||[]).forEach(function(t){t.setState("hover")}),n.hoverPoint&&n.hoverPoint.firePointEvent("mouseOut"),!h.series)return;n.hoverPoints=c,(n.hoverPoint=h).firePointEvent("mouseOver"),r&&r.refresh(s?c:h,i)}else t&&r&&!r.isHidden&&(t=r.getAnchor([{}],i),n.isInsidePlot(t[0],t[1],{visiblePlotOnly:!0})&&r.updatePosition({plotX:t[0],plotY:t[1]}));o.unDocMouseMove||(o.unDocMouseMove=addEvent(n.container.ownerDocument,"mousemove",function(t){var o=charts[u.hoverChartIndex];o&&o.pointer.onDocumentMouseMove(t)}),o.eventsToUnbind.push(o.unDocMouseMove)),n.axes.forEach(function(o){var t,e=pick((o.crosshair||{}).snap,!0);e&&((t=n.hoverPoint)&&t.series[o.coll]===o||(t=find(c,function(t){return t.series[o.coll]===o}))),t||!e?o.drawCrosshair(i,t):o.hideCrosshair()})},u.prototype.scaleGroups=function(e,i){var n=this.chart;n.series.forEach(function(t){var o=e||t.getPlotBox();t.group&&(t.xAxis&&t.xAxis.zoomEnabled||n.mapView)&&(t.group.attr(o),t.markerGroup&&(t.markerGroup.attr(o),t.markerGroup.clip(i?n.clipRect:null)),t.dataLabelsGroup&&t.dataLabelsGroup.attr(o))}),n.clipRect.attr(i||n.clipBox)},u.prototype.setDOMEvents=function(){var t=this,o=this.chart.container,e=o.ownerDocument;o.onmousedown=this.onContainerMouseDown.bind(this),o.onmousemove=this.onContainerMouseMove.bind(this),o.onclick=this.onContainerClick.bind(this),this.eventsToUnbind.push(addEvent(o,"mouseenter",this.onContainerMouseEnter.bind(this))),this.eventsToUnbind.push(addEvent(o,"mouseleave",this.onContainerMouseLeave.bind(this))),u.unbindDocumentMouseUp||(u.unbindDocumentMouseUp=addEvent(e,"mouseup",this.onDocumentMouseUp.bind(this)));for(var i=this.chart.renderTo.parentElement;i&&"BODY"!==i.tagName;)this.eventsToUnbind.push(addEvent(i,"scroll",function(){delete t.chartPosition})),i=i.parentElement;H.hasTouch&&(this.eventsToUnbind.push(addEvent(o,"touchstart",this.onContainerTouchStart.bind(this),{passive:!1})),this.eventsToUnbind.push(addEvent(o,"touchmove",this.onContainerTouchMove.bind(this),{passive:!1})),u.unbindDocumentTouchEnd||(u.unbindDocumentTouchEnd=addEvent(e,"touchend",this.onDocumentTouchEnd.bind(this),{passive:!1})))},u.prototype.setHoverChartIndex=function(){var t=this.chart,o=H.charts[pick(u.hoverChartIndex,-1)];o&&o!==t&&o.pointer.onContainerMouseLeave({relatedTarget:!0}),o&&o.mouseIsDown||(u.hoverChartIndex=t.index)},u.prototype.touch=function(t,o){var e,i=this.chart;this.setHoverChartIndex(),1===t.touches.length?(t=this.normalize(t),i.isInsidePlot(t.chartX-i.plotLeft,t.chartY-i.plotTop,{visiblePlotOnly:!0})&&!i.openMenu?(o&&this.runPointActions(t),"touchmove"===t.type&&(e=!!(e=this.pinchDown)[0]&&4<=Math.sqrt(Math.pow(e[0].chartX-t.chartX,2)+Math.pow(e[0].chartY-t.chartY,2))),pick(e,!0)&&this.pinch(t)):o&&this.reset()):2===t.touches.length&&this.pinch(t)},u.prototype.touchSelect=function(t){return Boolean(this.chart.options.chart.zoomBySingleTouch&&t.touches&&1===t.touches.length)},u.prototype.zoomOption=function(t){var o=this.chart,e=o.options.chart,i=o.inverted,o=e.zoomType||"";/touch/.test(t.type)&&(o=pick(e.pinchType,o)),this.zoomX=e=/x/.test(o),this.zoomY=o=/y/.test(o),this.zoomHor=e&&!i||o&&i,this.zoomVert=o&&!i||e&&i,this.hasZoom=e||o},u}();export default Pointer;