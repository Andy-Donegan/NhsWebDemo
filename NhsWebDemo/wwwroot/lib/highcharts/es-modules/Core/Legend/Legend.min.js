"use strict";import A from"../Animation/AnimationUtilities.js";var animObject=A.animObject,setAnimation=A.setAnimation;import F from"../FormatUtilities.js";var format=F.format;import H from"../Globals.js";var isFirefox=H.isFirefox,marginNames=H.marginNames,win=H.win;import Point from"../Series/Point.js";import R from"../Renderer/RendererUtilities.js";var distribute=R.distribute;import U from"../Utilities.js";var addEvent=U.addEvent,createElement=U.createElement,css=U.css,defined=U.defined,discardElement=U.discardElement,find=U.find,fireEvent=U.fireEvent,isNumber=U.isNumber,merge=U.merge,pick=U.pick,relativeLength=U.relativeLength,stableSort=U.stableSort,syncTimeout=U.syncTimeout,wrap=U.wrap,Legend=function(){function t(t,e){this.allItems=[],this.box=void 0,this.contentGroup=void 0,this.display=!1,this.group=void 0,this.initialItemY=0,this.itemHeight=0,this.itemMarginBottom=0,this.itemMarginTop=0,this.itemX=0,this.itemY=0,this.lastItemY=0,this.lastLineHeight=0,this.legendHeight=0,this.legendWidth=0,this.maxItemWidth=0,this.maxLegendWidth=0,this.offsetWidth=0,this.options={},this.padding=0,this.pages=[],this.proximate=!1,this.scrollGroup=void 0,this.symbolHeight=0,this.symbolWidth=0,this.titleHeight=0,this.totalItemWidth=0,this.widthOption=0,this.chart=t,this.init(t,e)}return t.prototype.init=function(t,e){this.chart=t,this.setOptions(e),e.enabled&&(this.render(),addEvent(this.chart,"endResize",function(){this.legend.positionCheckboxes()}),this.proximate?this.unchartrender=addEvent(this.chart,"render",function(){this.legend.proximatePositions(),this.legend.positionItems()}):this.unchartrender&&this.unchartrender())},t.prototype.setOptions=function(t){var e=pick(t.padding,8);this.options=t,this.chart.styledMode||(this.itemStyle=t.itemStyle,this.itemHiddenStyle=merge(this.itemStyle,t.itemHiddenStyle)),this.itemMarginTop=t.itemMarginTop||0,this.itemMarginBottom=t.itemMarginBottom||0,this.padding=e,this.initialItemY=e-5,this.symbolWidth=pick(t.symbolWidth,16),this.pages=[],this.proximate="proximate"===t.layout&&!this.chart.inverted,this.baseline=void 0},t.prototype.update=function(t,e){var i=this.chart;this.setOptions(merge(!0,this.options,t)),this.destroy(),i.isDirtyLegend=i.isDirtyBox=!0,pick(e,!0)&&i.redraw(),fireEvent(this,"afterUpdate")},t.prototype.colorizeItem=function(t,e){var i,s,o,n,r,h,a,l;t.legendGroup[e?"removeClass":"addClass"]("highcharts-legend-item-hidden"),this.chart.styledMode||(l=this.options,i=t.legendItem,s=t.legendLine,o=t.legendSymbol,n=this.itemHiddenStyle.color,r=e?l.itemStyle.color:n,h=e&&t.color||n,a=t.options&&t.options.marker,l={fill:h},i&&i.css({fill:r,color:r}),s&&s.attr({stroke:h}),o&&(a&&o.isMarker&&(l=t.pointAttribs(),e||(l.stroke=l.fill=n)),o.attr(l))),fireEvent(this,"afterColorizeItem",{item:t,visible:e})},t.prototype.positionItems=function(){this.allItems.forEach(this.positionItem,this),this.chart.isResizing||this.positionCheckboxes()},t.prototype.positionItem=function(t){var e=this,i=this.options,s=i.symbolPadding,o=!i.rtl,n=t._legendItemPos,r=n[0],h=n[1],i=t.checkbox,n=t.legendGroup;n&&n.element&&(o={translateX:o?r:this.legendWidth-r-2*s-4,translateY:h},s=function(){fireEvent(e,"afterPositionItem",{item:t})},defined(n.translateY)?n.animate(o,void 0,s):(n.attr(o),s())),i&&(i.x=r,i.y=h)},t.prototype.destroyItem=function(e){var t=e.checkbox;["legendItem","legendLine","legendSymbol","legendGroup"].forEach(function(t){e[t]&&(e[t]=e[t].destroy())}),t&&discardElement(e.checkbox)},t.prototype.destroy=function(){function e(t){this[t]&&(this[t]=this[t].destroy())}this.getAllItems().forEach(function(t){["legendItem","legendGroup"].forEach(e,t)}),["clipRect","up","down","pager","nav","box","title","group"].forEach(e,this),this.display=null},t.prototype.positionCheckboxes=function(){var s,o=this.group&&this.group.alignAttr,n=this.clipHeight||this.legendHeight,r=this.titleHeight;o&&(s=o.translateY,this.allItems.forEach(function(t){var e,i=t.checkbox;i&&(e=s+r+i.y+(this.scrollOffset||0)+3,css(i,{left:o.translateX+t.checkboxOffset+i.x-20+"px",top:e+"px",display:this.proximate||s-6<e&&e<s+n-6?"":"none"}))},this))},t.prototype.renderTitle=function(){var t=this.options,e=this.padding,i=t.title,s=0;i.text&&(this.title||(this.title=this.chart.renderer.label(i.text,e-3,e-4,null,null,null,t.useHTML,null,"legend-title").attr({zIndex:1}),this.chart.styledMode||this.title.css(i.style),this.title.add(this.group)),i.width||this.title.css({width:this.maxLegendWidth+"px"}),s=(i=this.title.getBBox()).height,this.offsetWidth=i.width,this.contentGroup.attr({translateY:s})),this.titleHeight=s},t.prototype.setText=function(t){var e=this.options;t.legendItem.attr({text:e.labelFormat?format(e.labelFormat,t,this.chart):e.labelFormatter.call(t)})},t.prototype.renderItem=function(t){var e=this,i=e.chart,s=i.renderer,o=e.options,n="horizontal"===o.layout,r=e.symbolWidth,h=o.symbolPadding||0,a=e.itemStyle,l=e.itemHiddenStyle,d=n?pick(o.itemDistance,20):0,c=!o.rtl,m=!t.series,g=!m&&t.series.drawLegendSymbol?t.series:t,p=g.options,f=e.createCheckboxForItem&&p&&p.showCheckbox,u=o.useHTML,v=t.options.className,n=t.legendItem,p=r+h+d+(f?20:0);n||(t.legendGroup=s.g("legend-item").addClass("highcharts-"+g.type+"-series highcharts-color-"+t.colorIndex+(v?" "+v:"")+(m?" highcharts-series-"+t.index:"")).attr({zIndex:1}).add(e.scrollGroup),t.legendItem=n=s.text("",c?r+h:-h,e.baseline||0,u),i.styledMode||n.css(merge(t.visible?a:l)),n.attr({align:c?"left":"right",zIndex:2}).add(t.legendGroup),e.baseline||(e.fontMetrics=s.fontMetrics(i.styledMode?12:a.fontSize,n),e.baseline=e.fontMetrics.f+3+e.itemMarginTop,n.attr("y",e.baseline),e.symbolHeight=o.symbolHeight||e.fontMetrics.f,o.squareSymbol&&(e.symbolWidth=pick(o.symbolWidth,Math.max(e.symbolHeight,16)),p=e.symbolWidth+h+d+(f?20:0),c&&n.attr("x",e.symbolWidth+h))),g.drawLegendSymbol(e,t),e.setItemEvents&&e.setItemEvents(t,n,u)),f&&!t.checkbox&&e.createCheckboxForItem&&e.createCheckboxForItem(t),e.colorizeItem(t,t.visible),!i.styledMode&&a.width||n.css({width:(o.itemWidth||e.widthOption||i.spacingBox.width)-p+"px"}),e.setText(t);i=n.getBBox(),n=e.fontMetrics&&e.fontMetrics.h||0;t.itemWidth=t.checkboxOffset=o.itemWidth||t.legendItemWidth||i.width+p,e.maxItemWidth=Math.max(e.maxItemWidth,t.itemWidth),e.totalItemWidth+=t.itemWidth,e.itemHeight=t.itemHeight=Math.round(t.legendItemHeight||(i.height>1.5*n?i.height:n))},t.prototype.layoutItem=function(t){var e=this.options,i=this.padding,s="horizontal"===e.layout,o=t.itemHeight,n=this.itemMarginBottom,r=this.itemMarginTop,h=s?pick(e.itemDistance,20):0,a=this.maxLegendWidth,e=e.alignColumns&&this.totalItemWidth>a?this.maxItemWidth:t.itemWidth;s&&this.itemX-i+e>a&&(this.itemX=i,this.lastLineHeight&&(this.itemY+=r+this.lastLineHeight+n),this.lastLineHeight=0),this.lastItemY=r+this.itemY+n,this.lastLineHeight=Math.max(o,this.lastLineHeight),t._legendItemPos=[this.itemX,this.itemY],s?this.itemX+=e:(this.itemY+=r+o+n,this.lastLineHeight=o),this.offsetWidth=this.widthOption||Math.max((s?this.itemX-i-(t.checkbox?0:h):e)+i,this.offsetWidth)},t.prototype.getAllItems=function(){var i=[];return this.chart.series.forEach(function(t){var e=t&&t.options;t&&pick(e.showInLegend,!defined(e.linkedTo)&&void 0,!0)&&(i=i.concat(t.legendItems||("point"===e.legendType?t.data:t)))}),fireEvent(this,"afterGetAllItems",{allItems:i}),i},t.prototype.getAlignment=function(){var t=this.options;return this.proximate?t.align.charAt(0)+"tv":t.floating?"":t.align.charAt(0)+t.verticalAlign.charAt(0)+t.layout.charAt(0)},t.prototype.adjustMargins=function(i,s){var o=this.chart,n=this.options,r=this.getAlignment();r&&[/(lth|ct|rth)/,/(rtv|rm|rbv)/,/(rbh|cb|lbh)/,/(lbv|lm|ltv)/].forEach(function(t,e){t.test(r)&&!defined(i[e])&&(o[marginNames[e]]=Math.max(o[marginNames[e]],o.legend[(e+1)%2?"legendHeight":"legendWidth"]+[1,-1,-1,1][e]*n[e%2?"x":"y"]+pick(n.margin,12)+s[e]+(o.titleOffset[e]||0)))})},t.prototype.proximatePositions=function(){var n=this.chart,r=[],h="left"===this.options.align;this.allItems.forEach(function(t){var e,i,s,o=h;t.yAxis&&(t.xAxis.options.reversed&&(o=!o),t.points&&(e=find(o?t.points:t.points.slice(0).reverse(),function(t){return isNumber(t.plotY)})),i=this.itemMarginTop+t.legendItem.getBBox().height+this.itemMarginBottom,o=t.yAxis.top-n.plotTop,t.visible?(s=e?e.plotY:t.yAxis.height,s+=o-.3*i):s=o+t.yAxis.height,r.push({target:s,size:i,item:t}))},this),distribute(r,n.plotHeight).forEach(function(t){t.item._legendItemPos&&(t.item._legendItemPos[1]=n.plotTop-n.spacing[0]+t.pos)})},t.prototype.render=function(){var t,e,i=this,s=i.chart,o=s.renderer,n=i.options,r=i.padding,h=i.getAllItems(),a=i.group,l=i.box;i.itemX=r,i.itemY=i.initialItemY,i.offsetWidth=0,i.lastItemY=0,i.widthOption=relativeLength(n.width,s.spacingBox.width-r),e=s.spacingBox.width-2*r-n.x,-1<["rm","lm"].indexOf(i.getAlignment().substring(0,2))&&(e/=2),i.maxLegendWidth=i.widthOption||e,a||(i.group=a=o.g("legend").addClass(n.className||"").attr({zIndex:7}).add(),i.contentGroup=o.g().attr({zIndex:1}).add(a),i.scrollGroup=o.g().add(i.contentGroup)),i.renderTitle(),stableSort(h,function(t,e){return(t.options&&t.options.legendIndex||0)-(e.options&&e.options.legendIndex||0)}),n.reversed&&h.reverse(),i.allItems=h,i.display=t=!!h.length,i.lastLineHeight=0,i.maxItemWidth=0,i.totalItemWidth=0,i.itemHeight=0,h.forEach(i.renderItem,i),h.forEach(i.layoutItem,i),e=(i.widthOption||i.offsetWidth)+r,h=i.lastItemY+i.lastLineHeight+i.titleHeight,h=i.handleOverflow(h),h+=r,l||(i.box=l=o.rect().addClass("highcharts-legend-box").attr({r:n.borderRadius}).add(a),l.isNew=!0),s.styledMode||l.attr({stroke:n.borderColor,"stroke-width":n.borderWidth||0,fill:n.backgroundColor||"none"}).shadow(n.shadow),0<e&&0<h&&(l[l.isNew?"attr":"animate"](l.crisp.call({},{x:0,y:0,width:e,height:h},l.strokeWidth())),l.isNew=!1),l[t?"show":"hide"](),s.styledMode&&"none"===a.getStyle("display")&&(e=h=0),i.legendWidth=e,i.legendHeight=h,t&&i.align(),this.proximate||this.positionItems(),fireEvent(this,"afterRender")},t.prototype.align=function(t){void 0===t&&(t=this.chart.spacingBox);var e=this.chart,i=this.options,s=t.y;/(lth|ct|rth)/.test(this.getAlignment())&&0<e.titleOffset[0]?s+=e.titleOffset[0]:/(lbh|cb|rbh)/.test(this.getAlignment())&&0<e.titleOffset[2]&&(s-=e.titleOffset[2]),s!==t.y&&(t=merge(t,{y:s})),this.group.align(merge(i,{width:this.legendWidth,height:this.legendHeight,verticalAlign:this.proximate?"top":i.verticalAlign}),!0,t)},t.prototype.handleOverflow=function(t){function e(t){"number"==typeof t?x.attr({height:t}):x&&(s.clipRect=x.destroy(),s.contentGroup.clip()),s.contentGroup.div&&(s.contentGroup.div.style.clip=t?"rect("+c+"px,9999px,"+(c+t)+"px,0)":"auto")}function i(t){return s[t]=h.circle(0,0,1.3*f).translate(f/2,f/2).add(y),o.styledMode||s[t].attr("fill","rgba(0,0,0,0.0001)"),s[t]}var n,r,s=this,o=this.chart,h=o.renderer,a=this.options,l=a.y,d="top"===a.verticalAlign,c=this.padding,m=a.maxHeight,g=a.navigation,p=pick(g.animation,!0),f=g.arrowSize||12,u=this.pages,v=this.allItems,l=o.spacingBox.height+(d?-l:l)-c,y=this.nav,x=this.clipRect;return"horizontal"!==a.layout||"middle"===a.verticalAlign||a.floating||(l/=2),m&&(l=Math.min(l,m)),u.length=0,t&&0<l&&l<t&&!1!==g.enabled?(this.clipHeight=n=Math.max(l-20-this.titleHeight-c,0),this.currentPage=pick(this.currentPage,1),this.fullHeight=t,v.forEach(function(t,e){var i=t._legendItemPos[1],s=Math.round(t.legendItem.getBBox().height),o=u.length;(!o||i-u[o-1]>n&&(r||i)!==u[o-1])&&(u.push(r||i),o++),t.pageIx=o-1,r&&(v[e-1].pageIx=o-1),e===v.length-1&&i+s-u[o-1]>n&&s<=n&&(u.push(i),t.pageIx=o),i!==r&&(r=i)}),x||(x=s.clipRect=h.clipRect(0,c,9999,0),s.contentGroup.clip(x)),e(n),y||(this.nav=y=h.g().attr({zIndex:1}).add(this.group),this.up=h.symbol("triangle",0,0,f,f).add(y),i("upTracker").on("click",function(){s.scroll(-1,p)}),this.pager=h.text("",15,10).addClass("highcharts-legend-navigation"),o.styledMode||this.pager.css(g.style),this.pager.add(y),this.down=h.symbol("triangle-down",0,0,f,f).add(y),i("downTracker").on("click",function(){s.scroll(1,p)})),s.scroll(0),t=l):y&&(e(),this.nav=y.destroy(),this.scrollGroup.attr({translateY:1}),this.clipHeight=0),t},t.prototype.scroll=function(t,e){var i=this,s=this.chart,o=this.pages,n=o.length,r=this.clipHeight,h=this.options.navigation,a=this.pager,l=this.padding,d=this.currentPage+t;0<(d=n<d?n:d)&&(void 0!==e&&setAnimation(e,s),this.nav.attr({translateX:l,translateY:r+this.padding+7+this.titleHeight,visibility:"visible"}),[this.up,this.upTracker].forEach(function(t){t.attr({class:1===d?"highcharts-legend-nav-inactive":"highcharts-legend-nav-active"})}),a.attr({text:d+"/"+n}),[this.down,this.downTracker].forEach(function(t){t.attr({x:18+this.pager.getBBox().width,class:d===n?"highcharts-legend-nav-inactive":"highcharts-legend-nav-active"})},this),s.styledMode||(this.up.attr({fill:1===d?h.inactiveColor:h.activeColor}),this.upTracker.css({cursor:1===d?"default":"pointer"}),this.down.attr({fill:d===n?h.inactiveColor:h.activeColor}),this.downTracker.css({cursor:d===n?"default":"pointer"})),this.scrollOffset=-o[d-1]+this.initialItemY,this.scrollGroup.animate({translateY:this.scrollOffset}),this.currentPage=d,this.positionCheckboxes(),s=animObject(pick(e,s.renderer.globalAnimation,!0)),syncTimeout(function(){fireEvent(i,"afterScroll",{currentPage:d})},s.duration))},t.prototype.setItemEvents=function(s,e,t){function o(e){i.allItems.forEach(function(t){s!==t&&[t].concat(t.linkedSeries||[]).forEach(function(t){t.setState(e,!r)})})}var i=this,n=i.chart.renderer.boxWrapper,r=s instanceof Point,h="highcharts-legend-"+(r?"point":"series")+"-active",a=i.chart.styledMode,t=t?[e,s.legendSymbol]:[s.legendGroup];t.forEach(function(t){t&&t.on("mouseover",function(){s.visible&&o("inactive"),s.setState("hover"),s.visible&&n.addClass(h),a||e.css(i.options.itemHoverStyle)}).on("mouseout",function(){i.chart.styledMode||e.css(merge(s.visible?i.itemStyle:i.itemHiddenStyle)),o(""),n.removeClass(h),s.setState()}).on("click",function(t){function e(){s.setVisible&&s.setVisible(),o(s.visible?"inactive":"")}var i="legendItemClick";n.removeClass(h),t={browserEvent:t},s.firePointEvent?s.firePointEvent(i,t,e):fireEvent(s,i,t,e)})})},t.prototype.createCheckboxForItem=function(e){e.checkbox=createElement("input",{type:"checkbox",className:"highcharts-legend-checkbox",checked:e.selected,defaultChecked:e.selected},this.options.itemCheckboxStyle,this.chart.container),addEvent(e.checkbox,"click",function(t){t=t.target;fireEvent(e.series||e,"checkboxClick",{checked:t.checked,item:e},function(){e.select()})})},t}();(/Trident\/7\.0/.test(win.navigator&&win.navigator.userAgent)||isFirefox)&&wrap(Legend.prototype,"positionItem",function(t,e){function i(){e._legendItemPos&&t.call(s,e)}var s=this;i(),s.bubbleLegend||setTimeout(i)});export default Legend;