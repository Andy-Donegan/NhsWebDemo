"use strict";import Axis from"../Core/Axis/Axis.js";import Chart from"../Core/Chart/Chart.js";import F from"../Core/FormatUtilities.js";var format=F.format;import H from"../Core/Globals.js";import Series from"../Core/Series/Series.js";import StackingAxis from"../Core/Axis/StackingAxis.js";import U from"../Core/Utilities.js";var correctFloat=U.correctFloat,defined=U.defined,destroyObjectProperties=U.destroyObjectProperties,isArray=U.isArray,isNumber=U.isNumber,objectEach=U.objectEach,pick=U.pick,StackItem=function(){function t(t,i,e,s,o){var a=t.chart.inverted;this.axis=t,this.isNegative=e,this.options=i=i||{},this.x=s,this.total=null,this.points={},this.hasValidPoints=!1,this.stack=o,this.leftCliff=0,this.rightCliff=0,this.alignOptions={align:i.align||(a?e?"left":"right":"center"),verticalAlign:i.verticalAlign||(a?"middle":e?"bottom":"top"),y:i.y,x:i.x},this.textAlign=i.textAlign||(a?e?"right":"left":"center")}return t.prototype.destroy=function(){destroyObjectProperties(this,this.axis)},t.prototype.render=function(t){var i=this.axis.chart,e=this.options,s=e.format,o={},s=s?format(s,this,i):e.formatter.call(this);this.label?this.label.attr({text:s,visibility:"hidden"}):(this.label=i.renderer.label(s,null,null,e.shape,null,null,e.useHTML,!1,"stack-labels"),o={r:e.borderRadius||0,text:s,rotation:e.rotation,padding:pick(e.padding,5),visibility:"hidden"},i.styledMode||(o.fill=e.backgroundColor,o.stroke=e.borderColor,o["stroke-width"]=e.borderWidth,this.label.css(e.style)),this.label.attr(o),this.label.added||this.label.add(t)),this.label.labelrank=i.plotSizeY},t.prototype.setOffset=function(t,i,e,s,o){var a=this,r=a.axis,n=r.chart,c=r.translate(r.stacking.usePercentage?100:s||a.total,0,0,0,1),l=r.translate(e||0),p=defined(c)&&Math.abs(c-l),s=pick(o,n.xAxis[0].translate(a.x))+t,e=defined(c)&&a.getStackBox(n,a,s,c,i,p,r),l=a.label,o=a.isNegative,t="justify"===pick(a.options.overflow,"justify"),s=a.textAlign;l&&e&&(c=l.getBBox(),i=l.padding,r=p=void 0,p="left"===s?n.inverted?-i:i:"right"===s?c.width:(!n.inverted||"center"!==s)&&n.inverted?o?c.width+i:-i:c.width/2,r=n.inverted?c.height/2:o?-i:c.height,a.alignOptions.x=pick(a.options.x,0),a.alignOptions.y=pick(a.options.y,0),e.x-=p,e.y-=r,l.align(a.alignOptions,null,e),n.isInsidePlot(l.alignAttr.x+p-a.alignOptions.x,l.alignAttr.y+r-a.alignOptions.y)?l.show():t=!(l.alignAttr.y=-9999),t&&Series.prototype.justifyDataLabel.call(this.axis,l,a.alignOptions,l.alignAttr,c,e),l.attr({x:l.alignAttr.x,y:l.alignAttr.y}),pick(!t&&a.options.crop,!0)&&(isNumber(l.x)&&isNumber(l.y)&&n.isInsidePlot(l.x-i+l.width,l.y)&&n.isInsidePlot(l.x+i,l.y)||l.hide()))},t.prototype.getStackBox=function(t,i,e,s,o,a,r){var n=i.axis.reversed,c=t.inverted,l=r.height+r.pos-(c?t.plotLeft:t.plotTop),n=i.isNegative&&!n||!i.isNegative&&n;return{x:c?n?s-r.right:s-a+r.pos-t.plotLeft:e+t.xAxis[0].transB-t.plotLeft,y:c?r.height-e-o:n?l-s-a:l-s,width:c?a:o,height:c?o:a}},t}();Chart.prototype.getStacks=function(){var e=this,s=e.inverted;e.yAxis.forEach(function(t){t.stacking&&t.stacking.stacks&&t.hasVisibleSeries&&(t.stacking.oldStacks=t.stacking.stacks)}),e.series.forEach(function(t){var i=t.xAxis&&t.xAxis.options||{};!t.options.stacking||!0!==t.visible&&!1!==e.options.chart.ignoreHiddenSeries||(t.stackKey=[t.type,pick(t.options.stack,""),s?i.top:i.left,s?i.height:i.width].join(","))})},StackingAxis.compose(Axis),Series.prototype.setGroupedPoints=function(){var e=this.yAxis.stacking;this.options.centerInCategory&&(this.is("column")||this.is("columnrange"))&&!this.options.stacking&&1<this.chart.series.length?Series.prototype.setStackedPoints.call(this,"group"):e&&objectEach(e.stacks,function(t,i){"group"===i.slice(-5)&&(objectEach(t,function(t){return t.destroy()}),delete e.stacks[i])})},Series.prototype.setStackedPoints=function(t){var i=t||this.options.stacking;if(i&&(!0===this.visible||!1===this.chart.options.chart.ignoreHiddenSeries)){var e,s,o,a,r,n,c,l=this,p=l.processedXData,h=l.processedYData,d=[],g=h.length,k=l.options,u=k.threshold,f=pick(k.startFromThreshold&&u,0),x=k.stack,y=t?l.type+","+i:l.stackKey,m="-"+y,b=l.negStacks,v=l.yAxis,S=v.stacking.stacks,A=v.stacking.oldStacks;for(v.stacking.stacksTouched+=1,r=0;r<g;r++)n=p[r],c=h[r],a=(e=l.getStackIndicator(e,n,l.index)).key,S[o=(s=b&&c<(f?0:u))?m:y]||(S[o]={}),S[o][n]||(A[o]&&A[o][n]?(S[o][n]=A[o][n],S[o][n].total=null):S[o][n]=new StackItem(v,v.options.stackLabels,s,n,x)),o=S[o][n],null!==c?(o.points[a]=o.points[l.index]=[pick(o.cumulative,f)],defined(o.cumulative)||(o.base=a),o.touched=v.stacking.stacksTouched,0<e.index&&!1===l.singleStacks&&(o.points[a][0]=o.points[l.index+","+n+",0"][0])):o.points[a]=o.points[l.index]=null,"percent"===i?(s=s?y:m,b&&S[s]&&S[s][n]?(s=S[s][n],o.total=s.total=Math.max(s.total,o.total)+Math.abs(c)||0):o.total=correctFloat(o.total+(Math.abs(c)||0))):"group"===i?null!==(c=isArray(c)?c[0]:c)&&(o.total=(o.total||0)+1):o.total=correctFloat(o.total+(c||0)),o.cumulative="group"===i?(o.total||1)-1:pick(o.cumulative,f)+(c||0),null!==c&&(o.points[a].push(o.cumulative),d[r]=o.cumulative,o.hasValidPoints=!0);"percent"===i&&(v.stacking.usePercentage=!0),"group"!==i&&(this.stackedYData=d),v.stacking.oldStacks={}}},Series.prototype.modifyStacks=function(){var o,a=this,t=a.yAxis,i=a.stackKey,r=t.stacking.stacks,n=a.processedXData,c=a.options.stacking;a[c+"Stacker"]&&[i,"-"+i].forEach(function(t){for(var i,e,s=n.length;s--;)e=n[s],o=a.getStackIndicator(o,e,a.index,t),(e=(i=r[t]&&r[t][e])&&i.points[o.key])&&a[c+"Stacker"](e,i,s)})},Series.prototype.percentStacker=function(t,i,e){i=i.total?100/i.total:0;t[0]=correctFloat(t[0]*i),t[1]=correctFloat(t[1]*i),this.stackedYData[e]=t[1]},Series.prototype.getStackIndicator=function(t,i,e,s){return!defined(t)||t.x!==i||s&&t.key!==s?t={x:i,index:0,key:s}:t.index++,t.key=[e,i,t.index].join(","),t},H.StackItem=StackItem;export default H.StackItem;