"use strict";import Chart from"../Core/Chart/Chart.js";import Color from"../Core/Color/Color.js";var color=Color.parse;import H from"../Core/Globals.js";var doc=H.doc,noop=H.noop;import Series from"../Core/Series/Series.js";import SeriesRegistry from"../Core/Series/SeriesRegistry.js";var seriesTypes=SeriesRegistry.seriesTypes;import U from"../Core/Utilities.js";var destroyLoadingDiv,addEvent=U.addEvent,extend=U.extend,fireEvent=U.fireEvent,isNumber=U.isNumber,merge=U.merge,pick=U.pick,wrap=U.wrap,CHUNK_SIZE=5e4,initCanvasBoost=function(){H.seriesTypes.heatmap&&wrap(H.seriesTypes.heatmap.prototype,"drawPoints",function(){var s=this.chart,a=this.getContext(),n=this.chart.inverted,c=this.xAxis,l=this.yAxis;a?(this.points.forEach(function(e){var t,o,r,i=e.plotY;void 0!==i&&!isNaN(i)&&null!==e.y&&a&&(t=void 0===(o=(r=e.shapeArgs||{}).x)?0:o,o=void 0===(i=r.y)?0:i,i=void 0===(i=r.width)?0:i,r=void 0===(r=r.height)?0:r,e=s.styledMode?e.series.colorAttribs(e):e.series.pointAttribs(e),a.fillStyle=e.fill,n?a.fillRect(l.len-o+c.left,c.len-t+l.top,-r,-i):a.fillRect(t+c.left,o+l.top,i,r))}),this.canvasToSVG()):this.chart.showLoading("Your browser doesn't support HTML5 canvas, <br>please use a modern browser")}),extend(Series.prototype,{getContext:function(){function t(e,t,o,r,i,s,a){e.call(this,o,t,r,i,s,a)}var o,e=this.chart,r=e.chartWidth,i=e.chartHeight,s=e.seriesGroup||this.group,a=this;return e.isChartSeriesBoosting()&&(s=(a=e).seriesGroup),o=a.ctx,a.canvas?Chart:(a.canvas=doc.createElement("canvas"),a.renderTarget=e.renderer.image("",0,0,r,i).addClass("highcharts-boost-canvas").add(s),a.ctx=o=a.canvas.getContext("2d"),e.inverted&&["moveTo","lineTo","rect","arc"].forEach(function(e){wrap(o,e,t)}),a.boostCopy=function(){a.renderTarget.attr({href:a.canvas.toDataURL("image/png")})},a.boostClear=function(){o.clearRect(0,0,a.canvas.width,a.canvas.height),a===this&&a.renderTarget.attr({href:""})},a.boostClipRect=e.renderer.clipRect(),a.renderTarget.clip(a.boostClipRect)),a.canvas.width!==r&&(a.canvas.width=r),a.canvas.height!==i&&(a.canvas.height=i),a.renderTarget.attr({x:0,y:0,width:r,height:i,style:"pointer-events: none",href:""}),a.boostClipRect.attr(e.getBoostClipRect(a)),o},canvasToSVG:function(){this.chart.isChartSeriesBoosting()?this.boostClear&&this.boostClear():(this.boostCopy||this.chart.boostCopy)&&(this.boostCopy||this.chart.boostCopy)()},cvsLineTo:function(e,t,o){e.lineTo(t,o)},renderCanvas:function(){function d(e,t,o,r){0===n&&(i.beginPath(),P&&(i.lineJoin="round")),T.scroller&&"highcharts-navigator-series"===b.options.className?(t+=T.scroller.top,o&&(o+=T.scroller.top)):t+=T.plotTop,e+=T.plotLeft,u?i.moveTo(e,t):N?N(i,e,t,o,s):P?P(i,e,t):A&&A.call(b,i,e,t,h,r),(n+=1)===G&&(z(),n=0),s={clientX:e,plotY:t,yBottom:o}}function v(e,t,o){a=J?e:e+","+t,L&&!p[a]&&(p[a]=!0,T.inverted&&(e=x.len-e,t=S.len-t),r.push({x:!!F&&F[O+o],clientX:e,plotX:e,plotY:t,i:O+o}))}var i,g,r,s,u,y,f,m,C,a,b=this,e=b.options,T=b.chart,x=this.xAxis,S=this.yAxis,t=T.options.boost||{},o=t.timeRendering||!1,n=(t.timeSeriesProcessing,t.timeSetup,0),c=b.processedXData,w=b.processedYData,l=e.data,t=x.getExtremes(),k=t.min,D=t.max,t=S.getExtremes(),E=t.min,M=t.max,p={},R=!!b.sampling,h=e.marker&&e.marker.radius,N=this.cvsDrawPoint,P=e.lineWidth?this.cvsLineTo:void 0,A=h&&h<=1?this.cvsMarkerSquare:this.cvsMarkerCircle,G=this.cvsStrokeBatch||1e3,L=!1!==e.enableMouseTracking,t=e.threshold,B=S.getThreshold(t),X=isNumber(t),j=B,Y=this.fill,I=b.pointArrayMap&&"low,high"===b.pointArrayMap.join(","),K=!!e.stacking,O=b.cropStart||0,t=T.options.loading,V=b.requireSorting,W=e.connectNulls,q=!c,_=K?b.data:c||l,Z=b.fillOpacity?Color.parse(b.color).setOpacity(pick(e.fillOpacity,.75)).get():b.color,z=function(){Y?(i.fillStyle=Z,i.fill()):(i.strokeStyle=b.color,i.lineWidth=e.lineWidth,i.stroke())},J="x"===e.findNearestPointBy,F=this.xData||this.options.xData||this.processedXData||!1;this.renderTarget&&this.renderTarget.attr({href:""}),(this.points||this.graph)&&this.destroyGraphics(),b.plotGroup("group","series",b.visible?"visible":"hidden",e.zIndex,T.seriesGroup),b.markerGroup=b.group,addEvent(b,"destroy",function(){b.markerGroup=null}),r=this.points=[],i=this.getContext(),b.buildKDTree=noop,this.boostClear&&this.boostClear(),this.visible&&(99999<l.length&&(T.options.loading=merge(t,{labelStyle:{backgroundColor:color("#ffffff").setOpacity(.75).get(),padding:"1em",borderRadius:"0.5em"},style:{backgroundColor:"none",opacity:1}}),U.clearTimeout(destroyLoadingDiv),T.showLoading("Drawing..."),T.options.loading=t),o&&console.time("canvas rendering"),H.eachAsync(_,function(e,t){var o,r,i,s,a=!1,n=!1,c=!1,l=!1,p=void 0===T.index,h=!0;return p||(q?(r=e[0],o=e[1],_[t+1]&&(c=_[t+1][0]),_[t-1]&&(l=_[t-1][0])):(r=e,o=w[t],_[t+1]&&(c=_[t+1]),_[t-1]&&(l=_[t-1])),c&&k<=c&&c<=D&&(a=!0),l&&k<=l&&l<=D&&(n=!0),I?(s=(o=q?e.slice(1,3):o)[0],o=o[1]):K&&(r=e.x,s=(o=e.stackY)-e.y),V||(h=E<=o&&o<=M),!(e=null===o)&&(k<=r&&r<=D&&h||a||n)&&(r=Math.round(x.toPixels(r,!0)),R?(void 0!==m&&r!==g||(I||(s=o),(void 0===C||f<o)&&(f=o,C=t),(void 0===m||s<y)&&(y=s,m=t)),r!==g&&(void 0!==m&&(i=S.toPixels(f,!0),B=S.toPixels(y,!0),d(r,X?Math.min(i,j):i,X?Math.max(B,j):B,t),v(r,i,C),B!==i&&v(r,B,m)),m=C=void 0,g=r)):(i=Math.round(S.toPixels(o,!0)),d(r,i,B,t),v(r,i,t))),u=e&&!W,t%CHUNK_SIZE==0&&(b.boostCopy||b.chart.boostCopy)&&(b.boostCopy||b.chart.boostCopy)()),!p},function(){var e=T.loadingDiv,t=T.loadingShown;z(),b.canvasToSVG(),o&&console.timeEnd("canvas rendering"),fireEvent(b,"renderedCanvas"),t&&(extend(e.style,{transition:"opacity 250ms",opacity:0}),T.loadingShown=!1,destroyLoadingDiv=setTimeout(function(){e.parentNode&&e.parentNode.removeChild(e),T.loadingDiv=T.loadingSpan=null},250)),delete b.buildKDTree,b.buildKDTree()},T.renderer.forExport?Number.MAX_VALUE:void 0))}}),seriesTypes.scatter.prototype.cvsMarkerCircle=function(e,t,o,r){e.moveTo(t,o),e.arc(t,o,r,0,2*Math.PI,!1)},seriesTypes.scatter.prototype.cvsMarkerSquare=function(e,t,o,r){e.rect(t-r,o-r,2*r,2*r)},seriesTypes.scatter.prototype.fill=!0,seriesTypes.bubble&&(seriesTypes.bubble.prototype.cvsMarkerCircle=function(e,t,o,r,i){e.moveTo(t,o),e.arc(t,o,this.radii&&this.radii[i],0,2*Math.PI,!1)},seriesTypes.bubble.prototype.cvsStrokeBatch=1),extend(seriesTypes.area.prototype,{cvsDrawPoint:function(e,t,o,r,i){i&&t!==i.clientX&&(e.moveTo(i.clientX,i.yBottom),e.lineTo(i.clientX,i.plotY),e.lineTo(t,o),e.lineTo(t,r))},fill:!0,fillOpacity:!0,sampling:!0}),extend(seriesTypes.column.prototype,{cvsDrawPoint:function(e,t,o,r){e.rect(t-1,o,1,r-o)},fill:!0,sampling:!0}),Chart.prototype.callbacks.push(function(e){addEvent(e,"predraw",function(){e.renderTarget&&e.renderTarget.attr({href:""}),e.canvas&&e.canvas.getContext("2d").clearRect(0,0,e.canvas.width,e.canvas.height)}),addEvent(e,"render",function(){e.boostCopy&&e.boostCopy()})})};export default initCanvasBoost;