"use strict";import Earcon from"./Earcon.js";import Point from"../../Core/Series/Point.js";import SeriesSonify from"./SeriesSonify.js";import SU from"./SonificationUtilities.js";var getExtremesForInstrumentProps=SU.getExtremesForInstrumentProps,virtualAxisTranslate=SU.virtualAxisTranslate;import Timeline from"./Timeline.js";import TimelineEvent from"./TimelineEvent.js";import TimelinePath from"./TimelinePath.js";import U from"../../Core/Utilities.js";var addEvent=U.addEvent,extend=U.extend,merge=U.merge,pick=U.pick,splat=U.splat;function buildPathOrder(e,s,r){var i;return"sequential"===e||"simultaneous"===e?(i=s.series.reduce(function(e,i){return i.visible&&!1!==(i.options.sonification&&i.options.sonification.enabled)&&e.push({series:i,seriesOptions:r(i)}),e},[]),"simultaneous"===e&&(i=[i])):i=e.reduce(function(e,i){i=splat(i).reduce(function(e,i){var t,n;return"string"==typeof i?(n=s.get(i)).visible&&(t={series:n,seriesOptions:r(n)}):i instanceof Earcon&&(t=new TimelinePath({events:[new TimelineEvent({eventObject:i})]})),(t=i.silentWait?new TimelinePath({silentWait:i.silentWait}):t)&&e.push(t),e},[]);return i.length&&e.push(i),e},[]),i}function addAfterSeriesWaits(n,s){return s?n.reduce(function(e,i,t){i=splat(i);return e.push(i),t<n.length-1&&i.some(function(e){return e.series})&&e.push(new TimelinePath({silentWait:s})),e},[]):n}function getWaitTime(e){return e.reduce(function(e,i){i=splat(i);return e+(1===i.length&&i[0].options&&i[0].options.silentWait||0)},0)}function syncSimultaneousPaths(e){var s=e.reduce(function(e,i){i=i.events;return i&&i.length&&(e.min=Math.min(i[0].time,e.min),e.max=Math.max(i[i.length-1].time,e.max)),e},{min:1/0,max:-1/0});e.forEach(function(e){var i=e.events,t=i&&i.length,n=[];t&&i[0].time<=s.min||n.push(new TimelineEvent({time:s.min})),t&&i[i.length-1].time>=s.max||n.push(new TimelineEvent({time:s.max})),n.length&&e.addTimelineEvents(n)})}function getSimulPathDurationTotal(e){return e.reduce(function(e,i){return e+splat(i).reduce(function(e,i){i=i.series&&i.seriesOptions&&i.seriesOptions.timeExtremes;return i?Math.max(e,i.max-i.min):e},0)},0)}function getSeriesDurationMs(e,i,t){return virtualAxisTranslate(e,{min:0,max:i},{min:0,max:t})}function buildPathsFromOrder(e,i){var t=Math.max(i-getWaitTime(e),0),n=getSimulPathDurationTotal(e);return e.reduce(function(e,i){i=splat(i).reduce(function(e,i){return i instanceof TimelinePath?e.push(i):i.series&&(i.seriesOptions.duration=i.seriesOptions.duration||getSeriesDurationMs(i.seriesOptions.timeExtremes.max-i.seriesOptions.timeExtremes.min,n,t),e.push(SeriesSonify.buildTimelinePathFromSeries(i.series,i.seriesOptions))),e},[]);return e.push(i),e},[])}function getChartSonifyOptions(e,i){e=e.options.sonification||{};return merge({duration:e.duration,afterSeriesWait:e.afterSeriesWait,pointPlayTime:e.defaultInstrumentOptions&&e.defaultInstrumentOptions.mapping&&e.defaultInstrumentOptions.mapping.pointPlayTime,order:e.order,onSeriesStart:e.events&&e.events.onSeriesStart,onSeriesEnd:e.events&&e.events.onSeriesEnd,onEnd:e.events&&e.events.onEnd},i)}function chartSonify(e){var i=getChartSonifyOptions(this,e);this.sonification.timeline&&this.sonification.timeline.pause(),this.sonification.duration=i.duration;var t=getExtremesForInstrumentProps(this,i.instruments,i.dataExtremes),e=buildPathsFromOrder(addAfterSeriesWaits(buildPathOrder(i.order,this,function(e){return SeriesSonify.buildChartSonifySeriesOptions(e,t,i)}),i.afterSeriesWait||0),i.duration);e.forEach(function(e){syncSimultaneousPaths(e)}),this.sonification.timeline=new Timeline({paths:e,onEnd:i.onEnd}),this.sonification.timeline.play()}function getCurrentPoints(){var i;return this.sonification.timeline?(i=this.sonification.timeline.getCursor(),Object.keys(i).map(function(e){return i[e].options.eventObject}).filter(function(e){return e instanceof Point})):[]}function setCursor(e){var i=this.sonification.timeline;i&&splat(e).forEach(function(e){i.setCursor(e.id)})}function pause(e){this.sonification.timeline?this.sonification.timeline.pause(pick(e,!0)):this.sonification.currentlyPlayingPoint&&this.sonification.currentlyPlayingPoint.cancelSonify(e)}function resume(e){this.sonification.timeline&&this.sonification.timeline.play(e)}function rewind(e){this.sonification.timeline&&this.sonification.timeline.rewind(e)}function cancel(e){this.pauseSonify(e),this.resetSonifyCursor()}function resetCursor(){this.sonification.timeline&&this.sonification.timeline.resetCursor()}function resetCursorEnd(){this.sonification.timeline&&this.sonification.timeline.resetCursorEnd()}var composedClasses=[];function compose(e){var i;return-1===composedClasses.indexOf(e)&&(composedClasses.push(e),i=e.prototype,extend(i,{sonify:chartSonify,pauseSonify:pause,resumeSonify:resume,rewindSonify:rewind,cancelSonify:cancel,getCurrentSonifyPoints:getCurrentPoints,setSonifyCursor:setCursor,resetSonifyCursor:resetCursor,resetSonifyCursorEnd:resetCursorEnd}),addEvent(e,"init",function(){this.sonification={}}),addEvent(e,"update",function(e){e=e.options.sonification;e&&merge(!0,this.options.sonification,e)})),e}var ChartSonify={chartSonify:chartSonify,compose:compose,pause:pause,resume:resume,rewind:rewind,cancel:cancel,getCurrentPoints:getCurrentPoints,setCursor:setCursor,resetCursor:resetCursor,resetCursorEnd:resetCursorEnd};export default ChartSonify;