"use strict";import Earcon from"./Earcon.js";import Instrument from"./Instrument.js";import Point from"../../Core/Series/Point.js";import SU from"./SonificationUtilities.js";var getExtremesForInstrumentProps=SU.getExtremesForInstrumentProps,virtualAxisTranslate=SU.virtualAxisTranslate;import Timeline from"./Timeline.js";import TimelineEvent from"./TimelineEvent.js";import TimelinePath from"./TimelinePath.js";import U from"../../Core/Utilities.js";var SeriesSonify,extend=U.extend,find=U.find,isArray=U.isArray,merge=U.merge,objectEach=U.objectEach,pick=U.pick;!function(n){var i=[];function o(n,r){var t,i,e,o,s=r.timeExtremes||f(n,r.pointPlayTime),a=getExtremesForInstrumentProps(n.chart,r.instruments,r.dataExtremes),m=(i=r.instruments,e=a,o=n.points[n.points.length-1],i.reduce(function(n,t){t=t.instrumentMapping.duration,t="string"==typeof t?0:"function"==typeof t?t(o,e):t;return Math.max(n,t)},0)),u=pick(r.masterVolume,1),i=r.instruments.map(function(n){var t=n.instrument,t=("string"==typeof t?Instrument.definitions[t]:t).copy();return merge(n,{instrument:t})}),p=(t=u,(i=i).forEach(function(n){n=n.instrument;"string"!=typeof n&&n.setMasterVolume(t)}),i),i=n.points.reduce(function(n,t){var o,i=(o=t,(r.earcons||[]).reduce(function(n,t){var i,e=t.earcon;return t.condition?(i=t.condition(o))instanceof Earcon?n.push(i):i&&n.push(e):t.onPoint&&o.id===t.onPoint&&n.push(e),n},[])),e=virtualAxisTranslate(c(t,r.pointPlayTime),s,{min:0,max:Math.max(r.duration-m,10)});return n.concat(new TimelineEvent({eventObject:t,time:e,id:t.id,playOptions:{instruments:p,dataExtremes:a,masterVolume:u}}),i.map(function(n){return new TimelineEvent({eventObject:n,time:e,playOptions:{volume:u}})}))},[]);return new TimelinePath({events:i,onStart:function(){r.onStart&&r.onStart(n)},onEventStart:function(n){var t=n.options&&n.options.eventObject;if(t instanceof Point){if(!t.series.visible&&!t.series.chart.series.some(function(n){return n.visible}))return n.timelinePath.timeline.pause(),n.timelinePath.timeline.resetCursor(),!1;r.onPointStart&&r.onPointStart(n,t)}},onEventEnd:function(n){var t=n.event&&n.event.options&&n.event.options.eventObject;t instanceof Point&&r.onPointEnd&&r.onPointEnd(n.event,t)},onEnd:function(){r.onEnd&&r.onEnd(n)},targetDuration:r.duration})}function s(n){var t=n.options.sonification||{},i=n.chart.options.sonification||{},e=i.events||{},o=t.events||{};return{onEnd:o.onSeriesEnd||e.onSeriesEnd,onStart:o.onSeriesStart||e.onSeriesStart,onPointEnd:o.onPointEnd||e.onPointEnd,onPointStart:o.onPointStart||e.onPointStart,pointPlayTime:i.defaultInstrumentOptions&&i.defaultInstrumentOptions.mapping&&i.defaultInstrumentOptions.mapping.pointPlayTime,masterVolume:i.masterVolume,instruments:function(n,t){if(t&&t.instruments)return t.instruments;function i(i){objectEach(i,function(n,t){null===n&&delete i[t]})}var e=n.chart.options.sonification&&n.chart.options.sonification.defaultInstrumentOptions||{},n=n.options.sonification&&n.options.sonification.instruments||[{}];return n.map(function(n){return i(n.mapping||{}),i(n),{instrument:n.instrument||e.instrument,instrumentOptions:merge(e,n,{mapping:void 0,instrument:void 0}),instrumentMapping:merge(e.mapping,n.mapping)}})}(n),earcons:t.earcons||i.earcons}}function c(n,t){return"function"==typeof t?t(n):pick(n[t],n.options[t])}function f(n,i){return n.points.reduce(function(n,t){t=c(t,i);return n.min=Math.min(n.min,t),n.max=Math.max(n.max,t),n},{min:1/0,max:-1/0})}function e(n){var t,i,e,e=(i=n,e=(t=this).chart.options.sonification,n=t.options.sonification,merge({duration:n&&n.duration||e&&e.duration},s(t),i)),t=o(this,e),i=this.chart.sonification;i&&(i.timeline&&i.timeline.pause(),i.duration=e.duration,i.timeline=new Timeline({paths:[t]}),i.timeline.play())}n.compose=function(n){var t;return-1===i.indexOf(n)&&(i.push(n),t=n.prototype,extend(t,{sonify:e})),n},n.buildChartSonifySeriesOptions=function(t,n,i){var e=i.seriesOptions||{},o=(r=t.chart.options.sonification)&&r.defaultInstrumentOptions&&r.defaultInstrumentOptions.mapping&&r.defaultInstrumentOptions.mapping.pointPlayTime||"x",r=s(t);return merge(r,{dataExtremes:n,timeExtremes:f(t,o),instruments:i.instruments||r.instruments,onStart:i.onSeriesStart||r.onStart,onEnd:i.onSeriesEnd||r.onEnd,earcons:i.earcons||r.earcons,masterVolume:pick(i.masterVolume,r.masterVolume)},isArray(e)?find(e,function(n){return n.id===pick(t.id,t.options.id)})||{}:e,{pointPlayTime:o})},n.buildTimelinePathFromSeries=o}(SeriesSonify=SeriesSonify||{});export default SeriesSonify;