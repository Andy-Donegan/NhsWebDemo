"use strict";import TimelineEvent from"./TimelineEvent.js";import SU from"./SonificationUtilities.js";import U from"../../Core/Utilities.js";var merge=U.merge,uniqueKey=U.uniqueKey,TimelinePath=function(){function t(t){this.cursor=void 0,this.events=void 0,this.eventIdMap=void 0,this.eventsPlaying=void 0,this.id=void 0,this.options=void 0,this.signalHandler=void 0,this.init(t)}return t.prototype.init=function(t){this.options=t,this.id=this.options.id=t.id||uniqueKey(),this.cursor=0,this.eventsPlaying={},this.events=t.silentWait?[new TimelineEvent({time:0}),new TimelineEvent({time:t.silentWait})]:this.options.events,this.targetDuration=t.targetDuration||t.silentWait,this.sortEvents(),this.updateEventIdMap(),this.signalHandler=new SU.SignalHandler(["playOnEnd","masterOnEnd","onStart","onEventStart","onEventEnd"]),this.signalHandler.registerSignalCallbacks(merge(t,{masterOnEnd:t.onEnd}))},t.prototype.sortEvents=function(){this.events=this.events.sort(function(t,n){return t.time-n.time})},t.prototype.updateEventIdMap=function(){this.eventIdMap=this.events.reduce(function(t,n,e){return t[n.id]=e,t},{})},t.prototype.addTimelineEvents=function(t){this.events=this.events.concat(t),this.sortEvents(),this.updateEventIdMap()},t.prototype.getCursor=function(){return this.events[this.cursor]},t.prototype.setCursor=function(t){t=this.eventIdMap[t];return void 0!==t&&(this.cursor=t,!0)},t.prototype.play=function(t){this.pause(),this.signalHandler.emitSignal("onStart"),this.signalHandler.clearSignalCallbacks(["playOnEnd"]),this.signalHandler.registerSignalCallbacks({playOnEnd:t}),this.playEvents(1)},t.prototype.rewind=function(t){this.pause(),this.signalHandler.emitSignal("onStart"),this.signalHandler.clearSignalCallbacks(["playOnEnd"]),this.signalHandler.registerSignalCallbacks({playOnEnd:t}),this.playEvents(-1)},t.prototype.resetCursor=function(){this.cursor=0},t.prototype.resetCursorEnd=function(){this.cursor=this.events.length-1},t.prototype.pause=function(n){var e=this;clearTimeout(e.nextScheduledPlay),Object.keys(e.eventsPlaying).forEach(function(t){e.eventsPlaying[t]&&e.eventsPlaying[t].cancel(n)}),e.eventsPlaying={}},t.prototype.playEvents=function(t){function n(t){i.signalHandler.emitSignal("masterOnEnd",t),i.signalHandler.emitSignal("playOnEnd",t)}var e,i=this,s=i.events[this.cursor],a=i.events[this.cursor+t];!1!==(s.timelinePath=i).signalHandler.emitSignal("onEventStart",s)?((i.eventsPlaying[s.id]=s).play({onEnd:function(t){t={event:s,cancelled:!!t};delete i.eventsPlaying[s.id],i.signalHandler.emitSignal("onEventEnd",t),a||n(t)}}),a&&((e=Math.abs(a.time-s.time))<1?(i.cursor+=t,i.playEvents(t)):this.nextScheduledPlay=setTimeout(function(){i.cursor+=t,i.playEvents(t)},e))):n({event:s,cancelled:!0})},t}();export default TimelinePath;