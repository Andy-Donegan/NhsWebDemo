"use strict";import H from"../../Core/Globals.js";var win=H.win;import Sonification from"./Sonification.js";import SU from"./SonificationUtilities.js";import U from"../../Core/Utilities.js";var error=U.error,merge=U.merge,pick=U.pick,uniqueKey=U.uniqueKey,Instrument=function(){function n(t){this.id=void 0,this.masterVolume=void 0,this.options=void 0,this.playCallbackTimers=void 0,this.init(t)}return n.prototype.init=function(t){var i;this.initAudioContext()?(this.options=merge(n.defaultOptions,t),this.id=this.options.id=t&&t.id||uniqueKey(),this.masterVolume=this.options.masterVolume||0,i=n.audioContext,t=this.destinationNode||i.destination,this.gainNode=i.createGain(),this.setGain(0),this.panNode=i.createStereoPanner&&i.createStereoPanner(),this.panNode?(this.setPan(0),this.gainNode.connect(this.panNode),this.panNode.connect(t)):this.gainNode.connect(t),"oscillator"===this.options.type&&this.initOscillator(this.options.oscillator),this.playCallbackTimers=[]):error(29)},n.prototype.copy=function(t){return new n(merge(this.options,{id:null},t))},n.prototype.initAudioContext=function(){var t=win.AudioContext||win.webkitAudioContext,i=!!n.audioContext;return!!t&&(n.audioContext=n.audioContext||new t,!i&&n.audioContext&&"running"===n.audioContext.state&&n.audioContext.suspend(),!!(n.audioContext&&n.audioContext.createOscillator&&n.audioContext.createGain))},n.prototype.initOscillator=function(t){var i=n.audioContext;this.oscillator=i.createOscillator(),this.oscillator.type=t.waveformShape,this.oscillator.connect(this.gainNode),this.oscillatorStarted=!1},n.prototype.setPan=function(t){this.panNode&&this.panNode.pan.setValueAtTime(t,n.audioContext.currentTime)},n.prototype.setGain=function(t,i){var e=this.gainNode,t=t*this.masterVolume;e&&(1.2<t&&(console.warn("Highcharts sonification warning: Volume of instrument set too high."),t=1.2),i?(e.gain.setValueAtTime(e.gain.value,n.audioContext.currentTime),e.gain.linearRampToValueAtTime(t,n.audioContext.currentTime+i/1e3)):e.gain.setValueAtTime(t,n.audioContext.currentTime))},n.prototype.cancelGainRamp=function(){this.gainNode&&this.gainNode.gain.cancelScheduledValues(0)},n.prototype.setMasterVolume=function(t){this.masterVolume=t||0},n.prototype.getValidFrequency=function(e,t,i){var o=this.options.allowedFrequencies,a=pick(i,1/0),n=pick(t,-1/0);return o&&o.length?o.reduce(function(t,i){return Math.abs(i-e)<Math.abs(t-e)&&i<a&&n<i?i:t},1/0):e},n.prototype.clearPlayCallbackTimers=function(){this.playCallbackTimers.forEach(function(t){clearInterval(t)}),this.playCallbackTimers=[]},n.prototype.setFrequency=function(t,i){i=i||{},i=this.getValidFrequency(t,i.min,i.max);"oscillator"===this.options.type&&this.oscillatorPlay(i)},n.prototype.oscillatorPlay=function(t){this.oscillatorStarted||(this.oscillator.start(),this.oscillatorStarted=!0),this.oscillator.frequency.setValueAtTime(t,n.audioContext.currentTime)},n.prototype.preparePlay=function(){this.setGain(.001),"suspended"===n.audioContext.state&&n.audioContext.resume(),this.oscillator&&!this.oscillatorStarted&&(this.oscillator.start(),this.oscillatorStarted=!0)},n.prototype.play=function(t){function i(i,e,o){var a,n=t.duration,s=l.options.playCallbackInterval,r=0;"function"==typeof i?(a=setInterval(function(){var t=++r*s/n;1<=t?(l[e](i(1),o),clearInterval(a)):l[e](i(t),o)},s),l.playCallbackTimers.push(a)):l[e](i,o)}var l=this,e=t.duration||0;if(l.id){if("suspended"===n.audioContext.state||this.oscillator&&!this.oscillatorStarted)return l.preparePlay(),void setTimeout(function(){l.play(t)},10);l.playCallbackTimers.length&&l.clearPlayCallbackTimers(),l.cancelGainRamp(),l.stopOscillatorTimeout&&(clearTimeout(l.stopOscillatorTimeout),delete l.stopOscillatorTimeout),l.stopTimeout&&(clearTimeout(l.stopTimeout),delete l.stopTimeout,l.stopCallback&&(l._play=l.play,l.play=function(){},l.stopCallback("cancelled"),l.play=l._play));var o=e<Sonification.fadeOutDuration+20;l.stopCallback=t.onEnd;var a=function(){delete l.stopTimeout,l.stop(o)};e?(l.stopTimeout=setTimeout(a,o?e:e-Sonification.fadeOutDuration),i(t.frequency,"setFrequency",{minFrequency:t.minFrequency,maxFrequency:t.maxFrequency}),i(pick(t.volume,1),"setGain",4),i(pick(t.pan,0),"setPan")):a()}},n.prototype.mute=function(){this.setGain(1e-4,.8*Sonification.fadeOutDuration)},n.prototype.stop=function(t,i,e){function o(){if(a.stopOscillatorTimeout&&delete a.stopOscillatorTimeout,a.oscillator&&a.options.oscillator){try{a.oscillator.stop()}catch(t){}a.gainNode&&a.oscillator.disconnect(a.gainNode),a.initOscillator(a.options.oscillator)}i&&i(e),a.stopCallback&&a.stopCallback(e)}var a=this;a.playCallbackTimers.length&&a.clearPlayCallbackTimers(),a.stopTimeout&&clearTimeout(a.stopTimeout),t?(a.setGain(0),o()):(a.mute(),a.stopOscillatorTimeout=setTimeout(o,Sonification.fadeOutDuration+100))},n.defaultOptions={type:"oscillator",playCallbackInterval:20,masterVolume:1,oscillator:{waveformShape:"sine"}},n.definitions={},n}();["sine","square","triangle","sawtooth"].forEach(function(t){Instrument.definitions[t]=new Instrument({oscillator:{waveformShape:t}}),Instrument.definitions[t+"Musical"]=new Instrument({allowedFrequencies:SU.musicalFrequencies,oscillator:{waveformShape:t}}),Instrument.definitions[t+"Major"]=new Instrument({allowedFrequencies:SU.getMusicalScale([1,3,5,6,8,10,12]),oscillator:{waveformShape:t}})});export default Instrument;