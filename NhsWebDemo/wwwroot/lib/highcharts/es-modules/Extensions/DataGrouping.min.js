"use strict";import Axis from"../Core/Axis/Axis.js";import DateTimeAxis from"../Core/Axis/DateTimeAxis.js";import F from"../Core/FormatUtilities.js";var format=F.format;import H from"../Core/Globals.js";import Point from"../Core/Series/Point.js";import Series from"../Core/Series/Series.js";var seriesProto=Series.prototype;import Tooltip from"../Core/Tooltip.js";import D from"../Core/DefaultOptions.js";import U from"../Core/Utilities.js";var addEvent=U.addEvent,arrayMax=U.arrayMax,arrayMin=U.arrayMin,correctFloat=U.correctFloat,defined=U.defined,error=U.error,extend=U.extend,isNumber=U.isNumber,merge=U.merge,pick=U.pick;import"../Core/Axis/Axis.js";var approximations=H.approximations={sum:function(t){var o,i=t.length;if(!i&&t.hasNulls)o=null;else if(i)for(o=0;i--;)o+=t[i];return o},average:function(t){var o=t.length,t=approximations.sum(t);return t=isNumber(t)&&o?correctFloat(t/o):t},averages:function(){var o=[];return[].forEach.call(arguments,function(t){o.push(approximations.average(t))}),void 0===o[0]?void 0:o},open:function(t){return t.length?t[0]:t.hasNulls?null:void 0},high:function(t){return t.length?arrayMax(t):t.hasNulls?null:void 0},low:function(t){return t.length?arrayMin(t):t.hasNulls?null:void 0},close:function(t){return t.length?t[t.length-1]:t.hasNulls?null:void 0},hlc:function(t,o,i){if(t=approximations.high(t),o=approximations.low(o),i=approximations.close(i),isNumber(t)||isNumber(o)||isNumber(i))return[t,o,i]},ohlc:function(t,o,i,a){if(t=approximations.open(t),o=approximations.high(o),i=approximations.low(i),a=approximations.close(a),isNumber(t)||isNumber(o)||isNumber(i)||isNumber(a))return[t,o,i,a]},range:function(t,o){return t=approximations.low(t),o=approximations.high(o),isNumber(t)||isNumber(o)?[t,o]:null===t&&null===o?null:void 0}},applyGrouping=function(t){var o,i=this,a=i.chart,e=i.options.dataGrouping,r=!1!==i.allowDG&&e&&pick(e.enabled,a.options.isStock),n=i.visible||!a.options.chart.ignoreHiddenSeries,s=this.currentDataGrouping,p=!1;if(r&&!i.requireSorting&&(i.requireSorting=p=!0),g=!1===skipDataGrouping(i,t)||!r,p&&(i.requireSorting=!1),!g){i.destroyGroupedData();var u=void 0,l=e.groupAll?i.xData:i.processedXData,d=e.groupAll?i.yData:i.processedYData,h=a.plotSizeX,t=i.xAxis,r=t.options.ordinal,p=i.groupPixelWidth;if(p&&l&&l.length){i.isDirty=o=!0,i.points=null;var m=t.getExtremes(),g=m.min,m=m.max,r=p*(m-g)/h*(r&&t.ordinal&&t.ordinal.getGroupIntervalFactor(g,m,i)||1),c=t.getTimeTicks(DateTimeAxis.Additions.prototype.normalizeTimeTickInterval(r,e.units||defaultDataGroupingUnits),Math.min(g,l[0]),Math.max(m,l[l.length-1]),t.options.startOfWeek,l,i.closestPointRange),g=seriesProto.groupData.apply(i,[l,d,c,e.approximation]),l=g.groupedXData,d=g.groupedYData,f=0;for(e&&e.smoothed&&l.length&&(e.firstAnchor="firstPoint",e.anchor="middle",e.lastAnchor="lastPoint",error(32,!1,a,{"dataGrouping.smoothed":"use dataGrouping.anchor"})),anchorPoints(i,l,m),u=1;u<c.length;u++)c.info.segmentStarts&&-1!==c.info.segmentStarts.indexOf(u)||(f=Math.max(c[u]-c[u-1],f));(m=c.info).gapSize=f,i.closestPointRange=c.info.totalRange,i.groupMap=g.groupMap,n&&adjustExtremes(t,l),e.groupAll&&(i.allGroupedData=d,l=(t=i.cropData(l,d,t.min,t.max,1)).xData,d=t.yData,i.cropStart=t.start),i.processedXData=l,i.processedYData=d}else i.groupMap=null;i.hasGroupedData=o,i.currentDataGrouping=m,i.preventGraphAnimation=(s&&s.totalRange)!==(m&&m.totalRange)}},skipDataGrouping=function(t,o){return!(t.isCartesian&&!t.isDirty&&!t.xAxis.isDirty&&!t.yAxis.isDirty&&!o)},groupData=function(t,o,i,a){var e,r,n,s,p,u,l=this,d=l.data,h=l.options&&l.options.data,m=[],g=[],c=[],f=t.length,x=!!o,D=[],G=l.pointArrayMap,y=G&&G.length,b=["x"].concat(G||["y"]),v=this.options.dataGrouping&&this.options.dataGrouping.groupAll,A=0,M=0;for(n="function"==typeof(u=a)?u:approximations[u]||approximations[l.getDGApproximation&&l.getDGApproximation()||"average"],y?G.forEach(function(){D.push([])}):D.push([]),s=y||1,p=0;p<=f&&!(t[p]>=i[0]);p++);for(;p<=f;p++){for(;void 0!==i[A+1]&&t[p]>=i[A+1]||p===f;){for(e=i[A],l.dataGroupInfo={start:v?M:l.cropStart+M,length:D[0].length},r=n.apply(l,D),l.pointClass&&!defined(l.dataGroupInfo.options)&&(l.dataGroupInfo.options=merge(l.pointClass.prototype.optionsToObject.call({series:l},l.options.data[l.cropStart+M])),b.forEach(function(t){delete l.dataGroupInfo.options[t]})),void 0!==r&&(m.push(e),g.push(r),c.push(l.dataGroupInfo)),M=p,k=0;k<s;k++)D[k].length=0,D[k].hasNulls=!1;if(A+=1,p===f)break}if(p===f)break;if(G)for(var P,N=l.options.dataGrouping&&l.options.dataGrouping.groupAll?p:l.cropStart+p,S=d&&d[N]||l.pointClass.prototype.applyOptions.apply({series:l},[h[N]]),k=0;k<y;k++)P=S[G[k]],isNumber(P)?D[k].push(P):null===P&&(D[k].hasNulls=!0);else N=x?o[p]:null,isNumber(N)?D[0].push(N):null===N&&(D[0].hasNulls=!0)}return{groupedXData:m,groupedYData:g,groupMap:c}},anchorPoints=function(t,o,i){var a=t.options.dataGrouping,e=t.currentDataGrouping&&t.currentDataGrouping.gapSize;if(a&&t.xData&&e&&t.groupMap){var r,n=o.length-1,s=a.anchor,p=pick(a.firstAnchor,s),u=pick(a.lastAnchor,s);if(s&&"start"!==s)for(var l=e*{middle:.5,end:1}[s],d=o.length-1;d--&&0<d;)o[d]+=l;p&&"start"!==p&&t.xData[0]>=o[0]&&(r=t.groupMap[0].start,a=t.groupMap[0].length,s=void 0,isNumber(r)&&isNumber(a)&&(s=r+(a-1)),o[0]={middle:o[0]+.5*e,end:o[0]+e,firstPoint:t.xData[0],lastPoint:s&&t.xData[s]}[p]),u&&"start"!==u&&e&&o[n]>=i-e&&(i=t.groupMap[t.groupMap.length-1].start,o[n]={middle:o[n]+.5*e,end:o[n]+e,firstPoint:i&&t.xData[i],lastPoint:t.xData[t.xData.length-1]}[u])}},adjustExtremes=function(t,o){defined(o[0])&&isNumber(t.min)&&isNumber(t.dataMin)&&o[0]<t.min&&((!defined(t.options.min)&&t.min<=t.dataMin||t.min===t.dataMin)&&(t.min=Math.min(o[0],t.min)),t.dataMin=Math.min(o[0],t.dataMin)),defined(o[o.length-1])&&isNumber(t.max)&&isNumber(t.dataMax)&&o[o.length-1]>t.max&&((!defined(t.options.max)&&isNumber(t.dataMax)&&t.max>=t.dataMax||t.max===t.dataMax)&&(t.max=Math.max(o[o.length-1],t.max)),t.dataMax=Math.max(o[o.length-1],t.dataMax))},dataGrouping={approximations:approximations,groupData:groupData},baseProcessData=seriesProto.processData,baseGeneratePoints=seriesProto.generatePoints,commonOptions={groupPixelWidth:2,dateTimeLabelFormats:{millisecond:["%A, %b %e, %H:%M:%S.%L","%A, %b %e, %H:%M:%S.%L","-%H:%M:%S.%L"],second:["%A, %b %e, %H:%M:%S","%A, %b %e, %H:%M:%S","-%H:%M:%S"],minute:["%A, %b %e, %H:%M","%A, %b %e, %H:%M","-%H:%M"],hour:["%A, %b %e, %H:%M","%A, %b %e, %H:%M","-%H:%M"],day:["%A, %b %e, %Y","%A, %b %e","-%A, %b %e, %Y"],week:["Week from %A, %b %e, %Y","%A, %b %e","-%A, %b %e, %Y"],month:["%B %Y","%B","-%B %Y"],year:["%Y","%Y","-%Y"]}},specificOptions={line:{},spline:{},area:{},areaspline:{},arearange:{},column:{groupPixelWidth:10},columnrange:{groupPixelWidth:10},candlestick:{groupPixelWidth:10},ohlc:{groupPixelWidth:5},hlc:{groupPixelWidth:5},heikinashi:{groupPixelWidth:10}},defaultDataGroupingUnits=H.defaultDataGroupingUnits=[["millisecond",[1,2,5,10,20,25,50,100,200,500]],["second",[1,2,5,10,15,30]],["minute",[1,2,5,10,15,30]],["hour",[1,2,3,4,6,8,12]],["day",[1]],["week",[1]],["month",[1,3,6]],["year",null]];seriesProto.getDGApproximation=function(){return this.is("arearange")?"range":this.is("ohlc")?"ohlc":this.is("hlc")?"hlc":this.is("column")?"sum":"average"},seriesProto.groupData=groupData,seriesProto.applyGrouping=applyGrouping,seriesProto.destroyGroupedData=function(){this.groupedData&&(this.groupedData.forEach(function(t,o){t&&(this.groupedData[o]=t.destroy?t.destroy():null)},this),this.groupedData.length=0)},seriesProto.generatePoints=function(){baseGeneratePoints.apply(this),this.destroyGroupedData(),this.groupedData=this.hasGroupedData?this.points:null},Axis.prototype.applyGrouping=function(o){var i=this;i.series.forEach(function(t){t.groupPixelWidth=void 0,t.groupPixelWidth=i.getGroupPixelWidth&&i.getGroupPixelWidth(),t.groupPixelWidth&&(t.hasProcessed=!0),t.applyGrouping(!!o.hasExtemesChanged)})},Axis.prototype.getGroupPixelWidth=function(){for(var t,o,i=this.series,a=i.length,e=0,r=!1,n=a;n--;)(o=i[n].options.dataGrouping)&&(e=Math.max(e,pick(o.groupPixelWidth,commonOptions.groupPixelWidth)));for(n=a;n--;)(o=i[n].options.dataGrouping)&&(t=(i[n].processedXData||i[n].data).length,(i[n].groupPixelWidth||t>this.chart.plotSizeX/e||t&&o.forced)&&(r=!0));return r?e:0},Axis.prototype.setDataGrouping=function(o,t){var i;if(t=pick(t,!0),o=o||{forced:!1,units:null},this instanceof Axis)for(i=this.series.length;i--;)this.series[i].update({dataGrouping:o},!1);else this.chart.options.series.forEach(function(t){t.dataGrouping=o},!1);this.ordinal&&(this.ordinal.slope=void 0),t&&this.chart.redraw()},addEvent(Axis,"postProcessData",Axis.prototype.applyGrouping),addEvent(Point,"update",function(){if(this.dataGroup)return error(24,!1,this.series.chart),!1}),addEvent(Tooltip,"headerFormatter",function(t){var o,i,a=this.chart,e=a.time,r=t.labelConfig,n=r.series,s=n.options,p=n.tooltipOptions,u=s.dataGrouping,l=p.xDateFormat,d=n.xAxis,h=p[t.isFooter?"footerFormat":"headerFormat"];d&&"datetime"===d.options.type&&u&&isNumber(r.key)&&(i=n.currentDataGrouping,s=u.dateTimeLabelFormats||commonOptions.dateTimeLabelFormats,i?(u=s[i.unitName],1===i.count?l=u[0]:(l=u[1],o=u[2])):!l&&s&&d.dateTime&&(l=d.dateTime.getXDateFormat(r.x,p.dateTimeLabelFormats)),l=e.dateFormat(l,r.key),o&&(l+=e.dateFormat(o,r.key+i.totalRange-1)),n.chart.styledMode&&(h=this.styledModeFormat(h)),t.text=format(h,{point:extend(r.point,{key:l}),series:n},a),t.preventDefault())}),addEvent(Series,"destroy",seriesProto.destroyGroupedData),addEvent(Series,"afterSetOptions",function(t){var o=t.options,i=this.type,a=this.chart.options.plotOptions,e=D.defaultOptions.plotOptions[i].dataGrouping,r=this.useCommonDataGrouping&&commonOptions;a&&(specificOptions[i]||r)&&(e=e||merge(commonOptions,specificOptions[i]),t=this.chart.rangeSelector,o.dataGrouping=merge(r,e,a.series&&a.series.dataGrouping,a[i].dataGrouping,this.userOptions.dataGrouping,!o.isInternal&&t&&isNumber(t.selected)&&t.buttonOptions[t.selected].dataGrouping))}),addEvent(Axis,"afterSetScale",function(){this.series.forEach(function(t){t.hasProcessed=!1})});export default H.dataGrouping=dataGrouping;