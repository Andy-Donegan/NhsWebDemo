import AST from"../../Core/Renderer/HTML/AST.js";import H from"../../Core/Globals.js";var doc=H.doc,isFirefox=H.isFirefox;import NavigationBindings from"./NavigationBindings.js";import D from"../../Core/DefaultOptions.js";var getOptions=D.getOptions;import Pointer from"../../Core/Pointer.js";import U from"../../Core/Utilities.js";var DropdownProperties,addEvent=U.addEvent,createElement=U.createElement,defined=U.defined,fireEvent=U.fireEvent,isArray=U.isArray,isObject=U.isObject,objectEach=U.objectEach,pick=U.pick,stableSort=U.stableSort,wrap=U.wrap,indexFilter=/\d/g,PREFIX="highcharts-",A="a",DIV="div",INPUT="input",LABEL="label",BUTTON="button",SELECT="select",OPTION="option",SPAN="span",UL="ul",LI="li",H3="h3";!function(t){t[t["params.algorithm"]=0]="params.algorithm",t[t["params.average"]=1]="params.average"}(DropdownProperties=DropdownProperties||{});var dropdownParameters={"algorithm-pivotpoints":["standard","fibonacci","camarilla"],"average-disparityindex":["sma","ema","dema","tema","wma"]};wrap(Pointer.prototype,"onContainerMouseDown",function(t,e){this.inClass(e.target,PREFIX+"popup")||t.apply(this,Array.prototype.slice.call(arguments,1))}),H.Popup=function(t,e,i){this.init(t,e,i)},H.Popup.prototype={init:function(t,e,i){this.chart=i,this.container=createElement(DIV,{className:PREFIX+"popup highcharts-no-tooltip"},void 0,t),addEvent(this.container,"mousedown",function(){var t,e=i&&i.navigationBindings&&i.navigationBindings.activeAnnotation;e&&(e.cancelClick=!0,t=addEvent(H.doc,"click",function(){setTimeout(function(){e.cancelClick=!1},0),t()}))}),this.lang=this.getLangpack(),this.iconsURL=e,this.addCloseBtn()},addCloseBtn:function(){var e=this,t=this.iconsURL,i=createElement(DIV,{className:PREFIX+"popup-close"},void 0,this.container);i.style["background-image"]="url("+(t.match(/png|svg|jpeg|jpg|gif/gi)?t:t+"close.svg")+")",["click","touchstart"].forEach(function(t){addEvent(i,t,function(){e.chart?fireEvent(e.chart.navigationBindings,"closePopup"):e.closePopup()})})},addColsContainer:function(t){var e=createElement(DIV,{className:PREFIX+"popup-lhs-col"},void 0,t),t=createElement(DIV,{className:PREFIX+"popup-rhs-col"},void 0,t);return createElement(DIV,{className:PREFIX+"popup-rhs-col-wrapper"},void 0,t),{lhsCol:e,rhsCol:t}},addInput:function(t,e,i,a){var o=t.split("."),n=o[o.length-1],o=this.lang,e=PREFIX+e+"-"+pick(a.htmlFor,n);return e.match(indexFilter)||createElement(LABEL,{htmlFor:e,className:a.labelClassName},void 0,i).appendChild(doc.createTextNode(o[n]||n)),(i=createElement(INPUT,{name:e,value:a.value,type:a.type,className:PREFIX+"popup-field"},void 0,i)).setAttribute(PREFIX+"data-name",t),i},addButton:function(t,e,i,a,o){var n=this,s=this.closePopup,r=this.getFields,l=createElement(BUTTON,void 0,void 0,t);return l.appendChild(doc.createTextNode(e)),o&&["click","touchstart"].forEach(function(t){addEvent(l,t,function(){return s.call(n),o(r(a,i))})}),l},getFields:function(t,e){var i=Array.prototype.slice.call(t.querySelectorAll(INPUT)),a=Array.prototype.slice.call(t.querySelectorAll(SELECT)),o="#"+PREFIX+"select-volume > option:checked",n=t.querySelectorAll("#"+PREFIX+"select-series > option:checked")[0],o=t.querySelectorAll(o)[0],s={actionType:e,linkedTo:n&&n.getAttribute("value")||"",fields:{}};return i.forEach(function(t){var e=t.getAttribute(PREFIX+"data-name");t.getAttribute(PREFIX+"data-series-id")?s.seriesId=t.value:e?s.fields[e]=t.value:s.type=t.value}),a.forEach(function(t){var e=t.id;e!==PREFIX+"select-series"&&e!==PREFIX+"select-volume"&&(e=e.split("highcharts-select-")[1],s.fields[e]=t.value)}),o&&(s.fields["params.volumeSeriesID"]=o.getAttribute("value")||""),s},showPopup:function(){var t=this.container,e=PREFIX+"annotation-toolbar",i=t.querySelectorAll("."+PREFIX+"popup-close")[0];this.formType=void 0,t.innerHTML=AST.emptyHTML,0<=t.className.indexOf(e)&&(t.classList.remove(e),t.removeAttribute("style")),t.appendChild(i),t.style.display="block",t.style.height=""},closePopup:function(){pick(this.popup&&this.popup.container,this.container).style.display="none"},showForm:function(t,e,i,a){e&&(this.popup=e.navigationBindings.popup,this.showPopup(),"indicators"===t&&this.indicators.addForm.call(this,e,i,a),"annotation-toolbar"===t&&this.annotations.addToolbar.call(this,e,i,a),"annotation-edit"===t&&this.annotations.addForm.call(this,e,i,a),"flag"===t&&this.annotations.addForm.call(this,e,i,a,!0),this.formType=t,this.container.style.height=this.container.offsetHeight+"px")},getLangpack:function(){return getOptions().lang.navigation.popup},annotations:{addToolbar:function(t,e,i){var a=this,o=this.lang,n=this.popup.container,s=this.showForm,r=PREFIX+"annotation-toolbar";-1===n.className.indexOf(r)&&(n.className+=" "+r),t&&(n.style.top=t.plotTop+10+"px"),createElement(SPAN,void 0,void 0,n).appendChild(doc.createTextNode(pick(o[e.langKey]||e.langKey,e.shapes&&e.shapes[0].type))),(r=this.addButton(n,o.removeButton||"remove","remove",n,i)).className+=" "+PREFIX+"annotation-remove-button",r.style["background-image"]="url("+this.iconsURL+"destroy.svg)",(r=this.addButton(n,o.editButton||"edit","edit",n,function(){s.call(a,"annotation-edit",t,e,i)})).className+=" "+PREFIX+"annotation-edit-button",r.style["background-image"]="url("+this.iconsURL+"edit.svg)"},addForm:function(t,e,i,a){var o,n,s=this.popup.container,r=this.lang;t&&((n=createElement("h2",{className:PREFIX+"popup-main-title"},void 0,s)).appendChild(doc.createTextNode(r[e.langKey]||e.langKey||"")),n=createElement(DIV,{className:PREFIX+"popup-lhs-col "+PREFIX+"popup-lhs-full"},void 0,s),o=createElement(DIV,{className:PREFIX+"popup-bottom-row"},void 0,s),this.annotations.addFormFields.call(this,n,t,"",e,[],!0),this.addButton(o,a?r.addButton||"add":r.saveButton||"save",a?"add":"save",s,i))},addFormFields:function(i,a,o,t,n,e){var s,r,l=this,c=this.annotations.addFormFields,d=this.addInput,p=this.lang;a&&(objectEach(t,function(t,e){s=""!==o?o+"."+e:e,isObject(t)&&(!isArray(t)||isArray(t)&&isObject(t[0])?((r=p[e]||e).match(indexFilter)||n.push([!0,r,i]),c.call(l,i,a,s,t,n,!1)):n.push([l,s,"annotation",i,t]))}),e&&(stableSort(n,function(t){return t[1].match(/format/g)?-1:1}),isFirefox&&n.reverse(),n.forEach(function(t){!0===t[0]?createElement(SPAN,{className:PREFIX+"annotation-title"},void 0,t[2]).appendChild(doc.createTextNode(t[1])):(t[4]={value:t[4][0],type:t[4][1]},d.apply(t[0],t.splice(1)))})))}},indicators:{addForm:function(t,e,i){var a,o,n=this.indicators,s=this.lang;t&&(this.tabs.init.call(this,t),a=this.popup.container.querySelectorAll("."+PREFIX+"tab-item-content"),this.addColsContainer(a[0]),n.addSearchBox.call(this,t,a[0]),n.addIndicatorList.call(this,t,a[0],"add"),o=a[0].querySelectorAll("."+PREFIX+"popup-rhs-col")[0],this.addButton(o,s.addButton||"add","add",o,i),this.addColsContainer(a[1]),n.addIndicatorList.call(this,t,a[1],"edit"),o=a[1].querySelectorAll("."+PREFIX+"popup-rhs-col")[0],this.addButton(o,s.saveButton||"save","edit",o,i),this.addButton(o,s.removeButton||"remove","remove",o,i))},filterSeries:function(t,n){var s,r=this.indicators,e=this.chart&&this.chart.options.lang,l=e&&e.navigation&&e.navigation.popup&&e.navigation.popup.indicatorAliases,c=[];return objectEach(t,function(t,e){var i,a,o=t.options;(t.params||o&&o.params)&&(i=(a=r.getNameType(t,e)).indicatorFullName,o=a.indicatorType,n?(e=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),a=new RegExp(e,"i"),e=l&&l[o]&&l[o].join(" ")||"",(i.match(a)||e.match(a))&&(s={indicatorFullName:i,indicatorType:o,series:t},c.push(s))):(s={indicatorFullName:i,indicatorType:o,series:t},c.push(s)))}),c},filterSeriesArray:function(t){var e,i=[];return t.forEach(function(t){t.options;t.is("sma")&&(e={indicatorFullName:t.name,indicatorType:t.type,series:t},i.push(e))}),i},addIndicatorList:function(o,t,e,i){var n,s,r,l=this,a=l.indicators,c=l.lang,d=t.querySelectorAll("."+PREFIX+"popup-lhs-col")[0],p=t.querySelectorAll("."+PREFIX+"popup-rhs-col")[0],h="edit"===e,u=this.indicators.addFormFields,t=h?o.series:o.options.plotOptions||{};!o&&t||(e=[],h||isArray(t)?isArray(t)&&(e=a.filterSeriesArray.call(this,t)):e=a.filterSeries.call(this,t,i),stableSort(e,function(t,e){t=t.indicatorFullName.toLowerCase(),e=e.indicatorFullName.toLowerCase();return t<e?-1:e<t?1:0}),d.children[1]&&d.children[1].remove(),s=createElement(UL,{className:PREFIX+"indicator-list"},void 0,d),n=p.querySelectorAll("."+PREFIX+"popup-rhs-col-wrapper")[0],e.forEach(function(t){var e=t.indicatorFullName,i=t.indicatorType,a=t.series;(r=createElement(LI,{className:PREFIX+"indicator-list"},void 0,s)).appendChild(doc.createTextNode(e)),["click","touchstart"].forEach(function(t){addEvent(r,t,function(){var t=n.parentNode.children[1];u.call(l,o,a,i,n),t&&(t.style.display="block"),h&&a.options&&createElement(INPUT,{type:"hidden",name:PREFIX+"id-"+i,value:a.options.id},void 0,n).setAttribute(PREFIX+"data-series-id",a.options.id)})})}),0<s.childNodes.length?s.childNodes[0].click():h||(AST.setElementHTML(n.parentNode.children[0],c.noFilterMatch||""),n.parentNode.children[1].style.display="none"))},addSearchBox:function(e,t){function i(t){a.indicators.addIndicatorList.call(a,e,a.container,"add",t)}var a=this,o=t.querySelectorAll("."+PREFIX+"popup-lhs-col")[0],t=this.lang.clearFilter,o=createElement(DIV,{className:"highcharts-input-wrapper"},void 0,o),n=this.addInput("searchIndicators",INPUT,o,{value:"",type:"text",htmlFor:"search-indicators",labelClassName:"highcharts-input-search-indicators-label"}),s=createElement(A,{textContent:t},void 0,o);n.classList.add("highcharts-input-search-indicators"),s.classList.add("clear-filter-button"),addEvent(n,"input",function(t){i(this.value),this.value.length?s.style.display="inline-block":s.style.display="none"}),["click","touchstart"].forEach(function(t){addEvent(s,t,function(){n.value="",i(""),s.style.display="none"})})},addSelection:function(t,e,i){var a=e.split("."),o=a[a.length-1],a=PREFIX+e+"-type-"+t,t=this.lang;return createElement(LABEL,{htmlFor:a},null,i).appendChild(doc.createTextNode(t[o]||e)),(i=createElement(SELECT,{name:a,className:PREFIX+"popup-field",id:PREFIX+"select-"+e},null,i)).setAttribute("id",PREFIX+"select-"+e),i},addSelectionOptions:function(t,a,o,e,i,n,s){"series"===a||"volume"===a?t.series.forEach(function(t){var e=t.options,i=e.name||e.params?t.name:e.id||"";e.id!==PREFIX+"navigator-series"&&e.id!==(s&&s.options&&s.options.id)&&(defined(n)||"volume"!==a||"column"!==t.type||(n=e.id),createElement(OPTION,{value:e.id},void 0,o).appendChild(doc.createTextNode(i)))}):e&&i&&dropdownParameters[i+"-"+e].forEach(function(t){createElement(OPTION,{value:t},void 0,o).appendChild(doc.createTextNode(t))}),defined(n)&&(o.value=n)},getNameType:function(t,e){var i=t.options,a=H.seriesTypes,a=a[e]&&a[e].prototype.nameBase||e.toUpperCase(),e=e;return i&&i.type&&(e=t.options.type,a=t.name),{indicatorFullName:a,indicatorType:e}},listAllSeries:function(t,e,i,a,o,n){var s=this.indicators;i&&(a=s.addSelection.call(this,t,e,a),s.addSelectionOptions.call(this,i,e,a,void 0,void 0,void 0,o),defined(n)&&(a.value=n))},addFormFields:function(t,e,i,a){var o=e.params||e.options.params,n=this.indicators.getNameType;a.innerHTML=AST.emptyHTML,createElement(H3,{className:PREFIX+"indicator-title"},void 0,a).appendChild(doc.createTextNode(n(e,i).indicatorFullName)),createElement(INPUT,{type:"hidden",name:PREFIX+"type-"+i,value:i},void 0,a),this.indicators.listAllSeries.call(this,i,"series",t,a,e,e.linkedParent&&e.linkedParent.options.id),o.volumeSeriesID&&this.indicators.listAllSeries.call(this,i,"volume",t,a,e,e.linkedParent&&o.volumeSeriesID),this.indicators.addParamInputs.call(this,t,"params",o,i,a)},addParamInputs:function(a,o,t,n,s){var r,l=this,c=l.indicators,d=this.indicators.addParamInputs,p=this.addInput;a&&objectEach(t,function(t,e){var i;r=o+"."+e,defined(t)&&r&&(isObject(t)&&(p.call(l,r,n,s,{}),d.call(l,a,r,t,n,s)),r in DropdownProperties?(i=c.addSelection.call(l,n,r,s),c.addSelectionOptions.call(l,a,o,i,n,e,t)):"params.volumeSeriesID"==r||isArray(t)||p.call(l,r,n,s,{value:t,type:"text"}))})},getAmount:function(){var t=this.series,i=0;return t.forEach(function(t){var e=t.options;(t.params||e&&e.params)&&i++}),i}},tabs:{init:function(t){var e=this.tabs,i=this.indicators.getAmount.call(t);t&&(t=e.addMenuItem.call(this,"add"),e.addMenuItem.call(this,"edit",i),e.addContentItem.call(this,"add"),e.addContentItem.call(this,"edit"),e.switchTabs.call(this,i),e.selectTab.call(this,t,0))},addMenuItem:function(t,e){var i=this.popup.container,a=PREFIX+"tab-item",o=this.lang;return 0===e&&(a+=" "+PREFIX+"tab-disabled"),(i=createElement(SPAN,{className:a},void 0,i)).appendChild(doc.createTextNode(o[t+"Button"]||t)),i.setAttribute(PREFIX+"data-tab-type",t),i},addContentItem:function(){var t=this.popup.container;return createElement(DIV,{className:PREFIX+"tab-item-content "+PREFIX+"no-mousewheel"},void 0,t)},switchTabs:function(t){var a=this;this.popup.container.querySelectorAll("."+PREFIX+"tab-item").forEach(function(e,i){"edit"===e.getAttribute(PREFIX+"data-tab-type")&&0===t||["click","touchstart"].forEach(function(t){addEvent(e,t,function(){a.tabs.deselectAll.call(a),a.tabs.selectTab.call(a,this,i)})})})},selectTab:function(t,e){var i=this.popup.container.querySelectorAll("."+PREFIX+"tab-item-content");t.className+=" "+PREFIX+"tab-item-active",i[e].className+=" "+PREFIX+"tab-item-show"},deselectAll:function(){for(var t=this.popup.container,e=t.querySelectorAll("."+PREFIX+"tab-item"),i=t.querySelectorAll("."+PREFIX+"tab-item-content"),a=0;a<e.length;a++)e[a].classList.remove(PREFIX+"tab-item-active"),i[a].classList.remove(PREFIX+"tab-item-show")}}},addEvent(NavigationBindings,"showPopup",function(t){this.popup||(this.popup=new H.Popup(this.chart.container,this.chart.options.navigation.iconsURL||this.chart.options.stockTools&&this.chart.options.stockTools.gui.iconsURL||"https://code.highcharts.com/9.3.3/gfx/stock-icons/",this.chart)),this.popup.showForm(t.formType,this.chart,t.options,t.onSubmit)}),addEvent(NavigationBindings,"closePopup",function(){this.popup&&this.popup.closePopup()});export default H.Popup;