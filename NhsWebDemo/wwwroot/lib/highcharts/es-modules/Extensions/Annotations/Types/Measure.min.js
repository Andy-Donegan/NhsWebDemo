"use strict";var __extends=this&&this.__extends||function(){var n=function(t,i){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var s in i)i.hasOwnProperty(s)&&(t[s]=i[s])})(t,i)};return function(t,i){function s(){this.constructor=t}n(t,i),t.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}}();import Annotation from"../Annotations.js";import ControlPoint from"../ControlPoint.js";import U from"../../../Core/Utilities.js";var defined=U.defined,extend=U.extend,isNumber=U.isNumber,merge=U.merge,pick=U.pick,Measure=function(s){function A(t,i){return s.call(this,t,i)||this}return __extends(A,s),A.prototype.init=function(t,i,s){Annotation.prototype.init.call(this,t,i,s),this.offsetX=0,this.offsetY=0,this.resizeX=0,this.resizeY=0,A.calculations.init.call(this),this.addValues(),this.addShapes()},A.prototype.setClipAxes=function(){this.clipXAxis=this.chart.xAxis[this.options.typeOptions.xAxis],this.clipYAxis=this.chart.yAxis[this.options.typeOptions.yAxis]},A.prototype.pointsOptions=function(){return this.options.points},A.prototype.shapePointsOptions=function(){var t=this.options.typeOptions,i=t.xAxis,t=t.yAxis;return[{x:this.xAxisMin,y:this.yAxisMin,xAxis:i,yAxis:t},{x:this.xAxisMax,y:this.yAxisMin,xAxis:i,yAxis:t},{x:this.xAxisMax,y:this.yAxisMax,xAxis:i,yAxis:t},{x:this.xAxisMin,y:this.yAxisMax,xAxis:i,yAxis:t}]},A.prototype.addControlPoints=function(){var t=this.chart.inverted,i=this.options.controlPointOptions,s=this.options.typeOptions.selectType;defined(this.userOptions.controlPointOptions&&this.userOptions.controlPointOptions.style.cursor)||("x"===s?i.style.cursor=t?"ns-resize":"ew-resize":"y"===s&&(i.style.cursor=t?"ew-resize":"ns-resize")),t=new ControlPoint(this.chart,this,this.options.controlPointOptions,0),this.controlPoints.push(t),"xy"!==s&&(t=new ControlPoint(this.chart,this,this.options.controlPointOptions,1),this.controlPoints.push(t))},A.prototype.addValues=function(t){var s=this.options.typeOptions,i=s.label.formatter;A.calculations.recalculate.call(this,t),s.label.enabled&&(0<this.labels.length?this.labels[0].text=i&&i.call(this)||A.calculations.defaultFormatter.call(this):this.initLabel(extend({shape:"rect",backgroundColor:"none",color:"black",borderWidth:0,dashStyle:"Dash",overflow:"allow",align:"left",y:0,x:0,verticalAlign:"top",crop:!0,xAxis:0,yAxis:0,point:function(t){var i=t.annotation,t=t.options;return{x:i.xAxisMin,y:i.yAxisMin,xAxis:pick(s.xAxis,t.xAxis),yAxis:pick(s.yAxis,t.yAxis)}},text:i&&i.call(this)||A.calculations.defaultFormatter.call(this)},s.label),void 0))},A.prototype.addShapes=function(){this.addCrosshairs(),this.addBackground()},A.prototype.addBackground=function(){void 0!==this.shapePointsOptions()[0].x&&this.initShape(extend({type:"path",points:this.shapePointsOptions()},this.options.typeOptions.background),2)},A.prototype.addCrosshairs=function(){var t=this.chart,i=this.options.typeOptions,s=this.options.typeOptions.point,n=t.xAxis[i.xAxis],o=t.yAxis[i.yAxis],a=t.inverted,e=n.toPixels(this.xAxisMin),r=n.toPixels(this.xAxisMax),h=o.toPixels(this.yAxisMin),t=o.toPixels(this.yAxisMax),n={point:s,type:"path"},o=[],s=[];a&&(a=e,e=h,h=a,a=r,r=t,t=a),i.crosshairX.enabled&&(o=[["M",e,h+(t-h)/2],["L",r,h+(t-h)/2]]),i.crosshairY.enabled&&(s=[["M",e+(r-e)/2,h],["L",e+(r-e)/2,t]]),0<this.shapes.length?(this.shapes[0].options.d=o,this.shapes[1].options.d=s):(t=merge(n,i.crosshairX),i=merge(n,i.crosshairY),this.initShape(extend({d:o},t),0),this.initShape(extend({d:s},i),1))},A.prototype.onDrag=function(t){var i=this.mouseMoveToTranslation(t),s=this.options.typeOptions.selectType,t="y"===s?0:i.x,i="x"===s?0:i.y;this.translate(t,i),this.offsetX+=t,this.offsetY+=i,this.redraw(!1,!1,!0)},A.prototype.resize=function(t,i,s,n){var o=this.shapes[2];"x"===n?0===s?(o.translatePoint(t,0,0),o.translatePoint(t,i,3)):(o.translatePoint(t,0,1),o.translatePoint(t,i,2)):"y"===n?0===s?(o.translatePoint(0,i,0),o.translatePoint(0,i,1)):(o.translatePoint(0,i,2),o.translatePoint(0,i,3)):(o.translatePoint(t,0,1),o.translatePoint(t,i,2),o.translatePoint(0,i,3)),A.calculations.updateStartPoints.call(this,!1,!0,s,t,i),this.options.typeOptions.background.height=Math.abs(this.startYMax-this.startYMin),this.options.typeOptions.background.width=Math.abs(this.startXMax-this.startXMin)},A.prototype.redraw=function(t,i,s){this.linkPoints(),this.graphic||this.render(),s&&A.calculations.updateStartPoints.call(this,!0,!1),this.clipRect&&this.clipRect.animate(this.getClipBox()),this.addValues(i),this.addCrosshairs(),this.redrawItems(this.shapes,t),this.redrawItems(this.labels,t),this.controlPoints.forEach(function(t){t.redraw()})},A.prototype.translate=function(i,s){this.shapes.forEach(function(t){t.translate(i,s)}),this.options.typeOptions.point.x=this.startXMin,this.options.typeOptions.point.y=this.startYMin},A.calculations={init:function(){var t=this.options.typeOptions,i=this.chart,s=A.calculations.getPointPos,n=i.inverted,o=i.xAxis[t.xAxis],a=i.yAxis[t.yAxis],e=t.background,r=n?e.height:e.width,h=n?e.width:e.height,i=t.selectType,e=n?o.left:a.top,n=n?a.top:o.left;this.startXMin=t.point.x,this.startYMin=t.point.y,isNumber(r)?this.startXMax=this.startXMin+r:this.startXMax=s(o,this.startXMin,parseFloat(r)),isNumber(h)?this.startYMax=this.startYMin-h:this.startYMax=s(a,this.startYMin,parseFloat(h)),"x"===i?(this.startYMin=a.toValue(e),this.startYMax=a.toValue(e+a.len)):"y"===i&&(this.startXMin=o.toValue(n),this.startXMax=o.toValue(n+o.len))},recalculate:function(t){var i=A.calculations,s=this.options.typeOptions,n=this.chart.xAxis[s.xAxis],o=this.chart.yAxis[s.yAxis],a=A.calculations.getPointPos,e=this.offsetX,s=this.offsetY;this.xAxisMin=a(n,this.startXMin,e),this.xAxisMax=a(n,this.startXMax,e),this.yAxisMin=a(o,this.startYMin,s),this.yAxisMax=a(o,this.startYMax,s),this.min=i.min.call(this),this.max=i.max.call(this),this.average=i.average.call(this),this.bins=i.bins.call(this),t&&this.resize(0,0)},getPointPos:function(t,i,s){return t.toValue(t.toPixels(i)+s)},updateStartPoints:function(t,i,s,n,o){var a=this.options.typeOptions,e=a.selectType,r=this.chart.xAxis[a.xAxis],h=this.chart.yAxis[a.yAxis],x=A.calculations.getPointPos,l=this.startXMin,p=this.startXMax,c=this.startYMin,y=this.startYMax,u=this.offsetX,a=this.offsetY;i&&("x"===e?0===s?this.startXMin=x(r,l,n):this.startXMax=x(r,p,n):"y"===e?0===s?this.startYMin=x(h,c,o):this.startYMax=x(h,y,o):(this.startXMax=x(r,p,n),this.startYMax=x(h,y,o))),t&&(this.startXMin=x(r,l,u),this.startXMax=x(r,p,u),this.startYMin=x(h,c,a),this.startYMax=x(h,y,a),this.offsetX=0,this.offsetY=0)},defaultFormatter:function(){return"Min: "+this.min+"<br>Max: "+this.max+"<br>Average: "+this.average+"<br>Bins: "+this.bins},getExtremes:function(t,i,s,n){return{xAxisMin:Math.min(i,t),xAxisMax:Math.max(i,t),yAxisMin:Math.min(n,s),yAxisMax:Math.max(n,s)}},min:function(){var i=1/0,t=this.chart.series,s=A.calculations.getExtremes(this.xAxisMin,this.xAxisMax,this.yAxisMin,this.yAxisMax),n=!1;return t.forEach(function(t){t.visible&&"highcharts-navigator-series"!==t.options.id&&t.points.forEach(function(t){!t.isNull&&t.y<i&&t.x>s.xAxisMin&&t.x<=s.xAxisMax&&t.y>s.yAxisMin&&t.y<=s.yAxisMax&&(i=t.y,n=!0)})}),i=!n?"":i},max:function(){var i=-1/0,t=this.chart.series,s=A.calculations.getExtremes(this.xAxisMin,this.xAxisMax,this.yAxisMin,this.yAxisMax),n=!1;return t.forEach(function(t){t.visible&&"highcharts-navigator-series"!==t.options.id&&t.points.forEach(function(t){!t.isNull&&t.y>i&&t.x>s.xAxisMin&&t.x<=s.xAxisMax&&t.y>s.yAxisMin&&t.y<=s.yAxisMax&&(i=t.y,n=!0)})}),i=!n?"":i},average:function(){var t="";return t=""!==this.max&&""!==this.min?(this.max+this.min)/2:t},bins:function(){var i=0,t=this.chart.series,s=A.calculations.getExtremes(this.xAxisMin,this.xAxisMax,this.yAxisMin,this.yAxisMax),n=!1;return t.forEach(function(t){t.visible&&"highcharts-navigator-series"!==t.options.id&&t.points.forEach(function(t){!t.isNull&&t.x>s.xAxisMin&&t.x<=s.xAxisMax&&t.y>s.yAxisMin&&t.y<=s.yAxisMax&&(i++,n=!0)})}),i=!n?"":i}},A}(Annotation);Measure.prototype.defaultOptions=merge(Annotation.prototype.defaultOptions,{typeOptions:{selectType:"xy",xAxis:0,yAxis:0,background:{fill:"rgba(130, 170, 255, 0.4)",strokeWidth:0,stroke:void 0},crosshairX:{enabled:!0,zIndex:6,dashStyle:"Dash",markerEnd:"arrow"},crosshairY:{enabled:!0,zIndex:6,dashStyle:"Dash",markerEnd:"arrow"},label:{enabled:!0,style:{fontSize:"11px",color:"#666666"},formatter:void 0}},controlPointOptions:{positioner:function(t){var i,s=this.index,n=t.chart,o=t.options,a=o.typeOptions,e=a.selectType,r=o.controlPointOptions,h=n.inverted,x=n.xAxis[a.xAxis],l=n.yAxis[a.yAxis],o=t.xAxisMax,n=t.yAxisMax,a=Measure.calculations.getExtremes(t.xAxisMin,t.xAxisMax,t.yAxisMin,t.yAxisMax);return"x"===e&&(n=(a.yAxisMax-a.yAxisMin)/2,0===s&&(o=t.xAxisMin)),"y"===e&&(o=a.xAxisMin+(a.xAxisMax-a.xAxisMin)/2,0===s&&(n=t.yAxisMin)),n=h?(i=l.toPixels(n),x.toPixels(o)):(i=x.toPixels(o),l.toPixels(n)),{x:i-r.width/2,y:n-r.height/2}},events:{drag:function(t,i){var s=this.mouseMoveToTranslation(t),n=i.options.typeOptions.selectType,o=this.index,t="y"===n?0:s.x,s="x"===n?0:s.y;i.resize(t,s,o,n),i.resizeX+=t,i.resizeY+=s,i.redraw(!1,!0)}}}});export default Annotation.types.measure=Measure;