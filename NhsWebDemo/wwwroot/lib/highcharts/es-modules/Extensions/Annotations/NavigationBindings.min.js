"use strict";import Annotation from"./Annotations.js";import Chart from"../../Core/Chart/Chart.js";import ChartNavigationComposition from"../../Core/Chart/ChartNavigationComposition.js";import F from"../../Core/FormatUtilities.js";var format=F.format;import H from"../../Core/Globals.js";import D from"../../Core/DefaultOptions.js";var setOptions=D.setOptions;import U from"../../Core/Utilities.js";var addEvent=U.addEvent,attr=U.attr,fireEvent=U.fireEvent,isArray=U.isArray,isFunction=U.isFunction,isNumber=U.isNumber,isObject=U.isObject,merge=U.merge,objectEach=U.objectEach,pick=U.pick,doc=H.doc,win=H.win,PREFIX="highcharts-";function closestPolyfill(t,n){var e=win.Element.prototype,i=e.matches||e.msMatchesSelector||e.webkitMatchesSelector,o=null;if(e.closest)o=e.closest.call(t,n);else do{if(i.call(t,n))return t}while(null!==(t=t.parentElement||t.parentNode)&&1===t.nodeType);return o}var bindingsUtils={getFieldType:function(t){return{string:"text",number:"number",boolean:"checkbox"}[typeof t]},updateRectSize:function(t,n){var e=n.chart,i=n.options.typeOptions,o=isNumber(i.xAxis)&&e.xAxis[i.xAxis],s=isNumber(i.yAxis)&&e.yAxis[i.yAxis];o&&s&&(o=o.toValue(t[o.horiz?"chartX":"chartY"]),s=s.toValue(t[s.horiz?"chartX":"chartY"]),o=o-i.point.x,s=i.point.y-s,n.update({typeOptions:{background:{width:e.inverted?s:o,height:e.inverted?o:s}}}))},getAssignedAxis:function(t){return t.filter(function(t){var n=t.axis.getExtremes(),e=n.min,i=n.max,n=pick(t.axis.minPointOffset,0);return isNumber(e)&&isNumber(i)&&t.value>=e-n&&t.value<=i+n&&!t.axis.options.isInternal})[0]}},NavigationBindings=function(){function t(t,n){this.boundClassNames=void 0,this.selectedButton=void 0,this.chart=t,this.options=n,this.eventsToUnbind=[],this.container=doc.getElementsByClassName(this.options.bindingsClassName||"")}return t.prototype.initEvents=function(){var i=this,n=i.chart,t=i.container,e=i.options;i.boundClassNames={},objectEach(e.bindings||{},function(t){i.boundClassNames[t.className]=t}),[].forEach.call(t,function(e){i.eventsToUnbind.push(addEvent(e,"click",function(t){var n=i.getButtonEvents(e,t);n&&-1===n.button.className.indexOf("highcharts-disabled-btn")&&i.bindingsButtonClick(n.button,n.events,t)}))}),objectEach(e.events||{},function(t,n){isFunction(t)&&i.eventsToUnbind.push(addEvent(i,n,t,{passive:!1}))}),i.eventsToUnbind.push(addEvent(n.container,"click",function(t){!n.cancelClick&&n.isInsidePlot(t.chartX-n.plotLeft,t.chartY-n.plotTop,{visiblePlotOnly:!0})&&i.bindingsChartClick(this,t)})),i.eventsToUnbind.push(addEvent(n.container,H.isTouchDevice?"touchmove":"mousemove",function(t){i.bindingsContainerMouseMove(this,t)},H.isTouchDevice?{passive:!1}:void 0))},t.prototype.initUpdate=function(){var n=this;ChartNavigationComposition.compose(this.chart).navigation.addUpdate(function(t){n.update(t)})},t.prototype.bindingsButtonClick=function(t,n,e){var i=this,o=i.chart,s=o.renderer.boxWrapper,a=!0;i.selectedButtonElement&&(i.selectedButtonElement.classList===t.classList&&(a=!1),fireEvent(i,"deselectButton",{button:i.selectedButtonElement}),i.nextEvent&&(i.currentUserDetails&&"annotations"===i.currentUserDetails.coll&&o.removeAnnotation(i.currentUserDetails),i.mouseMoveEvent=i.nextEvent=!1)),a?(i.selectedButton=n,i.selectedButtonElement=t,fireEvent(i,"selectButton",{button:t}),n.init&&n.init.call(i,t,e),(n.start||n.steps)&&o.renderer.boxWrapper.addClass(PREFIX+"draw-mode")):(o.stockTools&&o.stockTools.toggleButtonAciveClass(t),s.removeClass(PREFIX+"draw-mode"),i.nextEvent=!1,i.mouseMoveEvent=!1,i.selectedButton=null)},t.prototype.bindingsChartClick=function(t,n){t=this.chart;var e=this,i=e.activeAnnotation,o=e.selectedButton,t=t.renderer.boxWrapper;i&&(i.cancelClick||n.activeAnnotation||!n.target.parentNode||closestPolyfill(n.target,"."+PREFIX+"popup")?i.cancelClick&&setTimeout(function(){i.cancelClick=!1},0):fireEvent(e,"closePopup")),o&&o.start&&(e.nextEvent?(e.nextEvent(n,e.currentUserDetails),e.steps&&(e.stepIndex++,o.steps[e.stepIndex]?e.mouseMoveEvent=e.nextEvent=o.steps[e.stepIndex]:(fireEvent(e,"deselectButton",{button:e.selectedButtonElement}),t.removeClass(PREFIX+"draw-mode"),o.end&&o.end.call(e,n,e.currentUserDetails),e.nextEvent=!1,e.mouseMoveEvent=!1,e.selectedButton=null))):(e.currentUserDetails=o.start.call(e,n),e.currentUserDetails&&o.steps?(e.stepIndex=0,e.steps=!0,e.mouseMoveEvent=e.nextEvent=o.steps[e.stepIndex]):(fireEvent(e,"deselectButton",{button:e.selectedButtonElement}),t.removeClass(PREFIX+"draw-mode"),e.steps=!1,e.selectedButton=null,o.end&&o.end.call(e,n,e.currentUserDetails))))},t.prototype.bindingsContainerMouseMove=function(t,n){this.mouseMoveEvent&&this.mouseMoveEvent(n,this.currentUserDetails)},t.prototype.fieldsToOptions=function(t,e){return objectEach(t,function(i,t){var n=parseFloat(i),o=t.split("."),s=e,a=o.length-1;""!==(i=isNumber(n)&&!i.match(/px/g)&&!t.match(/format/g)?n:i)&&"undefined"!==i&&o.forEach(function(t,n){var e=pick(o[n+1],"");a===n?s[t]=i:s=s[t]||(s[t]=e.match(/\d/g)?[]:{},s[t])})}),e},t.prototype.deselectAnnotation=function(){this.activeAnnotation&&(this.activeAnnotation.setControlPointsVisibility(!1),this.activeAnnotation=!1)},t.prototype.annotationToFields=function(n){var i=n.options,o=t.annotationsEditable,a=o.nestedOptions,r=this.utils.getFieldType,s=pick(i.type,i.shapes&&i.shapes[0]&&i.shapes[0].type,i.labels&&i.labels[0]&&i.labels[0].itemType,"label"),l=t.annotationsNonEditable[i.langKey]||[],c={langKey:i.langKey,type:s};function p(t,i,e,o){var s;e&&t&&-1===l.indexOf(i)&&(0<=(e.indexOf&&e.indexOf(i))||e[i]||!0===e)&&(isArray(t)?(o[i]=[],t.forEach(function(t,e){isObject(t)?(o[i][e]={},objectEach(t,function(t,n){p(t,n,a[i],o[i][e])})):p(t,0,a[i],o[i])})):isObject(t)?(s={},isArray(o)?(o.push(s),s[i]={},s=s[i]):o[i]=s,objectEach(t,function(t,n){p(t,n,0===i?e:a[i],s)})):"format"===i?o[i]=[format(t,n.labels[0].points[0]).toString(),"text"]:isArray(o)?o.push([t,r(t)]):o[i]=[t,r(t)])}return objectEach(i,function(t,e){"typeOptions"===e?(c[e]={},objectEach(i[e],function(t,n){p(t,n,a,c[e])})):p(t,e,o[s],c)}),c},t.prototype.getClickedClassNames=function(t,n){for(var e,i=n.target,o=[];i;)if((e=attr(i,"class"))&&(o=o.concat(e.split(" ").map(function(t){return[t,i]}))),(i=i.parentNode)===t)return o;return o},t.prototype.getButtonEvents=function(t,n){var e,i=this;return this.getClickedClassNames(t,n).forEach(function(t){i.boundClassNames[t[0]]&&!e&&(e={events:i.boundClassNames[t[0]],button:t[1]})}),e},t.prototype.update=function(t){this.options=merge(!0,this.options,t),this.removeEvents(),this.initEvents()},t.prototype.removeEvents=function(){this.eventsToUnbind.forEach(function(t){t()})},t.prototype.destroy=function(){this.removeEvents()},t.annotationsEditable={nestedOptions:{labelOptions:["style","format","backgroundColor"],labels:["style"],label:["style"],style:["fontSize","color"],background:["fill","strokeWidth","stroke"],innerBackground:["fill","strokeWidth","stroke"],outerBackground:["fill","strokeWidth","stroke"],shapeOptions:["fill","strokeWidth","stroke"],shapes:["fill","strokeWidth","stroke"],line:["strokeWidth","stroke"],backgroundColors:[!0],connector:["fill","strokeWidth","stroke"],crosshairX:["strokeWidth","stroke"],crosshairY:["strokeWidth","stroke"]},circle:["shapes"],ellipse:["shapes"],verticalLine:[],label:["labelOptions"],measure:["background","crosshairY","crosshairX"],fibonacci:[],tunnel:["background","line","height"],pitchfork:["innerBackground","outerBackground"],rect:["shapes"],crookedLine:[],basicAnnotation:["shapes","labelOptions"]},t.annotationsNonEditable={rectangle:["crosshairX","crosshairY","labelOptions"],ellipse:["labelOptions"],circle:["labelOptions"]},t}();function selectableAnnotation(t){var o=t.prototype.defaultOptions.events&&t.prototype.defaultOptions.events.click;merge(!0,t.prototype.defaultOptions.events,{click:function(t){var e=this,i=e.chart.navigationBindings,n=i.activeAnnotation;o&&o.call(e,t),n!==e?(i.deselectAnnotation(),(i.activeAnnotation=e).setControlPointsVisibility(!0),fireEvent(i,"showPopup",{annotation:e,formType:"annotation-toolbar",options:i.annotationToFields(e),onSubmit:function(t){var n={};"remove"===t.actionType?(i.activeAnnotation=!1,i.chart.removeAnnotation(e)):(i.fieldsToOptions(t.fields,n),i.deselectAnnotation(),t=n.typeOptions,"measure"===e.options.type&&(t.crosshairY.enabled=0!==t.crosshairY.strokeWidth,t.crosshairX.enabled=0!==t.crosshairX.strokeWidth),e.update(n))}})):fireEvent(i,"closePopup"),t.activeAnnotation=!0}})}NavigationBindings.prototype.utils=bindingsUtils,Chart.prototype.initNavigationBindings=function(){var t=this,n=t.options;n&&n.navigation&&n.navigation.bindings&&(t.navigationBindings=new NavigationBindings(t,n.navigation),t.navigationBindings.initEvents(),t.navigationBindings.initUpdate())},addEvent(Chart,"load",function(){this.initNavigationBindings()}),addEvent(Chart,"destroy",function(){this.navigationBindings&&this.navigationBindings.destroy()}),addEvent(NavigationBindings,"deselectButton",function(){this.selectedButtonElement=null}),addEvent(Annotation,"remove",function(){this.chart.navigationBindings&&this.chart.navigationBindings.deselectAnnotation()}),H.Annotation&&(selectableAnnotation(Annotation),objectEach(Annotation.types,function(t){selectableAnnotation(t)})),setOptions({lang:{navigation:{popup:{simpleShapes:"Simple shapes",lines:"Lines",circle:"Circle",ellipse:"Ellipse",rectangle:"Rectangle",label:"Label",shapeOptions:"Shape options",typeOptions:"Details",fill:"Fill",format:"Text",strokeWidth:"Line width",stroke:"Line color",title:"Title",name:"Name",labelOptions:"Label options",labels:"Labels",backgroundColor:"Background color",backgroundColors:"Background colors",borderColor:"Border color",borderRadius:"Border radius",borderWidth:"Border width",style:"Style",padding:"Padding",fontSize:"Font size",color:"Color",height:"Height",shapes:"Shape options"}}},navigation:{bindingsClassName:"highcharts-bindings-container",bindings:{circleAnnotation:{className:"highcharts-circle-annotation",start:function(t){var n=this.chart.pointer.getCoordinates(t),e=this.utils.getAssignedAxis(n.xAxis),t=this.utils.getAssignedAxis(n.yAxis),n=this.chart.options.navigation;if(e&&t)return this.chart.addAnnotation(merge({langKey:"circle",type:"basicAnnotation",shapes:[{type:"circle",point:{x:e.value,y:t.value,xAxis:e.axis.options.index,yAxis:t.axis.options.index},r:5}]},n.annotationsOptions,n.bindings.circleAnnotation.annotationsOptions))},steps:[function(t,n){var e,i,o,s=n.options.shapes[0].point;isNumber(s.xAxis)&&isNumber(s.yAxis)&&(e=this.chart.inverted,i=this.chart.xAxis[s.xAxis].toPixels(s.x),o=this.chart.yAxis[s.yAxis].toPixels(s.y),o=Math.max(Math.sqrt(Math.pow(e?o-t.chartX:i-t.chartX,2)+Math.pow(e?i-t.chartY:o-t.chartY,2)),5)),n.update({shapes:[{r:o}]})}]},ellipseAnnotation:{className:"highcharts-ellipse-annotation",start:function(t){var n=this.chart.pointer.getCoordinates(t),e=this.utils.getAssignedAxis(n.xAxis),t=this.utils.getAssignedAxis(n.yAxis),n=this.chart.options.navigation;if(e&&t)return this.chart.addAnnotation(merge({langKey:"ellipse",type:"basicAnnotation",shapes:[{type:"ellipse",xAxis:e.axis.options.index,yAxis:t.axis.options.index,points:[{x:e.value,y:t.value},{x:e.value,y:t.value}],ry:1}]},n.annotationsOptions,n.bindings.ellipseAnnotation.annotationOptions))},steps:[function(t,n){var e=n.shapes[0],n=e.getAbsolutePosition(e.points[1]);e.translatePoint(t.chartX-n.x,t.chartY-n.y,1),e.redraw(!1)},function(t,n){var e=n.shapes[0],i=e.getAbsolutePosition(e.points[0]),n=e.getAbsolutePosition(e.points[1]),n=e.getDistanceFromLine(i,n,t.chartX,t.chartY),t=e.getYAxis(),n=Math.abs(t.toValue(0)-t.toValue(n));e.setYRadius(n),e.redraw(!1)}]},rectangleAnnotation:{className:"highcharts-rectangle-annotation",start:function(t){var n=this.chart.pointer.getCoordinates(t),e=this.utils.getAssignedAxis(n.xAxis),i=this.utils.getAssignedAxis(n.yAxis);if(e&&i){var o=e.value,t=i.value,n=e.axis.options.index,e=i.axis.options.index,i=this.chart.options.navigation;return this.chart.addAnnotation(merge({langKey:"rectangle",type:"basicAnnotation",shapes:[{type:"path",points:[{xAxis:n,yAxis:e,x:o,y:t},{xAxis:n,yAxis:e,x:o,y:t},{xAxis:n,yAxis:e,x:o,y:t},{xAxis:n,yAxis:e,x:o,y:t},{command:"Z"}]}]},i.annotationsOptions,i.bindings.rectangleAnnotation.annotationsOptions))}},steps:[function(t,n){var e=n.options.shapes[0].points,i=this.chart.pointer.getCoordinates(t),t=this.utils.getAssignedAxis(i.xAxis),i=this.utils.getAssignedAxis(i.yAxis);t&&i&&(t=t.value,i=i.value,e[1].x=t,e[2].x=t,e[2].y=i,e[3].y=i,n.update({shapes:[{points:e}]}))}]},labelAnnotation:{className:"highcharts-label-annotation",start:function(t){var n=this.chart.pointer.getCoordinates(t),e=this.utils.getAssignedAxis(n.xAxis),t=this.utils.getAssignedAxis(n.yAxis),n=this.chart.options.navigation;if(e&&t)return this.chart.addAnnotation(merge({langKey:"label",type:"basicAnnotation",labelOptions:{format:"{y:.2f}"},labels:[{point:{xAxis:e.axis.options.index,yAxis:t.axis.options.index,x:e.value,y:t.value},overflow:"none",crop:!0}]},n.annotationsOptions,n.bindings.labelAnnotation.annotationsOptions))}}},events:{},annotationsOptions:{animation:{defer:0}}}}),addEvent(Chart,"render",function(){var a,r=this,t=r.navigationBindings,l="highcharts-disabled-btn";r&&t&&(a=!1,r.series.forEach(function(t){!t.options.isInternal&&t.visible&&(a=!0)}),objectEach(t.boundClassNames,function(t,n){if(r.navigationBindings&&r.navigationBindings.container&&r.navigationBindings.container[0]){var e=r.navigationBindings.container[0].querySelectorAll("."+n);if(e)for(var i=0;i<e.length;i++){var o=e[i],s=o.className;"normal"===t.noDataState||a?-1!==s.indexOf(l)&&o.classList.remove(l):-1===s.indexOf(l)&&(o.className+=" "+l)}}}))}),addEvent(NavigationBindings,"closePopup",function(){this.deselectAnnotation()});export default NavigationBindings;