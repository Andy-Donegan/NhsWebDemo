"use strict";import Color from"../../Core/Color/Color.js";var color=Color.parse;import GLShader from"./WGLShader.js";import GLVertexBuffer from"./WGLVBuffer.js";import H from"../../Core/Globals.js";var doc=H.doc;import U from"../../Core/Utilities.js";var isNumber=U.isNumber,isObject=U.isObject,merge=U.merge,objectEach=U.objectEach,pick=U.pick;function GLRenderer(e){var m=!1,ne=!1,re=0,g=!1,i=0,n=0,oe=!1,r=!1,t={},o=!1,s=[],h={},se={column:!0,columnrange:!0,bar:!0,area:!0,arearange:!0},f={scatter:!0,bubble:!0},ae={pointSize:1,lineWidth:1,fillColor:"#AA00AA",useAlpha:!0,usePreallocated:!1,useGPUTranslations:!1,debug:{timeRendering:!1,timeSeriesProcessing:!1,timeSetup:!1,timeBufferCopy:!1,timeKDTree:!1,showSkipSummary:!1}};function a(e){var t,i;return e.isSeriesBoosting?(t=!!e.options.stacking,i=e.xData||e.options.xData||e.processedXData,i=(t?e.data:i||e.options.data).length,"treemap"===e.type?i*=12:"heatmap"===e.type?i*=6:se[e.type]&&(i*=2),i):0}function l(e,t){return[2/e,0,0,0,0,-2/t,0,0,0,0,-2,0,-1,1,-1,1]}function u(){g.clear(g.COLOR_BUFFER_BIT|g.DEPTH_BUFFER_BIT)}function d(s,i){var t,a,r,o,l,u,d,c,m=s.pointArrayMap&&"low,high"===s.pointArrayMap.join(","),g=s.chart,h=s.options,f=!!h.stacking,p=h.data,e=s.xAxis.getExtremes(),x=e.min,b=e.max,n=s.yAxis.getExtremes(),A=n.min,T=n.max,e=s.xData||h.xData||s.processedXData,E=s.yData||h.yData||s.processedYData,y=s.zData||h.zData||s.processedZData,P=s.yAxis,v=s.xAxis,U=s.chart.plotWidth,M=!e||0===e.length,S=h.connectNulls,n=s.points||!1,R=!1,_=!1,k=f?s.data:e||p,D={x:Number.MAX_VALUE,y:0},L={x:-Number.MAX_VALUE,y:0},N=0,C=!1,w=-1,z=!1,B=!1,G=void 0===g.index,O=!1,X=!1,I=!1,F=se[s.type],V=!1,H=!0,W=!0,j=h.zoneAxis||"y",Y=h.zones||!1,q=!1,Z=h.threshold,K=!1;if(!(h.boostData&&0<h.boostData.length)){if(h.gapSize&&(K="value"!==h.gapUnit?h.gapSize*s.closestPointRange:h.gapSize),Y&&(c=[],Y.forEach(function(e,t){var i;e.color&&((i=color(e.color).rgba)[0]/=255,i[1]/=255,i[2]/=255,c[t]=i,q||void 0!==e.value||(q=i))}),q||(e=s.pointAttribs&&s.pointAttribs().fill||s.color,(q=color(e).rgba)[0]/=255,q[1]/=255,q[2]/=255)),g.inverted&&(U=s.chart.plotHeight),s.closestPointRangePx=Number.MAX_VALUE,ee(),n&&0<n.length)return i.skipTranslation=!0,i.drawMode="triangles",n[0].node&&n[0].node.levelDynamic&&n.sort(function(e,t){if(e.node){if(e.node.levelDynamic>t.node.levelDynamic)return 1;if(e.node.levelDynamic<t.node.levelDynamic)return-1}return 0}),n.forEach(function(e){var t,i,n,r,o=e.plotY;void 0!==o&&!isNaN(o)&&null!==e.y&&e.shapeArgs&&(t=void 0===(r=(n=e.shapeArgs).x)?0:r,o=void 0===(i=n.y)?0:i,i=void 0===(r=n.width)?0:r,n=void 0===(r=n.height)?0:r,e=(r=g.styledMode?e.series.colorAttribs(e):e.series.pointAttribs(e))["stroke-width"]||0,(I=color(r.fill).rgba)[0]/=255,I[1]/=255,I[2]/=255,"treemap"===s.type&&(e=e||1,(a=color(r.stroke).rgba)[0]/=255,a[1]/=255,a[2]/=255,te(t,o,i,n,a),e/=2),"heatmap"===s.type&&g.inverted&&(t=v.len-t,o=P.len-o,i=-i,n=-n),te(t+e,o+e,i-2*e,n-2*e,I))}),void $();for(;w<k.length-1;)if("break"===function(){if(void 0===(l=k[++w]))return"continue";if(G)return"break";var n,e=p&&p[w];return!M&&isObject(e,!0)&&e.color&&((I=color(e.color).rgba)[0]/=255,I[1]/=255,I[2]/=255),M?(r=l[0],o=l[1],k[w+1]&&(B=k[w+1][0]),k[w-1]&&(z=k[w-1][0]),3<=l.length&&(u=l[2],l[2]>i.zMax&&(i.zMax=l[2]),l[2]<i.zMin&&(i.zMin=l[2]))):(r=l,o=E[w],k[w+1]&&(B=k[w+1]),k[w-1]&&(z=k[w-1]),y&&y.length&&(u=y[w],y[w]>i.zMax&&(i.zMax=y[w]),y[w]<i.zMin&&(i.zMin=y[w]))),S||null!==r&&null!==o?(B&&x<=B&&B<=b&&(O=!0),z&&x<=z&&z<=b&&(X=!0),m?(M&&(o=l.slice(1,3)),d=o[0],o=o[1]):f&&(r=l.x,o=l.stackY,d=o-l.y),null!=A&&null!=T&&(H=A<=o&&o<=T),b<r&&L.x<b&&(L.x=r,L.y=o),r<x&&D.x>x&&(D.x=r,D.y=o),null===o&&S?"continue":null!==o&&(H||O||X)?(V=(x<=B||x<=r)&&(z<=b||r<=b)||V)||O||X?(K&&K<r-z&&ee(),Y&&(Y.some(function(e,t){var i=Y[t-1];return"x"===j?void 0!==e.value&&r<=e.value&&(c[t]&&(!i||r>=i.value)&&(n=c[t]),!0):void 0!==e.value&&o<=e.value&&(c[t]&&(!i||o>=i.value)&&(n=c[t]),!0)}),I=n||q||I),!ae.useGPUTranslations&&(i.skipTranslation=!0,r=v.toPixels(r,!0),o=P.toPixels(o,!0),U<r&&"points"===i.drawMode)?"continue":(i.hasMarkers&&V&&!1!==R&&(s.closestPointRangePx=Math.min(s.closestPointRangePx,Math.abs(r-R))),!ae.useGPUTranslations&&!ae.usePreallocated&&R&&Math.abs(r-R)<1&&_&&Math.abs(o-_)<1?(ae.debug.showSkipSummary&&++N,"continue"):(F&&(!1!==(t=d)&&void 0!==d||(t=o<0?o:0),m||f||(t=Math.max(null===Z?A:Z,A)),ae.useGPUTranslations||(t=P.toPixels(t,!0)),Q(r,t,0,0,I)),h.step&&!W&&Q(r,_,0,2,I),Q(r,o,0,"bubble"===s.type?u||1:2,I),R=r,_=o,void(W=!(C=!0))))):"continue":(ee(),"continue")):(ee(),"continue")}())break;ae.debug.showSkipSummary&&console.log("skipped points:",N),C||!1===S||"line_strip"!==s.drawMode||(D.x<Number.MAX_VALUE&&ie(D,!0),L.x>-Number.MAX_VALUE&&ie(L)),$()}function J(e){e&&(i.colorData.push(e[0]),i.colorData.push(e[1]),i.colorData.push(e[2]),i.colorData.push(e[3]))}function Q(e,t,i,n,r){J(r),ae.usePreallocated?(ne.push(e,t,i?1:0,n||1),re+=4):(oe.push(e),oe.push(t),oe.push(i?1:0),oe.push(n||1))}function $(){i.segments.length&&(i.segments[i.segments.length-1].to=oe.length||re)}function ee(){i.segments.length&&i.segments[i.segments.length-1].from===(oe.length||re)||($(),i.segments.push({from:oe.length||re}))}function te(e,t,i,n,r){J(r),Q(e+i,t),J(r),Q(e,t),J(r),Q(e,t+n),J(r),Q(e,t+n),J(r),Q(e+i,t+n),J(r),Q(e+i,t)}function ie(e,t){ae.useGPUTranslations||(i.skipTranslation=!0,e.x=v.toPixels(e.x,!0),e.y=P.toPixels(e.y,!0)),t?oe=[e.x,e.y,0,2].concat(oe):Q(e.x,e.y,0,2)}}function p(){s=[],t.data=oe=[],r=[],ne&&ne.destroy()}function x(e){m&&(m.setUniform("xAxisTrans",e.transA),m.setUniform("xAxisMin",e.min),m.setUniform("xAxisMinPad",e.minPixelPadding),m.setUniform("xAxisPointRange",e.pointRange),m.setUniform("xAxisLen",e.len),m.setUniform("xAxisPos",e.pos),m.setUniform("xAxisCVSCoord",!e.horiz),m.setUniform("xAxisIsLog",!!e.logarithmic),m.setUniform("xAxisReversed",!!e.reversed))}function b(e){m&&(m.setUniform("yAxisTrans",e.transA),m.setUniform("yAxisMin",e.min),m.setUniform("yAxisMinPad",e.minPixelPadding),m.setUniform("yAxisPointRange",e.pointRange),m.setUniform("yAxisLen",e.len),m.setUniform("yAxisPos",e.pos),m.setUniform("yAxisCVSCoord",!e.horiz),m.setUniform("yAxisIsLog",!!e.logarithmic),m.setUniform("yAxisReversed",!!e.reversed))}function A(e,t){m.setUniform("hasThreshold",e),m.setUniform("translatedThreshold",t)}function c(c){return!!c&&(c.chartHeight&&c.chartWidth,i=c.chartWidth||800,n=c.chartHeight||400,!!(g&&i&&n&&m)&&(ae.debug.timeRendering&&console.time("gl rendering"),g.canvas.width=i,g.canvas.height=n,m.bind(),g.viewport(0,0,i,n),m.setPMatrix(l(i,n)),1<ae.lineWidth&&!H.isMS&&g.lineWidth(ae.lineWidth),ne.build(t.data,"aVertexPosition",4),ne.bind(),m.setInverted(c.inverted),s.forEach(function(e,t){var i,n,r=e.series.options,o=r.marker,s=void 0!==r.lineWidth?r.lineWidth:1,a=r.threshold,l=isNumber(a),u=e.series.yAxis.getThreshold(a),d=pick(r.marker?r.marker.enabled:null,!!e.series.xAxis.isRadial||null,e.series.closestPointRangePx>2*((r.marker?r.marker.radius:10)||10)),a=h[o&&o.symbol||e.series.symbol]||h.circle,o=[];if(0!==e.segments.length&&e.segments[0].from!==e.segments[0].to){if(a.isReady&&(g.bindTexture(g.TEXTURE_2D,a.handle),m.setTexture(a.handle)),c.styledMode?n=e.series.markerGroup&&e.series.markerGroup.getStyle("fill"):(n="points"===e.drawMode&&e.series.pointAttribs&&e.series.pointAttribs().fill||e.series.color,r.colorByPoint&&(n=e.series.chart.options.colors[t])),e.series.fillOpacity&&r.fillOpacity&&(n=new Color(n).setOpacity(pick(r.fillOpacity,1)).get()),o=color(n).rgba,ae.useAlpha||(o[3]=1),"lines"===e.drawMode&&ae.useAlpha&&o[3]<1&&(o[3]/=10),"add"===r.boostBlending?(g.blendFunc(g.SRC_ALPHA,g.ONE),g.blendEquation(g.FUNC_ADD)):"mult"===r.boostBlending||"multiply"===r.boostBlending?g.blendFunc(g.DST_COLOR,g.ZERO):"darken"===r.boostBlending?(g.blendFunc(g.ONE,g.ONE),g.blendEquation(g.FUNC_MIN)):g.blendFuncSeparate(g.SRC_ALPHA,g.ONE_MINUS_SRC_ALPHA,g.ONE,g.ONE_MINUS_SRC_ALPHA),m.reset(),0<e.colorData.length?(m.setUniform("hasColor",1),(n=GLVertexBuffer(g,m)).build(e.colorData,"aColor",4),n.bind()):g.disableVertexAttribArray(g.getAttribLocation(m.program(),"aColor")),m.setColor(o),x(e.series.xAxis),b(e.series.yAxis),A(l,u),"points"===e.drawMode&&(r.marker&&isNumber(r.marker.radius)?m.setPointSize(2*r.marker.radius):m.setPointSize(1)),m.setSkipTranslation(e.skipTranslation),"bubble"===e.series.type&&m.setBubbleUniforms(e.series,e.zMin,e.zMax),m.setDrawAsCircle(f[e.series.type]||!1),0<s||"line_strip"!==e.drawMode)for(i=0;i<e.segments.length;i++)ne.render(e.segments[i].from,e.segments[i].to,e.drawMode);if(e.hasMarkers&&d)for(r.marker&&isNumber(r.marker.radius)?m.setPointSize(2*r.marker.radius):m.setPointSize(10),m.setDrawAsCircle(!0),i=0;i<e.segments.length;i++)ne.render(e.segments[i].from,e.segments[i].to,"POINTS")}}),ae.debug.timeRendering&&console.timeEnd("gl rendering"),e&&e(),void p()))}return t={allocateBufferForSingleSeries:function(e){var t=0;ae.usePreallocated&&(e.isSeriesBoosting&&(t=a(e)),ne.allocate(t))},pushSeries:function(e){0<s.length&&s[s.length-1].hasMarkers&&(s[s.length-1].markerTo=r.length),ae.debug.timeSeriesProcessing&&console.time("building "+e.type+" series");var t={segments:[],markerFrom:r.length,colorData:[],series:e,zMin:Number.MAX_VALUE,zMax:-Number.MAX_VALUE,hasMarkers:!!e.options.marker&&!1!==e.options.marker.enabled,showMarkers:!0,drawMode:{area:"lines",arearange:"lines",areaspline:"line_strip",column:"lines",columnrange:"lines",bar:"lines",line:"line_strip",scatter:"points",heatmap:"triangles",treemap:"triangles",bubble:"points"}[e.type]||"line_strip"};e.index>=s.length?s.push(t):s[e.index]=t,d(e,t),ae.debug.timeSeriesProcessing&&console.timeEnd("building "+e.type+" series")},setSize:function(e,t){i===e&&n===t||!m||(i=e,n=t,m.bind(),m.setPMatrix(l(i,n)))},inited:function(){return o},setThreshold:A,init:function(e,t){var i=0,n=["webgl","experimental-webgl","moz-webgl","webkit-3d"];if(o=!1,!e)return!1;for(ae.debug.timeSetup&&console.time("gl setup");i<n.length&&!(g=e.getContext(n[i],{}));i++);return!!g&&(t||p(),g.enable(g.BLEND),g.blendFunc(g.SRC_ALPHA,g.ONE_MINUS_SRC_ALPHA),g.disable(g.DEPTH_TEST),g.depthFunc(g.LESS),!!(m=GLShader(g))&&(ne=GLVertexBuffer(g,m),r("circle",function(e){e.beginPath(),e.arc(256,256,256,0,2*Math.PI),e.stroke(),e.fill()}),r("square",function(e){e.fillRect(0,0,512,512)}),r("diamond",function(e){e.beginPath(),e.moveTo(256,0),e.lineTo(512,256),e.lineTo(256,512),e.lineTo(0,256),e.lineTo(256,0),e.fill()}),r("triangle",function(e){e.beginPath(),e.moveTo(0,512),e.lineTo(256,0),e.lineTo(512,512),e.lineTo(0,512),e.fill()}),r("triangle-down",function(e){e.beginPath(),e.moveTo(0,0),e.lineTo(256,512),e.lineTo(512,0),e.lineTo(0,0),e.fill()}),o=!0,ae.debug.timeSetup&&console.timeEnd("gl setup"),!0));function r(e,t){var i={isReady:!1,texture:doc.createElement("canvas"),handle:g.createTexture()},n=i.texture.getContext("2d");(h[e]=i).texture.width=512,i.texture.height=512,n.mozImageSmoothingEnabled=!1,n.webkitImageSmoothingEnabled=!1,n.msImageSmoothingEnabled=!1,n.imageSmoothingEnabled=!1,n.strokeStyle="rgba(255, 255, 255, 0)",n.fillStyle="#FFF",t(n);try{g.activeTexture(g.TEXTURE0),g.bindTexture(g.TEXTURE_2D,i.handle),g.texImage2D(g.TEXTURE_2D,0,g.RGBA,g.RGBA,g.UNSIGNED_BYTE,i.texture),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,g.LINEAR),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.LINEAR),g.bindTexture(g.TEXTURE_2D,null),i.isReady=!0}catch(e){}}},render:function e(t){if(u(),t.renderer.forExport)return c(t);o?c(t):setTimeout(function(){e(t)},1)},settings:ae,valid:function(){return!1!==g},clear:u,flush:p,setXAxis:x,setYAxis:b,data:oe,gl:function(){return g},allocateBuffer:function(e){var t=0;ae.usePreallocated&&(e.series.forEach(function(e){e.isSeriesBoosting&&(t+=a(e))}),ne.allocate(t))},destroy:function(){p(),ne.destroy(),m.destroy(),g&&(objectEach(h,function(e){e.handle&&g.deleteTexture(e.handle)}),g.canvas.width=1,g.canvas.height=1)},setOptions:function(e){merge(!0,ae,e)}}}export default GLRenderer;