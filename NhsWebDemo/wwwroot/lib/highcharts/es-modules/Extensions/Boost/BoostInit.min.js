"use strict";import Chart from"../../Core/Chart/Chart.js";import H from"../../Core/Globals.js";var noop=H.noop;import Series from"../../Core/Series/Series.js";import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";var seriesTypes=SeriesRegistry.seriesTypes;import U from"../../Core/Utilities.js";var addEvent=U.addEvent,extend=U.extend,fireEvent=U.fireEvent,wrap=U.wrap;import butils from"./BoostUtils.js";import createAndAttachRenderer from"./BoostAttach.js";var index,eachAsync=butils.eachAsync,pointDrawHandler=butils.pointDrawHandler,allocateIfNotSeriesBoosting=butils.allocateIfNotSeriesBoosting,renderIfNotSeriesBoosting=butils.renderIfNotSeriesBoosting,shouldForceChartSeriesBoosting=butils.shouldForceChartSeriesBoosting;function init(){extend(Series.prototype,{renderCanvas:function(){var p,s,d,l,h,u,e,r=this,t=r.options||{},o=!1,c=r.chart,m=this.xAxis,g=this.yAxis,i=t.xData||r.processedXData,x=t.yData||r.processedYData,a=t.data,n=m.getExtremes(),y=n.min,f=n.max,n=g.getExtremes(),v=n.min,b=n.max,S={},B=!!r.sampling,k=!1!==t.enableMouseTracking,n=t.threshold,A=g.getThreshold(n),C=r.pointArrayMap&&"low,high"===r.pointArrayMap.join(","),T=!!t.stacking,G=r.cropStart||0,D=r.requireSorting,E=!i,w="x"===t.findNearestPointBy,j=this.xData||this.options.xData||this.processedXData||!1,U=function(e,r,t){e=Math.ceil(e),index=w?e:e+","+r,k&&!S[index]&&(S[index]=!0,c.inverted&&(e=m.len-e,r=g.len-r),s.push({x:!!j&&j[G+t],clientX:e,plotX:e,plotY:r,i:G+t}))};o=createAndAttachRenderer(c,r),c.isBoosting=!0,e=o.settings,this.visible&&((this.points||this.graph)&&this.destroyGraphics(),c.isChartSeriesBoosting()?(this.markerGroup&&this.markerGroup!==c.markerGroup&&this.markerGroup.destroy(),this.markerGroup=c.markerGroup,this.renderTarget&&(this.renderTarget=this.renderTarget.destroy())):(this.markerGroup===c.markerGroup&&(this.markerGroup=void 0),this.markerGroup=r.plotGroup("markerGroup","markers",!0,1,c.seriesGroup)),s=this.points=[],r.buildKDTree=noop,o&&(allocateIfNotSeriesBoosting(o,this),o.pushSeries(r),renderIfNotSeriesBoosting(o,this,c)),c.renderer.forExport||(e.debug.timeKDTree&&console.time("kd tree building"),eachAsync(T?r.data:i||a,function(e,r){var t,s,o,i=!1,a=void 0===c.index,n=!0;return void 0===e||(a||(t=E?(s=e[0],e[1]):(s=e,x[r]),C?(i=(t=E?e.slice(1,3):t)[0],t=t[1]):T&&(s=e.x,i=(t=e.stackY)-e.y),D||(n=v<=t&&t<=b),!(null===t)&&y<=s&&s<=f&&n&&(s=m.toPixels(s,!0),B?(void 0!==h&&s!==p||(C||(i=t),(void 0===u||l<t)&&(l=t,u=r),(void 0===h||i<d)&&(d=i,h=r)),s!==p&&(void 0!==h&&(o=g.toPixels(l,!0),A=g.toPixels(d,!0),U(s,o,u),A!==o&&U(s,A,h)),h=u=void 0,p=s)):(o=Math.ceil(g.toPixels(t,!0)),U(s,o,r)))),!a)},function(){fireEvent(r,"renderedCanvas"),delete r.buildKDTree,r.buildKDTree(),e.debug.timeKDTree&&console.timeEnd("kd tree building")})))}}),["heatmap","treemap"].forEach(function(e){seriesTypes[e]&&wrap(seriesTypes[e].prototype,"drawPoints",pointDrawHandler)}),seriesTypes.bubble&&(delete seriesTypes.bubble.prototype.buildKDTree,wrap(seriesTypes.bubble.prototype,"markerAttribs",function(e){return!this.isSeriesBoosting&&e.apply(this,[].slice.call(arguments,1))})),seriesTypes.scatter.prototype.fill=!0,extend(seriesTypes.area.prototype,{fill:!0,fillOpacity:!0,sampling:!0}),extend(seriesTypes.column.prototype,{fill:!0,sampling:!0}),Chart.prototype.propsRequireUpdateSeries.push("boost"),Chart.prototype.callbacks.push(function(t){addEvent(t,"predraw",function(){t.boostForceChartBoost=void 0,t.boostForceChartBoost=shouldForceChartSeriesBoosting(t),t.isBoosting=!1,!t.isChartSeriesBoosting()&&t.didBoost&&(t.didBoost=!1),t.boostClear&&t.boostClear(),t.canvas&&t.ogl&&t.isChartSeriesBoosting()&&(t.didBoost=!0,t.ogl.allocateBuffer(t)),t.markerGroup&&t.xAxis&&0<t.xAxis.length&&t.yAxis&&0<t.yAxis.length&&t.markerGroup.translate(t.xAxis[0].pos,t.yAxis[0].pos)}),addEvent(t,"render",function(){t.ogl&&t.isChartSeriesBoosting()&&t.ogl.render(t)});var s=-1,o=-1;addEvent(t.pointer,"afterGetHoverData",function(){var e,r=t.hoverSeries;t.markerGroup&&r&&(e=t.inverted?r.yAxis:r.xAxis,r=t.inverted?r.xAxis:r.yAxis,(e&&e.pos!==s||r&&r.pos!==o)&&(t.markerGroup.translate(e.pos,r.pos),s=e.pos,o=r.pos))})})}export default init;