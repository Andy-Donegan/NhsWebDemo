"use strict";import A from"../Core/Animation/AnimationUtilities.js";var animObject=A.animObject;import Chart from"../Core/Chart/Chart.js";import H from"../Core/Globals.js";import Pane from"./Pane.js";import Pointer from"../Core/Pointer.js";import Series from"../Core/Series/Series.js";import SeriesRegistry from"../Core/Series/SeriesRegistry.js";var seriesTypes=SeriesRegistry.seriesTypes;import SVGRenderer from"../Core/Renderer/SVG/SVGRenderer.js";import U from"../Core/Utilities.js";var columnProto,arearangeProto,addEvent=U.addEvent,defined=U.defined,find=U.find,isNumber=U.isNumber,pick=U.pick,splat=U.splat,uniqueKey=U.uniqueKey,wrap=U.wrap,seriesProto=Series.prototype,pointerProto=Pointer.prototype;seriesProto.searchPointByAngle=function(t){var e=this.chart,i=this.xAxis.pane.center,r=t.chartX-i[0]-e.plotLeft,e=t.chartY-i[1]-e.plotTop;return this.searchKDTree({clientX:180+Math.atan2(r,e)*(-180/Math.PI)})},seriesProto.getConnectors=function(t,e,i,r){var a=1.5,o=2.5,n=r?1:0,s=0<=e&&e<=t.length-1?e:e<0?t.length-1+e:0,l=s-1<0?t.length-(1+n):s-1,p=s+1>t.length-1?n:s+1,h=t[l],c=t[p],d=h.plotX,f=h.plotY,e=c.plotX,n=c.plotY,p=t[s].plotX,h=t[s].plotY,c=(a*p+d)/o,s=(a*h+f)/o,d=(a*p+e)/o,f=(a*h+n)/o,e=Math.sqrt(Math.pow(c-p,2)+Math.pow(s-h,2)),a=Math.sqrt(Math.pow(d-p,2)+Math.pow(f-h,2)),n=Math.atan2(s-h,c-p),o=Math.atan2(f-h,d-p),o=Math.PI/2+(n+o)/2;return Math.abs(n-o)>Math.PI/2&&(o-=Math.PI),c=p+Math.cos(o)*e,s=h+Math.sin(o)*e,h={rightContX:p+Math.cos(Math.PI+o)*a,rightContY:h+Math.sin(Math.PI+o)*a,leftContX:c,leftContY:s,plotX:p,plotY:h},i&&(h.prevPointCont=this.getConnectors(t,l,!1,r)),h},seriesProto.toXY=function(t){var e=this.chart,i=this.xAxis,r=this.yAxis,a=t.plotX,o=t.plotY,n=t.series,s=e.inverted,l=t.y,p=s?a:r.len-o;s&&n&&!n.isRadialBar&&(t.plotY=o="number"==typeof l&&r.translate(l)||0),t.rectPlotX=a,t.rectPlotY=o,r.center&&(p+=r.center[3]/2),isNumber(o)&&(p=s?r.postTranslate(o,p):i.postTranslate(a,p),t.plotX=t.polarPlotX=p.x-e.plotLeft,t.plotY=t.polarPlotY=p.y-e.plotTop),this.kdByAngle?((i=(a/Math.PI*180+i.pane.options.startAngle)%360)<0&&(i+=360),t.clientX=i):t.clientX=t.plotX},seriesTypes.spline&&(wrap(seriesTypes.spline.prototype,"getPointSpline",function(t,e,i,r){var a,o,n;return this.chart.polar?r?(o=(a=this.getConnectors(e,r,!0,this.connectEnds)).prevPointCont&&a.prevPointCont.rightContX,n=a.prevPointCont&&a.prevPointCont.rightContY,["C",isNumber(o)?o:a.plotX,isNumber(n)?n:a.plotY,isNumber(a.leftContX)?a.leftContX:a.plotX,isNumber(a.leftContY)?a.leftContY:a.plotY,a.plotX,a.plotY]):["M",i.plotX,i.plotY]:t.call(this,e,i,r)}),seriesTypes.areasplinerange&&(seriesTypes.areasplinerange.prototype.getPointSpline=seriesTypes.spline.prototype.getPointSpline)),addEvent(Series,"afterTranslate",function(){var t=this,e=t.chart;if(e.polar&&t.xAxis){if(t.kdByAngle=e.tooltip&&e.tooltip.shared,t.kdByAngle?t.searchPoint=t.searchPointByAngle:t.options.findNearestPointBy="xy",!t.preventPostTranslate)for(var i=t.points,r=i.length;r--;)t.toXY(i[r]),!e.hasParallelCoordinates&&!t.yAxis.reversed&&i[r].y<t.yAxis.min&&(i[r].isNull=!0);this.hasClipCircleSetter||(this.hasClipCircleSetter=!!t.eventsToUnbind.push(addEvent(t,"afterRender",function(){var t;e.polar&&(t=this.yAxis.pane.center,this.clipCircle?this.clipCircle.animate({x:t[0],y:t[1],r:t[2]/2,innerR:t[3]/2}):this.clipCircle=e.renderer.clipCircle(t[0],t[1],t[2]/2,t[3]/2),this.group.clip(this.clipCircle),this.setClip=H.noop)})))}},{order:2}),wrap(seriesTypes.line.prototype,"getGraphPath",function(t,e){var i,r,a,o=this;if(this.chart.polar){for(e=e||this.points,i=0;i<e.length;i++)if(!e[i].isNull){r=i;break}!1!==this.options.connectEnds&&void 0!==r&&(this.connectEnds=!0,e.splice(e.length,0,e[r]),a=!0),e.forEach(function(t){void 0===t.polarPlotY&&o.toXY(t)})}t=t.apply(this,[].slice.call(arguments,1));return a&&e.pop(),t});var polarAnimate=function(t,e){var i,r,a,o,n,s,l=this,p=this.chart,h=this.options.animation,c=this.group,d=this.markerGroup,f=this.xAxis&&this.xAxis.center,g=p.plotLeft,m=p.plotTop;p.polar?l.isRadialBar?e||(l.startAngleRad=pick(l.translatedThreshold,l.xAxis.startAngleRad),H.seriesTypes.pie.prototype.animate.call(l,e)):p.renderer.isSVG&&(h=animObject(h),l.is("column")?e||(r=f[3]/2,l.points.forEach(function(t){a=t.graphic,o=t.shapeArgs,n=o&&o.r,s=o&&o.innerR,a&&o&&(a.attr({r:r,innerR:r}),a.animate({r:n,innerR:s},l.options.animation))})):e?(i={translateX:f[0]+g,translateY:f[1]+m,scaleX:.001,scaleY:.001},c.attr(i),d&&d.attr(i)):(c.animate(i={translateX:g,translateY:m,scaleX:1,scaleY:1},h),d&&d.animate(i,h))):t.call(this,e)};wrap(seriesProto,"animate",polarAnimate),seriesTypes.column&&(arearangeProto=seriesTypes.arearange.prototype,(columnProto=seriesTypes.column.prototype).polarArc=function(t,e,i,r){var a=this.xAxis.center,o=this.yAxis.len,n=a[3]/2,e=o-e+n,o=o-pick(t,o)+n;return this.yAxis.reversed&&(e<0&&(e=n),o<0&&(o=n)),{x:a[0],y:a[1],r:e,innerR:o,start:i,end:r}},wrap(columnProto,"animate",polarAnimate),wrap(columnProto,"translate",function(t){var e,i,r,a,o,n,s,l,p,h,c,d,f,g=this,m=g.options,u=(m.threshold,m.stacking),P=g.chart,y=g.xAxis,A=g.yAxis,v=A.reversed,x=A.center,C=y.startAngleRad,X=y.endAngleRad-C;if(g.preventPostTranslate=!0,t.call(g),y.isRadial)for(o=(r=g.points).length,n=A.translate(A.min),s=A.translate(A.max),e=m.threshold||0,P.inverted&&isNumber(e)&&(i=A.translate(e),defined(i)&&(i<0?i=0:X<i&&(i=X),g.translatedThreshold=i+C));o--;)c=(a=r[o]).barX,d=a.x,h=a.y,a.shapeType="arc",P.inverted?(a.plotY=A.translate(h),u&&A.stacking?(h=A.stacking.stacks[(h<0?"-":"")+g.stackKey],g.visible&&h&&h[d]&&(a.isNull||(f=h[d].points[g.getStackIndicator(void 0,d,g.index).key],l=A.translate(f[0]),p=A.translate(f[1]),defined(l)&&(l=U.clamp(l,0,X))))):(l=i,p=a.plotY),p<l&&(p=[l,l=p][0]),v?n<p?p=n:l<s?l=s:(n<l||p<s)&&(l=p=X):l<n?l=n:s<p?p=s:(p<n||s<l)&&(l=p=0),A.min>A.max&&(l=p=v?X:0),l+=C,p+=C,x&&(a.barX=c+=x[3]/2),d=Math.max(c,0),f=Math.max(c+a.pointWidth,0),a.shapeArgs={x:x&&x[0],y:x&&x[1],r:f,innerR:d,start:l,end:p},a.opacity=l===p?0:void 0,a.plotY=(defined(g.translatedThreshold)&&(l<g.translatedThreshold?l:p))-C):a.shapeArgs=g.polarArc(a.yBottom,a.plotY,l=c+C,l+a.pointWidth),g.toXY(a),P.inverted?(c=A.postTranslate(a.rectPlotY,c+a.pointWidth/2),a.tooltipPos=[c.x-P.plotLeft,c.y-P.plotTop]):a.tooltipPos=[a.plotX,a.plotY],x&&(a.ttBelow=a.plotY>x[1])}),columnProto.findAlignments=function(t,e){return null===e.align&&(e.align=20<t&&t<160?"left":200<t&&t<340?"right":"center"),null===e.verticalAlign&&(e.verticalAlign=t<45||315<t?"bottom":135<t&&t<225?"top":"middle"),e},arearangeProto&&(arearangeProto.findAlignments=columnProto.findAlignments),wrap(columnProto,"alignDataLabel",function(t,e,i,r,a,o){var n,s=this.chart,l=pick(r.inside,!!this.options.stacking);s.polar?(n=e.rectPlotX/Math.PI*180,s.inverted?(this.forceDL=s.isInsidePlot(e.plotX,Math.round(e.plotY)),l&&e.shapeArgs?(l=e.shapeArgs,a={x:(l=this.yAxis.postTranslate(((l.start||0)+(l.end||0))/2-this.xAxis.startAngleRad,e.barX+e.pointWidth/2)).x-s.plotLeft,y:l.y-s.plotTop}):e.tooltipPos&&(a={x:e.tooltipPos[0],y:e.tooltipPos[1]}),r.align=pick(r.align,"center"),r.verticalAlign=pick(r.verticalAlign,"middle")):this.findAlignments&&(r=this.findAlignments(n,r)),seriesProto.alignDataLabel.call(this,e,i,r,a,o),this.isRadialBar&&e.shapeArgs&&e.shapeArgs.start===e.shapeArgs.end&&i.hide(!0)):t.call(this,e,i,r,a,o)})),wrap(pointerProto,"getCoordinates",function(t,a){var o=this.chart,n={xAxis:[],yAxis:[]};return o.polar?o.axes.forEach(function(t){var e,i=t.isXAxis,r=t.center;"colorAxis"!==t.coll&&(e=a.chartX-r[0]-o.plotLeft,r=a.chartY-r[1]-o.plotTop,n[i?"xAxis":"yAxis"].push({axis:t,value:t.translate(i?Math.PI-Math.atan2(e,r):Math.sqrt(Math.pow(e,2)+Math.pow(r,2)),!0)}))}):n=t.call(this,a),n}),SVGRenderer.prototype.clipCircle=function(t,e,i,r){var a=uniqueKey(),o=this.createElement("clipPath").attr({id:a}).add(this.defs),i=(r?this.arc(t,e,i,r,0,2*Math.PI):this.circle(t,e,i)).add(o);return i.id=a,i.clipPath=o,i},addEvent(Chart,"getAxes",function(){this.pane||(this.pane=[]),this.options.pane=splat(this.options.pane),this.options.pane.forEach(function(t){new Pane(t,this)},this)}),addEvent(Chart,"afterDrawChartBox",function(){this.pane.forEach(function(t){t.render()})}),addEvent(Series,"afterInit",function(){var t=this.chart;t.inverted&&t.polar&&(this.isRadialSeries=!0,this.is("column")&&(this.isRadialBar=!0))}),wrap(Chart.prototype,"get",function(t,e){return find(this.pane||[],function(t){return t.options.id===e})||t.call(this,e)});