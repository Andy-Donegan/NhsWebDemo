"use strict";import AST from"../../Core/Renderer/HTML/AST.js";import Chart from"../../Core/Chart/Chart.js";import D from"../../Core/DefaultOptions.js";var defaultOptions=D.defaultOptions;import DownloadURL from"../DownloadURL.js";var downloadURL=DownloadURL.downloadURL;import Exporting from"../Exporting/Exporting.js";import H from"../../Core/Globals.js";var win=H.win,doc=H.doc;import OfflineExportingDefaults from"./OfflineExportingDefaults.js";import U from"../../Core/Utilities.js";var addEvent=U.addEvent,error=U.error,extend=U.extend,fireEvent=U.fireEvent,merge=U.merge;AST.allowedAttributes.push("data-z-index","fill-opacity","rx","ry","stroke-dasharray","stroke-linejoin","text-anchor","transform","version","viewBox","visibility","xmlns","xmlns:xlink"),AST.allowedTags.push("desc","clippath","g");var OfflineExporting,composedClasses=[];!function(h){function n(e,t){var n=this,o=merge(n.options.exporting,e),r=function(e){!1===o.fallbackToExportServer?o.error?o.error(o,e):error(28,!0):n.exportChart(o)};H.isMS&&n.styledMode&&!Exporting.inlineWhitelist.length&&Exporting.inlineWhitelist.push(/^blockSize/,/^border/,/^caretColor/,/^color/,/^columnRule/,/^columnRuleColor/,/^cssFloat/,/^cursor/,/^fill$/,/^fillOpacity/,/^font/,/^inlineSize/,/^length/,/^lineHeight/,/^opacity/,/^outline/,/^parentRule/,/^rx$/,/^ry$/,/^stroke/,/^textAlign/,/^textAnchor/,/^textDecoration/,/^transform/,/^vectorEffect/,/^visibility/,/^x$/,/^y$/),H.isMS&&("application/pdf"===o.type||n.container.getElementsByTagName("image").length&&"image/svg+xml"!==o.type)||"application/pdf"===o.type&&[].some.call(n.container.getElementsByTagName("image"),function(e){e=e.getAttribute("href");return""!==e&&"string"==typeof e&&0!==e.indexOf("data:")})?r(new Error("Image type not supported for this chart/browser.")):n.getSVGForLocalExport(o,t||{},r,function(e){-1<e.indexOf("<foreignObject")&&"image/svg+xml"!==o.type&&(H.isMS||"application/pdf"===o.type)?r(new Error("Image type not supported for charts with embedded HTML")):h.downloadSVGLocal(e,extend({filename:n.getFilename()},o),r,function(){return fireEvent(n,"exportChartLocalSuccess")})})}function m(e,t){var n=doc.getElementsByTagName("head")[0],o=doc.createElement("script");o.type="text/javascript",o.src=e,o.onload=t,o.onerror=function(){error("Error loading script "+e)},n.appendChild(o)}function o(e,t,n,o){function r(e,t,n){++m,n.imageElement.setAttributeNS("http://www.w3.org/1999/xlink","href",e),g()}var i,a,l,s,c,f=this,d=function(e){return f.sanitizeSVG(e,l)},g=function(){c&&m===p&&o(d(a.innerHTML))},p=0,m=0;f.unbindGetSVG=addEvent(f,"getSVG",function(e){l=e.chartCopy.options,a=e.chartCopy.container.cloneNode(!0),c=a&&a.getElementsByTagName("image")||[],p=c.length}),f.getSVGForExport(e,t);try{if(!c||!c.length)return void o(d(a.innerHTML));for(var u=0;u<c.length;u++)(s=(i=c[u]).getAttributeNS("http://www.w3.org/1999/xlink","href"))?h.imageToDataUrl(s,"image/png",{imageElement:i},e.scale,r,n,n,n):(m++,i.parentNode.removeChild(i),u--,g())}catch(e){n(e)}f.unbindGetSVG()}function u(o,r,i,a,l,e,s,t,c){function n(){setTimeout(function(){var e,t=doc.createElement("canvas"),n=t.getContext&&t.getContext("2d");try{if(n){t.height=d.height*a,t.width=d.width*a,n.drawImage(d,0,0,t.width,t.height);try{e=t.toDataURL(r),l(e,r,i,a)}catch(e){g(o,r,i,a)}}else s(o,r,i,a)}finally{c&&c(o,r,i,a)}},h.loadEventDeferDelay)}function f(){t(o,r,i,a),c&&c(o,r,i,a)}var d=new win.Image,g=function(){d=new win.Image,g=e,d.crossOrigin="Anonymous",d.onload=n,d.onerror=f,d.src=o};d.onload=n,d.onerror=f,d.src=o}function v(e){var t=win.navigator.userAgent,t=-1<t.indexOf("WebKit")&&t.indexOf("Chrome")<0;try{if(!t&&-1===e.indexOf("<foreignObject"))return h.domurl.createObjectURL(new win.Blob([e],{type:"image/svg+xml;charset-utf-16"}))}catch(e){}return"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(e)}function x(e,t){var n=e.width.baseVal.value+2*t,t=e.height.baseVal.value+2*t,t=new win.jsPDF(n<t?"p":"l","pt",[n,t]);[].forEach.call(e.querySelectorAll('*[visibility="hidden"]'),function(e){e.parentNode.removeChild(e)});for(var o=e.querySelectorAll("linearGradient"),r=0;r<o.length;r++)for(var i=o[r].querySelectorAll("stop"),a=0;a<i.length&&"0"===i[a].getAttribute("offset")&&"0"===i[a+1].getAttribute("offset");)i[a].remove(),a++;return[].forEach.call(e.querySelectorAll("tspan"),function(e){"â€‹"===e.textContent&&(e.textContent=" ",e.setAttribute("dx",-5))}),win.svg2pdf(e,t,{removeInvalid:!0}),t.output("datauristring")}h.CanVGRenderer={},h.domurl=win.URL||win.webkitURL||win,h.loadEventDeferDelay=H.isMS?150:0,h.compose=function(e){var t;return-1===composedClasses.indexOf(e)&&(composedClasses.push(e),(t=e.prototype).getSVGForLocalExport=o,t.exportChartLocal=n,merge(!0,defaultOptions.exporting,OfflineExportingDefaults)),e},h.downloadSVGLocal=function(i,e,a,l){function t(){AST.setElementHTML(r,i);var e,t=r.getElementsByTagName("text");[].forEach.call(t,function(t){["font-family","font-size"].forEach(function(e){!function(e,t){for(var n=e;n&&n!==r;){if(n.style[t]){e.style[t]=n.style[t];break}n=n.parentNode}}(t,e)}),t.style["font-family"]=t.style["font-family"]&&t.style["font-family"].split(" ").splice(-1),e=t.getElementsByTagName("title"),[].forEach.call(e,function(e){t.removeChild(e)})}),t=x(r.firstChild,0);try{downloadURL(t,f),l&&l()}catch(e){a(e)}}var n,o,s,r=doc.createElement("div"),c=e.type||"image/png",f=(e.filename||"chart")+"."+("image/svg+xml"===c?"svg":c.split("/")[1]),d=e.scale||1,g=e.libURL||defaultOptions.exporting.libURL,p=!0,g="/"!==g.slice(-1)?g+"/":g;if("image/svg+xml"===c)try{n=void 0!==win.navigator.msSaveOrOpenBlob?((o=new MSBlobBuilder).append(i),o.getBlob("image/svg+xml")):v(i),downloadURL(n,f),l&&l()}catch(e){a(e)}else"application/pdf"===c?win.jsPDF&&win.svg2pdf?t():(p=!0,m(g+"jspdf.js",function(){m(g+"svg2pdf.js",function(){t()})})):(n=v(i),s=function(){try{h.domurl.revokeObjectURL(n)}catch(e){}},u(n,c,{},d,function(e){try{downloadURL(e,f),l&&l()}catch(e){a(e)}},function(){function e(){win.canvg.Canvg.fromString(n,i).start();try{downloadURL(win.navigator.msSaveOrOpenBlob?t.msToBlob():t.toDataURL(c),f),l&&l()}catch(e){a(e)}finally{s()}}var t=doc.createElement("canvas"),n=t.getContext("2d"),o=i.match(/^<svg[^>]*width\s*=\s*\"?(\d+)\"?[^>]*>/)[1]*d,r=i.match(/^<svg[^>]*height\s*=\s*\"?(\d+)\"?[^>]*>/)[1]*d;t.width=o,t.height=r,win.canvg?e():(p=!0,m(g+"canvg.js",function(){e()}))},a,a,function(){p&&s()}))},h.getScript=m,h.imageToDataUrl=u,h.svgToDataUrl=v,h.svgToPdf=x}(OfflineExporting=OfflineExporting||{});export default OfflineExporting;