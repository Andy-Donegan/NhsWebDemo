"use strict";import A from"../Core/Animation/AnimationUtilities.js";var animObject=A.animObject;import Axis from"../Core/Axis/Axis.js";import Chart from"../Core/Chart/Chart.js";import Color from"../Core/Color/Color.js";import ColumnSeries from"../Series/Column/ColumnSeries.js";import F from"../Core/FormatUtilities.js";var format=F.format;import H from"../Core/Globals.js";var noop=H.noop;import D from"../Core/DefaultOptions.js";var defaultOptions=D.defaultOptions;import Point from"../Core/Series/Point.js";import Series from"../Core/Series/Series.js";import SeriesRegistry from"../Core/Series/SeriesRegistry.js";var seriesTypes=SeriesRegistry.seriesTypes;import SVGRenderer from"../Core/Renderer/SVG/SVGRenderer.js";import Tick from"../Core/Axis/Tick.js";import U from"../Core/Utilities.js";var addEvent=U.addEvent,removeEvent=U.removeEvent,extend=U.extend,fireEvent=U.fireEvent,merge=U.merge,objectEach=U.objectEach,pick=U.pick,syncTimeout=U.syncTimeout;import"../Series/Column/ColumnSeries.js";var PieSeries=seriesTypes.pie,ddSeriesId=1;extend(defaultOptions.lang,{drillUpText:"‚óÅ Back to {series.name}"}),defaultOptions.drilldown={activeAxisLabelStyle:{cursor:"pointer",color:"#003399",fontWeight:"bold",textDecoration:"underline"},activeDataLabelStyle:{cursor:"pointer",color:"#003399",fontWeight:"bold",textDecoration:"underline"},animation:{duration:500},drillUpButton:{position:{align:"right",x:-10,y:10}}},SVGRenderer.prototype.Element.prototype.fadeIn=function(e){this.attr({opacity:.1,visibility:"inherit"}).animate({opacity:pick(this.newOpacity,1)},e||{duration:250})},Chart.prototype.addSeriesAsDrilldown=function(e,i){this.addSingleSeriesAsDrilldown(e,i),this.applyDrilldown()},Chart.prototype.addSingleSeriesAsDrilldown=function(e,i){var t,o,r,n=e.series,s=n.xAxis,l=n.yAxis,a=[],d=[],p=this.styledMode?{colorIndex:pick(e.colorIndex,n.colorIndex)}:{color:e.color||n.color};this.drilldownLevels||(this.drilldownLevels=[]),o=n.options._levelNumber||0,(r=this.drilldownLevels[this.drilldownLevels.length-1])&&r.levelNumber!==o&&(r=void 0),i=extend(extend({_ddSeriesId:ddSeriesId++},p),i),t=n.points.indexOf(e),n.chart.series.forEach(function(e){e.xAxis!==s||e.isDrilling||(e.options._ddSeriesId=e.options._ddSeriesId||ddSeriesId++,e.options._colorIndex=e.userOptions._colorIndex,e.options._levelNumber=e.options._levelNumber||o,r?(a=r.levelSeries,d=r.levelSeriesOptions):(a.push(e),e.purgedOptions=merge({_ddSeriesId:e.options._ddSeriesId,_levelNumber:e.options._levelNumber,selected:e.options.selected},e.userOptions),d.push(e.purgedOptions)))}),p=extend({levelNumber:o,seriesOptions:n.options,seriesPurgedOptions:n.purgedOptions,levelSeriesOptions:d,levelSeries:a,shapeArgs:e.shapeArgs,bBox:e.graphic?e.graphic.getBBox():{},color:e.isNull?Color.parse(p.color).setOpacity(0).get():p.color,lowerSeriesOptions:i,pointOptions:n.options.data[t],pointIndex:t,oldExtremes:{xMin:s&&s.userMin,xMax:s&&s.userMax,yMin:l&&l.userMin,yMax:l&&l.userMax},resetZoomButton:this.resetZoomButton},p),this.drilldownLevels.push(p),s&&s.names&&(s.names.length=0),(i=p.lowerSeries=this.addSeries(i,!1)).options._levelNumber=o+1,s&&(s.oldPos=s.pos,s.userMin=s.userMax=null,l.userMin=l.userMax=null),n.type===i.type&&(i.animate=i.animateDrilldown||noop,i.options.animation=!0)},Chart.prototype.applyDrilldown=function(){var i,e=this.drilldownLevels;e&&0<e.length&&(i=e[e.length-1].levelNumber,this.drilldownLevels.forEach(function(e){e.levelNumber===i&&e.levelSeries.forEach(function(e){e.options&&e.options._levelNumber===i&&e.remove(!1)})})),this.resetZoomButton&&(this.resetZoomButton.hide(),delete this.resetZoomButton),this.pointer.reset(),this.redraw(),this.showDrillUpButton(),fireEvent(this,"afterDrilldown")},Chart.prototype.getDrilldownBackText=function(){var e=this.drilldownLevels;if(e&&0<e.length)return(e=e[e.length-1]).series=e.seriesOptions,format(this.options.lang.drillUpText||"",e)},Chart.prototype.showDrillUpButton=function(){var e,i,t=this,o=this.getDrilldownBackText(),r=t.options.drilldown.drillUpButton,n="chart"===r.relativeTo||"spacingBox"===r.relativeTo?null:"scrollablePlotBox";this.drillUpButton?this.drillUpButton.attr({text:o}).align():(i=(e=r.theme)&&e.states,this.drillUpButton=this.renderer.button(o,null,null,function(){t.drillUp()},e,i&&i.hover,i&&i.select).addClass("highcharts-drillup-button").attr({align:r.position.align,zIndex:7}).add().align(r.position,!1,n))},Chart.prototype.drillUp=function(){if(this.drilldownLevels&&0!==this.drilldownLevels.length){for(var e,o,r,n,i,s=this,t=s.drilldownLevels,l=t[t.length-1].levelNumber,a=t.length,d=s.series,p=function(i){var t;d.forEach(function(e){e.options._ddSeriesId===i._ddSeriesId&&(t=e)}),(t=t||s.addSeries(i,!1)).type===r.type&&t.animateDrillupTo&&(t.animate=t.animateDrillupTo),i===o.seriesPurgedOptions&&(n=t)};a--;)if((o=t[a]).levelNumber===l){if(t.pop(),!(r=o.lowerSeries).chart)for(e=d.length;e--;)if(d[e].options.id===o.lowerSeriesOptions.id&&d[e].options._levelNumber===l+1){r=d[e];break}r.xData=[],o.levelSeriesOptions.forEach(p),fireEvent(s,"drillup",{seriesOptions:o.seriesPurgedOptions||o.seriesOptions}),this.resetZoomButton&&this.resetZoomButton.destroy(),n.type===r.type&&(n.drilldownLevel=o,n.options.animation=s.options.drilldown.animation,r.animateDrillupFrom&&r.chart&&r.animateDrillupFrom(o)),n.options._levelNumber=l,r.remove(!1),n.xAxis&&(i=o.oldExtremes,n.xAxis.setExtremes(i.xMin,i.xMax,!1),n.yAxis.setExtremes(i.yMin,i.yMax,!1)),o.resetZoomButton&&(s.resetZoomButton=o.resetZoomButton,s.resetZoomButton.show())}this.redraw(),0===this.drilldownLevels.length?this.drillUpButton=this.drillUpButton.destroy():this.drillUpButton.attr({text:this.getDrilldownBackText()}).align(),this.ddDupes.length=[],fireEvent(s,"drillupall")}},addEvent(Chart,"afterInit",function(){var t=this;t.drilldown={update:function(e,i){merge(!0,t.options.drilldown,e),pick(i,!0)&&t.redraw()}}}),addEvent(Chart,"afterShowResetZoom",function(){var e=this,i=e.resetZoomButton&&e.resetZoomButton.getBBox(),e=e.options.drilldown&&e.options.drilldown.drillUpButton;this.drillUpButton&&i&&e&&e.position&&e.position.x&&this.drillUpButton.align({x:e.position.x-i.width-10,y:e.position.y,align:e.position.align},!1,e.relativeTo||"plotBox")}),addEvent(Chart,"render",function(){(this.xAxis||[]).forEach(function(n){n.ddPoints={},n.series.forEach(function(e){for(var i,t=e.xData||[],o=e.points,r=0;r<t.length;r++)"number"!=typeof(i=e.options.data[r])&&(i=e.pointClass.prototype.optionsToObject.call({series:e},i)).drilldown&&(n.ddPoints[t[r]]||(n.ddPoints[t[r]]=[]),i=r-(e.cropStart||0),n.ddPoints[t[r]].push(!(o&&0<=i&&i<o.length)||o[i]))}),objectEach(n.ticks,Tick.prototype.drillable)})}),ColumnSeries.prototype.animateDrillupTo=function(e){var t,o;e||(o=(t=this).drilldownLevel,this.points.forEach(function(e){var i=e.dataLabel;e.graphic&&e.graphic.hide(),i&&(i.hidden="hidden"===i.attr("visibility"),i.hidden||(i.hide(),e.connector&&e.connector.hide()))}),syncTimeout(function(){var i;t.points&&(i=[],t.data.forEach(function(e){i.push(e)}),(i=t.nodes?i.concat(t.nodes):i).forEach(function(e,i){var t=i===(o&&o.pointIndex)?"show":"fadeIn",i=e.dataLabel;e.graphic&&e.graphic[t]("show"==t||void 0),i&&!i.hidden&&(i.fadeIn(),e.connector&&e.connector.fadeIn())}))},Math.max(this.chart.options.drilldown.animation.duration-50,0)),delete this.animate)},ColumnSeries.prototype.animateDrilldown=function(e){var t,o=this,i=this.chart,r=i.drilldownLevels,n=animObject(i.options.drilldown.animation),s=this.xAxis,l=i.styledMode;e||(r.forEach(function(e){o.options._ddSeriesId===e.lowerSeriesOptions._ddSeriesId&&(t=e.shapeArgs,l||(t.fill=e.color))}),t.x+=pick(s.oldPos,s.pos)-s.pos,this.points.forEach(function(e){var i=e.shapeArgs;l||(i.fill=e.color),e.graphic&&e.graphic.attr(t).animate(extend(e.shapeArgs,{fill:e.color||o.color}),n),e.dataLabel&&e.dataLabel.fadeIn(n)}),delete this.animate)},ColumnSeries.prototype.animateDrillupFrom=function(r){var n=animObject(this.chart.options.drilldown.animation),s=this.group,l=s!==this.chart.columnGroup,a=this;a.trackerGroups.forEach(function(e){a[e]&&a[e].on("mouseover")}),l&&delete this.group,this.points.forEach(function(e){function i(){t.destroy(),s&&l&&(s=s.destroy())}var t=e.graphic,o=r.shapeArgs;t&&o&&(delete e.graphic,a.chart.styledMode||(o.fill=r.color),n.duration?t.animate(o,merge(n,{complete:i})):(t.attr(o),i()))})},PieSeries&&extend(PieSeries.prototype,{animateDrillupTo:ColumnSeries.prototype.animateDrillupTo,animateDrillupFrom:ColumnSeries.prototype.animateDrillupFrom,animateDrilldown:function(e){var o,r,n,s,l=this.chart.drilldownLevels[this.chart.drilldownLevels.length-1],a=this.chart.options.drilldown.animation;this.is("item")&&(a.duration=0),this.center&&(o=l.shapeArgs,r=o.start,n=(o.end-r)/this.points.length,s=this.chart.styledMode,e||(this.points.forEach(function(e,i){var t=e.shapeArgs;s||(o.fill=l.color,t.fill=e.color),e.graphic&&e.graphic.attr(merge(o,{start:r+i*n,end:r+(i+1)*n}))[a?"animate":"attr"](t,a)}),delete this.animate))}}),Point.prototype.doDrilldown=function(){this.runDrilldown()},Point.prototype.runDrilldown=function(o,e,i){var t,r=this.series.chart,n=r.options.drilldown,s=(n.series||[]).length;for(r.ddDupes||(r.ddDupes=[]);s--&&!t;)n.series[s].id===this.drilldown&&-1===r.ddDupes.indexOf(this.drilldown)&&(t=n.series[s],r.ddDupes.push(this.drilldown));fireEvent(r,"drilldown",{point:this,seriesOptions:t,category:e,originalEvent:i,points:void 0!==e&&this.series.xAxis.getDDPoints(e).slice(0)},function(e){var i=e.point.series&&e.point.series.chart,t=e.seriesOptions;i&&t&&(o?i.addSingleSeriesAsDrilldown(e.point,t):i.addSeriesAsDrilldown(e.point,t))})},Axis.prototype.drilldownCategory=function(i,t){this.getDDPoints(i).forEach(function(e){e&&e.series&&e.series.visible&&e.runDrilldown&&e.runDrilldown(!0,i,t)}),this.chart.applyDrilldown()},Axis.prototype.getDDPoints=function(e){return this.ddPoints&&this.ddPoints[e]||[]},Tick.prototype.drillable=function(){var i=this.pos,e=this.label,t=this.axis,o="xAxis"===t.coll&&t.getDDPoints,r=o&&t.getDDPoints(i),n=t.chart.styledMode;o&&(e&&r&&r.length?(e.drillable=!0,e.basicStyles||n||(e.basicStyles=merge(e.styles)),e.addClass("highcharts-drilldown-axis-label"),e.removeOnDrillableClick&&removeEvent(e.element,"click"),e.removeOnDrillableClick=addEvent(e.element,"click",function(e){e.preventDefault(),t.drilldownCategory(i,e)}),n||e.css(t.chart.options.drilldown.activeAxisLabelStyle)):e&&e.drillable&&e.removeOnDrillableClick&&(n||(e.styles={},e.css(e.basicStyles)),e.removeOnDrillableClick(),e.removeClass("highcharts-drilldown-axis-label")))},addEvent(Point,"afterInit",function(){var e=this;return e.drilldown&&!e.unbindDrilldownClick&&(e.unbindDrilldownClick=addEvent(e,"click",handlePointClick)),e}),addEvent(Point,"update",function(e){var i=this,e=e.options||{};e.drilldown&&!i.unbindDrilldownClick?i.unbindDrilldownClick=addEvent(i,"click",handlePointClick):!e.drilldown&&void 0!==e.drilldown&&i.unbindDrilldownClick&&(i.unbindDrilldownClick=i.unbindDrilldownClick())});var handlePointClick=function(e){var i=this.series;i.xAxis&&!1===i.chart.options.drilldown.allowPointDrilldown?i.xAxis.drilldownCategory(this.x,e):this.runDrilldown(void 0,void 0,e)};addEvent(Series,"afterDrawDataLabels",function(){var o=this.chart.options.drilldown.activeDataLabelStyle,r=this.chart.renderer,n=this.chart.styledMode;this.points.forEach(function(e){var i=e.options.dataLabels,t=pick(e.dlOptions,i&&i.style,{});e.drilldown&&e.dataLabel&&("contrast"!==o.color||n||(t.color=r.getContrast(e.color||this.color)),i&&i.color&&(t.color=i.color),e.dataLabel.addClass("highcharts-drilldown-data-label"),n||e.dataLabel.css(o).css(t))},this)});var applyCursorCSS=function(e,i,t,o){e[t?"addClass":"removeClass"]("highcharts-drilldown-point"),o||e.css({cursor:i})};addEvent(Series,"afterDrawTracker",function(){var i=this.chart.styledMode;this.points.forEach(function(e){e.drilldown&&e.graphic&&applyCursorCSS(e.graphic,"pointer",!0,i)})}),addEvent(Point,"afterSetState",function(){var e=this.series.chart.styledMode;this.drilldown&&this.series.halo&&"hover"===this.state?applyCursorCSS(this.series.halo,"pointer",!0,e):this.series.halo&&applyCursorCSS(this.series.halo,"auto",!1,e)}),addEvent(Chart,"selection",function(e){!0!==e.resetSelection||!this.drillUpButton||(e=this.options.drilldown&&this.options.drilldown.drillUpButton)&&e.position&&this.drillUpButton.align({x:e.position.x,y:e.position.y,align:e.position.align},!1,e.relativeTo||"plotBox")}),addEvent(Chart,"drillup",function(){this.resetZoomButton&&(this.resetZoomButton=this.resetZoomButton.destroy())});