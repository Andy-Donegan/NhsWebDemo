"use strict";import Chart from"../Core/Chart/Chart.js";import U from"../Core/Utilities.js";var addEvent=U.addEvent,fireEvent=U.fireEvent,isArray=U.isArray,isNumber=U.isNumber,objectEach=U.objectEach,pick=U.pick;function hideOrShow(t,a){var e,i,r=!1;return t&&(i=t.newOpacity,t.oldOpacity!==i&&(t.alignAttr&&t.placed?(t[i?"removeClass":"addClass"]("highcharts-data-label-hidden"),e=function(){a.styledMode||t.css({pointerEvents:i?"auto":"none"})},r=!0,t.alignAttr.opacity=i,t[t.isOld?"animate":"attr"](t.alignAttr,null,e),fireEvent(a,"afterHideOverlappingLabel")):t.attr({opacity:i})),t.isOld=!0),r}addEvent(Chart,"render",function(){var i=this,r=[];(this.labelCollectors||[]).forEach(function(t){r=r.concat(t())}),(this.yAxis||[]).forEach(function(t){t.stacking&&t.options.stackLabels&&!t.options.stackLabels.allowOverlap&&objectEach(t.stacking.stacks,function(t){objectEach(t,function(t){t.label&&"hidden"!==t.label.visibility&&r.push(t.label)})})}),(this.series||[]).forEach(function(t){var a=t.options.dataLabels;t.visible&&(!1!==a.enabled||t._hasPointLabels)&&((a=function(t){return t.forEach(function(e){e.visible&&(isArray(e.dataLabels)?e.dataLabels:e.dataLabel?[e.dataLabel]:[]).forEach(function(t){var a=t.options;t.labelrank=pick(a.labelrank,e.labelrank,e.shapeArgs&&e.shapeArgs.height),a.allowOverlap?(t.oldOpacity=t.opacity,t.newOpacity=1,hideOrShow(t,i)):r.push(t)})})})(t.nodes||[]),a(t.points))}),this.hideOverlappingLabels(r)}),Chart.prototype.hideOverlappingLabels=function(t){for(var a,e,i,r,n,l,o,s,h=this,c=t.length,d=h.renderer,p=!1,b=0;b<c;b++)(a=t[b])&&(a.oldOpacity=a.opacity,a.newOpacity=1,a.absoluteBox=function(t){var a,e,i,r,n=!t.box&&t.padding||0,l=0,o=0;if(t&&(!t.alignAttr||t.placed))return a=t.alignAttr||{x:t.attr("x"),y:t.attr("y")},e=t.parentGroup,t.width||(r=t.getBBox(),t.width=r.width,t.height=r.height,l=d.fontMetrics(null,t.element).h),i=t.width-2*n,(r={left:"0",center:"0.5",right:"1"}[t.alignValue])?o=+r*i:isNumber(t.x)&&Math.round(t.x)!==t.translateX&&(o=t.x-t.translateX),{x:a.x+(e.translateX||0)+n-(o||0),y:a.y+(e.translateY||0)+n-l,width:t.width-2*n,height:t.height-2*n}}(a));for(t.sort(function(t,a){return(a.labelrank||0)-(t.labelrank||0)}),b=0;b<c;b++)for(n=(i=t[b])&&i.absoluteBox,e=b+1;e<c;++e)l=(r=t[e])&&r.absoluteBox,n&&l&&i!==r&&0!==i.newOpacity&&0!==r.newOpacity&&(o=n,(s=l).x>=o.x+o.width||s.x+s.width<=o.x||s.y>=o.y+o.height||s.y+s.height<=o.y||((i.labelrank<r.labelrank?i:r).newOpacity=0));t.forEach(function(t){hideOrShow(t,h)&&(p=!0)}),p&&fireEvent(h,"afterHideAllOverlappingLabels")};