"use strict";import A from"../Core/Animation/AnimationUtilities.js";var animObject=A.animObject;import Chart from"../Core/Chart/Chart.js";import F from"../Core/FormatUtilities.js";var format=F.format;import D from"../Core/DefaultOptions.js";var setOptions=D.setOptions;import Series from"../Core/Series/Series.js";import SVGRenderer from"../Core/Renderer/SVG/SVGRenderer.js";var symbols=SVGRenderer.prototype.symbols;import U from"../Core/Utilities.js";var addEvent=U.addEvent,extend=U.extend,fireEvent=U.fireEvent,isNumber=U.isNumber,pick=U.pick,syncTimeout=U.syncTimeout,labelDistance=3;function ccw(t,e,r,i,o,a){t=(a-e)*(r-t)-(i-e)*(o-t);return 0<t||!(t<0)}function intersectLine(t,e,r,i,o,a,n,h){return ccw(t,e,o,a,n,h)!==ccw(r,i,o,a,n,h)&&ccw(t,e,r,i,o,a)!==ccw(t,e,r,i,n,h)}function boxIntersectLine(t,e,r,i,o,a,n,h){return intersectLine(t,e,t+r,e,o,a,n,h)||intersectLine(t+r,e,t+r,e+i,o,a,n,h)||intersectLine(t,e+i,t+r,e+i,o,a,n,h)||intersectLine(t,e,t,e+i,o,a,n,h)}function drawLabels(o){var a,n;this.renderer&&(n=animObject((a=this).renderer.globalAnimation).duration,a.labelSeries=[],a.labelSeriesMaxSum=0,U.clearTimeout(a.seriesLabelTimer),a.series.forEach(function(t){var e=t.options.label,r=t.labelBySeries,i=r&&r.closest;e.enabled&&t.visible&&(t.graph||t.area)&&!t.isSeriesBoosting&&(a.labelSeries.push(t),e.minFontSize&&e.maxFontSize&&(t.sum=t.yData.reduce(function(t,e){return(t||0)+(e||0)},0),a.labelSeriesMaxSum=Math.max(a.labelSeriesMaxSum,t.sum)),"load"===o.type&&(n=Math.max(n,animObject(t.options.animation).duration)),i&&(void 0!==i[0].plotX?r.animate({x:i[0].plotX+i[1],y:i[0].plotY+i[2]}):r.attr({opacity:0})))}),a.seriesLabelTimer=syncTimeout(function(){a.series&&a.labelSeries&&a.drawSeriesLabels()},a.renderer.forExport||!n?0:n))}setOptions({plotOptions:{series:{label:{enabled:!0,connectorAllowed:!1,connectorNeighbourDistance:24,format:void 0,formatter:void 0,minFontSize:null,maxFontSize:null,onArea:null,style:{fontWeight:"bold"},boxesToAvoid:[]}}}}),symbols.connector=function(t,e,r,i,o){var a,n=o&&o.anchorX,h=o&&o.anchorY,s=r/2;return isNumber(n)&&isNumber(h)&&(a=[["M",n,h]],(o=(o=e-h)<0?-i-o:o)<r&&(s=n<t+r/2?o:r-o),e+i<h?a.push(["L",t+s,e+i]):h<e?a.push(["L",t+s,e]):n<t?a.push(["L",t,e+i/2]):t+r<n&&a.push(["L",t+r,e+i/2])),a||[]},Series.prototype.getPointsOnGraph=function(){if(this.xAxis||this.yAxis){var t,e,r,i,o,a,n,h,s,c=this.points,l=[],p=this.graph||this.area,d=p.element,b=this.chart.inverted,m=this.xAxis,u=this.yAxis,x=(b?u:m).pos,f=(b?m:u).pos,g=pick(this.options.label.onArea,!!this.area),y=u.getThreshold(this.options.threshold),w={};if(this.getPointSpline&&d.getPointAtLength&&!g&&c.length<this.chart.plotSizeX/16){for(p.toD&&(s=p.attr("d"),p.attr({d:p.toD})),a=d.getTotalLength(),r=0;r<a;r+=16)S({chartX:x+(t=d.getPointAtLength(r)).x,chartY:f+t.y,plotX:t.x,plotY:t.y});s&&p.attr({d:s}),(t=c[c.length-1]).chartX=x+t.plotX,t.chartY=f+t.plotY,S(t)}else for(a=c.length,r=0;r<a;r+=1){if(t=c[r],e=c[r-1],t.chartX=x+t.plotX,t.chartY=f+t.plotY,g&&(t.chartCenterY=f+(t.plotY+pick(t.yBottom,y))/2),0<r&&(i=Math.abs(t.chartX-e.chartX),o=Math.abs(t.chartY-e.chartY),16<(o=Math.max(i,o))))for(n=Math.ceil(o/16),h=1;h<n;h+=1)S({chartX:e.chartX+(t.chartX-e.chartX)*(h/n),chartY:e.chartY+(t.chartY-e.chartY)*(h/n),chartCenterY:e.chartCenterY+(t.chartCenterY-e.chartCenterY)*(h/n),plotX:e.plotX+(t.plotX-e.plotX)*(h/n),plotY:e.plotY+(t.plotY-e.plotY)*(h/n)});isNumber(t.plotY)&&S(t)}return l}function S(t){var e=Math.round(t.plotX/8)+","+Math.round(t.plotY/8);w[e]||(w[e]=1,l.push(t))}},Series.prototype.labelFontSize=function(t,e){return t+this.sum/this.chart.labelSeriesMaxSum*(e-t)+"px"},Series.prototype.checkClearPoint=function(t,e,r,i){var o,a,n,h,s,c,l,p,d,b,m,u=this.chart,x=pick(this.options.label.onArea,!!this.area),f=x||this.options.label.connectorAllowed,g=Number.MAX_VALUE,y=Number.MAX_VALUE;for(p=0;p<u.boxesToAvoid.length;p+=1)if(b=u.boxesToAvoid[p],!((m={left:t,right:t+r.width,top:e,bottom:e+r.height}).left>b.right||m.right<b.left||m.top>b.bottom||m.bottom<b.top))return!1;for(p=0;p<u.series.length;p+=1)if(h=(n=u.series[p]).interpolatedPoints,n.visible&&h){for(d=1;d<h.length;d+=1){if(h[d].chartX>=t-16&&h[d-1].chartX<=t+r.width+16){if(boxIntersectLine(t,e,r.width,r.height,h[d-1].chartX,h[d-1].chartY,h[d].chartX,h[d].chartY))return!1;this===n&&!s&&i&&(s=boxIntersectLine(t-16,e-16,r.width+32,r.height+32,h[d-1].chartX,h[d-1].chartY,h[d].chartX,h[d].chartY))}!f&&!s||this===n&&!x||(c=t+r.width/2-h[d].chartX,l=e+r.height/2-h[d].chartY,g=Math.min(g,c*c+l*l))}if(!x&&f&&this===n&&(i&&!s||g<Math.pow(this.options.label.connectorNeighbourDistance,2))){for(d=1;d<h.length;d+=1)(o=Math.min(Math.pow(t+r.width/2-h[d].chartX,2)+Math.pow(e+r.height/2-h[d].chartY,2),Math.pow(t-h[d].chartX,2)+Math.pow(e-h[d].chartY,2),Math.pow(t+r.width-h[d].chartX,2)+Math.pow(e-h[d].chartY,2),Math.pow(t+r.width-h[d].chartX,2)+Math.pow(e+r.height-h[d].chartY,2),Math.pow(t-h[d].chartX,2)+Math.pow(e+r.height-h[d].chartY,2)))<y&&(y=o,a=h[d]);s=!0}}return!(i&&!s)&&{x:t,y:e,weight:g-(a?y:0),connectorPoint:a}},Chart.prototype.drawSeriesLabels=function(){var v=this,t=this.labelSeries;v.boxesToAvoid=[],t.forEach(function(t){t.interpolatedPoints=t.getPointsOnGraph(),(t.options.label.boxesToAvoid||[]).forEach(function(t){v.boxesToAvoid.push(t)})}),v.series.forEach(function(t){var e=t.options.label;if(e&&(t.xAxis||t.yAxis)){var r,i,o,a,n,h,s,c,l,p="highcharts-color-"+pick(t.colorIndex,"none"),d=!t.labelBySeries,b=e.minFontSize,m=e.maxFontSize,u=v.inverted,x=(u?t.yAxis:t.xAxis).pos,f=(u?t.xAxis:t.yAxis).pos,g=(v.inverted?t.yAxis:t.xAxis).len,y=(v.inverted?t.xAxis:t.yAxis).len,w=t.interpolatedPoints,S=pick(e.onArea,!!t.area),Y=[],X=t.labelBySeries;if(S&&!u&&(l=[t.xAxis.toPixels(t.xData[0]),t.xAxis.toPixels(t.xData[t.xData.length-1])],s=Math.min.apply(Math,l),c=Math.max.apply(Math,l)),t.visible&&!t.isSeriesBoosting&&w){for(X||(l=t.name,"string"==typeof e.format?l=format(e.format,t,v):e.formatter&&(l=e.formatter.call(t)),t.labelBySeries=X=v.renderer.label(l,0,-9999,"connector").addClass("highcharts-series-label highcharts-series-label-"+t.index+" "+(t.options.className||"")+" "+p),v.renderer.styledMode||(X.css(extend({color:S?v.renderer.getContrast(t.color):t.color},e.style||{})),X.attr({opacity:v.renderer.forExport?1:0,stroke:t.color,"stroke-width":1})),b&&m&&X.css({fontSize:t.labelFontSize(b,m)}),X.attr({padding:0,zIndex:3}).add()),(r=X.getBBox()).width=Math.round(r.width),n=w.length-1;0<n;--n)S?(h=A(i=w[n].chartX-r.width/2,o=w[n].chartCenterY-r.height/2,r)?t.checkClearPoint(i,o,r):h)&&Y.push(h):((h=A(i=w[n].chartX+labelDistance,o=w[n].chartY-r.height-labelDistance,r)?t.checkClearPoint(i,o,r,!0):h)&&Y.push(h),(h=A(i=w[n].chartX+labelDistance,o=w[n].chartY+labelDistance,r)?t.checkClearPoint(i,o,r,!0):h)&&Y.push(h),(h=A(i=w[n].chartX-r.width-labelDistance,o=w[n].chartY+labelDistance,r)?t.checkClearPoint(i,o,r,!0):h)&&Y.push(h),(h=A(i=w[n].chartX-r.width-labelDistance,o=w[n].chartY-r.height-labelDistance,r)?t.checkClearPoint(i,o,r,!0):h)&&Y.push(h));if(e.connectorAllowed&&!Y.length&&!S)for(i=x+g-r.width;x<=i;i-=16)for(o=f;o<f+y-r.height;o+=16)(a=t.checkClearPoint(i,o,r,!0))&&Y.push(a);Y.length?(Y.sort(function(t,e){return e.weight-t.weight}),h=Y[0],v.boxesToAvoid.push({left:h.x,right:h.x+r.width,top:h.y,bottom:h.y+r.height}),(b=Math.sqrt(Math.pow(Math.abs(h.x-(X.x||0)),2)+Math.pow(Math.abs(h.y-(X.y||0)),2)))&&t.labelBySeries&&(m={opacity:v.renderer.forExport?1:0,x:h.x,y:h.y},e={opacity:1},b<=10&&(e={x:m.x,y:m.y},m={}),b=void 0,d&&((b=animObject(t.options.animation)).duration*=.2),t.labelBySeries.attr(extend(m,{anchorX:h.connectorPoint&&h.connectorPoint.plotX+x,anchorY:h.connectorPoint&&h.connectorPoint.plotY+f})).animate(e,b),t.options.kdNow=!0,t.buildKDTree(),(b=t.searchPoint({chartX:h.x,chartY:h.y},!0))&&(X.closest=[b,h.x-(b.plotX||0),h.y-(b.plotY||0)]))):M()}else M()}function A(t,e,r){var i=Math.max(x,pick(s,-1/0)),o=Math.min(x+g,pick(c,1/0));return i<t&&t<=o-r.width&&f<=e&&e<=f+y-r.height}function M(){X&&(t.labelBySeries=X.destroy())}}),fireEvent(v,"afterDrawSeriesLabels")},addEvent(Chart,"load",drawLabels),addEvent(Chart,"redraw",drawLabels);