"use strict";var __extends=this&&this.__extends||function(){var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(e,t)};return function(e,t){function o(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}}();import VBPPoint from"./VBPPoint.js";import A from"../../../Core/Animation/AnimationUtilities.js";var animObject=A.animObject;import H from"../../../Core/Globals.js";var noop=H.noop;import SeriesRegistry from"../../../Core/Series/SeriesRegistry.js";var SMAIndicator=SeriesRegistry.seriesTypes.sma;import U from"../../../Core/Utilities.js";import StockChart from"../../../Core/Chart/StockChart.js";var addEvent=U.addEvent,arrayMax=U.arrayMax,arrayMin=U.arrayMin,correctFloat=U.correctFloat,defined=U.defined,error=U.error,extend=U.extend,isArray=U.isArray,merge=U.merge;function arrayExtremesOHLC(e){for(var t,o=e.length,r=e[0][3],a=r,i=1;i<o;i++)(t=e[i][3])<r&&(r=t),a<t&&(a=t);return{min:r,max:a}}var abs=Math.abs,columnPrototype=SeriesRegistry.seriesTypes.column.prototype,VBPIndicator=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.data=void 0,e.negWidths=void 0,e.options=void 0,e.points=void 0,e.posWidths=void 0,e.priceZones=void 0,e.rangeStep=void 0,e.volumeDataArray=void 0,e.zoneStarts=void 0,e.zoneLinesSVG=void 0,e}return __extends(e,t),e.prototype.init=function(e){var t,o,r=this;H.seriesTypes.sma.prototype.init.apply(r,arguments);var a=addEvent(StockChart,"afterLinkSeries",function(){r.options&&(o=r.options.params,t=r.linkedParent,o=e.get(o.volumeSeriesID),r.addCustomEvents(t,o)),a()},{order:1});return r},e.prototype.addCustomEvents=function(e,t){var o=this;function r(){o.chart.redraw(),o.setData([]),o.zoneStarts=[],o.zoneLinesSVG&&(o.zoneLinesSVG=o.zoneLinesSVG.destroy())}return o.dataEventsToUnbind.push(addEvent(e,"remove",function(){r()})),t&&o.dataEventsToUnbind.push(addEvent(t,"remove",function(){r()})),o},e.prototype.animate=function(e){var o=this,t=o.chart.inverted,r=o.group,a={};!e&&r&&(e=t?o.yAxis.top:o.xAxis.left,t?(r["forceAnimate:translateY"]=!0,a.translateY=e):(r["forceAnimate:translateX"]=!0,a.translateX=e),r.animate(a,extend(animObject(o.options.animation),{step:function(e,t){o.group.attr({scaleX:Math.max(.001,t.pos)})}})))},e.prototype.drawPoints=function(){var e=this;e.options.volumeDivision.enabled&&(e.posNegVolume(!0,!0),columnPrototype.drawPoints.apply(e,arguments),e.posNegVolume(!1,!1)),columnPrototype.drawPoints.apply(e,arguments)},e.prototype.posNegVolume=function(e,t){var o,r,a,i,n=this,s=t?["positive","negative"]:["negative","positive"],p=n.options.volumeDivision,l=n.points.length,d=[],u=[],c=0;for(e?(n.posWidths=d,n.negWidths=u):(d=n.posWidths,u=n.negWidths);c<l;c++)(i=n.points[c])[s[0]+"Graphic"]=i.graphic,i.graphic=i[s[1]+"Graphic"],e&&(o=i.shapeArgs.width,(a=(r=n.priceZones[c]).wholeVolumeData)?(d.push(o/a*r.positiveVolumeData),u.push(o/a*r.negativeVolumeData)):(d.push(0),u.push(0))),i.color=t?p.styles.positiveColor:p.styles.negativeColor,i.shapeArgs.width=(t?n.posWidths:n.negWidths)[c],i.shapeArgs.x=t?i.shapeArgs.x:n.posWidths[c]},e.prototype.translate=function(){var e,o,r,a,i,n,t,s,p,l=this,d=l.options,u=l.chart,c=l.yAxis,h=c.min,m=l.options.zoneLines,v=l.priceZones,f=0;columnPrototype.translate.apply(l),(e=l.points).length&&(t=d.pointPadding<.5?d.pointPadding:.1,d=l.volumeDataArray,o=arrayMax(d),r=u.plotWidth/2,s=u.plotTop,a=abs(c.toPixels(h)-c.toPixels(h+l.rangeStep)),i=abs(c.toPixels(h)-c.toPixels(h+l.rangeStep)),t&&(t=abs(a*(1-2*t)),f=abs((a-t)/2),a=abs(t)),e.forEach(function(e,t){e.barX=e.plotX=0,p=e.plotY=c.toPixels(v[t].start)-s-(c.reversed?a-i:a)-f,n=correctFloat(r*v[t].wholeVolumeData/o),e.pointWidth=n,e.shapeArgs=l.crispCol.apply(l,[0,p,n,a]),e.volumeNeg=v[t].negativeVolumeData,e.volumePos=v[t].positiveVolumeData,e.volumeAll=v[t].wholeVolumeData}),m.enabled&&l.drawZones(u,c,l.zoneStarts,m.styles))},e.prototype.getValues=function(e,t){var o,r,a=e.processedXData,i=e.processedYData,n=this.chart,s=t.ranges,p=[],l=[],d=[];if(e.chart)if(r=n.get(t.volumeSeriesID)){if(!(o=isArray(i[0]))||4===i[0].length)return(this.priceZones=this.specifyZones(o,a,i,s,r)).forEach(function(e,t){p.push([e.x,e.end]),l.push(p[t][0]),d.push(p[t][1])}),{values:p,xData:l,yData:d};error("Type of "+e.name+" series is different than line, OHLC or candlestick.",!0,n)}else error("Series "+t.volumeSeriesID+" not found! Check `volumeSeriesID`.",!0,n);else error("Base series not found! In case it has been removed, add a new one.",!0,n)},e.prototype.specifyZones=function(e,t,o,r,a){var i,n,s=this,p=!!e&&arrayExtremesOHLC(o),l=p?p.min:arrayMin(o),d=p?p.max:arrayMax(o),u=s.zoneStarts=[],c=[],h=0,m=1,p=s.linkedParent;if(!s.options.compareToMain&&p.dataModify&&(l=p.dataModify.modifyValue(l),d=p.dataModify.modifyValue(d)),!defined(l)||!defined(d))return this.points.length&&(this.setData([]),this.zoneStarts=[],this.zoneLinesSVG&&(this.zoneLinesSVG=this.zoneLinesSVG.destroy())),[];for(i=s.rangeStep=correctFloat(d-l)/r,u.push(l);h<r-1;h++)u.push(correctFloat(u[h]+i));for(u.push(d),n=u.length;m<n;m++)c.push({index:m-1,x:t[0],start:u[m-1],end:u[m]});return s.volumePerZone(e,c,a,t,o)},e.prototype.volumePerZone=function(o,e,t,r,a){var i,n,s,p,l,d=this,u=t.processedXData,c=t.processedYData,h=e.length-1,m=a.length,t=c.length;return abs(m-t)&&(r[0]!==u[0]&&c.unshift(0),r[m-1]!==u[t-1]&&c.push(0)),d.volumeDataArray=[],e.forEach(function(e){for(e.wholeVolumeData=0,e.positiveVolumeData=0,e.negativeVolumeData=0,l=0;l<m;l++){s=n=!1,p=o?a[l][3]:a[l],i=l?o?a[l-1][3]:a[l-1]:p;var t=d.linkedParent;!d.options.compareToMain&&t.dataModify&&(p=t.dataModify.modifyValue(p),i=t.dataModify.modifyValue(i)),p<=e.start&&0===e.index&&(n=!0),p>=e.end&&e.index===h&&(s=!0),(p>e.start||n)&&(p<e.end||s)&&(e.wholeVolumeData+=c[l],p<i?e.negativeVolumeData+=c[l]:e.positiveVolumeData+=c[l])}d.volumeDataArray.push(e.wholeVolumeData)}),e},e.prototype.drawZones=function(t,o,e,r){var a,i=t.renderer,n=this.zoneLinesSVG,s=[],p=t.plotWidth,l=t.plotTop;e.forEach(function(e){a=o.toPixels(e)-l,s=s.concat(t.renderer.crispLine([["M",0,a],["L",p,a]],r.lineWidth))}),n?n.animate({d:s}):this.zoneLinesSVG=i.path(s).attr({"stroke-width":r.lineWidth,stroke:r.color,dashstyle:r.dashStyle,zIndex:this.group.zIndex+.1}).add(this.group)},e.defaultOptions=merge(SMAIndicator.defaultOptions,{params:{index:void 0,period:void 0,ranges:12,volumeSeriesID:"volume"},zoneLines:{enabled:!0,styles:{color:"#0A9AC9",dashStyle:"LongDash",lineWidth:1}},volumeDivision:{enabled:!0,styles:{positiveColor:"rgba(144, 237, 125, 0.8)",negativeColor:"rgba(244, 91, 91, 0.8)"}},animationLimit:1e3,enableMouseTracking:!1,pointPadding:0,zIndex:-1,crisp:!0,dataGrouping:{enabled:!1},dataLabels:{allowOverlap:!0,enabled:!0,format:"P: {point.volumePos:.2f} | N: {point.volumeNeg:.2f}",padding:0,style:{fontSize:"7px"},verticalAlign:"top"}}),e}(SMAIndicator);extend(VBPIndicator.prototype,{nameBase:"Volume by Price",nameComponents:["ranges"],calculateOn:{chart:"render",xAxis:"afterSetExtremes"},pointClass:VBPPoint,markerAttribs:noop,drawGraph:noop,getColumnMetrics:columnPrototype.getColumnMetrics,crispCol:columnPrototype.crispCol}),SeriesRegistry.registerSeriesType("vbp",VBPIndicator);export default VBPIndicator;