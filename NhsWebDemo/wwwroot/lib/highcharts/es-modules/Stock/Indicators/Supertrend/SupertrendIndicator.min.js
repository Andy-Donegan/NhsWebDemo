"use strict";var __extends=this&&this.__extends||function(){var r=function(o,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,t){o.__proto__=t}||function(o,t){for(var e in t)t.hasOwnProperty(e)&&(o[e]=t[e])})(o,t)};return function(o,t){function e(){this.constructor=o}r(o,t),o.prototype=null===t?Object.create(t):(e.prototype=t.prototype,new e)}}();import SeriesRegistry from"../../../Core/Series/SeriesRegistry.js";var _a=SeriesRegistry.seriesTypes,ATRIndicator=_a.atr,SMAIndicator=_a.sma;import U from"../../../Core/Utilities.js";import StockChart from"../../../Core/Chart/StockChart.js";var addEvent=U.addEvent,correctFloat=U.correctFloat,isArray=U.isArray,extend=U.extend,merge=U.merge,objectEach=U.objectEach;function createPointObj(o,t,e){return{index:t,close:o.yData[t][e],x:o.xData[t]}}var SupertrendIndicator=function(t){function o(){var o=null!==t&&t.apply(this,arguments)||this;return o.data=void 0,o.linkedParent=void 0,o.options=void 0,o.points=void 0,o}return __extends(o,t),o.prototype.init=function(){var t;SMAIndicator.prototype.init.apply(this,arguments);var e=this,r=addEvent(StockChart,"afterLinkSeries",function(){var o;e.options&&(o=e.options,t=e.linkedParent.options,o.cropThreshold=t.cropThreshold-(o.params.period-1)),r()},{order:1})},o.prototype.drawGraph=function(){for(var o,t,e,r,n,i,a,l,s=this,p=s.options,c=s.linkedParent,d=c?c.points:[],h=s.points,u=s.graph,y=h.length,g=d.length-y,x=0<g?g:0,f={options:{gapSize:p.gapSize}},m={top:[],bottom:[],intersect:[]},S={top:{styles:{lineWidth:p.lineWidth,lineColor:p.fallingTrendColor||p.color,dashStyle:p.dashStyle}},bottom:{styles:{lineWidth:p.lineWidth,lineColor:p.risingTrendColor||p.color,dashStyle:p.dashStyle}},intersect:p.changeTrendLine};y--;)o=h[y],t=h[y-1],e=d[y-1+x],r=d[y-2+x],l=d[y+x],n=d[y+x+1],i=o.options.color,a={x:o.x,plotX:o.plotX,plotY:o.plotY,isNull:!1},!r&&e&&c.yData[e.index-1]&&(r=createPointObj(c,e.index-1,3)),!n&&l&&c.yData[l.index+1]&&(n=createPointObj(c,l.index+1,3)),!e&&r&&c.yData[r.index+1]?e=createPointObj(c,r.index+1,3):!e&&l&&c.yData[l.index-1]&&(e=createPointObj(c,l.index-1,3)),o&&e&&l&&r&&o.x!==e.x&&(o.x===l.x?(r=e,e=l):o.x===r.x?(e=r,r={close:c.yData[e.index-1][3],x:c.xData[e.index-1]}):n&&o.x===n.x&&(e=n,r=l)),t&&r&&e?(l={x:t.x,plotX:t.plotX,plotY:t.plotY,isNull:!1},o.y>=e.close&&t.y>=r.close?(o.color=i||p.fallingTrendColor||p.color,m.top.push(a)):o.y<e.close&&t.y<r.close?(o.color=i||p.risingTrendColor||p.color,m.bottom.push(a)):(m.intersect.push(a),m.intersect.push(l),m.intersect.push(merge(l,{isNull:!0})),o.y>=e.close&&t.y<r.close?(o.color=i||p.fallingTrendColor||p.color,t.color=i||p.risingTrendColor||p.color,m.top.push(a),m.top.push(merge(l,{isNull:!0}))):o.y<e.close&&t.y>=r.close&&(o.color=i||p.risingTrendColor||p.color,t.color=i||p.fallingTrendColor||p.color,m.bottom.push(a),m.bottom.push(merge(l,{isNull:!0}))))):e&&(o.y>=e.close?(o.color=i||p.fallingTrendColor||p.color,m.top.push(a)):(o.color=i||p.risingTrendColor||p.color,m.bottom.push(a)));objectEach(m,function(o,t){s.points=o,s.options=merge(S[t].styles,f),s.graph=s["graph"+t+"Line"],SMAIndicator.prototype.drawGraph.call(s),s["graph"+t+"Line"]=s.graph}),s.points=h,s.options=p,s.graph=u},o.prototype.getValues=function(o,t){var e,r,n,i,a,l,s,p,c,d,h=t.period,u=t.multiplier,y=o.xData,g=o.yData,x=[],f=[],m=[],S=0===h?0:h-1,C=[],v=[];if(!(y.length<=h||!isArray(g[0])||4!==g[0].length||h<0)){for(e=ATRIndicator.prototype.getValues.call(this,o,{period:h}).yData,d=0;d<e.length;d++)c=g[S+d],p=g[S+d-1]||[],a=C[d-1],l=v[d-1],s=m[d-1],0===d&&(a=l=s=0),r=correctFloat((c[1]+c[2])/2+u*e[d]),n=correctFloat((c[1]+c[2])/2-u*e[d]),r<a||p[3]>a?C[d]=r:C[d]=a,l<n||p[3]<l?v[d]=n:v[d]=l,s===a&&c[3]<C[d]||s===l&&c[3]<v[d]?i=C[d]:(s===a&&c[3]>C[d]||s===l&&c[3]>v[d])&&(i=v[d]),x.push([y[S+d],i]),f.push(y[S+d]),m.push(i);return{values:x,xData:f,yData:m}}},o.defaultOptions=merge(SMAIndicator.defaultOptions,{params:{index:void 0,multiplier:3,period:10},risingTrendColor:"#06b535",fallingTrendColor:"#f21313",changeTrendLine:{styles:{lineWidth:1,lineColor:"#333333",dashStyle:"LongDash"}}}),o}(SMAIndicator);extend(SupertrendIndicator.prototype,{nameBase:"Supertrend",nameComponents:["multiplier","period"]}),SeriesRegistry.registerSeriesType("supertrend",SupertrendIndicator);export default SupertrendIndicator;