"use strict";var __spreadArrays=this&&this.__spreadArrays||function(){for(var t=0,e=0,o=arguments.length;e<o;e++)t+=arguments[e].length;for(var r=Array(t),n=0,e=0;e<o;e++)for(var i=arguments[e],s=0,a=i.length;s<a;s++,n++)r[n]=i[s];return r};import DataPromise from"./DataPromise.js";import U from"../Core/Utilities.js";var addEvent=U.addEvent,fireEvent=U.fireEvent,uniqueKey=U.uniqueKey,DataTable=function(){function w(t,e){void 0===t&&(t={}),this.aliasMap={},this.autoId=!e,this.columns={},this.id=e||uniqueKey(),(this.modified=this).rowCount=0,this.versionTag=uniqueKey();for(var o,r,n=Object.keys(t),i=this.columns,s=0,a=0,l=n.length;a<l;++a)o=t[r=n[a]].slice(),i[r]=o,s=Math.max(s,o.length);for(a=0,l=n.length;a<l;++a)i[n[a]].length=s;this.rowCount=s}return w.isNull=function(t){if(t===w.NULL)return!0;if(t instanceof Array){if(!t.length)return!1;for(var e=0,o=t.length;e<o;++e)if(null!==t[e])return!1}else{var r=Object.keys(t);if(!r.length)return!1;for(e=0,o=r.length;e<o;++e)if(null!==t[r[e]])return!1}return!0},w.prototype.clone=function(t,e){var o=this,r=o.aliasMap,n=Object.keys(o.aliasMap);o.emit({type:"cloneTable",detail:e});var i=new w(t?{}:o.columns,o.autoId?void 0:o.id);if(!t&&(i.versionTag=o.versionTag,n.length))for(var s,a=i.aliasMap,l=0,u=n.length;l<u;++l)a[s=n[l]]=r[s];return o.emit({type:"afterCloneTable",detail:e,tableClone:i}),i},w.prototype.deleteColumnAlias=function(t){var e=this,o=e.aliasMap[t],r=e.modifier;return o&&(delete e.aliasMap[t],r&&r.modifyColumns(e,((r={})[o]=new Array(e.rowCount),r),0)),o},w.prototype.deleteColumns=function(t,e){var o=this,r=o.columns,n={},i={},s=o.modifier,a=o.rowCount;if((t=t||Object.keys(r)).length){o.emit({type:"deleteColumns",columnNames:t,detail:e});for(var l,u,f=0,p=t.length;f<p;++f)(l=r[u=t[f]])&&(n[u]=l,i[u]=new Array(a)),delete r[u];return Object.keys(r).length||(o.rowCount=0),s&&s.modifyColumns(o,i,0,e),o.emit({type:"afterDeleteColumns",columns:n,columnNames:t,detail:e}),n}},w.prototype.deleteRows=function(t,e,o){var r=this,n=[],i=[],s=r.modifier;if(r.emit({type:"deleteRows",detail:o,rowCount:e=void 0===e?1:e,rowIndex:t||0}),void 0===t&&(t=0,e=r.rowCount),0<e&&t<r.rowCount)for(var a,l=r.columns,u=Object.keys(l),f=0,p=u.length,m=void 0;f<p;++f){a=(m=l[u[f]]).splice(t,e),f||(r.rowCount=m.length);for(var h=0,c=a.length;h<c;++h)n[h]=n[h]||[],n[h][f]=a[h];i.push(new Array(p))}return s&&s.modifyRows(r,i,t||0,o),r.emit({type:"afterDeleteRows",detail:o,rowCount:e,rowIndex:t||0,rows:n}),n},w.prototype.emit=function(t){switch(t.type){case"afterDeleteColumns":case"afterDeleteRows":case"afterSetCell":case"afterSetColumns":case"afterSetRows":this.versionTag=uniqueKey()}fireEvent(this,t.type,t)},w.prototype.getCell=function(t,e){t=this.aliasMap[t]||t;t=this.columns[t];if(t)return t[e]},w.prototype.getCellAsBoolean=function(t,e){t=this.aliasMap[t]||t;t=this.columns[t];return!(!t||!t[e])},w.prototype.getCellAsNumber=function(t,e,o){t=this.aliasMap[t]||t;var t=this.columns[t],r=t&&t[e];switch(typeof r){case"boolean":return r?1:0;case"number":return isNaN(r)&&!o?null:r}return r=parseFloat(""+r),isNaN(r)&&!o?null:r},w.prototype.getCellAsString=function(t,e){t=this.aliasMap[t]||t;t=this.columns[t];return""+(t&&t[e])},w.prototype.getColumn=function(t,e){return this.getColumns([t],e)[t]},w.prototype.getColumnAliases=function(){return Object.keys(this.aliasMap)},w.prototype.getColumnAsNumbers=function(t,e){var o=this.columns[t=this.aliasMap[t]||t],r=[];if(o){var n=o.length;if(e)for(var i=0;i<n;++i)r.push(this.getCellAsNumber(t,i,!0));else{for(var s,i=0;i<n;++i){if("number"==typeof(s=o[i]))return o.slice();if(null!=s)break}for(i=0;i<n;++i)r.push(this.getCellAsNumber(t,i))}}return r},w.prototype.getColumnNames=function(){return Object.keys(this.columns)},w.prototype.getColumns=function(t,e){for(var o,r=this.aliasMap,n=this.columns,i={},s=0,a=(t=t||Object.keys(n)).length,l=void 0;s<a;++s)(l=n[r[o=t[s]]||o])&&(i[o]=e?l:l.slice());return i},w.prototype.getModifier=function(){return this.modifier},w.prototype.getRow=function(t,e){return this.getRows(t,1,e)[0]},w.prototype.getRowCount=function(){return this.rowCount},w.prototype.getRowIndexBy=function(t,e,o){t=this.aliasMap[t]||t;t=this.columns[t];if(t){o=t.indexOf(e,o);if(-1!==o)return o}},w.prototype.getRowObject=function(t,e){return this.getRowObjects(t,1,e)[0]},w.prototype.getRowObjects=function(t,e,o){void 0===t&&(t=0),void 0===e&&(e=this.rowCount-t);for(var r=this.aliasMap,n=this.columns,i=new Array(e),s=(o=o||Object.keys(n)).length,a=t,l=0,u=Math.min(this.rowCount,t+e),f=void 0;a<u;++a,++l)for(var p,f=i[l]={},m=0,h=s;m<h;++m)f[p=o[m]]=n[r[p]||p][a];return i},w.prototype.getRows=function(t,e,o){void 0===t&&(t=0),void 0===e&&(e=this.rowCount-t);for(var r,n=this.aliasMap,i=this.columns,s=new Array(e),a=(o=o||Object.keys(i)).length,l=t,u=0,f=Math.min(this.rowCount,t+e),p=void 0;l<f;++l,++u)for(var p=s[u]=new Array(a),m=0;m<a;++m)r=o[m],p[m]=i[n[r]||r][l];return s},w.prototype.getVersionTag=function(){return this.versionTag},w.prototype.hasColumns=function(t){for(var e,o=this.aliasMap,r=this.columns,n=0,i=t.length;n<i;++n)if(!r[e=t[n]]&&!o[e])return!1;return!0},w.prototype.hasRowWith=function(t,e){t=this.aliasMap[t]||t;t=this.columns[t];return!!t&&-1!==t.indexOf(e)},w.prototype.on=function(t,e){return addEvent(this,t,e)},w.prototype.renameColumn=function(t,e){var o,r=this.columns;return!!r[t]&&(t!==e&&((o=this.aliasMap)[e]&&delete o[e],r[e]=r[t],delete r[t]),!0)},w.prototype.setCell=function(t,e,o,r){var n=this,i=n.columns,s=n.modifier,a=i[t=n.aliasMap[t]||t];a&&a[e]===o||(n.emit({type:"setCell",cellValue:o,columnName:t,detail:r,rowIndex:e}),a=a||(i[t]=new Array(n.rowCount)),e>=n.rowCount&&(n.rowCount=e+1),a[e]=o,s&&s.modifyCell(n,t,e,o),n.emit({type:"afterSetCell",cellValue:o,columnName:t,detail:r,rowIndex:e}))},w.prototype.setColumn=function(t,e,o,r){var n;void 0===o&&(o=0),this.setColumns(((n={})[t]=e=void 0===e?[]:e,n),o,r)},w.prototype.setColumnAlias=function(t,e){var o=this.aliasMap;return!o[t]&&(o[t]=e,!0)},w.prototype.setColumns=function(t,e,o){var r=this,n=r.columns,i=r.modifier,s=r.rowCount,a=void 0===e,l=Object.keys(t);r.emit({type:"setColumns",columns:t,columnNames:l,detail:o,rowIndex:e});for(var u=0,f=l.length,p=void 0,m=void 0;u<f;++u){var h,p=t[m=l[u]];m=r.aliasMap[m]||m,a?(n[m]=p.slice(),r.rowCount=p.length):(h=n[m]||(n[m]=new Array(r.rowCount)),s<(e=e||0)?(h.length=e,h.push.apply(h,p)):h.splice.apply(h,__spreadArrays([e,p.length-e],p)),r.rowCount=Math.max(r.rowCount,h.length))}for(var c=Object.keys(n),u=0,f=c.length;u<f;++u)n[c[u]].length=r.rowCount;i&&i.modifyColumns(r,t,e||0),r.emit({type:"afterSetColumns",columns:t,columnNames:l,detail:o,rowIndex:e})},w.prototype.setModifier=function(e,o){var r=this;return r.emit({type:"setModifier",detail:o,modifier:e,modified:r.modified}),((r.modifier=e)?e.modify(r):DataPromise.resolve(r).then(function(t){return t.modified=t})).then(function(t){return t.emit({type:"afterSetModifier",detail:o,modifier:e,modified:t.modified}),t}).catch(function(t){throw r.emit({type:"setModifierError",error:t,modifier:e,modified:r.modified}),t})},w.prototype.setRow=function(t,e,o){this.setRows([t],e,o)},w.prototype.setRows=function(t,e,o){void 0===e&&(e=this.rowCount);var r=this,n=r.aliasMap,i=r.columns,s=Object.keys(i),a=r.modifier,l=t.length;r.emit({type:"setRows",detail:o,rowCount:l,rowIndex:e,rows:t});for(var u,f=0,p=e;f<l;++f,++p)if((u=t[f])===w.NULL)for(var m=0,h=s.length;m<h;++m)i[s[m]][p]=null;else if(u instanceof Array)for(m=0,h=s.length;m<h;++m)i[s[m]][p]=u[m];else for(var c=Object.keys(u),m=0,h=c.length,d=void 0;m<h;++m)i[d=n[d=c[m]]||d]||(i[d]=new Array(p+1)),i[d][p]=u[d];var y=e+l;if(y>r.rowCount){r.rowCount=y;for(var f=0,v=s.length;f<v;++f)i[s[f]].length=y}a&&a.modifyRows(r,t,e),r.emit({type:"afterSetRows",detail:o,rowCount:l,rowIndex:e,rows:t})},w.NULL={},w}();export default DataTable;