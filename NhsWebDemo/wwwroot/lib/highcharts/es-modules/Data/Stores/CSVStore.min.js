"use strict";var __extends=this&&this.__extends||function(){var o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};return function(t,e){function r(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),__rest=this&&this.__rest||function(t,e){var r={};for(a in t)Object.prototype.hasOwnProperty.call(t,a)&&e.indexOf(a)<0&&(r[a]=t[a]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var o=0,a=Object.getOwnPropertySymbols(t);o<a.length;o++)e.indexOf(a[o])<0&&Object.prototype.propertyIsEnumerable.call(t,a[o])&&(r[a[o]]=t[a[o]]);return r};import CSVParser from"../Parsers/CSVParser.js";import DataStore from"./DataStore.js";import DataTable from"../DataTable.js";import HU from"../../Core/HttpUtilities.js";var ajax=HU.ajax;import U from"../../Core/Utilities.js";var merge=U.merge,objectEach=U.objectEach,CSVStore=function(s){function l(t,e,r){void 0===t&&(t=new DataTable),void 0===e&&(e={});var o=s.call(this,t)||this,a=e.csv,i=e.csvURL,n=e.enablePolling,t=e.dataRefreshRate,e=__rest(e,["csv","csvURL","enablePolling","dataRefreshRate"]);return o.parserOptions=e,o.options=merge(l.defaultOptions,{csv:a,csvURL:i,enablePolling:n,dataRefreshRate:t}),o.parser=r||new CSVParser(e),o}return __extends(l,s),l.prototype.poll=function(){var t=this,e=this.options,r=e.dataRefreshRate,o=e.enablePolling,e=e.csvURL;o&&e===this.liveDataURL&&(this.liveDataTimeout=setTimeout(function(){t.fetchCSV()},1e3*(1<r?r:1)))},l.prototype.fetchCSV=function(t,r){var o,a=this,e=a.options.csvURL;a.table.deleteColumns(),t&&(clearTimeout(a.liveDataTimeout),a.liveDataURL=e),a.emit({type:"load",detail:r,table:a.table}),ajax({url:a.liveDataURL,dataType:"text",success:function(t){a.parser.parse({csv:t}),a.table.setColumns(a.parser.getTable().getColumns()),a.liveDataURL&&a.poll(),a.emit({type:"afterLoad",csv:t,detail:r,table:a.table})},error:function(t,e){++o<3&&a.poll(),a.emit({type:"loadError",detail:r,error:e,table:a.table,xhr:t})}})},l.prototype.load=function(t){var e=this,r=e.parser,o=e.table,a=e.options,i=a.csv,a=a.csvURL;i?(o.deleteRows(),e.emit({type:"load",csv:i,detail:t,table:o}),r.parse({csv:i}),o.setColumns(r.getTable().getColumns()),e.emit({type:"afterLoad",csv:i,detail:t,table:o})):a?e.fetchCSV(!0,t):e.emit({type:"loadError",detail:t,error:"Unable to load: no CSV string or URL was provided",table:o})},l.prototype.getCSVForExport=function(t){var e=t.useLocalDecimalPoint,r=t.lineDelimiter,o=!1!==this.parserOptions.firstRowAsNames,a=t.decimalPoint,i=t.itemDelimiter,a=a||(","!==i&&e?1.1.toLocaleString()[1]:"."),i=i||(","===a?";":","),t=this.getColumnsForExport(t.usePresentationOrder),n=t.columnNames,s=t.columnValues,l=[],p=n.length,c=[];o&&l.push(n.map(function(t){return'"'+t+'"'}).join(i));for(var u=0;u<p;u++){var f=n[u],m=s[u],v=m.length,f=this.whatIs(f),d=void 0;f&&(d=f.dataType);for(var h=0;h<v;h++){var b=m[h];if(c[h]||(c[h]=[]),"string"===d?b='"'+b+'"':"number"==typeof b?b=String(b).replace(".",a):"string"==typeof b&&(b='"'+b+'"'),c[h][u]=b,u===p-1){for(var y=u;2<c[h].length;){if(void 0!==c[h][y])break;c[h].pop(),y--}l.push(c[h].join(i))}}}return l.join(r)},l.prototype.save=function(t){var r=l.defaultExportOptions;return objectEach(this.parserOptions,function(t,e){e in r&&(r[e]=t)}),this.getCSVForExport(merge(r,t))},l.defaultOptions={csv:"",csvURL:"",enablePolling:!1,dataRefreshRate:1},l.defaultExportOptions={decimalPoint:null,itemDelimiter:null,lineDelimiter:"\n"},l}(DataStore);DataStore.addStore(CSVStore);export default CSVStore;