"use strict";var __extends=this&&this.__extends||function(){var s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,r=1,s=arguments.length;r<s;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};import DataParser from"./DataParser.js";import DataConverter from"../DataConverter.js";import U from"../../Core/Utilities.js";var merge=U.merge,CSVParser=function(s){function n(e,t){var r=s.call(this)||this;return r.columns=[],r.headers=[],r.dataTypes=[],r.options=merge(n.defaultOptions,e),r.converter=t||new DataConverter,r}return __extends(n,s),n.prototype.parse=function(e,t){var r,s=this,n=s.dataTypes,i=s.converter,o=merge(this.options,e),a=o.beforeParse,l=o.lineDelimiter,u=o.firstRowAsNames,p=o.itemDelimiter,m=0,e=o.csv,c=o.startRow,f=o.endRow;if(s.columns=[],s.emit({type:"parse",columns:s.columns,detail:t,headers:s.headers}),e=e&&a?a(e):e){if(r=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split(l||"\n"),(!c||c<0)&&(c=0),(!f||f>=r.length)&&(f=r.length-1),p||(s.guessedItemDelimiter=s.guessDelimiter(r)),u){for(var g=r[0].split(p||s.guessedItemDelimiter||","),h=0;h<g.length;h++)g[h]=g[h].replace(/^["']|["']$/g,"");s.headers=g,c++}for(var d=0,m=c;m<=f;m++)"#"===r[m][0]?d++:s.parseCSVRow(r[m],m-c-d);n.length&&n[0].length&&"date"===n[0][1]&&!s.converter.getDateFormat()&&s.converter.deduceDateFormat(s.columns[0],null,!0);for(var h=0,v=s.columns.length;h<v;++h)for(var y,D,_=0,b=(y=s.columns[h]).length;_<b;++_)y[_]&&"string"==typeof y[_]&&((D=i.asGuessedType(y[_]))instanceof Date&&(D=D.getTime()),s.columns[h][_]=D)}s.emit({type:"afterParse",columns:s.columns,detail:t,headers:s.headers})},n.prototype.parseCSVRow=function(t,r){var e=this,s=this.converter,n=e.columns||[],i=e.dataTypes,o=e.options,a=o.startColumn,l=o.endColumn,u=e.options.itemDelimiter||e.guessedItemDelimiter,p=e.options.decimalPoint;p&&p!==u||(p=e.guessedDecimalPoint||".");var m=0,c="",f="",g="",h="",d=0,v=0;function y(e){c=t[e],f=t[e-1],g=t[e+1]}function D(e){i.length<v+1&&i.push([e]),i[v][i[v].length-1]!==e&&i[v].push(e)}function _(){if(d<a||l<d)return++d,void(h="");var e;"string"==typeof h?!isNaN(parseFloat(h))&&isFinite(h)?(h=parseFloat(h),D("number")):isNaN(Date.parse(h))?D("string"):(h=h.replace(/\//g,"-"),D("date")):D("number"),n.length<v+1&&n.push([]),"number"!=typeof h&&"number"!==s.guessType(h)&&p&&(h=(e=h).replace(p,"."),"number"!==s.guessType(h)&&(h=e)),n[v][r]=h,h="",++v,++d}if(t.trim().length&&"#"!==t.trim()[0]){for(;m<t.length;m++){if(y(m),"#"===c&&!/^#[0-F]{3,3}|[0-F]{6,6}/i.test(t.substr(m)))return void _();if('"'===c)for(y(++m);m<t.length&&('"'!==c||'"'===f||'"'===g);)('"'!==c||'"'===c&&'"'!==f)&&(h+=c),y(++m);else c===u?_():h+=c}_()}},n.prototype.guessDelimiter=function(e){for(var t,r=0,s=0,n={",":0,";":0,"\t":0},i=e.length,o=0;o<i;o++){var a,l,u=!1,p=void 0,m="";if(13<o)break;for(var c=e[o],f=0;f<c.length&&(a=c[f],p=c[f+1],l=c[f-1],"#"!==a);f++){if('"'===a)if(u){if('"'!==l&&'"'!==p){for(;" "===p&&f<c.length;)p=c[++f];void 0!==n[p]&&n[p]++,u=!1}}else u=!0;else void 0!==n[a]?(m=m.trim(),isNaN(Date.parse(m))&&!isNaN(Number(m))&&isFinite(Number(m))||n[a]++,m=""):m+=a;","===a&&s++,"."===a&&r++}}return t=n[";"]>n[","]?";":(n[","],n[";"],","),this.guessedDecimalPoint=s<r?".":",",t},n.prototype.getTable=function(){return DataParser.getTableFromColumns(this.columns,this.headers)},n.defaultOptions=__assign(__assign({},DataParser.defaultOptions),{lineDelimiter:"\n"}),n}(DataParser);export default CSVParser;