"use strict";import ColumnSeries from"../Column/ColumnSeries.js";var columnProto=ColumnSeries.prototype;import H from"../../Core/Globals.js";var svg=H.svg;import Series from"../../Core/Series/Series.js";import Math3D from"../../Extensions/Math3D.js";var perspective=Math3D.perspective;import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";import StackItem from"../../Extensions/Stacking.js";import U from"../../Core/Utilities.js";var columnRangeProto,addEvent=U.addEvent,pick=U.pick,wrap=U.wrap;function retrieveStacks(t,i){var e,s=t.series,o={totalStacks:0},r=1;return s.forEach(function(t){e=pick(t.options.stack,i?0:s.length-1-t.index),o[e]?o[e].series.push(t):(o[e]={series:[t],position:r},r++)}),o.totalStacks=r+1,o}function pointAttribs(t){t=t.apply(this,[].slice.call(arguments,1));return this.chart.is3d&&this.chart.is3d()&&(t.stroke=this.options.edgeColor||t.fill,t["stroke-width"]=pick(this.options.edgeWidth,1)),t}function setState(t,i,e){var s=this.chart.is3d&&this.chart.is3d();s&&(this.options.inactiveOtherPoints=!0),t.call(this,i,e),s&&(this.options.inactiveOtherPoints=!1)}function hasNewShapeType(t){for(var i=[],e=1;e<arguments.length;e++)i[e-1]=arguments[e];return this.series.chart.is3d()?this.graphic&&"g"!==this.graphic.element.nodeName:t.apply(this,i)}wrap(columnProto,"translate",function(t){t.apply(this,[].slice.call(arguments,1)),this.chart.is3d()&&this.translate3dShapes()}),wrap(Series.prototype,"justifyDataLabel",function(t){return!arguments[2].outside3dPlot&&t.apply(this,[].slice.call(arguments,1))}),columnProto.translate3dPoints=function(){},columnProto.translate3dShapes=function(){var i,r=this,a=r.chart,t=r.options,p=t.depth,n=(t.stacking?t.stack||0:r.index)*(p+(t.groupZPadding||1)),h=r.borderWidth%2?.5:0;a.inverted&&!r.yAxis.reversed&&(h*=-1),!1!==t.grouping&&(n=0),n+=t.groupZPadding||1,r.data.forEach(function(e){var s,t,o;(e.outside3dPlot=null)!==e.y&&(s=e.shapeArgs,t=e.tooltipPos,[["x","width"],["y","height"]].forEach(function(t){if((o=s[t[0]]-h)<0&&(s[t[1]]+=s[t[0]]+h,s[t[0]]=-h,o=0),o+s[t[1]]>r[t[0]+"Axis"].len&&0!==s[t[1]]&&(s[t[1]]=r[t[0]+"Axis"].len-s[t[0]]),0!==s[t[1]]&&(s[t[0]]>=r[t[0]+"Axis"].len||s[t[0]]+s[t[1]]<=h)){for(var i in s)s[i]="y"===i?-9999:0;e.outside3dPlot=!0}}),"rect"===e.shapeType&&(e.shapeType="cuboid"),s.z=n,s.depth=p,s.insidePlotArea=!0,i={x:s.x+s.width/2,y:s.y,z:n+p/2},a.inverted&&(i.x=s.height,i.y=e.clientX),e.plot3d=perspective([i],a,!0,!1)[0],t=perspective([{x:t[0],y:t[1],z:n+p/2}],a,!0,!1)[0],e.tooltipPos=[t.x,t.y])}),r.z=n},wrap(columnProto,"animate",function(t){var i,e,s;this.chart.is3d()?(i=this.yAxis,s=(e=this).yAxis.reversed,svg&&(arguments[1]?e.data.forEach(function(t){null!==t.y&&(t.height=t.shapeArgs.height,t.shapey=t.shapeArgs.y,t.shapeArgs.height=1,s||(t.stackY?t.shapeArgs.y=t.plotY+i.translate(t.stackY):t.shapeArgs.y=t.plotY+(t.negative?-t.height:t.height)))}):(e.data.forEach(function(t){null!==t.y&&(t.shapeArgs.height=t.height,t.shapeArgs.y=t.shapey,t.graphic&&t.graphic[t.outside3dPlot?"attr":"animate"](t.shapeArgs,e.options.animation))}),this.drawDataLabels()))):t.apply(this,[].slice.call(arguments,1))}),wrap(columnProto,"plotGroup",function(t,i,e,s,o,r){return"dataLabelsGroup"!==i&&this.chart.is3d()&&(this[i]&&delete this[i],r&&(this.chart.columnGroup||(this.chart.columnGroup=this.chart.renderer.g("columnGroup").add(r)),this[i]=this.chart.columnGroup,this.chart.columnGroup.attr(this.getPlotBox()),this[i].survive=!0,"group"!==i&&"markerGroup"!==i||(arguments[3]="visible"))),t.apply(this,Array.prototype.slice.call(arguments,1))}),wrap(columnProto,"setVisible",function(t,i){var e=this;e.chart.is3d()&&e.data.forEach(function(t){t.visible=t.options.visible=i=void 0===i?!pick(e.visible,t.visible):i,e.options.data[e.data.indexOf(t)]=t.options,t.graphic&&t.graphic.attr({visibility:i?"visible":"hidden"})}),t.apply(this,Array.prototype.slice.call(arguments,1))}),addEvent(ColumnSeries,"afterInit",function(){if(this.chart.is3d()){var t=this.options,i=t.grouping,e=t.stacking,s=this.yAxis.options.reversedStacks,o=0;if(void 0===i||i){for(var r=retrieveStacks(this.chart,e),a=t.stack||0,p=void 0,p=0;p<r[a].series.length&&r[a].series[p]!==this;p++);o=10*(r.totalStacks-r[a].position)+(s?p:-p),this.xAxis.reversed||(o=10*r.totalStacks-o)}t.depth=t.depth||25,this.z=this.z||0,t.zIndex=o}}),wrap(columnProto,"pointAttribs",pointAttribs),wrap(columnProto,"setState",setState),wrap(columnProto.pointClass.prototype,"hasNewShapeType",hasNewShapeType),SeriesRegistry.seriesTypes.columnRange&&(wrap(columnRangeProto=SeriesRegistry.seriesTypes.columnrange.prototype,"pointAttribs",pointAttribs),wrap(columnRangeProto,"setState",setState),wrap(columnRangeProto.pointClass.prototype,"hasNewShapeType",hasNewShapeType),columnRangeProto.plotGroup=columnProto.plotGroup,columnRangeProto.setVisible=columnProto.setVisible),wrap(Series.prototype,"alignDataLabel",function(t,i,e,s,o){var r,a,p,n=this.chart;s.outside3dPlot=i.outside3dPlot,n.is3d()&&this.is("column")&&(p=this.options,r=pick(s.inside,!!this.options.stacking),a=n.options.chart.options3d,s=i.pointWidth/2||0,p={x:o.x+s,y:o.y,z:this.z+p.depth/2},n.inverted&&(r&&(o.width=0,p.x+=i.shapeArgs.height/2),90<=a.alpha&&a.alpha<=270&&(p.y+=i.shapeArgs.width)),p=perspective([p],n,!0,!1)[0],o.x=p.x-s,o.y=i.outside3dPlot?-9e9:p.y),t.apply(this,[].slice.call(arguments,1))}),wrap(StackItem.prototype,"getStackBox",function(t,i,e,s,o,r,a,p){var n=t.apply(this,[].slice.call(arguments,1));return i.is3d()&&e.base&&(t=+e.base.split(",")[0],e=i.series[t],t=i.options.chart.options3d,e&&e instanceof SeriesRegistry.seriesTypes.column&&(e={x:n.x+(i.inverted?a:r/2),y:n.y,z:e.options.depth/2},i.inverted&&(n.width=0,90<=t.alpha&&t.alpha<=270&&(e.y+=r)),e=perspective([e],i,!0,!1)[0],n.x=e.x-r/2,n.y=e.y)),n});export default ColumnSeries;