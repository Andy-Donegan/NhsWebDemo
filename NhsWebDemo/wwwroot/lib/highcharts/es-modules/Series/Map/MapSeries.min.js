"use strict";var __extends=this&&this.__extends||function(){var o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};return function(t,e){function r(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}();import A from"../../Core/Animation/AnimationUtilities.js";var animObject=A.animObject;import ColorMapMixin from"../ColorMapMixin.js";import CU from"../CenteredUtilities.js";import H from"../../Core/Globals.js";var noop=H.noop;import LegendSymbol from"../../Core/Legend/LegendSymbol.js";import MapChart from"../../Core/Chart/MapChart.js";var maps=MapChart.maps,splitPath=MapChart.splitPath;import MapPoint from"./MapPoint.js";import MapView from"../../Maps/MapView.js";import Series from"../../Core/Series/Series.js";import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";var _a=SeriesRegistry.seriesTypes,ColumnSeries=_a.column,ScatterSeries=_a.scatter;import SVGRenderer from"../../Core/Renderer/SVG/SVGRenderer.js";import U from"../../Core/Utilities.js";var extend=U.extend,fireEvent=U.fireEvent,getNestedProperty=U.getNestedProperty,isArray=U.isArray,isNumber=U.isNumber,merge=U.merge,objectEach=U.objectEach,pick=U.pick,splat=U.splat,MapSeries=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.chart=void 0,t.data=void 0,t.group=void 0,t.joinBy=void 0,t.options=void 0,t.points=void 0,t.transformGroup=void 0,t}return __extends(t,e),t.prototype.animate=function(t){var e=this.chart,r=this.group,o=animObject(this.options.animation);e.renderer.isSVG&&(t?r.attr({translateX:e.plotLeft+e.plotWidth/2,translateY:e.plotTop+e.plotHeight/2,scaleX:.001,scaleY:.001}):r.animate({translateX:e.plotLeft,translateY:e.plotTop,scaleX:1,scaleY:1},o))},t.prototype.animateDrilldown=function(t){var e=this.chart,r=this.group;e.renderer.isSVG&&(t?r.attr({translateX:e.plotLeft+e.plotWidth/2,translateY:e.plotTop+e.plotHeight/2,scaleX:.1,scaleY:.1,opacity:.01}):r.animate({translateX:e.plotLeft,translateY:e.plotTop,scaleX:1,scaleY:1,opacity:1}))},t.prototype.animateDrillupFrom=function(){var t=this.chart;t.renderer.isSVG&&this.group.animate({translateX:t.plotLeft+t.plotWidth/2,translateY:t.plotTop+t.plotHeight/2,scaleX:.1,scaleY:.1,opacity:.01})},t.prototype.animateDrillupTo=function(t){ColumnSeries.prototype.animateDrillupTo.call(this,t)},t.prototype.clearBounds=function(){this.points.forEach(function(t){delete t.bounds,delete t.projectedPath}),delete this.bounds},t.prototype.doFullTranslate=function(){return Boolean(this.isDirtyData||this.chart.isResizing||this.chart.renderer.isVML||!this.hasRendered)},t.prototype.drawMapDataLabels=function(){Series.prototype.drawDataLabels.call(this),this.dataLabelsGroup&&this.dataLabelsGroup.clip(this.chart.clipRect)},t.prototype.drawPoints=function(){var o,i,a,s,n,p,l,r=this,t=this,h=t.chart,c=t.group,d=t.svgTransform,e=h.mapView,t=h.renderer;this.transformGroup||(this.transformGroup=t.g().add(c),this.transformGroup.survive=!0),this.doFullTranslate()&&(h.hasRendered&&!h.styledMode&&this.points.forEach(function(t){t.shapeArgs&&(t.shapeArgs.fill=r.pointAttribs(t,t.state).fill)}),this.group=this.transformGroup,ColumnSeries.prototype.drawPoints.apply(this),this.group=c,this.points.forEach(function(t){var e;t.graphic&&(e="",t.name&&(e+="highcharts-name-"+t.name.replace(/ /g,"-").toLowerCase()),t.properties&&t.properties["hc-key"]&&(e+=" highcharts-key-"+t.properties["hc-key"].toLowerCase()),e&&t.graphic.addClass(e),h.styledMode&&t.graphic.css(r.pointAttribs(t,t.selected?"select":void 0)))})),e&&d&&(o=pick(this.options[this.pointAttrToOptions&&this.pointAttrToOptions["stroke-width"]||"borderWidth"],1),i=d.scaleX,a=0<d.scaleY?1:-1,s=this.transformGroup,t.globalAnimation&&h.hasRendered?(n=Number(s.attr("translateX")),p=Number(s.attr("translateY")),l=Number(s.attr("scaleX")),s.attr({animator:0}).animate({animator:1},{step:function(t,e){var r=l+(i-l)*e.pos;s.attr({translateX:n+(d.translateX-n)*e.pos,translateY:p+(d.translateY-p)*e.pos,scaleX:r,scaleY:r*a}),c.element.setAttribute("stroke-width",o/r)}})):(s.attr(d),c.element.setAttribute("stroke-width",o/i))),this.drawMapDataLabels()},t.prototype.getProjectedBounds=function(){var p,l,h;return this.bounds||(p=Number.MAX_VALUE,l=this.chart.mapView&&this.chart.mapView.projection,h=[],(this.points||[]).forEach(function(t){var r,o,i,a,s,e,n;(t.path||t.geometry)&&("string"==typeof t.path?t.path=splitPath(t.path):isArray(t.path)&&"M"===t.path[0]&&(t.path=SVGRenderer.prototype.pathToSegments(t.path)),t.bounds||(e=MapPoint.getProjectedPath(t,l),n=t.properties,r=-p,i=-(o=p),a=p,e.forEach(function(t){var e=t[t.length-2],t=t[t.length-1];"number"==typeof e&&"number"==typeof t&&(o=Math.min(o,e),r=Math.max(r,e),a=Math.min(a,t),i=Math.max(i,t),s=!0)}),s&&(e=n&&n["hc-middle-x"],e=o+(r-o)*pick(t.middleX,isNumber(e)?e:.5),n=n&&n["hc-middle-y"],n=pick(t.middleY,isNumber(n)?n:.5),t.geometry||(n=1-n),n=i-(i-a)*n,t.bounds={midX:e,midY:n,x1:o,y1:a,x2:r,y2:i},t.labelrank=pick(t.labelrank,(r-o)*(i-a)))),t.bounds&&h.push(t.bounds))}),this.bounds=MapView.compositeBounds(h)),this.bounds},t.prototype.hasData=function(){return!!this.processedXData.length},t.prototype.pointAttribs=function(t,e){var r=t.series.chart,o=r.mapView,e=r.styledMode?this.colorAttribs(t):ColumnSeries.prototype.pointAttribs.call(this,t,e),t=t.options[this.pointAttrToOptions&&this.pointAttrToOptions["stroke-width"]||"borderWidth"];return t&&o&&(t/=o.getScale()),e.dashstyle&&o&&this.options.borderWidth&&(t=this.options.borderWidth/o.getScale()),e["stroke-width"]=pick(t,"inherit"),e},t.prototype.setData=function(i,t,e,r){var o,a,s,n,p,l=this.options,h=this.chart.options.chart,c=h&&h.map,d=l.mapData,m=this.joinBy,u=l.keys||this.pointArrayMap,f=[],y={},g=this.chart.mapTransforms;if(!d&&c&&(d="string"==typeof c?maps[c]:c),i&&i.forEach(function(t,e){var r=0;if(isNumber(t))i[e]={value:t};else if(isArray(t)){i[e]={},!l.keys&&t.length>u.length&&"string"==typeof t[0]&&(i[e]["hc-key"]=t[0],++r);for(var o=0;o<u.length;++o,++r)u[o]&&void 0!==t[r]&&(0<u[o].indexOf(".")?MapPoint.prototype.setNestedProperty(i[e],t[r],u[o]):i[e][u[o]]=t[r])}m&&"_i"===m[0]&&(i[e]._i=e)}),this.chart.mapTransforms=g=h.mapTransforms||d&&d["hc-transform"]||g,g&&objectEach(g,function(t){t.rotation&&(t.cosAngle=Math.cos(t.rotation),t.sinAngle=Math.sin(t.rotation))}),d){for("FeatureCollection"===d.type&&(this.mapTitle=d.title,d=H.geojson(d,this.type,this)),this.mapData=d,this.mapMap={},s=0;s<d.length;s++)a=(o=d[s]).properties,o._i=s,m[0]&&a&&a[m[0]]&&(o[m[0]]=a[m[0]]),y[o[m[0]]]=o;this.mapMap=y,i&&m[1]&&(n=m[1],i.forEach(function(t){t=getNestedProperty(n,t);y[t]&&f.push(y[t])})),l.allAreas&&(i=i||[],m[1]&&(p=m[1],i.forEach(function(t){f.push(getNestedProperty(p,t))})),f="|"+f.map(function(t){return t&&t[m[0]]}).join("|")+"|",d.forEach(function(t){m[0]&&-1!==f.indexOf("|"+t[m[0]]+"|")||(i.push(merge(t,{value:null})),r=!1)}))}Series.prototype.setData.call(this,i,t,e,r),this.processData(),this.generatePoints()},t.prototype.setOptions=function(t){var e=Series.prototype.setOptions.call(this,t),t=e.joinBy;return(t=this.joinBy=splat(t=null===t?"_i":t))[1]||(t[1]=t[0]),e},t.prototype.translate=function(){var t,e,r,o,i=this.doFullTranslate(),a=this.chart.mapView,s=a&&a.projection;!this.chart.hasRendered||!this.isDirtyData&&this.hasRendered||(this.processData(),this.generatePoints(),delete this.bounds,this.getProjectedBounds()),a&&(t=a.getScale(),e=(r=a.projection.forward(a.center))[0],r=r[1],a=a.projection.hasCoordinates?-1:1,o={scaleX:t,scaleY:t*a,translateX:this.chart.plotWidth/2-e*t,translateY:this.chart.plotHeight/2-r*t*a},this.svgTransform=o),this.points.forEach(function(t){o&&t.bounds&&isNumber(t.bounds.midX)&&isNumber(t.bounds.midY)&&(t.plotX=t.bounds.midX*o.scaleX+o.translateX,t.plotY=t.bounds.midY*o.scaleY+o.translateY),i&&(t.shapeType="path",t.shapeArgs={d:MapPoint.getProjectedPath(t,s)})}),fireEvent(this,"afterTranslate")},t.defaultOptions=merge(ScatterSeries.defaultOptions,{animation:!1,dataLabels:{crop:!1,formatter:function(){var t=this.series.chart.numberFormatter,e=this.point.value;return isNumber(e)?t(e,-1):""},inside:!0,overflow:!1,padding:0,verticalAlign:"middle"},marker:null,nullColor:"#f7f7f7",stickyTracking:!1,tooltip:{followPointer:!0,pointFormat:"{point.name}: {point.value}<br/>"},turboThreshold:0,allAreas:!0,borderColor:"#cccccc",borderWidth:1,joinBy:"hc-key",states:{hover:{halo:null,brightness:.2},normal:{animation:!0},select:{color:"#cccccc"},inactive:{opacity:1}}}),t}(ScatterSeries);extend(MapSeries.prototype,{type:"map",axisTypes:ColorMapMixin.SeriesMixin.axisTypes,colorAttribs:ColorMapMixin.SeriesMixin.colorAttribs,colorKey:ColorMapMixin.SeriesMixin.colorKey,directTouch:!0,drawDataLabels:noop,drawGraph:noop,drawLegendSymbol:LegendSymbol.drawRectangle,forceDL:!0,getCenter:CU.getCenter,getExtremesFromAll:!0,getSymbol:ColorMapMixin.SeriesMixin.getSymbol,isCartesian:!1,parallelArrays:ColorMapMixin.SeriesMixin.parallelArrays,pointArrayMap:ColorMapMixin.SeriesMixin.pointArrayMap,pointClass:MapPoint,preserveAspectRatio:!0,searchPoint:noop,trackerGroups:ColorMapMixin.SeriesMixin.trackerGroups,useMapGeometry:!0}),SeriesRegistry.registerSeriesType("map",MapSeries);export default MapSeries;