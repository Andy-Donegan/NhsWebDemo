"use strict";var __extends=this&&this.__extends||function(){var i=function(t,o){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,o){t.__proto__=o}||function(t,o){for(var e in o)o.hasOwnProperty(e)&&(t[e]=o[e])})(t,o)};return function(t,o){function e(){this.constructor=t}i(t,o),t.prototype=null===o?Object.create(o):(e.prototype=o.prototype,new e)}}();import Color from"../../Core/Color/Color.js";import H from"../../Core/Globals.js";import NodesComposition from"../NodesComposition.js";import SankeyPoint from"./SankeyPoint.js";import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";var Series=SeriesRegistry.series,ColumnSeries=SeriesRegistry.seriesTypes.column;import TU from"../TreeUtilities.js";var getLevelOptions=TU.getLevelOptions;import U from"../../Core/Utilities.js";var defined=U.defined,extend=U.extend,find=U.find,isObject=U.isObject,merge=U.merge,pick=U.pick,relativeLength=U.relativeLength,stableSort=U.stableSort,SankeySeries=function(o){function p(){var t=null!==o&&o.apply(this,arguments)||this;return t.colDistance=void 0,t.data=void 0,t.group=void 0,t.nodeLookup=void 0,t.nodePadding=void 0,t.nodes=void 0,t.nodeWidth=void 0,t.options=void 0,t.points=void 0,t.translationFactor=void 0,t}return __extends(p,o),p.getDLOptions=function(t){var o=isObject(t.optionsPoint)?t.optionsPoint.dataLabels:{},t=isObject(t.level)?t.level.dataLabels:{};return merge({style:{}},t,o)},p.prototype.createNodeColumn=function(){var d=this,h=this.chart,p=[];return p.sum=function(){return this.reduce(function(t,o){return t+o.getSum()},0)},p.offset=function(t,o){for(var e=0,i=d.nodePadding,n=0;n<p.length;n++){var r=p[n].getSum(),s=Math.max(r*o,d.options.minLinkWidth),a=t.options[h.inverted?"offsetHorizontal":"offsetVertical"],l=t.options.offset||0,r=r?s+i:0;if(p[n]===t)return{relativeTop:e+(defined(a)?relativeLength(a,s):relativeLength(l,r))};e+=r}},p.top=function(e){var i=d.nodePadding,t=this.reduce(function(t,o){return 0<t&&(t+=i),t+=Math.max(o.getSum()*e,d.options.minLinkWidth)},0);return(h.plotSizeY-t)/2},p},p.prototype.createNodeColumns=function(){var s=[];this.nodes.forEach(function(e){var t,o=-1;if(!defined(e.options.column))if(0===e.linksTo.length)e.column=0;else{for(var i,n=0;n<e.linksTo.length;n++){var r=e.linksTo[n];r.fromNode.column>o&&r.fromNode!==e&&(o=(t=r.fromNode).column)}e.column=o+1,t&&"hanging"===t.options.layout&&(e.hangsFrom=t,i=-1,find(t.linksFrom,function(t,o){t=t.toNode===e;return t&&(i=o),t}),e.column+=i)}s[e.column]||(s[e.column]=this.createNodeColumn()),s[e.column].push(e)},this);for(var t=0;t<s.length;t++)void 0===s[t]&&(s[t]=this.createNodeColumn());return s},p.prototype.generatePoints=function(){NodesComposition.generatePoints.apply(this,arguments),this.orderNodes&&(this.nodes.filter(function(t){return 0===t.linksTo.length}).forEach(function(t){!function o(t,e){void 0===t.level&&(t.level=e,t.linksFrom.forEach(function(t){t.toNode&&o(t.toNode,e+1)}))}(t,0)}),stableSort(this.nodes,function(t,o){return t.level-o.level}))},p.prototype.getNodePadding=function(){var t,o=this.options.nodePadding||0;return!this.nodeColumns||(t=this.nodeColumns.reduce(function(t,o){return Math.max(t,o.length)},0))*o>this.chart.plotSizeY&&(o=this.chart.plotSizeY/t),o},p.prototype.hasData=function(){return!!this.processedXData.length},p.prototype.pointAttribs=function(t,o){if(!t)return{};var e=this,i=(t.isNode?t:t.fromNode).level,n=e.mapOptionsToLevel[i||0]||{},r=t.options,s=n.states&&n.states[o||""]||{},i=["colorByPoint","borderColor","borderWidth","linkOpacity"].reduce(function(t,o){return t[o]=pick(s[o],r[o],n[o],e.options[o]),t},{}),o=pick(s.color,r.color,(i.colorByPoint?t:n).color);return t.isNode?{fill:o,stroke:i.borderColor,"stroke-width":i.borderWidth}:{fill:Color.parse(o).setOpacity(i.linkOpacity).get()}},p.prototype.render=function(){var t=this.points;this.points=this.points.concat(this.nodes||[]),ColumnSeries.prototype.render.call(this),this.points=t},p.prototype.translate=function(){var a=this;this.processedXData||this.processData(),this.generatePoints(),this.nodeColumns=this.createNodeColumns(),this.nodeWidth=relativeLength(this.options.nodeWidth,this.chart.plotSizeX);var l=this,d=this.chart,h=this.options,t=this.nodeWidth,o=this.nodeColumns;this.nodePadding=this.getNodePadding(),this.translationFactor=o.reduce(function(t,o){return Math.min(t,function(o){for(var t,e,i=o.slice(),n=a.options.minLinkWidth||0,r=0,s=d.plotSizeY-h.borderWidth-(o.length-1)*l.nodePadding;o.length;){for(r=s/o.sum(),t=!1,e=o.length;e--;)o[e].getSum()*r<n&&(o.splice(e,1),s-=n,t=!0);if(!t)break}return o.length=0,i.forEach(function(t){return o.push(t)}),r}(o))},1/0),this.colDistance=(d.plotSizeX-t-h.borderWidth)/Math.max(1,o.length-1),l.mapOptionsToLevel=getLevelOptions({from:1,levels:h.levels,to:o.length-1,defaults:{borderColor:h.borderColor,borderRadius:h.borderRadius,borderWidth:h.borderWidth,color:l.color,colorByPoint:h.colorByPoint,levelIsConstant:!0,linkColor:h.linkColor,linkLineWidth:h.linkLineWidth,linkOpacity:h.linkOpacity,states:h.states}}),o.forEach(function(o){o.forEach(function(t){l.translateNode(t,o)})},this),this.nodes.forEach(function(t){t.linksFrom.forEach(function(t){(t.weight||t.isNull)&&t.to&&(l.translateLink(t),t.allowShadow=!1)})})},p.prototype.translateLink=function(e){var t,o,i,n,r,s,a,l,d,h,p,c=function(t,o){o=t.offset(e,o)*g;return Math.min(t.nodeY+o,t.nodeY+(t.shapeArgs&&t.shapeArgs.height||0)-v)},u=e.fromNode,f=e.toNode,m=this.chart,g=this.translationFactor,v=Math.max(e.weight*g,this.options.minLinkWidth),y=this.options,S=(m.inverted?-this.colDistance:this.colDistance)*y.curveFactor,k=c(u,"linksFrom"),C=c(f,"linksTo"),b=u.nodeX,L=this.nodeWidth,N=f.nodeX,P=e.outgoing,O=b+L<N;m.inverted&&(k=m.plotSizeY-k,C=(m.plotSizeY||0)-C,L=-L,v=-v,O=N<b),e.shapeType="path",e.linkBase=[k,k+v,C,C+v],O&&"number"==typeof C?e.shapeArgs={d:[["M",b+L,k],["C",b+L+S,k,N-S,C,N,C],["L",N+(P?L:0),C+v/2],["L",N,C+v],["C",N-S,C+v,b+L+S,k+v,b+L,k+v],["Z"]]}:"number"==typeof C&&(p=m.plotHeight-k-v,t=N-20-v,n=(i=(o=b+L)+20)+v,h=(d=(l=(a=(s=(r=k)+v)+20)+p)+20)+v,y=s-.7*v,c=d+.7*v,P=(O=(f=C)+v)-.7*v,S=N-.7*v,p=o+.7*v,e.shapeArgs={d:[["M",o,r],["C",p,r,n,y,n,a],["L",n,l],["C",n,c,p,h,o,h],["L",N,h],["C",S,h,t,c,t,l],["L",t,c=O+20],["C",t,P,S,f,N,f],["L",N,O],["C",f=N-20,O,f,O,f,c],["L",f,l],["C",f,d,f,d,N,d],["L",o,d],["C",i,d,i,d,i,l],["L",i,a],["C",i,s,i,s,o,s],["Z"]]}),e.dlBox={x:b+(N-b+L)/2,y:k+(C-k)/2,height:v,width:0},e.tooltipPos=m.inverted?[m.plotSizeY-e.dlBox.y-v/2,m.plotSizeX-e.dlBox.x]:[e.dlBox.x,e.dlBox.y+v/2],e.y=e.plotY=1,e.color||(e.color=u.color)},p.prototype.translateNode=function(t,o){var e=this.translationFactor,i=this.chart,n=this.options,r=t.getSum(),s=Math.max(Math.round(r*e),this.options.minLinkWidth),a=Math.round(this.nodeWidth),l=Math.round(n.borderWidth)%2/2,d=o.offset(t,e),h=Math.floor(pick(d.absoluteTop,o.top(e)+d.relativeTop))+l,o=Math.floor(this.colDistance*t.column+n.borderWidth/2)+relativeLength(t.options.offsetHorizontal||0,a)+l,e=i.inverted?i.plotSizeX-o:o;(t.sum=r)?(t.shapeType="rect",d=t.nodeX=e,l=t.nodeY=h,o=t.options.width||n.width||a,r=t.options.height||n.height||s,i.inverted&&(d=e-a,l=i.plotSizeY-h-s,o=t.options.height||n.height||a,r=t.options.width||n.width||s),t.dlOptions=p.getDLOptions({level:this.mapOptionsToLevel[t.level],optionsPoint:t.options}),t.plotX=1,t.plotY=1,t.tooltipPos=i.inverted?[i.plotSizeY-l-r/2,i.plotSizeX-d-o/2]:[d+o/2,l+r/2],t.shapeArgs={x:d,y:l,width:o,height:r,display:t.hasShape()?"":"none"}):t.dlOptions={enabled:!1}},p.defaultOptions=merge(ColumnSeries.defaultOptions,{borderWidth:0,colorByPoint:!0,curveFactor:.33,dataLabels:{enabled:!0,backgroundColor:"none",crop:!1,nodeFormat:void 0,nodeFormatter:function(){return this.point.name},format:void 0,formatter:function(){},inside:!0},inactiveOtherPoints:!0,linkOpacity:.5,minLinkWidth:0,nodeWidth:20,nodePadding:10,showInLegend:!1,states:{hover:{linkOpacity:1},inactive:{linkOpacity:.1,opacity:.1,animation:{duration:50}}},tooltip:{followPointer:!0,headerFormat:'<span style="font-size: 10px">{series.name}</span><br/>',pointFormat:"{point.fromNode.name} â†’ {point.toNode.name}: <b>{point.weight}</b><br/>",nodeFormat:"{point.name}: <b>{point.sum}</b><br/>"}}),p}(ColumnSeries);NodesComposition.compose(SankeyPoint,SankeySeries),extend(SankeySeries.prototype,{animate:Series.prototype.animate,createNode:NodesComposition.createNode,forceDL:!0,invertible:!0,isCartesian:!1,orderNodes:!0,noSharedTooltip:!0,pointArrayMap:["from","to"],pointClass:SankeyPoint,searchPoint:H.noop}),SeriesRegistry.registerSeriesType("sankey",SankeySeries);export default SankeySeries;