"use strict";var __extends=this&&this.__extends||function(){var r=function(t,i){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e])})(t,i)};return function(t,i){function e(){this.constructor=t}r(t,i),t.prototype=null===i?Object.create(i):(e.prototype=i.prototype,new e)}}();import Axis from"../../Core/Axis/Axis.js";import BubbleLegendComposition from"./BubbleLegendComposition.js";import BubblePoint from"./BubblePoint.js";import Color from"../../Core/Color/Color.js";var color=Color.parse;import H from"../../Core/Globals.js";var noop=H.noop;import Series from"../../Core/Series/Series.js";import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";var _a=SeriesRegistry.seriesTypes,ColumnSeries=_a.column,ScatterSeries=_a.scatter;import U from"../../Core/Utilities.js";var addEvent=U.addEvent,arrayMax=U.arrayMax,arrayMin=U.arrayMin,clamp=U.clamp,extend=U.extend,isNumber=U.isNumber,merge=U.merge,pick=U.pick;import"../Column/ColumnSeries.js";import"../Scatter/ScatterSeries.js";import"./BubbleLegendItem.js";var BubbleSeries=function(i){function t(){var t=null!==i&&i.apply(this,arguments)||this;return t.data=void 0,t.maxPxSize=void 0,t.minPxSize=void 0,t.options=void 0,t.points=void 0,t.radii=void 0,t.yData=void 0,t.zData=void 0,t}return __extends(t,i),t.prototype.animate=function(t){!t&&this.points.length<this.options.animationLimit&&this.points.forEach(function(t){var i=t.graphic;i&&i.width&&(this.hasRendered||i.attr({x:t.plotX,y:t.plotY,width:1,height:1}),i.animate(this.markerAttribs(t),this.options.animation))},this)},t.prototype.getRadii=function(){var t,i,e,r,o,a,s=this,n=this.zData,l=this.yData,p=[],h=this.chart.bubbleZExtremes,u=this.getPxExtremes(),m=u.minPxSize,d=u.maxPxSize;for(h||(r=Number.MAX_VALUE,o=-Number.MAX_VALUE,this.chart.series.forEach(function(t){!t.bubblePadding||!t.visible&&s.chart.options.chart.ignoreHiddenSeries||(t=t.getZExtremes())&&(r=Math.min(r||t.zMin,t.zMin),o=Math.max(o||t.zMax,t.zMax),a=!0)}),a?(h={zMin:r,zMax:o},this.chart.bubbleZExtremes=h):h={zMin:0,zMax:0}),i=0,t=n.length;i<t;i++)e=n[i],p.push(this.getRadius(h.zMin,h.zMax,m,d,e,l[i]));this.radii=p},t.prototype.getRadius=function(t,i,e,r,o,a){var s=this.options,n="width"!==s.sizeBy,l=s.zThreshold,p=i-t,h=.5;if(null===a||null===o)return null;if(isNumber(o)){if(s.sizeByAbsoluteValue&&(o=Math.abs(o-l),i=p=Math.max(i-l,Math.abs(t-l)),t=0),o<t)return e/2-1;0<p&&(h=(o-t)/p)}return n&&0<=h&&(h=Math.sqrt(h)),Math.ceil(e+h*(r-e))/2},t.prototype.hasData=function(){return!!this.processedXData.length},t.prototype.pointAttribs=function(t,i){var e=this.options.marker.fillOpacity,i=Series.prototype.pointAttribs.call(this,t,i);return 1!==e&&(i.fill=color(i.fill).setOpacity(e).get("rgba")),i},t.prototype.translate=function(){i.prototype.translate.call(this),this.getRadii(),this.translateBubble()},t.prototype.translateBubble=function(){for(var t=this.data,i=this.radii,e=this.getPxExtremes().minPxSize,r=t.length;r--;){var o=t[r],a=i?i[r]:0;isNumber(a)&&e/2<=a?(o.marker=extend(o.marker,{radius:a,width:2*a,height:2*a}),o.dlBox={x:o.plotX-a,y:o.plotY-a,width:2*a,height:2*a}):o.shapeArgs=o.plotY=o.dlBox=void 0}},t.prototype.getPxExtremes=function(){function t(t){var i;return"string"==typeof t&&(i=/%$/.test(t),t=parseInt(t,10)),i?e*t/100:t}var e=Math.min(this.chart.plotWidth,this.chart.plotHeight),i=t(pick(this.options.minSize,8));return{minPxSize:i,maxPxSize:Math.max(t(pick(this.options.maxSize,"20%")),i)}},t.prototype.getZExtremes=function(){var t=this.options,i=(this.zData||[]).filter(isNumber);if(i.length){var e=pick(t.zMin,clamp(arrayMin(i),!1===t.displayNegative?t.zThreshold||0:-Number.MAX_VALUE,Number.MAX_VALUE)),i=pick(t.zMax,arrayMax(i));if(isNumber(e)&&isNumber(i))return{zMin:e,zMax:i}}},t.compose=BubbleLegendComposition.compose,t.defaultOptions=merge(ScatterSeries.defaultOptions,{dataLabels:{formatter:function(){var t=this.series.chart.numberFormatter,i=this.point.z;return isNumber(i)?t(i,-1):""},inside:!0,verticalAlign:"middle"},animationLimit:250,marker:{lineColor:null,lineWidth:1,fillOpacity:.5,radius:null,states:{hover:{radiusPlus:0}},symbol:"circle"},minSize:8,maxSize:"20%",softThreshold:!1,states:{hover:{halo:{size:5}}},tooltip:{pointFormat:"({point.x}, {point.y}), Size: {point.z}"},turboThreshold:0,zThreshold:0,zoneAxis:"z"}),t}(ScatterSeries);extend(BubbleSeries.prototype,{alignDataLabel:ColumnSeries.prototype.alignDataLabel,applyZones:noop,bubblePadding:!0,buildKDTree:noop,directTouch:!0,isBubble:!0,pointArrayMap:["y","z"],pointClass:BubblePoint,parallelArrays:["x","y","z"],trackerGroups:["group","dataLabelsGroup"],specialGroup:"group",zoneAxis:"z"}),addEvent(BubbleSeries,"updatedData",function(t){delete t.target.chart.bubbleZExtremes}),Axis.prototype.beforePadding=function(){var o,a=this,t=this.len,s=this.chart,n=0,l=t,p=this.isXAxis,h=p?"xData":"yData",u=this.min,m=this.max-u,d=t/m;this.series.forEach(function(t){if(t.bubblePadding&&(t.visible||!s.options.chart.ignoreHiddenSeries)){a.allowZoomOutside=!0,o=!0;var i=t[h];if(p&&t.getRadii(0,0,t),0<m)for(var e,r=i.length;r--;)isNumber(i[r])&&a.dataMin<=i[r]&&i[r]<=a.max&&(e=t.radii&&t.radii[r]||0,n=Math.min((i[r]-u)*d-e,n),l=Math.max((i[r]-u)*d+e,l))}}),o&&0<m&&!this.logarithmic&&(l-=t,d*=(t+Math.max(0,n)-Math.min(l,t))/t,[["min","userMin",n],["max","userMax",l]].forEach(function(t){void 0===pick(a.options[t[0]],a[t[1]])&&(a[t[0]]+=t[2]/d)}))},SeriesRegistry.registerSeriesType("bubble",BubbleSeries);export default BubbleSeries;