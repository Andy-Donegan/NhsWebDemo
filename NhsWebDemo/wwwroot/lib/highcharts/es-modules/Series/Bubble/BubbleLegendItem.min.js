"use strict";import Color from"../../Core/Color/Color.js";var color=Color.parse;import F from"../../Core/FormatUtilities.js";import H from"../../Core/Globals.js";var noop=H.noop;import U from"../../Core/Utilities.js";var arrayMax=U.arrayMax,arrayMin=U.arrayMin,isNumber=U.isNumber,merge=U.merge,pick=U.pick,stableSort=U.stableSort,BubbleLegendItem=function(){function e(e,t){this.chart=void 0,this.fontMetrics=void 0,this.legend=void 0,this.legendGroup=void 0,this.legendItem=void 0,this.legendItemHeight=void 0,this.legendItemWidth=void 0,this.legendSymbol=void 0,this.maxLabel=void 0,this.movementX=void 0,this.ranges=void 0,this.selected=void 0,this.visible=void 0,this.symbols=void 0,this.options=void 0,this.setState=noop,this.init(e,t)}return e.prototype.init=function(e,t){this.options=e,this.visible=!0,this.chart=t.chart,this.legend=t},e.prototype.addToLegend=function(e){e.splice(this.options.legendIndex,0,this)},e.prototype.drawLegendSymbol=function(e){var t,i=this.chart,s=this.options,o=pick(e.options.itemDistance,20),r=s.ranges,n=s.connectorDistance;this.fontMetrics=i.renderer.fontMetrics(s.labels.style.fontSize),r&&r.length&&isNumber(r[0].value)?(stableSort(r,function(e,t){return t.value-e.value}),this.ranges=r,this.setOptions(),this.render(),t=this.getMaxLabelSize(),r=2*(i=this.ranges[0].radius),i=0<(i=n-i+t.width)?i:0,this.maxLabel=t,this.movementX="left"===s.labels.align?i:0,this.legendItemWidth=r+i+o,this.legendItemHeight=r+this.fontMetrics.h/2):e.options.bubbleLegend.autoRanges=!0},e.prototype.setOptions=function(){var i=this.ranges,s=this.options,o=this.chart.series[s.seriesIndex],r=this.legend.baseline,n={zIndex:s.zIndex,"stroke-width":s.borderWidth},a={zIndex:s.zIndex,"stroke-width":s.connectorWidth},l={align:this.legend.options.rtl||"left"===s.labels.align?"right":"left",zIndex:s.zIndex},h=o.options.marker.fillOpacity,d=this.chart.styledMode;i.forEach(function(e,t){d||(n.stroke=pick(e.borderColor,s.borderColor,o.color),n.fill=pick(e.color,s.color,1!==h?color(o.color).setOpacity(h).get("rgba"):o.color),a.stroke=pick(e.connectorColor,s.connectorColor,o.color)),i[t].radius=this.getRangeRadius(e.value),i[t]=merge(i[t],{center:i[0].radius-i[t].radius+r}),d||merge(!0,i[t],{bubbleAttribs:merge(n),connectorAttribs:merge(a),labelAttribs:l})},this)},e.prototype.getRangeRadius=function(e){var t=this.options,i=this.options.seriesIndex,s=this.chart.series[i],o=t.ranges[0].value,r=t.ranges[t.ranges.length-1].value,i=t.minSize,t=t.maxSize;return s.getRadius.call(this,r,o,i,t,e)},e.prototype.render=function(){var e=this.chart.renderer,t=this.options.zThreshold;this.symbols||(this.symbols={connectors:[],bubbleItems:[],labels:[]}),this.legendSymbol=e.g("bubble-legend"),this.legendItem=e.g("bubble-legend-item"),this.legendSymbol.translateX=0,this.legendSymbol.translateY=0,this.ranges.forEach(function(e){e.value>=t&&this.renderRange(e)},this),this.legendSymbol.add(this.legendItem),this.legendItem.add(this.legendGroup),this.hideOverlappingLabels()},e.prototype.renderRange=function(e){var t=this.ranges[0],i=this.legend,s=this.options,o=s.labels,r=this.chart,n=r.series[s.seriesIndex],a=r.renderer,l=this.symbols,h=l.labels,d=e.center,c=Math.abs(e.radius),b=s.connectorDistance||0,g=o.align,p=i.options.rtl,u=s.borderWidth,m=s.connectorWidth,r=t.radius||0,i=d-c-u/2+m/2,t=this.fontMetrics,u=t.f/2-(t.h-t.f)/2,t=(i%1?1:.5)-(m%2?0:.5),m=a.styledMode,p=p||"left"===g?-b:b;"center"===g&&(s.connectorDistance=p=0,e.labelAttribs.align="center");b=i+s.labels.y,g=r+p+s.labels.x;l.bubbleItems.push(a.circle(r,d+t,c).attr(m?{}:e.bubbleAttribs).addClass((m?"highcharts-color-"+n.colorIndex+" ":"")+"highcharts-bubble-legend-symbol "+(s.className||"")).add(this.legendSymbol)),l.connectors.push(a.path(a.crispLine([["M",r,i],["L",r+p,i]],s.connectorWidth)).attr(m?{}:e.connectorAttribs).addClass((m?"highcharts-color-"+this.options.seriesIndex+" ":"")+"highcharts-bubble-legend-connectors "+(s.connectorClassName||"")).add(this.legendSymbol));s=a.text(this.formatLabel(e),g,b+u).attr(m?{}:e.labelAttribs).css(m?{}:o.style).addClass("highcharts-bubble-legend-labels "+(s.labels.className||"")).add(this.legendSymbol);h.push(s),s.placed=!0,s.alignAttr={x:g,y:b+u}},e.prototype.getMaxLabelSize=function(){var t,i;return this.symbols.labels.forEach(function(e){i=e.getBBox(!0),t=!t||i.width>t.width?i:t}),t||{}},e.prototype.formatLabel=function(e){var t=this.options,i=t.labels.formatter,s=t.labels.format,t=this.chart.numberFormatter;return s?F.format(s,e):i?i.call(e):t(e.value,1)},e.prototype.hideOverlappingLabels=function(){var e=this.chart,t=this.options.labels.allowOverlap,i=this.symbols;!t&&i&&(e.hideOverlappingLabels(i.labels),i.labels.forEach(function(e,t){e.newOpacity?e.newOpacity!==e.oldOpacity&&i.connectors[t].show():i.connectors[t].hide()}))},e.prototype.getRanges=function(){var i,t,e=this.legend.bubbleLegend,s=e.chart.series,o=e.options.ranges,r=Number.MAX_VALUE,n=-Number.MAX_VALUE;return s.forEach(function(e){e.isBubble&&!e.ignoreSeries&&(t=e.zData.filter(isNumber)).length&&(r=pick(e.options.zMin,Math.min(r,Math.max(arrayMin(t),!1===e.options.displayNegative?e.options.zThreshold:-Number.MAX_VALUE))),n=pick(e.options.zMax,Math.max(n,arrayMax(t))))}),i=r===n?[{value:n}]:[{value:r},{value:(r+n)/2},{value:n,autoRanges:!0}],o.length&&o[0].radius&&i.reverse(),i.forEach(function(e,t){o&&o[t]&&(i[t]=merge(o[t],e))}),i},e.prototype.predictBubbleSizes=function(){var e,t=this.chart,i=this.fontMetrics,s=t.legend.options,o=s.floating,r="horizontal"===s.layout,n=r?t.legend.lastLineHeight:0,a=t.plotSizeX,l=t.plotSizeY,h=t.series[this.options.seriesIndex],d=h.getPxExtremes(),s=Math.ceil(d.minPxSize),t=Math.ceil(d.maxPxSize),d=Math.min(l,a),h=h.options.maxSize;return o||!/%$/.test(h)?e=t:(h=parseFloat(h),e=(d+n-i.h/2)*h/100/(h/100+1),(r&&a<=l-e||!r&&l<=a-e)&&(e=t)),[s,Math.ceil(e)]},e.prototype.updateRanges=function(e,t){var i=this.legend.options.bubbleLegend;i.minSize=e,i.maxSize=t,i.ranges=this.getRanges()},e.prototype.correctSizes=function(){var e=this.legend,t=this.chart.series[this.options.seriesIndex].getPxExtremes(),i=t.maxPxSize,s=this.options.maxSize;1<Math.abs(Math.ceil(i)-s)&&(this.updateRanges(this.options.minSize,t.maxPxSize),e.render())},e}();export default BubbleLegendItem;