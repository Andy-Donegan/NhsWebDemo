"use strict";var __extends=this&&this.__extends||function(){var o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])})(t,e)};return function(t,e){function a(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(a.prototype=e.prototype,new a)}}();import Axis from"../../Core/Axis/Axis.js";import Chart from"../../Core/Chart/Chart.js";import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";var _a=SeriesRegistry.seriesTypes,ColumnSeries=_a.column,LineSeries=_a.line;import U from"../../Core/Utilities.js";var arrayMax=U.arrayMax,arrayMin=U.arrayMin,correctFloat=U.correctFloat,extend=U.extend,isNumber=U.isNumber,merge=U.merge,objectEach=U.objectEach,pick=U.pick;import WaterfallAxis from"../../Core/Axis/WaterfallAxis.js";import WaterfallPoint from"./WaterfallPoint.js";import"../../Core/DefaultOptions.js";function ownProp(t,e){return Object.hasOwnProperty.call(t,e)}var WaterfallSeries=function(y){function t(){var t=null!==y&&y.apply(this,arguments)||this;return t.chart=void 0,t.data=void 0,t.options=void 0,t.points=void 0,t.stackedYNeg=void 0,t.stackedYPos=void 0,t.stackKey=void 0,t.xData=void 0,t.yAxis=void 0,t.yData=void 0,t}return __extends(t,y),t.prototype.generatePoints=function(){var t,e,a,o;for(ColumnSeries.prototype.generatePoints.apply(this),a=0,e=this.points.length;a<e;a++)t=this.points[a],o=this.processedYData[a],(t.isIntermediateSum||t.isSum)&&(t.y=correctFloat(o))},t.prototype.translate=function(){var t,e,a,o,s=this,r=s.options,i=s.yAxis,n=pick(r.minPointLength,5),l=n/2,h=r.threshold||0,p=h,d=h,c=r.stacking,u=i.waterfall.stacks[s.stackKey];ColumnSeries.prototype.translate.apply(s);for(var y=s.points,g=0;g<y.length;g++){var f,m,S,x=y[g],b=s.processedYData[g],k=x.shapeArgs;k&&isNumber(b)&&(f=[0,b],m=x.y,c?u&&(S=u[g],"overlap"===c?(e=S.stackState[S.stateIndex--],t=0<=m?e:e-m,ownProp(S,"absolutePos")&&delete S.absolutePos,ownProp(S,"absoluteNeg")&&delete S.absoluteNeg):(t=0<=m?(e=S.threshold+S.posTotal,S.posTotal-=m,e):(e=S.threshold+S.negTotal,S.negTotal-=m,e-m),S.posTotal||ownProp(S,"absolutePos")&&(S.posTotal=S.absolutePos,delete S.absolutePos),S.negTotal||ownProp(S,"absoluteNeg")&&(S.negTotal=S.absoluteNeg,delete S.absoluteNeg)),x.isSum||(S.connectorThreshold=S.threshold+S.stackTotal),o=i.reversed?(a=0<=m?t-m:t+m,t):(a=t)-m,x.below=a<=h,k.y=i.translate(a,!1,!0,!1,!0)||0,k.height=Math.abs(k.y-(i.translate(o,!1,!0,!1,!0)||0)),(S=i.waterfall.dummyStackItem)&&(S.x=g,S.label=u[g].label,S.setOffset(s.pointXOffset||0,s.barW||0,s.stackedYNeg[g],s.stackedYPos[g]))):(t=Math.max(p,p+m)+f[0],k.y=i.translate(t,!1,!0,!1,!0)||0,x.isSum?(k.y=i.translate(f[1],!1,!0,!1,!0)||0,k.height=Math.min(i.translate(f[0],!1,!0,!1,!0)||0,i.len)-k.y,x.below=f[1]<=h):x.isIntermediateSum?(o=0<=m?(a=f[1]+d,d):(a=d,f[1]+d),i.reversed&&(a^=o,a^=o^=a),k.y=i.translate(a,!1,!0,!1,!0)||0,k.height=Math.abs(k.y-Math.min(i.translate(o,!1,!0,!1,!0)||0,i.len)),d+=f[1],x.below=a<=h):(k.height=0<b?(i.translate(p,!1,!0,!1,!0)||0)-k.y:(i.translate(p,!1,!0,!1,!0)||0)-(i.translate(p-b,!1,!0,!1,!0)||0),p+=b,x.below=p<h),k.height<0&&(k.y+=k.height,k.height*=-1)),x.plotY=k.y=Math.round(k.y||0)-s.borderWidth%2/2,k.height=Math.max(Math.round(k.height||0),.001),x.yBottom=k.y+k.height,k.height<=n&&!x.isNull?(k.height=n,k.y-=l,x.plotY=k.y,x.y<0?x.minPointLengthOffset=-l:x.minPointLengthOffset=l):(x.isNull&&(k.width=0),x.minPointLengthOffset=0),b=x.plotY+(x.negative?k.height:0),x.below&&(x.plotY+=k.height),x.tooltipPos&&(s.chart.inverted?x.tooltipPos[0]=i.len-b:x.tooltipPos[1]=b))}},t.prototype.processData=function(t){for(var e,a,o,s,r,i=this,n=i.options,l=i.yData,h=n.data,p=l.length,d=n.threshold||0,c=a=o=s=0,u=0;u<p;u++)r=l[u],e=h&&h[u]?h[u]:{},"sum"===r||e.isSum?l[u]=correctFloat(c):"intermediateSum"===r||e.isIntermediateSum?(l[u]=correctFloat(a),a=0):(c+=r,a+=r),o=Math.min(c,o),s=Math.max(c,s);y.prototype.processData.call(this,t),n.stacking||(i.dataMin=o+d,i.dataMax=s)},t.prototype.toYData=function(t){return t.isSum?"sum":t.isIntermediateSum?"intermediateSum":t.y},t.prototype.updateParallelArrays=function(t,e){y.prototype.updateParallelArrays.call(this,t,e),"sum"!==this.yData[0]&&"intermediateSum"!==this.yData[0]||(this.yData[0]=null)},t.prototype.pointAttribs=function(t,e){var a=this.options.upColor;return a&&!t.options.color&&(t.color=0<t.y?a:null),delete(e=ColumnSeries.prototype.pointAttribs.call(this,t,e)).dashstyle,e},t.prototype.getGraphPath=function(){return[["M",0,0]]},t.prototype.getCrispPath=function(){for(var t=this.data,e=this.yAxis,a=t.length,o=Math.round(this.graph.strokeWidth())%2/2,s=Math.round(this.borderWidth)%2/2,r=this.xAxis.reversed,i=this.yAxis.reversed,n=this.options.stacking,l=[],h=1;h<a;h++){var p=t[h].shapeArgs,d=t[h-1],c=t[h-1].shapeArgs,u=e.waterfall.stacks[this.stackKey],y=0<d.y?-c.height:0;u&&c&&p&&(u=u[h-1],y=n?(u=u.connectorThreshold,Math.round(e.translate(u,0,1,0,1)+(i?y:0))-o):c.y+d.minPointLengthOffset+s-o,l.push(["M",(c.x||0)+(!r&&c.width||0),y],["L",(p.x||0)+(r&&p.width||0),y])),c&&l.length&&(!n&&d.y<0&&!i||0<d.y&&i)&&((d=l[l.length-2])&&"number"==typeof d[2]&&(d[2]+=c.height||0),(d=l[l.length-1])&&"number"==typeof d[2]&&(d[2]+=c.height||0))}return l},t.prototype.drawGraph=function(){LineSeries.prototype.drawGraph.call(this),this.graph.attr({d:this.getCrispPath()})},t.prototype.setStackedPoints=function(){var s,t,e,a,r,o,i,n,l,h,p,d=this,c=d.options,u=d.yAxis.waterfall.stacks,y=c.threshold,g=y||0,f=g,m=d.stackKey,S=d.xData,x=S.length;function b(t,e,a,o){if(r)for(;a<r;a++)s.stackState[a]+=o;else s.stackState[0]=t,r=s.stackState.length;s.stackState.push(s.stackState[r-1]+e)}if(d.yAxis.stacking.usePercentage=!1,t=e=a=g,d.visible||!d.chart.options.chart.ignoreHiddenSeries){p=u.changed,(h=u.alreadyChanged)&&h.indexOf(m)<0&&(p=!0),u[m]||(u[m]={});for(var k=u[m],v=0;v<x;v++)k[l=S[v]]&&!p||(k[l]={negTotal:0,posTotal:0,stackTotal:0,threshold:0,stateIndex:0,stackState:[],label:p&&k[l]?k[l].label:void 0}),s=k[l],0<=(n=d.yData[v])?s.posTotal+=n:s.negTotal+=n,i=c.data[v],o=s.absolutePos=s.posTotal,l=s.absoluteNeg=s.negTotal,s.stackTotal=o+l,r=s.stackState.length,i&&i.isIntermediateSum?(b(a,e,0,a),a=e,e=y,g^=f,g^=f^=g):i&&i.isSum?(b(y,t,r),g=y):(b(g,n,0,t),i&&(t+=n,e+=n)),s.stateIndex++,s.threshold=g,g+=s.stackTotal;u.changed=!1,u.alreadyChanged||(u.alreadyChanged=[]),u.alreadyChanged.push(m)}},t.prototype.getExtremes=function(){var t,e,a,o=this.options.stacking;return o?(t=this.yAxis.waterfall.stacks,e=this.stackedYNeg=[],a=this.stackedYPos=[],objectEach(t[this.stackKey],"overlap"===o?function(t){e.push(arrayMin(t.stackState)),a.push(arrayMax(t.stackState))}:function(t){e.push(t.negTotal+t.threshold),a.push(t.posTotal+t.threshold)}),{dataMin:arrayMin(e),dataMax:arrayMax(a)}):{dataMin:this.dataMin,dataMax:this.dataMax}},t.defaultOptions=merge(ColumnSeries.defaultOptions,{dataLabels:{inside:!0},lineWidth:1,lineColor:"#333333",dashStyle:"Dot",borderColor:"#333333",states:{hover:{lineWidthPlus:0}}}),t}(ColumnSeries);extend(WaterfallSeries.prototype,{getZonesGraphs:LineSeries.prototype.getZonesGraphs,pointValKey:"y",showLine:!0,pointClass:WaterfallPoint}),SeriesRegistry.registerSeriesType("waterfall",WaterfallSeries),WaterfallAxis.compose(Axis,Chart);export default WaterfallSeries;