"use strict";import CU from"../../Core/Geometry/CircleUtilities.js";var getAreaOfCircle=CU.getAreaOfCircle,getCircleCircleIntersection=CU.getCircleCircleIntersection,getOverlapBetweenCirclesByDistance=CU.getOverlapBetweenCircles,isPointInsideAllCircles=CU.isPointInsideAllCircles,isPointInsideCircle=CU.isPointInsideCircle,isPointOutsideAllCircles=CU.isPointOutsideAllCircles;import GU from"../../Core/Geometry/GeometryUtilities.js";var getDistanceBetweenPoints=GU.getDistanceBetweenPoints;import U from"../../Core/Utilities.js";var extend=U.extend,isArray=U.isArray,isNumber=U.isNumber,isObject=U.isObject,isString=U.isString;function addOverlapToSets(e){var r=e.filter(function(e){return 2===e.sets.length}).reduce(function(n,i){return i.sets.forEach(function(e,t,r){isObject(n[e])||(n[e]={overlapping:{},totalOverlap:0}),n[e].totalOverlap+=i.value,n[e].overlapping[r[1-t]]=i.value}),n},{});return e.filter(isSet).forEach(function(e){var t=r[e.sets[0]];extend(e,t)}),e}function bisect(e,t,r,n,i){var s,o,a=e(t),c=e(r),l=i||100,u=n||1e-10,f=r-t,v=1;if(r<=t)throw new Error("a must be smaller than b.");if(0<a*c)throw new Error("f(a) and f(b) must have opposite signs.");if(0===a)s=t;else if(0===c)s=r;else for(;v++<=l&&0!==o&&u<f;)0<a*(o=e(s=t+(f=(r-t)/2)))?t=s:r=s;return s}function getCentroid(e){for(var t=e.slice(0,-1),r=t.length,n=[],i=function(e,t){return e.sum+=t[e.i],e},s=0;s<r;s++)n[s]=t.reduce(i,{sum:0,i:s}).sum/r;return n}function getDistanceBetweenCirclesByOverlap(t,r,n){var e=t+r,e=n<=0?e:getAreaOfCircle(t<r?t:r)<=n?0:bisect(function(e){e=getOverlapBetweenCirclesByDistance(t,r,e);return n-e},0,e);return e}function getLabelWidth(i,s,e){var t=s.reduce(function(e,t){return Math.min(t.r,e)},1/0),o=e.filter(function(e){return!isPointInsideCircle(i,e)}),e=function(r,n){return bisect(function(e){var t={x:i.x+n*e,y:i.y},t=isPointInsideAllCircles(t,s)&&isPointOutsideAllCircles(t,o);return-(r-e)+(t?0:Number.MAX_VALUE)},0,r)};return 2*Math.min(e(t,-1),e(t,1))}function getMarginFromCircles(r,e,t){e=e.reduce(function(e,t){t=t.r-getDistanceBetweenPoints(r,t);return t<=e?t:e},Number.MAX_VALUE);return e=t.reduce(function(e,t){t=getDistanceBetweenPoints(r,t)-t.r;return t<=e?t:e},e)}function getOverlapBetweenCircles(e){var t,r=0;return 2===e.length&&(t=e[0],e=e[1],r=getOverlapBetweenCirclesByDistance(t.r,e.r,getDistanceBetweenPoints(t,e))),r}function isSet(e){return isArray(e.sets)&&1===e.sets.length}function isValidRelation(e){var r={};return isObject(e)&&isNumber(e.value)&&-1<e.value&&isArray(e.sets)&&0<e.sets.length&&!e.sets.some(function(e){var t=!1;return!r[e]&&isString(e)?r[e]=!0:t=!0,t})}function isValidSet(e){return isValidRelation(e)&&isSet(e)&&0<e.value}function layoutGreedyVenn(e){var l=[],u={};e.filter(function(e){return 1===e.sets.length}).forEach(function(e){u[e.sets[0]]=e.circle={x:Number.MAX_VALUE,y:Number.MAX_VALUE,r:Math.sqrt(e.value/Math.PI)}});function r(e,t){var r=e.circle;r.x=t.x,r.y=t.y,l.push(e)}addOverlapToSets(e);var t=e.filter(isSet).sort(sortByTotalOverlap);r(t.shift(),{x:0,y:0});var f=e.filter(function(e){return 2===e.sets.length});return t.forEach(function(e){var o=e.circle,a=o.r,c=e.overlapping,t=l.reduce(function(r,e,t){var n=e.circle,e=c[e.sets[0]],i=getDistanceBetweenCirclesByOverlap(a,n.r,e),s=[{x:n.x+i,y:n.y},{x:n.x-i,y:n.y},{x:n.x,y:n.y+i},{x:n.x,y:n.y-i}];return l.slice(t+1).forEach(function(e){var t=e.circle,e=c[e.sets[0]],e=getDistanceBetweenCirclesByOverlap(a,t.r,e);s=s.concat(getCircleCircleIntersection({x:n.x,y:n.y,r:i},{x:t.x,y:t.y,r:e}))}),s.forEach(function(e){o.x=e.x,o.y=e.y;var t=loss(u,f);t<r.loss&&(r.loss=t,r.coordinates=e)}),r},{loss:Number.MAX_VALUE,coordinates:void 0});r(e,t.coordinates)}),u}function loss(n,e){return e.reduce(function(e,t){var r=0;return 1<t.sets.length&&(t=t.value-getOverlapBetweenCircles(t.sets.map(function(e){return n[e]})),r=Math.round(t*t*1e11)/1e11),e+r},0)}function nelderMead(s,e){for(var t=function(e,t){return e.fx-t.fx},i=function(r,e,n,i){return e.map(function(e,t){return r*e+n*i[t]})},r=function(e,t){return t.fx=s(t),e[e.length-1]=t,e},n=function(e){var t=e[0];return e.map(function(e){e=i(.5,t,.5,e);return e.fx=s(e),e})},o=function(e,t,r,n){t=i(r,e,n,t);return t.fx=s(t),t},a=function(e){var t=e.length,r=new Array(t+1);r[0]=e,r[0].fx=s(e);for(var n=0;n<t;++n){var i=e.slice();i[n]=i[n]?1.05*i[n]:.001,i.fx=s(i),r[n+1]=i}return r}(e),c=0;c<100;c++){a.sort(t);var l,u=a[a.length-1],f=getCentroid(a),v=o(f,u,2,-1);a=v.fx<a[0].fx?r(a,(l=o(f,u,3,-2)).fx<v.fx?l:v):v.fx>=a[a.length-2].fx?(l=void 0,v.fx>u.fx?(l=o(f,u,.5,.5)).fx<u.fx?r(a,l):n(a):(l=o(f,u,1.5,-.5)).fx<v.fx?r(a,l):n(a)):r(a,v)}return a[0]}function processVennData(e){var e=isArray(e)?e:[],r=e.reduce(function(e,t){return isValidSet(t)&&-1===e.indexOf(t.sets[0])&&e.push(t.sets[0]),e},[]).sort(),n=e.reduce(function(e,t){return isValidRelation(t)&&!t.sets.some(function(e){return-1===r.indexOf(e)})&&(e[t.sets.sort().join()]=t),e},{});return r.reduce(function(t,r,e,n){return n.slice(e+1).forEach(function(e){t.push(r+","+e)}),t},[]).forEach(function(e){var t;n[e]||(t={sets:e.split(","),value:0},n[e]=t)}),Object.keys(n).map(function(e){return n[e]})}function sortByTotalOverlap(e,t){return t.totalOverlap-e.totalOverlap}var VennUtils={geometry:GU,geometryCircles:CU,addOverlapToSets:addOverlapToSets,getCentroid:getCentroid,getDistanceBetweenCirclesByOverlap:getDistanceBetweenCirclesByOverlap,getLabelWidth:getLabelWidth,getMarginFromCircles:getMarginFromCircles,isSet:isSet,layoutGreedyVenn:layoutGreedyVenn,loss:loss,nelderMead:nelderMead,processVennData:processVennData,sortByTotalOverlap:sortByTotalOverlap};export default VennUtils;