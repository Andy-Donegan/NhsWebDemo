"use strict";var __extends=this&&this.__extends||function(){var o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();import H from"../../Core/Globals.js";import NodesComposition from"../NodesComposition.js";import Point from"../../Core/Series/Point.js";import Series from"../../Core/Series/Series.js";import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";var seriesTypes=SeriesRegistry.seriesTypes;import U from"../../Core/Utilities.js";var addEvent=U.addEvent,css=U.css,defined=U.defined,extend=U.extend,merge=U.merge,pick=U.pick;import"../../Core/DefaultOptions.js";import"./Layouts.js";import"./DraggableNodes.js";var dragNodesMixin=H.dragNodesMixin,NetworkgraphSeries=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.data=void 0,t.nodes=void 0,t.options=void 0,t.points=void 0,t}return __extends(t,e),t.defaultOptions=merge(Series.defaultOptions,{stickyTracking:!1,inactiveOtherPoints:!0,marker:{enabled:!0,states:{inactive:{opacity:.3,animation:{duration:50}}}},states:{inactive:{linkOpacity:.3,animation:{duration:50}}},dataLabels:{formatter:function(){return this.key},linkFormatter:function(){return this.point.fromNode.name+"<br>"+this.point.toNode.name},linkTextPath:{enabled:!0},textPath:{enabled:!1},style:{transition:"opacity 2000ms"}},link:{color:"rgba(100, 100, 100, 0.5)",width:1},draggable:!0,layoutAlgorithm:{initialPositions:"circle",initialPositionRadius:1,enableSimulation:!1,theta:.5,maxSpeed:10,approximation:"none",type:"reingold-fruchterman",integration:"euler",maxIterations:1e3,gravitationalConstant:.0625,friction:-.981},showInLegend:!1}),t}(Series);extend(NetworkgraphSeries.prototype,{forces:["barycenter","repulsive","attractive"],hasDraggableNodes:!0,drawGraph:void 0,isCartesian:!1,requireSorting:!1,directTouch:!0,noSharedTooltip:!0,pointArrayMap:["from","to"],trackerGroups:["group","markerGroup","dataLabelsGroup"],drawTracker:seriesTypes.column.prototype.drawTracker,animate:void 0,buildKDTree:H.noop,createNode:NodesComposition.createNode,destroy:function(){this.layout&&this.layout.removeElementFromCollection(this,this.layout.series),NodesComposition.destroy.call(this)},init:function(){var t=this;return Series.prototype.init.apply(this,arguments),addEvent(this,"updatedData",function(){t.layout&&t.layout.stop()}),addEvent(this,"afterUpdate",function(){t.nodes.forEach(function(t){t&&t.series&&t.resolveColor()})}),this},generatePoints:function(){var t,e;for(NodesComposition.generatePoints.apply(this,arguments),this.options.nodes&&this.options.nodes.forEach(function(t){this.nodeLookup[t.id]||(this.nodeLookup[t.id]=this.createNode(t.id))},this),e=this.nodes.length-1;0<=e;e--)(t=this.nodes[e]).degree=t.getDegree(),t.radius=pick(t.marker&&t.marker.radius,this.options.marker&&this.options.marker.radius,0),this.nodeLookup[t.id]||t.remove();this.data.forEach(function(t){t.formatPrefix="link"}),this.indexateNodes()},getPointsCollection:function(){return this.nodes||[]},indexateNodes:function(){this.nodes.forEach(function(t,e){t.index=e})},markerAttribs:function(t,e){e=Series.prototype.markerAttribs.call(this,t,e);return defined(t.plotY)||(e.y=0),e.x=(t.plotX||0)-(e.width||0)/2,e},translate:function(){this.processedXData||this.processData(),this.generatePoints(),this.deferLayout(),this.nodes.forEach(function(t){t.isInside=!0,t.linksFrom.forEach(function(t){t.shapeType="path",t.y=1})})},deferLayout:function(){var t,e=this.options.layoutAlgorithm,i=this.chart.graphLayoutsStorage,o=this.chart.graphLayoutsLookup,s=this.chart.options.chart;this.visible&&(i||(this.chart.graphLayoutsStorage=i={},this.chart.graphLayoutsLookup=o=[]),(t=i[e.type])||(e.enableSimulation=defined(s.forExport)?!s.forExport:e.enableSimulation,i[e.type]=t=new H.layouts[e.type],t.init(e),o.splice(t.index,0,t)),(this.layout=t).setArea(0,0,this.chart.plotWidth,this.chart.plotHeight),t.addElementsToCollection([this],t.series),t.addElementsToCollection(this.nodes,t.nodes),t.addElementsToCollection(this.points,t.links))},render:function(){var t=this,e=t.points,i=t.chart.hoverPoint,o=[];t.points=t.nodes,seriesTypes.line.prototype.render.call(this),(t.points=e).forEach(function(t){t.fromNode&&t.toNode&&(t.renderLink(),t.redrawLink())}),i&&i.series===t&&t.redrawHalo(i),t.chart.hasRendered&&!t.options.dataLabels.allowOverlap&&(t.nodes.concat(t.points).forEach(function(t){t.dataLabel&&o.push(t.dataLabel)}),t.chart.hideOverlappingLabels(o))},drawDataLabels:function(){var t=this.options.dataLabels.textPath;Series.prototype.drawDataLabels.apply(this,arguments),this.points=this.data,this.options.dataLabels.textPath=this.options.dataLabels.linkTextPath,Series.prototype.drawDataLabels.apply(this,arguments),this.points=this.nodes,this.options.dataLabels.textPath=t},pointAttribs:function(t,e){var i=e||t&&t.state||"normal",e=Series.prototype.pointAttribs.call(this,t,i),i=this.options.states[i];return t&&!t.isNode&&(e=t.getLinkAttributes(),i&&(e={stroke:i.linkColor||e.stroke,dashstyle:i.linkDashStyle||e.dashstyle,opacity:pick(i.linkOpacity,e.opacity),"stroke-width":i.linkColor||e["stroke-width"]})),e},redrawHalo:dragNodesMixin.redrawHalo,onMouseDown:dragNodesMixin.onMouseDown,onMouseMove:dragNodesMixin.onMouseMove,onMouseUp:dragNodesMixin.onMouseUp,setState:function(t,e){e?(this.points=this.nodes.concat(this.data),Series.prototype.setState.apply(this,arguments),this.points=this.data):Series.prototype.setState.apply(this,arguments),this.layout.simulation||t||this.render()}});var NetworkgraphPoint=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.degree=void 0,t.linksFrom=void 0,t.linksTo=void 0,t.options=void 0,t.radius=void 0,t.series=void 0,t.toNode=void 0,t}return __extends(t,e),t}(Series.prototype.pointClass);extend(NetworkgraphPoint.prototype,{setState:NodesComposition.setNodeState,init:function(){return Point.prototype.init.apply(this,arguments),this.series.options.draggable&&!this.series.chart.styledMode&&(addEvent(this,"mouseOver",function(){css(this.series.chart.container,{cursor:"move"})}),addEvent(this,"mouseOut",function(){css(this.series.chart.container,{cursor:"default"})})),this},getDegree:function(){var t=this.isNode?this.linksFrom.length+this.linksTo.length:0;return 0===t?1:t},getLinkAttributes:function(){var t=this.series.options.link,e=this.options;return{"stroke-width":pick(e.width,t.width),stroke:e.color||t.color,dashstyle:e.dashStyle||t.dashStyle,opacity:pick(e.opacity,t.opacity,1)}},renderLink:function(){var e;this.graphic||(this.graphic=this.series.chart.renderer.path(this.getLinkPath()).addClass(this.getClassName(),!0).add(this.series.group),this.series.chart.styledMode||(e=this.series.pointAttribs(this),this.graphic.attr(e),(this.dataLabels||[]).forEach(function(t){t&&t.attr({opacity:e.opacity})})))},redrawLink:function(){var e,t,i=this.getLinkPath();this.graphic&&(this.shapeArgs={d:i},this.series.chart.styledMode||(e=this.series.pointAttribs(this),this.graphic.attr(e),(this.dataLabels||[]).forEach(function(t){t&&t.attr({opacity:e.opacity})})),this.graphic.animate(this.shapeArgs),t=i[0],i=i[1],"M"===t[0]&&"L"===i[0]&&(this.plotX=(t[1]+i[1])/2,this.plotY=(t[2]+i[2])/2))},getMass:function(){var t=this.fromNode.mass,e=this.toNode.mass,i=t+e;return{fromNode:1-t/i,toNode:1-e/i}},getLinkPath:function(){var t=this.fromNode,e=this.toNode;return t.plotX>e.plotX&&(t=this.toNode,e=this.fromNode),[["M",t.plotX||0,t.plotY||0],["L",e.plotX||0,e.plotY||0]]},isValid:function(){return!this.isNode||defined(this.id)},remove:function(t,e){var i,o=this,s=o.series,r=s.options.nodes||[],n=r.length;if(o.isNode){for(s.points=[],[].concat(o.linksFrom).concat(o.linksTo).forEach(function(t){-1<(i=t.fromNode.linksFrom.indexOf(t))&&t.fromNode.linksFrom.splice(i,1),-1<(i=t.toNode.linksTo.indexOf(t))&&t.toNode.linksTo.splice(i,1),Series.prototype.removePoint.call(s,s.data.indexOf(t),!1,!1)}),s.points=s.data.slice(),s.nodes.splice(s.nodes.indexOf(o),1);n--;)if(r[n].id===o.options.id){s.options.nodes.splice(n,1);break}o&&o.destroy(),s.isDirty=!0,s.isDirtyData=!0,t&&s.chart.redraw(t)}else s.removePoint(s.data.indexOf(o),t,e)},destroy:function(){return this.isNode&&this.linksFrom.concat(this.linksTo).forEach(function(t){t.destroyElements&&t.destroyElements()}),this.series.layout.removeElementFromCollection(this,this.series.layout[this.isNode?"nodes":"links"]),Point.prototype.destroy.apply(this,arguments)}}),NetworkgraphSeries.prototype.pointClass=NetworkgraphPoint,SeriesRegistry.registerSeriesType("networkgraph",NetworkgraphSeries);export default NetworkgraphSeries;