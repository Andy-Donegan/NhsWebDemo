"use strict";var __extends=this&&this.__extends||function(){var o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();import CU from"../CenteredUtilities.js";var getCenter=CU.getCenter,getStartAndEndRadians=CU.getStartAndEndRadians;import H from"../../Core/Globals.js";var noop=H.noop;import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";var Series=SeriesRegistry.series,_a=SeriesRegistry.seriesTypes,ColumnSeries=_a.column,TreemapSeries=_a.treemap;import SunburstPoint from"./SunburstPoint.js";import SunburstUtilities from"./SunburstUtilities.js";import TU from"../TreeUtilities.js";var getColor=TU.getColor,getLevelOptions=TU.getLevelOptions,setTreeValues=TU.setTreeValues,updateRootId=TU.updateRootId;import U from"../../Core/Utilities.js";var error=U.error,extend=U.extend,isNumber=U.isNumber,isObject=U.isObject,isString=U.isString,merge=U.merge,splat=U.splat,rad2deg=180/Math.PI;function isBoolean(e){return"boolean"==typeof e}var getEndPoint=function(e,t,r,o){return{x:e+Math.cos(r)*o,y:t+Math.sin(r)*o}};function getDlOptions(e){var t,r=e.point,o=isObject(e.shapeArgs)?e.shapeArgs:{},i=isObject(e.optionsPoint)?e.optionsPoint.dataLabels:{},e=splat(isObject(e.level)?e.level.dataLabels:{})[0],e=merge({style:{}},e,i),i=e.rotationMode;return isNumber(e.rotation)||("auto"!==i&&"circular"!==i||(r.innerArcLength<1&&r.outerArcLength>o.radius?(t=0,r.dataLabelPath&&"circular"===i&&(e.textPath={enabled:!0})):1<r.innerArcLength&&r.outerArcLength>1.5*o.radius?"circular"===i?e.textPath={enabled:!0,attributes:{dy:5}}:i="parallel":(r.dataLabel&&r.dataLabel.textPathWrapper&&"circular"===i&&(e.textPath={enabled:!1}),i="perpendicular")),"auto"!==i&&"circular"!==i&&(t=o.end-(o.end-o.start)/2),e.style.width="parallel"===i?Math.min(2.5*o.radius,(r.outerArcLength+r.innerArcLength)/2):o.radius,"perpendicular"===i&&r.series.chart.renderer.fontMetrics(e.style.fontSize).h>r.outerArcLength&&(e.style.width=1),e.style.width=Math.max(e.style.width-2*(e.padding||0),1),t=t*rad2deg%180,"parallel"===i&&(t-=90),90<t?t-=180:t<-90&&(t+=180),e.rotation=t),e.textPath&&(0===r.shapeExisting.innerR&&e.textPath.enabled?(e.rotation=0,e.textPath.enabled=!1,e.style.width=Math.max(2*r.shapeExisting.r-2*(e.padding||0),1)):r.dlOptions&&r.dlOptions.textPath&&!r.dlOptions.textPath.enabled&&"circular"===i&&(e.textPath.enabled=!0),e.textPath.enabled&&(e.rotation=0,e.style.width=Math.max((r.outerArcLength+r.innerArcLength)/2-2*(e.padding||0),1))),0===e.rotation&&(e.rotation=.001),e}function getAnimation(e,t){var r=t.point,o=t.radians,i=t.innerR,n=t.idRoot,a=t.idPreviousRoot,s=t.shapeExisting,l=t.shapeRoot,d=t.shapePreviousRoot,p=t.visible,u={},t={end:e.end,start:e.start,innerR:e.innerR,r:e.r,x:e.x,y:e.y};return p?!r.graphic&&d&&((u=n===r.id?{start:o.start,end:o.end}:d.end<=e.start?{start:o.end,end:o.end}:{start:o.start,end:o.start}).innerR=u.r=i):r.graphic&&(a===r.id?t={innerR:i,r:i}:l&&(t=l.end<=s.start?{innerR:i,r:i,start:o.end,end:o.end}:{innerR:i,r:i,start:o.start,end:o.start})),{from:u,to:t}}function getDrillId(e,t,r){var o;return o=!e.node.isLeaf?t===e.id?r[t].parent:e.id:o}function cbSetTreeValuesBefore(e,t){var r=t.mapIdToNode[e.parent],o=t.series,i=o.chart,n=o.points[e.i],i=o.options.colors||i&&i.options.colors,r=getColor(e,{colors:i,colorIndex:o.colorIndex,index:t.index,mapOptionsToLevel:t.mapOptionsToLevel,parentColor:r&&r.color,parentColorIndex:r&&r.colorIndex,series:t.series,siblings:t.siblings});return e.color=r.color,e.colorIndex=r.colorIndex,n&&(n.color=e.color,n.colorIndex=e.colorIndex,e.sliced=e.id!==t.idRoot&&n.sliced),e}var SunburstSeries=function(o){function e(){var e=null!==o&&o.apply(this,arguments)||this;return e.center=void 0,e.data=void 0,e.mapOptionsToLevel=void 0,e.nodeMap=void 0,e.options=void 0,e.points=void 0,e.shapeRoot=void 0,e.startAndEndRadians=void 0,e.tree=void 0,e}return __extends(e,o),e.prototype.alignDataLabel=function(e,t,r){if(!r.textPath||!r.textPath.enabled)return o.prototype.alignDataLabel.apply(this,arguments)},e.prototype.animate=function(e){var t=this.chart,r=[t.plotWidth/2,t.plotHeight/2],o=t.plotLeft,i=t.plotTop,t=this.group;e?t.attr({translateX:r[0]+o,translateY:r[1]+i,scaleX:.001,scaleY:.001,rotation:10,opacity:.01}):t.animate({translateX:o,translateY:i,scaleX:1,scaleY:1,rotation:0,opacity:1},this.options.animation)},e.prototype.drawPoints=function(){var s,l=this,d=l.mapOptionsToLevel,p=l.shapeRoot,u=l.group,c=l.hasRendered,h=l.rootNode,v=l.idPreviousRoot,g=l.nodeMap,e=g[v],b=e&&e.shapeArgs,t=l.points,f=l.startAndEndRadians,m=l.chart,e=m&&m.options&&m.options.chart||{},y=!isBoolean(e.animation)||e.animation,e=l.center,x={x:e[0],y:e[1]},S=e[3]/2,R=l.chart.renderer,r=!1,A=!1,e=!!(y&&c&&h!==v&&l.dataLabelsGroup);e&&(l.dataLabelsGroup.attr({opacity:0}),s=function(){var e=l;r=!0,e.dataLabelsGroup&&e.dataLabelsGroup.animate({opacity:1,visibility:"visible"})}),t.forEach(function(e){var t,r=e.node,o=d[r.level],i=e.shapeExisting||{},n=r.shapeArgs||{},a=!(!r.visible||!r.shapeArgs),i=c&&y?getAnimation(n,{center:x,point:e,radians:f,innerR:S,idRoot:h,idPreviousRoot:v,shapeExisting:i,shapeRoot:p,shapePreviousRoot:b,visible:a}):{to:n,from:{}};extend(e,{shapeExisting:n,tooltipPos:[n.plotX,n.plotY],drillId:getDrillId(e,h,g),name:""+(e.name||e.id||e.index),plotX:n.plotX,plotY:n.plotY,value:r.val,isInside:a,isNull:!a}),e.dlOptions=getDlOptions({point:e,level:o,optionsPoint:e.options,shapeArgs:n}),!A&&a&&(A=!0,t=s),e.draw({animatableAttribs:i.to,attribs:extend(i.from,!m.styledMode&&l.pointAttribs(e,e.selected&&"select")),onComplete:t,group:u,renderer:R,shapeType:"arc",shapeArgs:n})}),e&&A?(l.hasRendered=!1,l.options.dataLabels.defer=!0,Series.prototype.drawDataLabels.call(l),l.hasRendered=!0,r&&s()):Series.prototype.drawDataLabels.call(l)},e.prototype.layoutAlgorithm=function(e,t,r){var i=e.start,n=e.end-i,a=e.val,s=e.x,l=e.y,d=r&&isObject(r.levelSize)&&isNumber(r.levelSize.value)?r.levelSize.value:0,p=e.r,u=p+d,c=r&&isNumber(r.slicedOffset)?r.slicedOffset:0;return(t||[]).reduce(function(e,t){var r=1/a*t.val*n,o=getEndPoint(s,l,i+r/2,c),r={x:t.sliced?o.x:s,y:t.sliced?o.y:l,innerR:p,r:u,radius:d,start:i,end:i+r};return e.push(r),i=r.end,e},[])},e.prototype.setShapeArgs=function(e,t,a){var r=e.level+1,r=a[r],e=e.children.filter(function(e){return e.visible}),s=this.layoutAlgorithm(t,e,r);e.forEach(function(e,t){var r=s[t],o=r.start+(r.end-r.start)/2,i=r.innerR+(r.r-r.innerR)/2,n=r.end-r.start,t=0===r.innerR&&6.28<n?{x:r.x,y:r.y}:getEndPoint(r.x,r.y,o,i),i=!e.val||e.childrenTotal>e.val?e.childrenTotal:e.val;this.points[e.i]&&(this.points[e.i].innerArcLength=n*r.innerR,this.points[e.i].outerArcLength=n*r.r),e.shapeArgs=merge(r,{plotX:t.x,plotY:t.y+4*Math.abs(Math.cos(o))}),e.values=merge(r,{val:i}),e.children.length&&this.setShapeArgs(e,e.values,a)},this)},e.prototype.translate=function(){var e,t=this,r=t.options,o=t.center=getCenter.call(t),i=t.startAndEndRadians=getStartAndEndRadians(r.startAngle,r.endAngle),n=o[3]/2,a=o[2]/2-n,s=updateRootId(t),l=t.nodeMap,d=l&&l[s],p={};t.shapeRoot=d&&d.shapeArgs,Series.prototype.translate.call(t),e=t.tree=t.getTree(),t.renderTraverseUpButton(s);var d=(l=t.nodeMap)[s],u=l[isString(d.parent)?d.parent:""],c=SunburstUtilities.getLevelFromAndTo(d),h=c.from,v=c.to,c=getLevelOptions({from:h,levels:t.options.levels,to:v,defaults:{colorByPoint:r.colorByPoint,dataLabels:r.dataLabels,levelIsConstant:r.levelIsConstant,levelSize:r.levelSize,slicedOffset:r.slicedOffset}});c=SunburstUtilities.calculateLevelSizes(c,{diffRadius:a,from:h,to:v}),setTreeValues(e,{before:cbSetTreeValuesBefore,idRoot:s,levelIsConstant:r.levelIsConstant,mapOptionsToLevel:c,mapIdToNode:l,points:t.points,series:t}),o=l[""].shapeArgs={end:i.end,r:n,start:i.start,val:d.val,x:o[0],y:o[1]},this.setShapeArgs(u,o,c),t.mapOptionsToLevel=c,t.data.forEach(function(e){p[e.id]&&error(31,!1,t.chart),p[e.id]=!0}),p={}},e.defaultOptions=merge(TreemapSeries.defaultOptions,{center:["50%","50%"],colorByPoint:!1,opacity:1,dataLabels:{allowOverlap:!0,defer:!0,rotationMode:"auto",style:{textOverflow:"ellipsis"}},rootId:void 0,levelIsConstant:!0,levelSize:{value:1,unit:"weight"},slicedOffset:10}),e}(TreemapSeries);extend(SunburstSeries.prototype,{drawDataLabels:noop,pointAttribs:ColumnSeries.prototype.pointAttribs,pointClass:SunburstPoint,utils:SunburstUtilities}),SeriesRegistry.registerSeriesType("sunburst",SunburstSeries);export default SunburstSeries;