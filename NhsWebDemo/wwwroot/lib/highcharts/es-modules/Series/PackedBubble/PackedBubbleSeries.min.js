"use strict";var __extends=this&&this.__extends||function(){var a=function(t,e){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])})(t,e)};return function(t,e){function o(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}}();import Color from"../../Core/Color/Color.js";var color=Color.parse;import H from"../../Core/Globals.js";import PackedBubblePoint from"./PackedBubblePoint.js";import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";var Series=SeriesRegistry.series,BubbleSeries=SeriesRegistry.seriesTypes.bubble;import U from"../../Core/Utilities.js";var addEvent=U.addEvent,clamp=U.clamp,defined=U.defined,extend=U.extend,fireEvent=U.fireEvent,isArray=U.isArray,isNumber=U.isNumber,merge=U.merge,pick=U.pick;import"../../Series/Networkgraph/DraggableNodes.js";var dragNodesMixin=H.dragNodesMixin;import"./PackedBubbleComposition.js";var PackedBubbleSeries=function(o){function t(){var t=null!==o&&o.apply(this,arguments)||this;return t.chart=void 0,t.data=void 0,t.layout=void 0,t.options=void 0,t.points=void 0,t.xData=void 0,t}return __extends(t,o),t.prototype.accumulateAllPoints=function(t){for(var e,o=t.chart,a=[],i=0;i<o.series.length;i++)if((t=o.series[i]).is("packedbubble")&&t.visible||!o.options.chart.ignoreHiddenSeries)for(e=0;e<t.yData.length;e++)a.push([null,null,t.yData[e],t.index,e,{id:e,marker:{radius:0}}]);return a},t.prototype.addLayout=function(){var t,e=this,o=e.options.layoutAlgorithm,a=e.chart.graphLayoutsStorage,i=e.chart.graphLayoutsLookup,r=e.chart.options.chart;a||(e.chart.graphLayoutsStorage=a={},e.chart.graphLayoutsLookup=i=[]),(t=a[o.type])||(o.enableSimulation=defined(r.forExport)?!r.forExport:o.enableSimulation,a[o.type]=t=new H.layouts[o.type],t.init(o),i.splice(t.index,0,t)),e.layout=t,e.points.forEach(function(t){t.mass=2,t.degree=1,t.collisionNmb=1}),t.setArea(0,0,e.chart.plotWidth,e.chart.plotHeight),t.addElementsToCollection([e],t.series),t.addElementsToCollection(e.points,t.nodes)},t.prototype.addSeriesLayout=function(){var t=this,e=t.options.layoutAlgorithm,o=t.chart.graphLayoutsStorage,a=t.chart.graphLayoutsLookup,i=merge(e,e.parentNodeOptions,{enableSimulation:t.layout.options.enableSimulation}),r=o[e.type+"-series"];r||(o[e.type+"-series"]=r=new H.layouts[e.type],r.init(i),a.splice(r.index,0,r)),t.parentNodeLayout=r,this.createParentNodes()},t.prototype.calculateParentRadius=function(){var t=this,e=t.seriesBox();t.parentNodeRadius=clamp(Math.sqrt(2*t.parentNodeMass/Math.PI)+20,20,e?Math.max(Math.sqrt(Math.pow(e.width,2)+Math.pow(e.height,2))/2+20,20):Math.sqrt(2*t.parentNodeMass/Math.PI)+20),t.parentNode&&(t.parentNode.marker.radius=t.parentNode.radius=t.parentNodeRadius)},t.prototype.calculateZExtremes=function(){var t=this.chart,e=this.options.zMin,o=this.options.zMax,a=1/0,i=-1/0;return e&&o?[e,o]:(t.series.forEach(function(t){t.yData.forEach(function(t){defined(t)&&(i<t&&(i=t),t<a&&(a=t))})}),[e=pick(e,a),o=pick(o,i)])},t.prototype.checkOverlap=function(t,e){var o=t[0]-e[0],a=t[1]-e[1],e=t[2]+e[2];return Math.sqrt(o*o+a*a)-Math.abs(e)<-.001},t.prototype.createParentNodes=function(){var e,o=this,t=o.chart,a=o.parentNodeLayout,i=o.parentNode,r=o.pointClass,n=o.layout.options,s={radius:o.parentNodeRadius,lineColor:o.color,fillColor:color(o.color).brighten(.4).get()};n.parentNodeOptions&&(s=merge(n.parentNodeOptions.marker||{},s)),o.parentNodeMass=0,o.points.forEach(function(t){o.parentNodeMass+=Math.PI*Math.pow(t.marker.radius,2)}),o.calculateParentRadius(),a.nodes.forEach(function(t){t.seriesIndex===o.index&&(e=!0)}),a.setArea(0,0,t.plotWidth,t.plotHeight),e||(i=i||(new r).init(this,{mass:o.parentNodeRadius/2,marker:s,dataLabels:{inside:!1},states:{normal:{marker:s},hover:{marker:s}},dataLabelOnNull:!0,degree:o.parentNodeRadius,isParentNode:!0,seriesIndex:o.index}),o.parentNode&&(i.plotX=o.parentNode.plotX,i.plotY=o.parentNode.plotY),o.parentNode=i,a.addElementsToCollection([o],a.series),a.addElementsToCollection([i],a.nodes))},t.prototype.deferLayout=function(){var t=this.options.layoutAlgorithm;this.visible&&(this.addLayout(),t.splitSeries&&this.addSeriesLayout())},t.prototype.destroy=function(){this.chart.graphLayoutsLookup&&this.chart.graphLayoutsLookup.forEach(function(t){t.removeElementFromCollection(this,t.series)},this),this.parentNode&&this.parentNodeLayout&&(this.parentNodeLayout.removeElementFromCollection(this.parentNode,this.parentNodeLayout.nodes),this.parentNode.dataLabel&&(this.parentNode.dataLabel=this.parentNode.dataLabel.destroy())),Series.prototype.destroy.apply(this,arguments)},t.prototype.drawDataLabels=function(){var t=this.options.dataLabels.textPath,e=this.points;Series.prototype.drawDataLabels.apply(this,arguments),this.parentNode&&(this.parentNode.formatPrefix="parentNode",this.points=[this.parentNode],this.options.dataLabels.textPath=this.options.dataLabels.parentNodeTextPath,Series.prototype.drawDataLabels.apply(this,arguments),this.points=e,this.options.dataLabels.textPath=t)},t.prototype.drawGraph=function(){var t,e,o,a;this.layout&&this.layout.options.splitSeries&&(e=(t=this).chart,o={},a={fill:(a=this.layout.options.parentNodeOptions.marker).fillColor||color(t.color).brighten(.4).get(),opacity:a.fillOpacity,stroke:a.lineColor||t.color,"stroke-width":pick(a.lineWidth,t.options.lineWidth)},this.parentNodesGroup||(t.parentNodesGroup=t.plotGroup("parentNodesGroup","parentNode",t.visible?"inherit":"hidden",.1,e.seriesGroup),t.group.attr({zIndex:2})),this.calculateParentRadius(),o=merge({x:t.parentNode.plotX-t.parentNodeRadius,y:t.parentNode.plotY-t.parentNodeRadius,width:2*t.parentNodeRadius,height:2*t.parentNodeRadius},a),t.parentNode.graphic||(t.graph=t.parentNode.graphic=e.renderer.symbol(a.symbol).add(t.parentNodesGroup)),t.parentNode.graphic.attr(o))},t.prototype.drawTracker=function(){var t,e=this.parentNode;o.prototype.drawTracker.call(this),e&&(t=isArray(e.dataLabels)?e.dataLabels:e.dataLabel?[e.dataLabel]:[],e.graphic&&(e.graphic.element.point=e),t.forEach(function(t){t.div?t.div.point=e:t.element.point=e}))},t.prototype.getPointRadius=function(){var o,a,i,r,n=this,t=n.chart,e=t.plotWidth,s=t.plotHeight,p=n.options,l=p.useSimulation,d=Math.min(e,s),u={},h=[],c=t.allDataPoints;["minSize","maxSize"].forEach(function(t){var e=parseInt(p[t],10),o=/%$/.test(p[t]);u[t]=o?d*e/100:e*Math.sqrt(c.length)}),t.minRadius=o=u.minSize/Math.sqrt(c.length),t.maxRadius=a=u.maxSize/Math.sqrt(c.length),r=l?n.calculateZExtremes():[o,a],(c||[]).forEach(function(t,e){i=l?clamp(t[2],r[0],r[1]):t[2],0===(i=n.getRadius(r[0],r[1],o,a,i))&&(i=null),c[e][2]=i,h.push(i)}),n.radii=h},t.prototype.init=function(){return Series.prototype.init.apply(this,arguments),this.eventsToUnbind.push(addEvent(this,"updatedData",function(){this.chart.series.forEach(function(t){t.type===this.type&&(t.isDirty=!0)},this)})),this},t.prototype.onMouseUp=function(e){var o,a,t;e.fixedPosition&&!e.removed&&(a=this.layout,(t=this.parentNodeLayout)&&a.options.dragBetweenSeries&&t.nodes.forEach(function(t){e&&e.marker&&t!==e.series.parentNode&&(o=a.getDistXY(e,t),a.vectorLength(o)-t.marker.radius-e.marker.radius<0&&(t.series.addPoint(merge(e.options,{plotX:e.plotX,plotY:e.plotY}),!1),a.removeElementFromCollection(e,a.nodes),e.remove()))}),dragNodesMixin.onMouseUp.apply(this,arguments))},t.prototype.placeBubbles=function(t){var e,o,a=this,i=a.checkOverlap,r=a.positionBubble,n=[],s=1,p=0,l=0,d=[],u=t.sort(function(t,e){return e[2]-t[2]});if(u.length){if(n.push([[0,0,u[0][2],u[0][3],u[0][4]]]),1<u.length)for(n.push([[0,0-u[1][2]-u[0][2],u[1][2],u[1][3],u[1][4]]]),o=2;o<u.length;o++)u[o][2]=u[o][2]||1,i(e=r(n[s][p],n[s-1][l],u[o]),n[s][0])?(n.push([]),n[s+1].push(r(n[s][p],n[s][l=0],u[o])),s++,p=0):1<s&&n[s-1][l+1]&&i(e,n[s-1][l+1])?(n[s].push(r(n[s][p],n[s-1][++l],u[o])),p++):(p++,n[s].push(e));a.chart.stages=n,a.chart.rawPositions=[].concat.apply([],n),a.resizeRadius(),d=a.chart.rawPositions}return d},t.prototype.pointAttribs=function(t,e){var o=this.options,a=t&&t.isParentNode,i=o.marker,i=(i=a&&o.layoutAlgorithm&&o.layoutAlgorithm.parentNodeOptions?o.layoutAlgorithm.parentNodeOptions.marker:i).fillOpacity,e=Series.prototype.pointAttribs.call(this,t,e);return 1!==i&&(e["fill-opacity"]=i),e},t.prototype.positionBubble=function(t,e,o){var a=Math.sqrt,i=Math.asin,r=Math.acos,n=Math.pow,s=Math.abs,a=a(n(t[0]-e[0],2)+n(t[1]-e[1],2)),n=r((n(a,2)+n(o[2]+e[2],2)-n(o[2]+t[2],2))/(2*(o[2]+e[2])*a)),a=i(s(t[0]-e[0])/a),a=(t[1]-e[1]<0?0:Math.PI)+n+a*((t[0]-e[0])*(t[1]-e[1])<0?1:-1),t=Math.cos(a),a=Math.sin(a);return[e[0]+(e[2]+o[2])*a,e[1]-(e[2]+o[2])*t,o[2],o[3],o[4]]},t.prototype.render=function(){var e=[];Series.prototype.render.apply(this,arguments),this.options.dataLabels.allowOverlap||(this.data.forEach(function(t){isArray(t.dataLabels)&&t.dataLabels.forEach(function(t){e.push(t)})}),this.options.useSimulation&&this.chart.hideOverlappingLabels(e))},t.prototype.resizeRadius=function(){for(var t,e,o,a,i,r=this.chart,n=r.rawPositions,s=Math.min,p=Math.max,l=r.plotLeft,d=r.plotTop,u=r.plotHeight,h=r.plotWidth,c=t=Number.POSITIVE_INFINITY,y=e=Number.NEGATIVE_INFINITY,f=0;f<n.length;f++)o=n[f][2],c=s(c,n[f][0]-o),y=p(y,n[f][0]+o),t=s(t,n[f][1]-o),e=p(e,n[f][1]+o);if(i=s.apply([],[(h-l)/(a=[y-c,e-t])[0],(u-d)/a[1]]),1e-10<Math.abs(i-1)){for(f=0;f<n.length;f++)n[f][2]*=i;this.placeBubbles(n)}else r.diffY=u/2+d-t-(e-t)/2,r.diffX=h/2+l-c-(y-c)/2},t.prototype.seriesBox=function(){var e,t=this.chart,o=this.data,a=Math.max,i=Math.min,r=[t.plotLeft,t.plotLeft+t.plotWidth,t.plotTop,t.plotTop+t.plotHeight];return o.forEach(function(t){defined(t.plotX)&&defined(t.plotY)&&t.marker.radius&&(e=t.marker.radius,r[0]=i(r[0],t.plotX-e),r[1]=a(r[1],t.plotX+e),r[2]=i(r[2],t.plotY-e),r[3]=a(r[3],t.plotY+e))}),isNumber(r.width/r.height)?r:null},t.prototype.setVisible=function(){var e=this;Series.prototype.setVisible.apply(e,arguments),e.parentNodeLayout&&e.graph?e.visible?(e.graph.show(),e.parentNode.dataLabel&&e.parentNode.dataLabel.show()):(e.graph.hide(),e.parentNodeLayout.removeElementFromCollection(e.parentNode,e.parentNodeLayout.nodes),e.parentNode.dataLabel&&e.parentNode.dataLabel.hide()):e.layout&&(e.visible?e.layout.addElementsToCollection(e.points,e.layout.nodes):e.points.forEach(function(t){e.layout.removeElementFromCollection(t,e.layout.nodes)}))},t.prototype.translate=function(){var t,e,o,a,i=this,r=i.chart,n=i.data,s=i.index,p=i.options.useSimulation;for(i.processedXData=i.xData,i.generatePoints(),defined(r.allDataPoints)||(r.allDataPoints=i.accumulateAllPoints(i),i.getPointRadius()),p?o=r.allDataPoints:(o=i.placeBubbles(r.allDataPoints),i.options.draggable=!1),a=0;a<o.length;a++)o[a][3]===s&&(t=n[o[a][4]],e=pick(o[a][2],void 0),p||(t.plotX=o[a][0]-r.plotLeft+r.diffX,t.plotY=o[a][1]-r.plotTop+r.diffY),isNumber(e)&&(t.marker=extend(t.marker,{radius:e,width:2*e,height:2*e}),t.radius=e));p&&i.deferLayout(),fireEvent(i,"afterTranslate")},t.defaultOptions=merge(BubbleSeries.defaultOptions,{minSize:"10%",maxSize:"50%",sizeBy:"area",zoneAxis:"y",crisp:!1,tooltip:{pointFormat:"Value: {point.value}"},draggable:!0,useSimulation:!0,parentNode:{allowPointSelect:!1},dataLabels:{formatter:function(){var t=this.series.chart.numberFormatter,e=this.point.value;return isNumber(e)?t(e,-1):""},parentNodeFormatter:function(){return this.name},parentNodeTextPath:{enabled:!0},padding:0,style:{transition:"opacity 2000ms"}},layoutAlgorithm:{initialPositions:"circle",initialPositionRadius:20,bubblePadding:5,parentNodeLimit:!1,seriesInteraction:!0,dragBetweenSeries:!1,parentNodeOptions:{maxIterations:400,gravitationalConstant:.03,maxSpeed:50,initialPositionRadius:100,seriesInteraction:!0,marker:{fillColor:null,fillOpacity:1,lineWidth:null,lineColor:null,symbol:"circle"}},enableSimulation:!0,type:"packedbubble",integration:"packedbubble",maxIterations:1e3,splitSeries:!1,maxSpeed:5,gravitationalConstant:.01,friction:-.981}}),t}(BubbleSeries);extend(PackedBubbleSeries.prototype,{alignDataLabel:Series.prototype.alignDataLabel,axisTypes:[],directTouch:!0,forces:["barycenter","repulsive"],hasDraggableNodes:!0,isCartesian:!1,noSharedTooltip:!0,onMouseDown:dragNodesMixin.onMouseDown,onMouseMove:dragNodesMixin.onMouseMove,pointArrayMap:["value"],pointClass:PackedBubblePoint,pointValKey:"value",redrawHalo:dragNodesMixin.redrawHalo,requireSorting:!1,searchPoint:H.noop,trackerGroups:["group","dataLabelsGroup","parentNodesGroup"]}),SeriesRegistry.registerSeriesType("packedbubble",PackedBubbleSeries);export default PackedBubbleSeries;