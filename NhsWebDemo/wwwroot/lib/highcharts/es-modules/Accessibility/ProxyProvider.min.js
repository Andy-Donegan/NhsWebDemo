"use strict";import H from"../Core/Globals.js";var doc=H.doc;import U from"../Core/Utilities.js";var attr=U.attr,css=U.css;import CU from"./Utils/ChartUtilities.js";var unhideChartElementFromAT=CU.unhideChartElementFromAT;import DOMElementProvider from"./Utils/DOMElementProvider.js";import HU from"./Utils/HTMLUtilities.js";var removeElement=HU.removeElement,removeChildNodes=HU.removeChildNodes;import ProxyElement from"./ProxyElement.js";var ProxyProvider=function(){function r(r){this.chart=r,this.domElementProvider=new DOMElementProvider,this.groups={},this.groupOrder=[],this.beforeChartProxyPosContainer=this.createProxyPosContainer("before"),this.afterChartProxyPosContainer=this.createProxyPosContainer("after"),this.update()}return r.prototype.addProxyElement=function(r,e,t){var o=this.groups[r];if(!o)throw new Error("ProxyProvider.addProxyElement: Invalid group key "+r);t=new ProxyElement(this.chart,e,o.type,t);return o.proxyContainerElement.appendChild(t.element),o.proxyElements.push(t),t},r.prototype.addGroup=function(r,e,t){var o,i;this.groups[r]||(o=this.domElementProvider.createElement(e),t&&t.role&&"div"!==e?(i=this.domElementProvider.createElement("div")).appendChild(o):i=o,i.className="highcharts-a11y-proxy-group highcharts-a11y-proxy-group-"+r.replace(/\W/g,"-"),this.groups[r]={proxyContainerElement:o,groupElement:i,type:e,proxyElements:[]},attr(i,t||{}),"ul"===e&&o.setAttribute("role","list"),this.afterChartProxyPosContainer.appendChild(i),this.updateGroupOrder(this.groupOrder))},r.prototype.updateGroupAttrs=function(r,e){var t=this.groups[r];if(!t)throw new Error("ProxyProvider.updateGroupAttrs: Invalid group key "+r);attr(t.groupElement,e)},r.prototype.updateGroupOrder=function(r){var t,o,e,i=this;this.groupOrder=r.slice(),this.isDOMOrderGroupOrder()||(e=r.indexOf("series"),t=-1<e?r.slice(0,e):r,o=-1<e?r.slice(e+1):[],e=doc.activeElement,["before","after"].forEach(function(r){var e=i["before"===r?"beforeChartProxyPosContainer":"afterChartProxyPosContainer"],r="before"===r?t:o;removeChildNodes(e),r.forEach(function(r){r=i.groups[r];r&&e.appendChild(r.groupElement)})}),(this.beforeChartProxyPosContainer.contains(e)||this.afterChartProxyPosContainer.contains(e))&&e&&e.focus&&e.focus())},r.prototype.clearGroup=function(r){var e=this.groups[r];if(!e)throw new Error("ProxyProvider.clearGroup: Invalid group key "+r);removeChildNodes(e.proxyContainerElement)},r.prototype.removeGroup=function(r){var e=this.groups[r];e&&(removeElement(e.groupElement),delete this.groups[r])},r.prototype.update=function(){this.updatePosContainerPositions(),this.updateGroupOrder(this.groupOrder),this.updateProxyElementPositions()},r.prototype.updateProxyElementPositions=function(){Object.keys(this.groups).forEach(this.updateGroupProxyElementPositions.bind(this))},r.prototype.updateGroupProxyElementPositions=function(r){r=this.groups[r];r&&r.proxyElements.forEach(function(r){return r.refreshPosition()})},r.prototype.destroy=function(){this.domElementProvider.destroyCreatedElements()},r.prototype.createProxyPosContainer=function(r){var e=this.domElementProvider.createElement("div");return e.setAttribute("aria-hidden","false"),e.className="highcharts-a11y-proxy-container"+(r?"-"+r:""),css(e,{top:"0",left:"0"}),this.chart.styledMode||(e.style.whiteSpace="nowrap",e.style.position="absolute"),e},r.prototype.getCurrentGroupOrderInDOM=function(){var n=this,r=function(r){for(var e=[],t=r.children,o=0;o<t.length;++o){var i=function(r){for(var e=Object.keys(n.groups),t=e.length;t--;){var o=e[t],i=n.groups[o];if(i&&r===i.groupElement)return o}}(t[o]);i&&e.push(i)}return e},e=r(this.beforeChartProxyPosContainer),r=r(this.afterChartProxyPosContainer);return e.push("series"),e.concat(r)},r.prototype.isDOMOrderGroupOrder=function(){var e=this,r=this.getCurrentGroupOrderInDOM(),t=this.groupOrder.filter(function(r){return"series"===r||!!e.groups[r]}),o=r.length;if(o!==t.length)return!1;for(;o--;)if(r[o]!==t[o])return!1;return!0},r.prototype.updatePosContainerPositions=function(){var r=this.chart,e=r.renderer.box;r.container.insertBefore(this.afterChartProxyPosContainer,e.nextSibling),r.container.insertBefore(this.beforeChartProxyPosContainer,e),unhideChartElementFromAT(this.chart,this.afterChartProxyPosContainer),unhideChartElementFromAT(this.chart,this.beforeChartProxyPosContainer)},r}();export default ProxyProvider;