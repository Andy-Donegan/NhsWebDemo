"use strict";var __extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();import A11yI18n from"../A11yI18n.js";import AccessibilityComponent from"../AccessibilityComponent.js";import Announcer from"../Utils/Announcer.js";import AnnotationsA11y from"./AnnotationsA11y.js";var getAnnotationsInfoHTML=AnnotationsA11y.getAnnotationsInfoHTML;import AST from"../../Core/Renderer/HTML/AST.js";import CU from"../Utils/ChartUtilities.js";var getAxisDescription=CU.getAxisDescription,getAxisRangeDescription=CU.getAxisRangeDescription,getChartTitle=CU.getChartTitle,unhideChartElementFromAT=CU.unhideChartElementFromAT;import F from"../../Core/FormatUtilities.js";var format=F.format;import H from"../../Core/Globals.js";var doc=H.doc;import HU from"../Utils/HTMLUtilities.js";var addClass=HU.addClass,getElement=HU.getElement,getHeadingTagNameForElement=HU.getHeadingTagNameForElement,stripHTMLTagsFromString=HU.stripHTMLTagsFromString,visuallyHideElement=HU.visuallyHideElement;import U from"../../Core/Utilities.js";var attr=U.attr,pick=U.pick;function getTableSummary(t){return t.langFormat("accessibility.table.tableSummary",{chart:t})}function getTypeDescForMapChart(t,e){return e.mapTitle?t.langFormat("accessibility.chartTypes.mapTypeDescription",e):t.langFormat("accessibility.chartTypes.unknownMap",e)}function getTypeDescForCombinationChart(t,e){return t.langFormat("accessibility.chartTypes.combinationChart",e)}function getTypeDescForEmptyChart(t,e){return t.langFormat("accessibility.chartTypes.emptyChart",e)}function buildTypeDescriptionFromSeries(t,e,i){var n=e[0],r=t.langFormat("accessibility.seriesTypeDescriptions."+n,i),e=t.series&&t.series.length<2?"Single":"Multiple";return(t.langFormat("accessibility.chartTypes."+n+e,i)||t.langFormat("accessibility.chartTypes.default"+e,i))+(r?" "+r:"")}function getTypeDescription(t,e){var i=e[0],n=t.series&&t.series[0]||{},n={numSeries:t.series.length,numPoints:n.points&&n.points.length,chart:t,mapTitle:n.mapTitle};return i?"map"===i?getTypeDescForMapChart(t,n):1<t.types.length?getTypeDescForCombinationChart(t,n):buildTypeDescriptionFromSeries(t,e,n):getTypeDescForEmptyChart(t,n)}function stripEmptyHTMLTags(t){return t.replace(/<(\w+)[^>]*?>\s*<\/\1>/g,"")}var InfoRegionsComponent=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.announcer=void 0,t.screenReaderSections={},t}return __extends(t,e),t.prototype.init=function(){var t=this.chart,e=this;this.initRegionsDefinitions(),this.addEvent(t,"aftergetTableAST",function(t){e.onDataTableCreated(t)}),this.addEvent(t,"afterViewData",function(t){e.dataTableDiv=t,setTimeout(function(){e.focusDataTable()},300)}),this.announcer=new Announcer(t,"assertive")},t.prototype.initRegionsDefinitions=function(){var i=this;this.screenReaderSections={before:{element:null,buildContent:function(t){var e=t.options.accessibility.screenReaderSection.beforeChartFormatter;return e?e(t):i.defaultBeforeChartFormatter(t)},insertIntoDOM:function(t,e){e.renderTo.insertBefore(t,e.renderTo.firstChild)},afterInserted:function(){void 0!==i.sonifyButtonId&&i.initSonifyButton(i.sonifyButtonId),void 0!==i.dataTableButtonId&&i.initDataTableButton(i.dataTableButtonId)}},after:{element:null,buildContent:function(t){var e=t.options.accessibility.screenReaderSection.afterChartFormatter;return e?e(t):i.defaultAfterChartFormatter()},insertIntoDOM:function(t,e){e.renderTo.insertBefore(t,e.container.nextSibling)},afterInserted:function(){i.chart.accessibility&&i.chart.accessibility.keyboardNavigation.updateExitAnchor()}}}},t.prototype.onChartRender=function(){var e=this;this.linkedDescriptionElement=this.getLinkedDescriptionElement(),this.setLinkedDescriptionAttrs(),Object.keys(this.screenReaderSections).forEach(function(t){e.updateScreenReaderSection(t)})},t.prototype.getLinkedDescriptionElement=function(){var t=this.chart.options.accessibility.linkedDescription;if(t){if("string"!=typeof t)return t;t=format(t,this.chart),t=doc.querySelectorAll(t);return 1===t.length?t[0]:void 0}},t.prototype.setLinkedDescriptionAttrs=function(){var t=this.linkedDescriptionElement;t&&(t.setAttribute("aria-hidden","true"),addClass(t,"highcharts-linked-description"))},t.prototype.updateScreenReaderSection=function(t){var e=this.chart,i=this.screenReaderSections[t],n=i.buildContent(e),r=i.element=i.element||this.createElement("div"),a=r.firstChild||this.createElement("div");n?(this.setScreenReaderSectionAttribs(r,t),AST.setElementHTML(a,n),r.appendChild(a),i.insertIntoDOM(r,e),e.styledMode?addClass(a,"highcharts-visually-hidden"):visuallyHideElement(a),unhideChartElementFromAT(e,a),i.afterInserted&&i.afterInserted()):(r.parentNode&&r.parentNode.removeChild(r),delete i.element)},t.prototype.setScreenReaderSectionAttribs=function(t,e){var i=this.chart,n=i.langFormat("accessibility.screenReaderSection."+e+"RegionLabel",{chart:i,chartTitle:getChartTitle(i)}),e="highcharts-screen-reader-region-"+e+"-"+i.index;attr(t,{id:e,"aria-label":n}),t.style.position="relative","all"===i.options.accessibility.landmarkVerbosity&&n&&t.setAttribute("role","region")},t.prototype.defaultBeforeChartFormatter=function(){var t=this.chart,e=t.options.accessibility.screenReaderSection.beforeChartFormat;if(!e)return"";var i=this.getAxesDescription(),n=t.sonify&&t.options.sonification&&t.options.sonification.enabled,r="highcharts-a11y-sonify-data-btn-"+t.index,a="hc-linkto-highcharts-data-table-"+t.index,o=getAnnotationsInfoHTML(t),s=t.langFormat("accessibility.screenReaderSection.annotations.heading",{chart:t}),o={headingTagName:getHeadingTagNameForElement(t.renderTo),chartTitle:getChartTitle(t),typeDescription:this.getTypeDescriptionText(),chartSubtitle:this.getSubtitleText(),chartLongdesc:this.getLongdescText(),xAxisDescription:i.xAxis,yAxisDescription:i.yAxis,playAsSoundButton:n?this.getSonifyButtonText(r):"",viewTableButton:t.getCSV?this.getDataTableButtonText(a):"",annotationsTitle:o?s:"",annotationsList:o},t=A11yI18n.i18nFormat(e,o,t);return this.dataTableButtonId=a,this.sonifyButtonId=r,stripEmptyHTMLTags(t)},t.prototype.defaultAfterChartFormatter=function(){var t=this.chart,e=t.options.accessibility.screenReaderSection.afterChartFormat;if(!e)return"";var i={endOfChartMarker:this.getEndOfChartMarkerText()};return stripEmptyHTMLTags(A11yI18n.i18nFormat(e,i,t))},t.prototype.getLinkedDescription=function(){var t=this.linkedDescriptionElement,t=t&&t.innerHTML||"";return stripHTMLTagsFromString(t)},t.prototype.getLongdescText=function(){var t=this.chart.options,e=t.caption,i=e&&e.text,e=this.getLinkedDescription();return t.accessibility.description||e||i||""},t.prototype.getTypeDescriptionText=function(){var t=this.chart;return t.types?t.options.accessibility.typeDescription||getTypeDescription(t,t.types):""},t.prototype.getDataTableButtonText=function(t){var e=this.chart;return'<button id="'+t+'">'+e.langFormat("accessibility.table.viewAsDataTableButtonText",{chart:e,chartTitle:getChartTitle(e)})+"</button>"},t.prototype.getSonifyButtonText=function(t){var e=this.chart;return e.options.sonification&&!1===e.options.sonification.enabled?"":'<button id="'+t+'">'+e.langFormat("accessibility.sonification.playAsSoundButtonText",{chart:e,chartTitle:getChartTitle(e)})+"</button>"},t.prototype.getSubtitleText=function(){var t=this.chart.options.subtitle;return stripHTMLTagsFromString(t&&t.text||"")},t.prototype.getEndOfChartMarkerText=function(){var t=this.chart,e=t.langFormat("accessibility.screenReaderSection.endOfChartMarker",{chart:t});return'<div id="'+("highcharts-end-of-chart-marker-"+t.index)+'">'+e+"</div>"},t.prototype.onDataTableCreated=function(t){var e,i=this.chart;i.options.accessibility.enabled&&(this.viewDataTableButton&&this.viewDataTableButton.setAttribute("aria-expanded","true"),(e=t.tree.attributes||{}).tabindex=-1,e.summary=getTableSummary(i),t.tree.attributes=e)},t.prototype.focusDataTable=function(){var t=this.dataTableDiv,t=t&&t.getElementsByTagName("table")[0];t&&t.focus&&t.focus()},t.prototype.initSonifyButton=function(t){var e=this,i=this.sonifyButton=getElement(t),n=this.chart;i&&n&&(i.setAttribute("tabindex",-1),i.onclick=function(t){(n.options.accessibility&&n.options.accessibility.screenReaderSection.onPlayAsSoundClick||function(t){i&&(i.setAttribute("aria-hidden","true"),i.setAttribute("aria-label","")),t.preventDefault(),t.stopPropagation();t=n.langFormat("accessibility.sonification.playAsSoundClickAnnouncement",{chart:n});e.announcer.announce(t),setTimeout(function(){i&&(i.removeAttribute("aria-hidden"),i.removeAttribute("aria-label")),n.sonify&&n.sonify()},1e3)}).call(this,t,n)})},t.prototype.initDataTableButton=function(t){var e=this.viewDataTableButton=getElement(t),i=this.chart,t=t.replace("hc-linkto-","");e&&(attr(e,{tabindex:-1,"aria-expanded":!!getElement(t)}),e.onclick=i.options.accessibility.screenReaderSection.onViewDataTableClick||function(){i.viewData()})},t.prototype.getAxesDescription=function(){function t(t,e){return 1<(t=i[t]).length||t[0]&&pick(t[0].options.accessibility&&t[0].options.accessibility.enabled,e)}var i=this.chart,e=!!i.types&&i.types.indexOf("map")<0,n=!!i.hasCartesianSeries,r=t("xAxis",!i.angular&&n&&e),n=t("yAxis",n&&e),e={};return r&&(e.xAxis=this.getAxisDescriptionText("xAxis")),n&&(e.yAxis=this.getAxisDescriptionText("yAxis")),e},t.prototype.getAxisDescriptionText=function(t){var e=this.chart,i=e[t];return e.langFormat("accessibility.axis."+t+"Description"+(1<i.length?"Plural":"Singular"),{chart:e,names:i.map(function(t){return getAxisDescription(t)}),ranges:i.map(function(t){return getAxisRangeDescription(t)}),numAxes:i.length})},t.prototype.destroy=function(){this.announcer&&this.announcer.destroy()},t}(AccessibilityComponent);export default InfoRegionsComponent;