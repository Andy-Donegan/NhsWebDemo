"use strict";var __extends=this&&this.__extends||function(){var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};return function(e,t){function i(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}}();import A from"../../Core/Animation/AnimationUtilities.js";var animObject=A.animObject;import H from"../../Core/Globals.js";import Legend from"../../Core/Legend/Legend.js";import U from"../../Core/Utilities.js";var addEvent=U.addEvent,fireEvent=U.fireEvent,isNumber=U.isNumber,pick=U.pick,syncTimeout=U.syncTimeout;import AccessibilityComponent from"../AccessibilityComponent.js";import KeyboardNavigationHandler from"../KeyboardNavigationHandler.js";import CU from"../Utils/ChartUtilities.js";var getChartTitle=CU.getChartTitle;import HU from"../Utils/HTMLUtilities.js";var stripHTMLTags=HU.stripHTMLTagsFromString,addClass=HU.addClass,removeClass=HU.removeClass;function scrollLegendToItem(e,t){var i=e.allItems[t].pageIx,t=e.currentPage;void 0!==i&&i+1!==t&&e.scroll(1+i-t)}function shouldDoLegendA11y(e){var t=e.legend&&e.legend.allItems,i=e.options.legend.accessibility||{};return!(!t||!t.length||e.colorAxis&&e.colorAxis.length||!1===i.enabled)}var LegendComponent=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.highlightedLegendItemIx=NaN,e}return __extends(e,t),e.prototype.init=function(){var t=this;this.recreateProxies(),this.addEvent(Legend,"afterScroll",function(){this.chart===t.chart&&(t.proxyProvider.updateGroupProxyElementPositions("legend"),t.updateLegendItemProxyVisibility(),-1<t.highlightedLegendItemIx&&this.chart.highlightLegendItem(t.highlightedLegendItemIx))}),this.addEvent(Legend,"afterPositionItem",function(e){this.chart===t.chart&&this.chart.renderer&&t.updateProxyPositionForItem(e.item)}),this.addEvent(Legend,"afterRender",function(){this.chart===t.chart&&this.chart.renderer&&t.recreateProxies()&&syncTimeout(function(){return t.proxyProvider.updateGroupProxyElementPositions("legend")},animObject(pick(this.chart.renderer.globalAnimation,!0)).duration)})},e.prototype.updateLegendItemProxyVisibility=function(){var r=this.chart,o=r.legend,e=o.allItems||[],a=o.currentPage||1,s=o.clipHeight||0;e.forEach(function(e){var t,i,n;e.a11yProxyElement&&(i=o.pages&&o.pages.length,t=e.a11yProxyElement.element,n=!1,i&&(i=e.pageIx||0,n=(e._legendItemPos?e._legendItemPos[1]:0)+(e.legendItem?Math.round(e.legendItem.getBBox().height):0)-o.pages[i]>s||i!==a-1),n?r.styledMode?addClass(t,"highcharts-a11y-invisible"):t.style.visibility="hidden":(removeClass(t,"highcharts-a11y-invisible"),t.style.visibility=""))})},e.prototype.onChartRender=function(){shouldDoLegendA11y(this.chart)||this.removeProxies()},e.prototype.highlightAdjacentLegendPage=function(e){var t=this.chart,i=t.legend,n=(i.currentPage||1)+e,e=i.pages||[];if(0<n&&n<=e.length)for(var r=i.allItems.length,o=0;o<r;++o)if(i.allItems[o].pageIx+1===n)return void(t.highlightLegendItem(o)&&(this.highlightedLegendItemIx=o))},e.prototype.updateProxyPositionForItem=function(e){e.a11yProxyElement&&e.a11yProxyElement.refreshPosition()},e.prototype.recreateProxies=function(){return this.removeProxies(),!!shouldDoLegendA11y(this.chart)&&(this.addLegendProxyGroup(),this.proxyLegendItems(),this.updateLegendItemProxyVisibility(),this.updateLegendTitle(),!0)},e.prototype.removeProxies=function(){this.proxyProvider.removeGroup("legend")},e.prototype.updateLegendTitle=function(){var e=this.chart,t=stripHTMLTags((e.legend&&e.legend.options.title&&e.legend.options.title.text||"").replace(/<br ?\/?>/g," ")),e=e.langFormat("accessibility.legend.legendLabel"+(t?"":"NoTitle"),{chart:e,legendTitle:t,chartTitle:getChartTitle(e)});this.proxyProvider.updateGroupAttrs("legend",{"aria-label":e})},e.prototype.addLegendProxyGroup=function(){var e="all"===this.chart.options.accessibility.landmarkVerbosity?"region":null;this.proxyProvider.addGroup("legend","ul",{"aria-label":"_placeholder_",role:e})},e.prototype.proxyLegendItems=function(){var t=this;(this.chart.legend&&this.chart.legend.allItems||[]).forEach(function(e){e.legendItem&&e.legendItem.element&&t.proxyLegendItem(e)})},e.prototype.proxyLegendItem=function(e){var t,i;e.legendItem&&e.legendGroup&&(i=this.chart.langFormat("accessibility.legend.legendItem",{chart:this.chart,itemName:stripHTMLTags(e.name),item:e}),t={tabindex:-1,"aria-pressed":e.visible,"aria-label":i},i=e.legendGroup.div?e.legendItem:e.legendGroup,e.a11yProxyElement=this.proxyProvider.addProxyElement("legend",{click:e.legendItem,visual:i.element},t))},e.prototype.getKeyboardNavigation=function(){var t=this.keyCodes,i=this,e=this.chart;return new KeyboardNavigationHandler(e,{keyCodeMap:[[[t.left,t.right,t.up,t.down],function(e){return i.onKbdArrowKey(this,e)}],[[t.enter,t.space],function(e){return H.isFirefox&&e===t.space?this.response.success:i.onKbdClick(this)}],[[t.pageDown,t.pageUp],function(e){e=e===t.pageDown?1:-1;return i.highlightAdjacentLegendPage(e),this.response.success}]],validate:function(){return i.shouldHaveLegendNavigation()},init:function(e){return i.onKbdNavigationInit(e)},terminate:function(){i.highlightedLegendItemIx=-1,e.legend.allItems.forEach(function(e){return e.setState("",!0)})}})},e.prototype.onKbdArrowKey=function(e,t){var i=this.keyCodes,n=e.response,r=this.chart,o=r.options.accessibility,a=r.legend.allItems.length,i=t===i.left||t===i.up?-1:1;return r.highlightLegendItem(this.highlightedLegendItemIx+i)?(this.highlightedLegendItemIx+=i,n.success):1<a&&o.keyboardNavigation.wrapAround?(e.init(i),n.success):n[0<i?"next":"prev"]},e.prototype.onKbdClick=function(e){var t=this.chart.legend.allItems[this.highlightedLegendItemIx];return t&&t.a11yProxyElement&&t.a11yProxyElement.click(),e.response.success},e.prototype.shouldHaveLegendNavigation=function(){var e=this.chart,t=e.options.legend||{},i=e.legend&&e.legend.allItems,n=e.colorAxis&&e.colorAxis.length,t=t.accessibility||{};return!!(i&&e.legend.display&&!n&&t.enabled&&t.keyboardNavigation&&t.keyboardNavigation.enabled)},e.prototype.onKbdNavigationInit=function(e){var t=this.chart,i=t.legend.allItems.length-1,i=0<e?0:i;t.highlightLegendItem(i),this.highlightedLegendItemIx=i},e}(AccessibilityComponent);!function(e){var i=[];function n(e){var t=this.legend.allItems,i=this.accessibility&&this.accessibility.components.legend.highlightedLegendItemIx,n=t[e];if(n){isNumber(i)&&t[i]&&fireEvent(t[i].legendGroup.element,"mouseout"),scrollLegendToItem(this.legend,e);i=n.legendItem,e=n.a11yProxyElement&&n.a11yProxyElement.buttonElement;return i&&i.element&&e&&this.setFocusToElement(i,e),n.legendGroup&&fireEvent(n.legendGroup.element,"mouseover"),!0}return!1}function r(e){var t=this.chart.options.accessibility,i=e.item;t.enabled&&i&&i.a11yProxyElement&&i.a11yProxyElement.buttonElement.setAttribute("aria-pressed",e.visible?"true":"false")}e.compose=function(e,t){-1===i.indexOf(e)&&(i.push(e),e.prototype.highlightLegendItem=n),-1===i.indexOf(t)&&(i.push(t),addEvent(t,"afterColorizeItem",r))}}(LegendComponent=LegendComponent||{});export default LegendComponent;